/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component file remote
import java util list
import org apache camel processor
import org apache camel component file genericfile
import org apache camel util fileutil
import org apache camel util objecthelper
import org apache camel util urisupport
import org apache commons net ftp ftpfile
/**
* ftp consumer
*/
public class ftpconsumer extends remotefileconsumer<ftpfile>
protected string endpointpath
public ftpconsumer remotefileendpoint<ftpfile> endpoint  processor processor  remotefileoperations<ftpfile> fileoperations
super endpoint  processor  fileoperations
this endpointpath   endpoint getconfiguration   getdirectory
@override
protected boolean polldirectory string filename  list<genericfile<ftpfile>> filelist  int depth
string currentdir   null
if  isstepwise
// must remember current dir so we stay in that directory after the poll
currentdir   operations getcurrentdirectory
// strip trailing slash
filename   fileutil striptrailingseparator filename
boolean answer   dopolldirectory filename  null  filelist  depth
if  currentdir    null
operations changecurrentdirectory currentdir
return answer
protected boolean pollsubdirectory string absolutepath  string dirname  list<genericfile<ftpfile>> filelist  int depth
boolean answer   dopolldirectory absolutepath  dirname  filelist  depth
// change back to parent directory when finished polling sub directory
if  isstepwise
operations changetoparentdirectory
return answer
protected boolean dopolldirectory string absolutepath  string dirname  list<genericfile<ftpfile>> filelist  int depth
log trace    absolutepath  dirname
depth
// remove trailing /
dirname   fileutil striptrailingseparator dirname
// compute dir depending on stepwise is enabled or not
string dir
if  isstepwise
dir   objecthelper isnotempty dirname  ? dirname   absolutepath
operations changecurrentdirectory dir
else
dir   absolutepath
log trace    dir
list<ftpfile> files
if  isstepwise
files   operations listfiles
else
files   operations listfiles dir
if  files    null    files isempty
// no files in this directory to poll
log trace    dir
return true
else
// we found some files
log trace    files size    dir
for  ftpfile file   files
// check if we can continue polling in files
if   canpollmorefiles filelist
return false
if  file isdirectory
remotefile<ftpfile> remote   asremotefile absolutepath  file
if  endpoint isrecursive      isvalidfile remote  true     depth < endpoint getmaxdepth
// recursive scan and add the sub files and folders
string subdirectory   file getname
string path   absolutepath       subdirectory
boolean canpollmore   pollsubdirectory path  subdirectory  filelist  depth
if   canpollmore
return false
else if  file isfile
remotefile<ftpfile> remote   asremotefile absolutepath  file
if  isvalidfile remote  false     depth >  endpoint getmindepth
if  isinprogress remote
log trace    remote getfilename
else
// matched file so add
filelist add remote
else
log debug     file
return true
private remotefile<ftpfile> asremotefile string absolutepath  ftpfile file
remotefile<ftpfile> answer   new remotefile<ftpfile>
answer setendpointpath endpointpath
answer setfile file
answer setfilenameonly file getname
answer setfilelength file getsize
if  file gettimestamp      null
answer setlastmodified file gettimestamp   gettimeinmillis
answer sethostname   remotefileconfiguration  endpoint getconfiguration    gethost
// absolute or relative path
boolean absolute   fileutil hasleadingseparator absolutepath
answer setabsolute absolute
// create a pseudo absolute name
string dir   fileutil striptrailingseparator absolutepath
string absolutefilename   fileutil stripleadingseparator dir       file getname
// if absolute start with a leading separator otherwise let it be relative
if  absolute
absolutefilename       absolutefilename
answer setabsolutefilepath absolutefilename
// the relative filename, skip the leading endpoint configured path
string relativepath   objecthelper after absolutefilename  endpointpath
// skip leading /
relativepath   fileutil stripleadingseparator relativepath
answer setrelativefilepath relativepath
// the file name should be the relative path
answer setfilename answer getrelativefilepath
return answer
private boolean isstepwise
remotefileconfiguration config    remotefileconfiguration  endpoint getconfiguration
return config isstepwise
@override
public string tostring
return     urisupport sanitizeuri getendpoint   getendpointuri