/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component jms
import java util map
import javax jms connectionfactory
import javax jms exceptionlistener
import javax jms session
import org apache camel camelcontext
import org apache camel endpoint
import org apache camel impl defaultcomponent
import org apache camel spi headerfilterstrategy
import org apache camel spi headerfilterstrategyaware
import org springframework beans beansexception
import org springframework context applicationcontext
import org springframework context applicationcontextaware
import org springframework core task taskexecutor
import org springframework jms connection jmstransactionmanager
import org springframework jms connection usercredentialsconnectionfactoryadapter
import org springframework jms core jmsoperations
import org springframework jms support converter messageconverter
import org springframework jms support destination destinationresolver
import org springframework transaction platformtransactionmanager
import org springframework util errorhandler
import static org apache camel util objecthelper removestartingcharacters
/**
* a <a href="http://activemq.apache.org/jms.html">jms component</a>
*
* @version
*/
public class jmscomponent extends defaultcomponent implements applicationcontextaware  headerfilterstrategyaware
private static final string key_format_strategy_param
private jmsconfiguration configuration
private applicationcontext applicationcontext
private queuebrowsestrategy queuebrowsestrategy
private headerfilterstrategy headerfilterstrategy   new jmsheaderfilterstrategy
public jmscomponent
public jmscomponent camelcontext context
super context
public jmscomponent jmsconfiguration configuration
this configuration   configuration
/**
* static builder method
*/
public static jmscomponent jmscomponent
return new jmscomponent
/**
* static builder method
*/
public static jmscomponent jmscomponent jmsconfiguration configuration
return new jmscomponent configuration
/**
* static builder method
*/
public static jmscomponent jmscomponent connectionfactory connectionfactory
return jmscomponent new jmsconfiguration connectionfactory
/**
* static builder method
*/
public static jmscomponent jmscomponentclientacknowledge connectionfactory connectionfactory
jmsconfiguration template   new jmsconfiguration connectionfactory
template setacknowledgementmode session client_acknowledge
return jmscomponent template
/**
* static builder method
*/
public static jmscomponent jmscomponentautoacknowledge connectionfactory connectionfactory
jmsconfiguration template   new jmsconfiguration connectionfactory
template setacknowledgementmode session auto_acknowledge
return jmscomponent template
public static jmscomponent jmscomponenttransacted connectionfactory connectionfactory
jmstransactionmanager transactionmanager   new jmstransactionmanager
transactionmanager setconnectionfactory connectionfactory
return jmscomponenttransacted connectionfactory  transactionmanager
@suppresswarnings
public static jmscomponent jmscomponenttransacted connectionfactory connectionfactory
platformtransactionmanager transactionmanager
jmsconfiguration template   new jmsconfiguration connectionfactory
template settransactionmanager transactionmanager
template settransacted true
template settransactedinout true
return jmscomponent template
// properties
// -------------------------------------------------------------------------
public jmsconfiguration getconfiguration
if  configuration    null
configuration   createconfiguration
// if we are being configured with spring...
if  applicationcontext    null
map<string  connectionfactory> beansoftypeconnectionfactory   applicationcontext getbeansoftype connectionfactory class
if   beansoftypeconnectionfactory isempty
connectionfactory cf   beansoftypeconnectionfactory values   iterator   next
configuration setconnectionfactory cf
map<string  destinationresolver> beansoftypedestinationresolver   applicationcontext getbeansoftype destinationresolver class
if   beansoftypedestinationresolver isempty
destinationresolver destinationresolver   beansoftypedestinationresolver values   iterator   next
configuration setdestinationresolver destinationresolver
return configuration
/**
* sets the jms configuration
*
* @param configuration the configuration to use by default for endpoints
*/
public void setconfiguration jmsconfiguration configuration
this configuration   configuration
public void setacceptmessageswhilestopping boolean acceptmessageswhilestopping
getconfiguration   setacceptmessageswhilestopping acceptmessageswhilestopping
public void setacknowledgementmode int consumeracknowledgementmode
getconfiguration   setacknowledgementmode consumeracknowledgementmode
public void seteagerloadingofproperties boolean eagerloadingofproperties
getconfiguration   seteagerloadingofproperties eagerloadingofproperties
public void setacknowledgementmodename string consumeracknowledgementmode
getconfiguration   setacknowledgementmodename consumeracknowledgementmode
public void setautostartup boolean autostartup
getconfiguration   setautostartup autostartup
public void setcachelevel int cachelevel
getconfiguration   setcachelevel cachelevel
public void setcachelevelname string cachename
getconfiguration   setcachelevelname cachename
public void setclientid string consumerclientid
getconfiguration   setclientid consumerclientid
public void setconcurrentconsumers int concurrentconsumers
getconfiguration   setconcurrentconsumers concurrentconsumers
public void setconnectionfactory connectionfactory connectionfactory
getconfiguration   setconnectionfactory connectionfactory
public void setdeliverypersistent boolean deliverypersistent
getconfiguration   setdeliverypersistent deliverypersistent
public void setdurablesubscriptionname string durablesubscriptionname
getconfiguration   setdurablesubscriptionname durablesubscriptionname
public void setexceptionlistener exceptionlistener exceptionlistener
getconfiguration   setexceptionlistener exceptionlistener
public void seterrorhandler errorhandler errorhandler
getconfiguration   seterrorhandler errorhandler
public void setexplicitqosenabled boolean explicitqosenabled
getconfiguration   setexplicitqosenabled explicitqosenabled
public void setexposelistenersession boolean exposelistenersession
getconfiguration   setexposelistenersession exposelistenersession
public void setidletaskexecutionlimit int idletaskexecutionlimit
getconfiguration   setidletaskexecutionlimit idletaskexecutionlimit
public void setidleconsumerlimit int idleconsumerlimit
getconfiguration   setidleconsumerlimit idleconsumerlimit
public void setmaxconcurrentconsumers int maxconcurrentconsumers
getconfiguration   setmaxconcurrentconsumers maxconcurrentconsumers
public void setmaxmessagespertask int maxmessagespertask
getconfiguration   setmaxmessagespertask maxmessagespertask
public void setmessageconverter messageconverter messageconverter
getconfiguration   setmessageconverter messageconverter
public void setmapjmsmessage boolean mapjmsmessage
getconfiguration   setmapjmsmessage mapjmsmessage
public void setmessageidenabled boolean messageidenabled
getconfiguration   setmessageidenabled messageidenabled
public void setmessagetimestampenabled boolean messagetimestampenabled
getconfiguration   setmessagetimestampenabled messagetimestampenabled
public void setalwayscopymessage boolean alwayscopymessage
getconfiguration   setalwayscopymessage alwayscopymessage
public void setusemessageidascorrelationid boolean usemessageidascorrelationid
getconfiguration   setusemessageidascorrelationid usemessageidascorrelationid
public void setpriority int priority
getconfiguration   setpriority priority
public void setpubsubnolocal boolean pubsubnolocal
getconfiguration   setpubsubnolocal pubsubnolocal
public void setreceivetimeout long receivetimeout
getconfiguration   setreceivetimeout receivetimeout
public void setrecoveryinterval long recoveryinterval
getconfiguration   setrecoveryinterval recoveryinterval
@deprecated
public void setsubscriptiondurable boolean subscriptiondurable
getconfiguration   setsubscriptiondurable subscriptiondurable
public void settaskexecutor taskexecutor taskexecutor
getconfiguration   settaskexecutor taskexecutor
public void settimetolive long timetolive
getconfiguration   settimetolive timetolive
public void settransacted boolean consumertransacted
getconfiguration   settransacted consumertransacted
public void settransactionmanager platformtransactionmanager transactionmanager
getconfiguration   settransactionmanager transactionmanager
public void settransactionname string transactionname
getconfiguration   settransactionname transactionname
public void settransactiontimeout int transactiontimeout
getconfiguration   settransactiontimeout transactiontimeout
public void settestconnectiononstartup boolean testconnectiononstartup
getconfiguration   settestconnectiononstartup testconnectiononstartup
public void setforcesendoriginalmessage boolean forcesendoriginalmessage
getconfiguration   setforcesendoriginalmessage forcesendoriginalmessage
public void setrequesttimeout long requesttimeout
getconfiguration   setrequesttimeout requesttimeout
public void settransferexchange boolean transferexchange
getconfiguration   settransferexchange transferexchange
public void settransferexception boolean transferexception
getconfiguration   settransferexception transferexception
public void setjmsoperations jmsoperations jmsoperations
getconfiguration   setjmsoperations jmsoperations
public void setdestinationresolver destinationresolver destinationresolver
getconfiguration   setdestinationresolver destinationresolver
public replytotype getreplytotype
return getconfiguration   getreplytotype
public void setreplytotype replytotype replytotype
getconfiguration   setreplytotype replytotype
public boolean ispreservemessageqos
return getconfiguration   ispreservemessageqos
public void setpreservemessageqos boolean preservemessageqos
getconfiguration   setpreservemessageqos preservemessageqos
public void setasyncconsumer boolean asyncconsumer
configuration setasyncconsumer asyncconsumer
public boolean isasyncconsumer
return configuration isasyncconsumer
public void setapplicationcontext applicationcontext applicationcontext  throws beansexception
this applicationcontext   applicationcontext
public queuebrowsestrategy getqueuebrowsestrategy
if  queuebrowsestrategy    null
queuebrowsestrategy   new defaultqueuebrowsestrategy
return queuebrowsestrategy
public void setqueuebrowsestrategy queuebrowsestrategy queuebrowsestrategy
this queuebrowsestrategy   queuebrowsestrategy
public headerfilterstrategy getheaderfilterstrategy
return headerfilterstrategy
public void setheaderfilterstrategy headerfilterstrategy strategy
this headerfilterstrategy   strategy
// implementation methods
// -------------------------------------------------------------------------
@override
protected void dostop   throws exception
super dostop
@override
protected endpoint createendpoint string uri  string remaining  map<string  object> parameters
throws exception
boolean pubsubdomain   false
boolean tempdestination   false
if  remaining startswith jmsconfiguration queue_prefix
pubsubdomain   false
remaining   removestartingcharacters remaining substring jmsconfiguration queue_prefix length
else if  remaining startswith jmsconfiguration topic_prefix
pubsubdomain   true
remaining   removestartingcharacters remaining substring jmsconfiguration topic_prefix length
else if  remaining startswith jmsconfiguration temp_queue_prefix
pubsubdomain   false
tempdestination   true
remaining   removestartingcharacters remaining substring jmsconfiguration temp_queue_prefix length
else if  remaining startswith jmsconfiguration temp_topic_prefix
pubsubdomain   true
tempdestination   true
remaining   removestartingcharacters remaining substring jmsconfiguration temp_topic_prefix length
final string subject   convertpathtoactualdestination remaining  parameters
// lets make sure we copy the configuration as each endpoint can
// customize its own version
jmsconfiguration newconfiguration   getconfiguration   copy
jmsendpoint endpoint
if  pubsubdomain
if  tempdestination
endpoint   new jmstemporarytopicendpoint uri  this  subject  newconfiguration
else
endpoint   new jmsendpoint uri  this  subject  pubsubdomain  newconfiguration
else
queuebrowsestrategy strategy   getqueuebrowsestrategy
if  tempdestination
endpoint   new jmstemporaryqueueendpoint uri  this  subject  newconfiguration  strategy
else
endpoint   new jmsqueueendpoint uri  this  subject  newconfiguration  strategy
// resolve any custom connection factory first
connectionfactory cf   resolveandremovereferenceparameter parameters     connectionfactory class
if  cf    null
endpoint getconfiguration   setconnectionfactory cf
string username   getandremoveparameter parameters     string class
string password   getandremoveparameter parameters     string class
if  username    null    password    null
cf   endpoint getconfiguration   getconnectionfactory
usercredentialsconnectionfactoryadapter ucfa   new usercredentialsconnectionfactoryadapter
ucfa settargetconnectionfactory cf
ucfa setpassword password
ucfa setusername username
endpoint getconfiguration   setconnectionfactory ucfa
else
if  username    null    password    null
// exclude the the saturation of username and password are all empty
throw new illegalargumentexception
// jms header strategy
string strategyval   getandremoveparameter parameters  key_format_strategy_param  string class
if    equalsignorecase strategyval
endpoint setjmskeyformatstrategy new defaultjmskeyformatstrategy
else if    equalsignorecase strategyval
endpoint setjmskeyformatstrategy new passthroughjmskeyformatstrategy
else      a reference
parameters put key_format_strategy_param  strategyval
endpoint setjmskeyformatstrategy resolveandremovereferenceparameter
parameters  key_format_strategy_param  jmskeyformatstrategy class
setproperties endpoint getconfiguration    parameters
endpoint setheaderfilterstrategy getheaderfilterstrategy
return endpoint
/**
* a strategy method allowing the uri destination to be translated into the
* actual jms destination name (say by looking up in jndi or something)
*/
protected string convertpathtoactualdestination string path  map<string  object> parameters
return path
/**
* factory method to create the default configuration instance
*
* @return a newly created configuration object which can then be further
*         customized
*/
protected jmsconfiguration createconfiguration
return new jmsconfiguration