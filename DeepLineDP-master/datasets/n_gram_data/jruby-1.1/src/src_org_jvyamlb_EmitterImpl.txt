/***** begin license block *****
* version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public
* license version 1.0 (the "license"); you may not use this file
* except in compliance with the license. you may obtain a copy of
* the license at http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as
* is" basis, without warranty of any kind, either express or
* implied. see the license for the specific language governing
* rights and limitations under the license.
*
* copyright (c) 2007 ola bini <ola@ologix.com>
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"),
* or the gnu lesser general public license version 2.1 or later (the "lgpl"),
* in which case the provisions of the gpl or the lgpl are applicable instead
* of those above. if you wish to allow use of your version of this file only
* under the terms of either the gpl or the lgpl, and not to allow others to
* use your version of this file under the terms of the cpl, indicate your
* decision by deleting the provisions above and replace them with the notice
* and other provisions required by the gpl or the lgpl. if you do not delete
* the provisions above, a recipient may use your version of this file under
* the terms of any one of the cpl, the gpl or the lgpl.
***** end license block *****/
package org jvyamlb
import java io ioexception
import java io outputstream
import java io bufferedinputstream
import java io fileinputstream
import java util hashmap
import java util list
import java util map
import java util arraylist
import java util iterator
import java util set
import java util treeset
import java util regex pattern
import org jvyamlb events event
import org jvyamlb events streamstartevent
import org jvyamlb events streamendevent
import org jvyamlb events documentstartevent
import org jvyamlb events documentendevent
import org jvyamlb events collectionstartevent
import org jvyamlb events collectionendevent
import org jvyamlb events mappingstartevent
import org jvyamlb events sequencestartevent
import org jvyamlb events mappingendevent
import org jvyamlb events sequenceendevent
import org jvyamlb events aliasevent
import org jvyamlb events scalarevent
import org jvyamlb events nodeevent
import org jruby util bytelist
/**
* @author <a href="mailto:ola.bini@ki.se">ola bini</a>
*/
public class emitterimpl implements emitter
private static class scalaranalysis
public bytelist scalar
public boolean empty
public boolean multiline
public boolean allowflowplain
public boolean allowblockplain
public boolean allowsinglequoted
public boolean allowdoublequoted
public boolean allowblock
public boolean specialcharacters
public scalaranalysis final bytelist scalar  final boolean empty  final boolean multiline  final boolean allowflowplain  final boolean allowblockplain  final boolean allowsinglequoted  final boolean allowdoublequoted  final boolean allowblock  final boolean specialcharacters
this scalar   scalar
this empty   empty
this multiline   multiline
this allowflowplain   allowflowplain
this allowblockplain   allowblockplain
this allowsinglequoted   allowsinglequoted
this allowdoublequoted   allowdoublequoted
this allowblock   allowblock
this specialcharacters   specialcharacters
private static interface emitterstate
void expect final emitterenvironment env  throws ioexception
private static final int stream_start   0
private static final int first_document_start   1
private static final int document_root   2
private static final int nothing   3
private static final int document_start   4
private static final int document_end   5
private static final int first_flow_sequence_item   6
private static final int flow_sequence_item   7
private static final int first_flow_mapping_key   8
private static final int flow_mapping_simple_value   9
private static final int flow_mapping_value   10
private static final int flow_mapping_key   11
private static final int block_sequence_item   12
private static final int first_block_mapping_key   13
private static final int block_mapping_simple_value   14
private static final int block_mapping_value   15
private static final int block_mapping_key   16
private static final int first_block_sequence_item   17
private static final emitterstate states   new emitterstate
static
states   new emitterstate
public void expect final emitterenvironment env
env expectstreamstart
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectdocumentstart true
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectdocumentroot
states   new emitterstate
public void expect final emitterenvironment env
env expectnothing
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectdocumentstart false
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectdocumentend
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectfirstflowsequenceitem
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectflowsequenceitem
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectfirstflowmappingkey
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectflowmappingsimplevalue
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectflowmappingvalue
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectflowmappingkey
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectblocksequenceitem false
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectfirstblockmappingkey
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectblockmappingsimplevalue
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectblockmappingvalue
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectblockmappingkey false
states   new emitterstate
public void expect final emitterenvironment env  throws ioexception
env expectblocksequenceitem true
private final static map default_tag_prefixes_1_0
private final static map default_tag_prefixes_1_1
static
final map definit0   new hashmap
definit0 put
default_tag_prefixes_1_0   java util collections unmodifiablemap definit0
final map definit   new hashmap
definit put
definit put
default_tag_prefixes_1_1   java util collections unmodifiablemap definit
private outputstream stream
private yamlconfig options
private emitterenvironment env
public emitterimpl final outputstream stream  final yamlconfig opts
this stream   stream
this options   opts
this env   new emitterenvironment
this env emitter   this
this env canonical   this options canonical
final int propindent   this options indent
if propindent> 2    propindent<10
this env bestindent   propindent
final int propwidth   this options bestwidth
if propwidth    0    propwidth >  this env bestindent 2
this env bestwidth   propwidth
public yamlconfig getoptions
return options
public void emit final event event  throws ioexception
this env events add event
while  this env needmoreevents
this env event    event this env events remove 0
states expect env
this env event   null
private static class emitterenvironment
public list states   new arraylist
public int state   stream_start
public list events   new arraylist
public event event
public int flowlevel   0
public list indents   new arraylist
public int indent    1
public boolean rootcontext   false
public boolean sequencecontext   false
public boolean mappingcontext   false
public boolean simplekeycontext   false
public int line   0
public int column   0
public boolean whitespace   true
public boolean indentation   true
public boolean canonical   false
public int bestindent   2
public int bestwidth   80
public bytelist bestlinebreak   bytelist create
public map tagprefixes
public string preparedanchor
public string preparedtag
public scalaranalysis analysis
public char style   0
public emitterimpl emitter
public boolean isversion10   false
public boolean needmoreevents
if events isempty
return true
event    event events get 0
if event instanceof documentstartevent
return needevents 1
else if event instanceof sequencestartevent
return needevents 2
else if event instanceof mappingstartevent
return needevents 3
else
return false
private boolean needevents final int count
int level   0
final iterator iter   events iterator
iter next
for  iter hasnext
final object curr   iter next
if curr instanceof documentstartevent    curr instanceof collectionstartevent
level
else if curr instanceof documentendevent    curr instanceof collectionendevent
level
else if curr instanceof streamendevent
level    1
if level<0
return false
return events size   < count 1
private void increaseindent final boolean flow  final boolean indentless
indents add 0 new integer indent
if indent     1
if flow
indent   bestindent
else
indent   0
else if  indentless
indent    bestindent
public void expectstreamstart
if this event instanceof streamstartevent
emitter writestreamstart
this state   first_document_start
else
throw new emitterexception     this event
public void expectnothing
throw new emitterexception     this event
public void expectdocumentstart final boolean first  throws ioexception
if event instanceof documentstartevent
final documentstartevent ev    documentstartevent event
if first
if null    ev getversion
emitter writeversiondirective prepareversion ev getversion
if  null    ev getversion      ev getversion      0     emitter getoptions   version   equals
isversion10   true
tagprefixes   new hashmap default_tag_prefixes_1_0
else
tagprefixes   new hashmap default_tag_prefixes_1_1
if null    ev gettags
final set handles   new treeset
handles addall ev gettags   keyset
for final iterator iter   handles iterator   iter hasnext
final string handle    string iter next
final string prefix    string ev gettags   get handle
tagprefixes put prefix handle
final string handletext   preparetaghandle handle
final string prefixtext   preparetagprefix prefix
emitter writetagdirective handletext prefixtext
final boolean implicit   first     ev getexplicit       canonical    ev getversion      null    ev gettags      null     checkemptydocument
if  implicit
emitter writeindent
emitter writeindicator bytelist create    true true false
if canonical
emitter writeindent
state   document_root
else if event instanceof streamendevent
emitter writestreamend
state   nothing
else
throw new emitterexception     event
public void expectdocumentroot   throws ioexception
states add 0 new integer document_end
expectnode true false false false
public void expectdocumentend   throws ioexception
if event instanceof documentendevent
emitter writeindent
if   documentendevent event  getexplicit
emitter writeindicator bytelist create    true false false
emitter writeindent
emitter flushstream
state   document_start
else
throw new emitterexception     event
public void expectfirstflowsequenceitem   throws ioexception
if event instanceof sequenceendevent
indent     integer indents remove 0   intvalue
flowlevel
emitter writeindicator bytelist create    false false false
state     integer states remove 0   intvalue
else
if canonical    column > bestwidth
emitter writeindent
states add 0 new integer flow_sequence_item
expectnode false true false false
public void expectflowsequenceitem   throws ioexception
if event instanceof sequenceendevent
indent     integer indents remove 0   intvalue
flowlevel
if canonical
emitter writeindicator bytelist create    false false false
emitter writeindent
emitter writeindicator bytelist create    false false false
state     integer states remove 0   intvalue
else
emitter writeindicator bytelist create    false false false
if canonical    column > bestwidth
emitter writeindent
states add 0 new integer flow_sequence_item
expectnode false true false false
public void expectfirstflowmappingkey   throws ioexception
if event instanceof mappingendevent
indent     integer indents remove 0   intvalue
flowlevel
emitter writeindicator bytelist create    false false false
state     integer states remove 0   intvalue
else
if canonical    column > bestwidth
emitter writeindent
if  canonical    checksimplekey
states add 0 new integer flow_mapping_simple_value
expectnode false false true true
else
emitter writeindicator bytelist create    true false false
states add 0 new integer flow_mapping_value
expectnode false false true false
public void expectflowmappingsimplevalue   throws ioexception
emitter writeindicator bytelist create    false true false
states add 0 new integer flow_mapping_key
expectnode false false true false
public void expectflowmappingvalue   throws ioexception
if canonical    column > bestwidth
emitter writeindent
emitter writeindicator bytelist create    false true false
states add 0 new integer flow_mapping_key
expectnode false false true false
public void expectflowmappingkey   throws ioexception
if event instanceof mappingendevent
indent     integer indents remove 0   intvalue
flowlevel
if canonical
emitter writeindicator bytelist create    false false false
emitter writeindent
emitter writeindicator bytelist create    false false false
state     integer states remove 0   intvalue
else
emitter writeindicator bytelist create    false false false
if canonical    column > bestwidth
emitter writeindent
if  canonical    checksimplekey
states add 0 new integer flow_mapping_simple_value
expectnode false false true true
else
emitter writeindicator bytelist create    true false false
states add 0 new integer flow_mapping_value
expectnode false false true false
public void expectblocksequenceitem final boolean first  throws ioexception
if  first    event instanceof sequenceendevent
indent     integer indents remove 0   intvalue
state     integer states remove 0   intvalue
else
emitter writeindent
emitter writeindicator bytelist create    true false true
states add 0 new integer block_sequence_item
expectnode false true false false
public void expectfirstblockmappingkey   throws ioexception
expectblockmappingkey true
public void expectblockmappingsimplevalue   throws ioexception
emitter writeindicator bytelist create    false true false
states add 0 new integer block_mapping_key
expectnode false false true false
public void expectblockmappingvalue   throws ioexception
emitter writeindent
emitter writeindicator bytelist create    true true true
states add 0 new integer block_mapping_key
expectnode false false true false
public void expectblockmappingkey final boolean first  throws ioexception
if  first    event instanceof mappingendevent
indent     integer indents remove 0   intvalue
state     integer states remove 0   intvalue
else
emitter writeindent
if checksimplekey
states add 0 new integer block_mapping_simple_value
expectnode false false true true
else
emitter writeindicator bytelist create    true false true
states add 0 new integer block_mapping_value
expectnode false false true false
private void expectnode final boolean root  final boolean sequence  final boolean mapping  final boolean simplekey  throws ioexception
rootcontext   root
sequencecontext   sequence
mappingcontext   mapping
simplekeycontext   simplekey
if event instanceof aliasevent
expectalias
else if event instanceof scalarevent    event instanceof collectionstartevent
processanchor bytelist create
processtag
if event instanceof scalarevent
expectscalar
else if event instanceof sequencestartevent
if flowlevel    0    canonical      sequencestartevent event  getflowstyle      checkemptysequence
expectflowsequence
else
expectblocksequence
else if event instanceof mappingstartevent
if flowlevel    0    canonical      mappingstartevent event  getflowstyle      checkemptymapping
expectflowmapping
else
expectblockmapping
else
throw new emitterexception     event
private void expectalias   throws ioexception
if   nodeevent event  getanchor      null
throw new emitterexception
processanchor bytelist create
state     integer states remove 0   intvalue
private void expectscalar   throws ioexception
increaseindent true false
processscalar
indent     integer indents remove 0   intvalue
state     integer states remove 0   intvalue
private void expectflowsequence   throws ioexception
emitter writeindicator bytelist create    true true false
flowlevel
increaseindent true false
state   first_flow_sequence_item
private void expectblocksequence   throws ioexception
increaseindent false  mappingcontext     indentation
state   first_block_sequence_item
private void expectflowmapping   throws ioexception
emitter writeindicator bytelist create    true true false
flowlevel
increaseindent true false
state   first_flow_mapping_key
private void expectblockmapping   throws ioexception
increaseindent false false
state   first_block_mapping_key
private boolean checkemptysequence
return event instanceof sequencestartevent     events isempty      events get 0  instanceof sequenceendevent
private boolean checkemptymapping
return event instanceof mappingstartevent     events isempty      events get 0  instanceof mappingendevent
private boolean checkemptydocument
if   event instanceof documentstartevent     events isempty
return false
final event ev    event events get 0
return ev instanceof scalarevent      scalarevent ev  getanchor      null      scalarevent ev  gettag      null      scalarevent ev  getimplicit      null      scalarevent ev  getvalue   realsize    0
private boolean checksimplekey
int length   0
if event instanceof nodeevent    null      nodeevent event  getanchor
if null    preparedanchor
preparedanchor   prepareanchor   nodeevent event  getanchor
length    preparedanchor length
string tag   null
if event instanceof scalarevent
tag     scalarevent event  gettag
else if event instanceof collectionstartevent
tag     collectionstartevent event  gettag
if tag    null
if null    preparedtag
preparedtag   emitter preparetag tag
length    preparedtag length
if event instanceof scalarevent
if null    analysis
analysis   analyzescalar   scalarevent event  getvalue
length    analysis scalar length
return  length < 128     event instanceof aliasevent     event instanceof scalarevent     analysis multiline     checkemptysequence      checkemptymapping
private void processanchor final bytelist indicator  throws ioexception
final nodeevent ev    nodeevent event
if null    ev getanchor
preparedanchor   null
return
if null    preparedanchor
preparedanchor   prepareanchor ev getanchor
if preparedanchor    null       equals preparedanchor
indicator append preparedanchor getbytes
if ev instanceof collectionstartevent
indentation   true
emitter writeindicator indicator true false true
preparedanchor   null
private void processtag   throws ioexception
string tag   null
if event instanceof scalarevent
final scalarevent ev    scalarevent event
tag   ev gettag
if style    0
style   choosescalarstyle
if    canonical    tag    null       0    style    ev getimplicit        0    style    ev getimplicit
preparedtag   null
return
if ev getimplicit      null    tag
tag
preparedtag   null
else
final collectionstartevent ev    collectionstartevent event
tag   ev gettag
if   canonical    tag    null     ev getimplicit
preparedtag   null
return
indentation   true
if tag    null
throw new emitterexception
if null    preparedtag
preparedtag   emitter preparetag tag
if preparedtag    null       equals preparedtag
emitter writeindicator bytelist create preparedtag  true false true
preparedtag   null
private char choosescalarstyle
final scalarevent ev    scalarevent event
if null    analysis
analysis   analyzescalar ev getvalue
if ev getstyle      ' tag yaml org 2002 str"
return
//            if(ev.getstyle() == 0 && ev.getimplicit()[0]) {
if ev getstyle      0
if   simplekeycontext     analysis empty    analysis multiline        flowlevel    0    analysis allowflowplain      flowlevel    0    analysis allowblockplain
return 0
if ev getstyle      0    ev getimplicit         simplekeycontext     analysis empty    analysis multiline       flowlevel  0    analysis allowflowplain     flowlevel    0    analysis allowblockplain
return 0
if  ev getstyle           ev getstyle            flowlevel    0    analysis allowblock
return
if  ev getstyle      0    ev getstyle             analysis allowsinglequoted      simplekeycontext    analysis multiline
return
if analysis multiline     first_space matcher ev getvalue    find       analysis specialcharacters
return
return
private void processscalar   throws ioexception
final scalarevent ev    scalarevent event
if null    analysis
analysis   analyzescalar ev getvalue
if 0    style
style   choosescalarstyle
final boolean split    simplekeycontext
if style
emitter writedoublequoted analysis scalar split
else if style
emitter writesinglequoted analysis scalar split
else if style
emitter writefolded analysis scalar
else if style
emitter writeliteral analysis scalar
else
emitter writeplain analysis scalar split
analysis   null
style   0
void writestreamstart
void writestreamend   throws ioexception
flushstream
void writeindicator final bytelist indicator  final boolean needwhitespace  final boolean whitespace  final boolean indentation  throws ioexception
bytelist data   indicator
if   env whitespace     needwhitespace
data prepend  byte
env whitespace   whitespace
env indentation   env indentation    indentation
env column    data length
stream write data bytes 0 data realsize
void writeindent   throws ioexception
int indent   0
if env indent     1
indent   env indent
if  env indentation    env column > indent     env column    indent     env whitespace
writelinebreak null
if env column < indent
env whitespace   true
final bytelist data   new bytelist
for int i 0 j  indent env column  i<j i
data append  byte
env column   indent
stream write data bytes 0 data realsize
void writeversiondirective final string version_text  throws ioexception
stream write      version_text  getbytes
writelinebreak null
void writetagdirective final string handle  final string prefix  throws ioexception
stream write      handle       prefix  getbytes
writelinebreak null
void writedoublequoted final bytelist text  final boolean split  throws ioexception
writeindicator bytelist create  "  true false false
int start   0
int ending   0
bytelist data   null
while ending <  text length
char ch   0
if ending < text length
ch   text charat ending
if ch  0       " indexof ch      1        <  ch    ch <
if start < ending
data    bytelist text subsequence start ending
env column  data length
stream write data bytes 0 data realsize
start   ending
if ch    0
if yaml escape_replacements containskey new character ch
data   bytelist create     yaml escape_replacements get new character ch
else if ch <
string str   integer tostring ch 16
if str length      1
str       str
data   bytelist create     str
env column    data length
stream write data bytes 0 data realsize
start   ending 1
if  0 < ending    ending <  text length   1       ch         start >  ending      env column  ending start   > env bestwidth    split
if start < ending
data    bytelist text subsequence start ending
data append
data append
start   ending 1
else
data   bytelist create
env column    data length
stream write data bytes 0 data realsize
writeindent
env whitespace   false
env indentation   false
if start <  text length   1     text charat start
data   bytelist create
stream write data bytes 0 data realsize
ending    1
writeindicator bytelist create  "  false false false
void writesinglequoted final bytelist text  final boolean split  throws ioexception
writeindicator bytelist create    true false false
boolean spaces   false
boolean breaks   false
int start 0 ending 0
char ceh   0
bytelist data   null
while ending <  text length
ceh   0
if ending < text length
ceh   text charat ending
if spaces
if ceh    0    ceh    32
if start 1    ending    env column > env bestwidth    split    start    0    ending    text length
writeindent
else
data    bytelist text subsequence start ending
env column    data length
stream write data bytes 0 data realsize
start   ending
else if breaks
if ceh    0           ceh
data    bytelist text subsequence start ending
for int i 0 j data length   i<j i
char cha   data charat i
if      cha
writelinebreak null
else
writelinebreak bytelist create   cha
writeindent
start   ending
else
if ceh    0           ceh
if start < ending
data    bytelist text subsequence start ending
env column    data length
stream write data bytes 0 data realsize
start   ending
if ceh
data   bytelist create
env column    2
stream write data bytes 0 data realsize
start   ending   1
if ceh    0
spaces   ceh
breaks   ceh
ending
writeindicator bytelist create    false false false
void writefolded final bytelist text  throws ioexception
string chomp   determinechomp text
writeindicator bytelist create     chomp   true  false  false
writeindent
boolean leadingspace   false
boolean spaces   false
boolean breaks   false
int start 0 ending 0
bytelist data   null
while ending <  text length
char ceh   0
if ending < text length
ceh   text charat ending
if breaks
if ceh    0           ceh
if  leadingspace    ceh    0    ceh         text charat start
writelinebreak null
leadingspace   ceh
data    bytelist text subsequence start ending
for int i 0 j data length   i<j i
char cha   data charat i
if      cha
writelinebreak null
else
writelinebreak bytelist create   cha
if ceh    0
writeindent
start   ending
else if spaces
if ceh
if start 1    ending    env column > env bestwidth
writeindent
else
data    bytelist text subsequence start ending
env column    data length
stream write data bytes 0 data realsize
start   ending
else
if ceh    0         ceh         ceh
data    bytelist text subsequence start ending
stream write data bytes 0 data realsize
if ceh    0
writelinebreak null
start   ending
if ceh    0
breaks        ceh
spaces   ceh
ending
void writeliteral final bytelist text  throws ioexception
string chomp   determinechomp text
writeindicator bytelist create     chomp   true  false  false
writeindent
boolean breaks   false
int start 0 ending 0
bytelist data   null
while ending <  text length
char ceh   0
if ending < text length
ceh   text charat ending
if breaks
if ceh    0           ceh
data    bytelist text subsequence start ending
for int i 0 j data length   i<j i
char cha   data charat i
if      cha
writelinebreak null
else
writelinebreak bytelist create   cha
if ceh    0
writeindent
start   ending
else
if ceh    0         ceh
data    bytelist text subsequence start ending
stream write data bytes 0 data realsize
if ceh    0
writelinebreak null
start   ending
if ceh    0
breaks        ceh
ending
void writeplain final bytelist text  final boolean split  throws ioexception
if text    null    text realsize    0
return
bytelist data   null
if  env whitespace
env column    1
stream write 32      space
env whitespace   false
env indentation   false
boolean spaces false  breaks   false
int start 0 ending 0
while ending <  text length
char ceh   0
if ending < text length
ceh    char  text bytes   0xff
if spaces
if ceh
if start 1    ending    env column > env bestwidth    split
writeindent
env whitespace   false
env indentation   false
else
data   new bytelist text  start  ending start
env column    data length
stream write data bytes 0 data realsize
start   ending
else if breaks
if ceh
if  text bytes   0xff
writelinebreak null
data   new bytelist text  start  ending start
for int i 0 j data length   i<j i
char cha    char  data bytes 0xff
if      cha
writelinebreak null
else
writelinebreak bytelist create   cha
writeindent
env whitespace   false
env indentation   false
start   ending
else
if ceh    0         ceh         ceh
data   new bytelist text  start  ending start
env column    data length
stream write data bytes 0 data realsize
start   ending
if ceh    0
spaces   ceh
breaks   ceh
ending
void writelinebreak final bytelist data  throws ioexception
bytelist xdata   data
if xdata    null
xdata   env bestlinebreak
env whitespace   true
env indentation   true
env line
env column   0
stream write xdata bytes 0 xdata realsize
void flushstream   throws ioexception
stream flush
static string prepareversion final int version
if version    1
throw new emitterexception     version       version
return   version       version
private final static pattern handle_format   pattern compile
static string preparetaghandle final string handle
if handle    null      equals handle
throw new emitterexception
else if handle charat 0          handle charat handle length   1
throw new emitterexception     handle
else if    equals handle      handle_format matcher handle  matches
throw new emitterexception     handle
return handle
static string preparetagprefix final string prefix
if prefix    null      equals prefix
throw new emitterexception
final stringbuffer chunks   new stringbuffer
int start 0 ending 0
if prefix charat 0
ending   1
while ending < prefix length
ending
if start < ending
chunks append prefix substring start ending
return chunks tostring
private final static pattern anchor_format   pattern compile
static string prepareanchor final string anchor
if anchor    null      equals anchor
throw new emitterexception
if  anchor_format matcher anchor  matches
throw new emitterexception     anchor
return anchor
string preparetag final string tag
if tag    null      equals tag
throw new emitterexception
if tag equals
return tag
string handle   null
string suffix   tag
for final iterator iter   env tagprefixes keyset   iterator   iter hasnext
string prefix    string iter next
if pattern matches     prefix      tag      prefix equals       prefix length   < tag length
handle    string env tagprefixes get prefix
suffix   tag substring prefix length
if handle    null
if tag startswith       tag indexof    4      1
int doti   tag indexof   4
string first   tag substring 4 doti
string rest   tag substring tag indexof    4  1
handle       first
suffix   rest
final stringbuffer chunks   new stringbuffer
int start 0 ending 0
while ending < suffix length
ending
if start < ending
chunks append suffix substring start ending
string suffixtext   chunks tostring
if tag charat 0          env isversion10
return tag
if handle    null
return handle   suffixtext
else
return     suffixtext
private final static pattern doc_indic   pattern compile
private final static pattern first_space   pattern compile
private final static string null_bl_t_linebr
private final static string special_indic    %@`"
private final static string flow_indic
static scalaranalysis analyzescalar final bytelist scalar
if scalar    null    scalar realsize    0
return new scalaranalysis scalar true false false true true true false false
boolean blockindicators   false
boolean flowindicators   false
boolean linebreaks   false
boolean specialcharacters   false
// whitespaces.
boolean inlinespaces   false              non space space  non space
boolean inlinebreaks   false              non space break  non space
boolean leadingspaces   false             ^ space   non space   $
boolean leadingbreaks   false             ^ break   non space   $
boolean trailingspaces   false             ^   non space  space  $
boolean trailingbreaks   false             ^   non space  break  $
boolean inlinebreaksspaces   false       non space break  space  non space
boolean mixedbreaksspaces   false        anything else
if doc_indic matcher scalar  matches
blockindicators   true
flowindicators   true
boolean preceededbyspace   true
boolean followedbyspace   scalar length      1    null_bl_t_linebr indexof scalar charat 1       1
boolean spaces   false
boolean breaks   false
boolean mixed   false
boolean leading   false
int index   0
while index < scalar length
char ceh   scalar charat index
if index    0
if special_indic indexof ceh      1
flowindicators   true
blockindicators   true
if ceh         ceh
flowindicators   true
if followedbyspace
blockindicators   true
if ceh         followedbyspace
flowindicators   true
blockindicators   true
else
if flow_indic indexof ceh      1
flowindicators   true
if ceh
flowindicators   true
if followedbyspace
blockindicators   true
if ceh         preceededbyspace
flowindicators   true
blockindicators   true
if ceh
linebreaks   true
if   ceh            <  ceh    ceh <
specialcharacters   true
if      ceh         ceh
if spaces    breaks
if ceh
mixed   true
else if spaces
if ceh
breaks   true
mixed   true
else if breaks
if ceh
spaces   true
else
leading    index    0
if ceh
spaces   true
else
breaks   true
else if spaces    breaks
if leading
if spaces    breaks
mixedbreaksspaces   true
else if spaces
leadingspaces   true
else if breaks
leadingbreaks   true
else
if mixed
mixedbreaksspaces   true
else if spaces    breaks
inlinebreaksspaces   true
else if spaces
inlinespaces   true
else if breaks
inlinebreaks   true
spaces   breaks   mixed   leading   false
if  spaces    breaks      index    scalar length   1
if spaces    breaks
mixedbreaksspaces   true
else if spaces
trailingspaces   true
if leading
leadingspaces   true
else if breaks
trailingbreaks   true
if leading
leadingbreaks   true
spaces   breaks   mixed   leading   false
index
preceededbyspace   null_bl_t_linebr indexof ceh      1
followedbyspace   index 1 >  scalar length      null_bl_t_linebr indexof scalar charat index 1       1
boolean allowflowplain   true
boolean allowblockplain   true
boolean allowsinglequoted   true
boolean allowdoublequoted   true
boolean allowblock   true
if leadingspaces    leadingbreaks    trailingspaces
allowflowplain   allowblockplain   allowblock   allowsinglequoted   false
if trailingbreaks
allowflowplain   allowblockplain   false
if inlinebreaksspaces
allowflowplain   allowblockplain   allowsinglequoted   false
if mixedbreaksspaces    specialcharacters
allowflowplain   allowblockplain   allowsinglequoted   allowblock   false
if inlinebreaks
allowflowplain   allowblockplain   allowsinglequoted   false
if trailingbreaks
allowsinglequoted   false
if linebreaks
allowflowplain   allowblockplain   false
if flowindicators
allowflowplain   false
if blockindicators
allowblockplain   false
return new scalaranalysis scalar false linebreaks allowflowplain allowblockplain allowsinglequoted allowdoublequoted allowblock specialcharacters
static string determinechomp final bytelist text
char ceh
char ceh2
if text realsize > 0
ceh    char  text bytes   0xff
if text realsize > 1
ceh2    char  text bytes   0xff
return  ceh       ?   ceh2       ?
public static void main final string args  throws ioexception
final string filename   args     filename to test against
system out println
final bufferedinputstream read   new bufferedinputstream new fileinputstream filename
int last    1
while  last   read read        1
system out print  char last
read close
system out println
final emitter emitter   new emitterimpl system out yaml config
final parser pars   new parserimpl new scannerimpl new fileinputstream filename
for final iterator iter   pars eachevent   iter hasnext
emitter emit  event iter next
emitterimpl