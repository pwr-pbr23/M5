/***** begin license block *****
* version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public
* license version 1.0 (the "license"); you may not use this file
* except in compliance with the license. you may obtain a copy of
* the license at http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as
* is" basis, without warranty of any kind, either express or
* implied. see the license for the specific language governing
* rights and limitations under the license.
*
* copyright (c) 2002-2004 anders bengtsson <ndrsbngtssn@yahoo.se>
* copyright (c) 2002-2004 jan arne petersen <jpetersen@uni-bonn.de>
* copyright (c) 2004 thomas e enebo <enebo@acm.org>
* copyright (c) 2004 stefan matthias aust <sma@3plus4.de>
* copyright (c) 2007 ola bini <ola@ologix.com>
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"),
* or the gnu lesser general public license version 2.1 or later (the "lgpl"),
* in which case the provisions of the gpl or the lgpl are applicable instead
* of those above. if you wish to allow use of your version of this file only
* under the terms of either the gpl or the lgpl, and not to allow others to
* use your version of this file under the terms of the cpl, indicate your
* decision by deleting the provisions above and replace them with the notice
* and other provisions required by the gpl or the lgpl. if you do not delete
* the provisions above, a recipient may use your version of this file under
* the terms of any one of the cpl, the gpl or the lgpl.
***** end license block *****/
package org jruby
import org jruby anno jrubymethod
import org jruby runtime block
import org jruby runtime threadcontext
import org jruby runtime builtin irubyobject
public class rubyargsfile
private static final class argsfiledata
private ruby runtime
public argsfiledata ruby runtime
this runtime   runtime
public irubyobject currentfile
public int currentlinenumber
public boolean startedprocessing   false
public boolean finishedprocessing   false
public boolean nextargsfile threadcontext context
if  finishedprocessing
return false
rubyarray args    rubyarray runtime getglobalvariables   get
if  args getlength      0
if   startedprocessing
currentfile   runtime getglobalvariables   get
rubystring  runtime getglobalvariables   get     setvalue new stringbuffer
currentlinenumber   0
startedprocessing   true
return true
else
finishedprocessing   true
return false
string filename   args shift   tostring
rubystring  runtime getglobalvariables   get     setvalue new stringbuffer filename
if  filename equals
currentfile   runtime getglobalvariables   get
else
currentfile   rubyfile open context  runtime getfile    new irubyobject  runtime newstring filename    block null_block
startedprocessing   true
return true
public static argsfiledata getdatafrom irubyobject recv
argsfiledata data    argsfiledata recv datagetstruct
if data    null
data   new argsfiledata recv getruntime
recv datawrapstruct data
return data
public static void setcurrentlinenumber irubyobject recv  int newlinenumber
argsfiledata getdatafrom recv  currentlinenumber   newlinenumber
public static void initargsfile ruby runtime
rubyobject argsfile   new rubyobject runtime  runtime getobject
runtime getenumerable   extend_object argsfile
runtime definereadonlyvariable    argsfile
runtime defineglobalconstant    argsfile
rubyclass argfclass   argsfile getmetaclass
argfclass defineannotatedmethods rubyargsfile class
runtime definereadonlyvariable    runtime newstring
@jrubymethod name
public static irubyobject fileno threadcontext context  irubyobject recv
argsfiledata data   argsfiledata getdatafrom recv
if  data startedprocessing     data nextargsfile context
throw recv getruntime   newargumenterror
return   rubyio data currentfile  fileno
@jrubymethod name
public static irubyobject to_io threadcontext context  irubyobject recv
argsfiledata data   argsfiledata getdatafrom recv
if  data startedprocessing     data nextargsfile context
throw recv getruntime   newargumenterror
return data currentfile
public static irubyobject internalgets threadcontext context  irubyobject recv  irubyobject args
argsfiledata data   argsfiledata getdatafrom recv
if data currentfile    null     data nextargsfile context
return recv getruntime   getnil
irubyobject line   data currentfile callmethod context     args
while  line instanceof rubynil
data currentfile callmethod context
if   data nextargsfile context
data currentfile   null
return line
line   data currentfile callmethod context     args
data currentlinenumber
recv getruntime   getglobalvariables   set    recv getruntime   newfixnum data currentlinenumber
return line
// argf methods
/** read a line.
*
*/
@jrubymethod name      optional   1  frame   true
public static irubyobject gets threadcontext context  irubyobject recv  irubyobject args
irubyobject result   internalgets context  recv  args
if   result isnil
context getcurrentframe   setlastline result
return result
/** read a line.
*
*/
@jrubymethod name      optional   1  frame   true
public static irubyobject readline threadcontext context  irubyobject recv  irubyobject args
irubyobject line   gets context  recv  args
if  line isnil
throw recv getruntime   neweoferror
return line
@jrubymethod name      optional   1  frame   true
public static rubyarray readlines threadcontext context  irubyobject recv  irubyobject args
irubyobject separatorargument
if  args length > 0
if   recv getruntime   getnilclass   isinstance args
recv getruntime   getstring   isinstance args
throw recv getruntime   newtypeerror args
recv getruntime   getstring
separatorargument   new irubyobject   args
else
separatorargument   irubyobject null_array
rubyarray result   recv getruntime   newarray
irubyobject line
while     line   internalgets context  recv  separatorargument   isnil
result append line
return result
@jrubymethod name      frame   true
public static irubyobject each_byte threadcontext context  irubyobject recv  block block
irubyobject bt
while   bt   getc context  recv   isnil
block yield context  bt
return recv
/** invoke a block for each line.
*
*/
@jrubymethod name      alias        optional   1  frame   true
public static irubyobject each_line threadcontext context  irubyobject recv  irubyobject args  block block
irubyobject nextline   internalgets context  recv  args
while   nextline isnil
block yield context  nextline
nextline   internalgets context  recv  args
return recv
@jrubymethod name
public static irubyobject file threadcontext context  irubyobject recv
argsfiledata data   argsfiledata getdatafrom recv
if data currentfile    null     data nextargsfile context
return recv getruntime   getnil
return data currentfile
@jrubymethod name
public static irubyobject skip irubyobject recv
argsfiledata data   argsfiledata getdatafrom recv
data currentfile   null
return recv
@jrubymethod name
public static irubyobject close threadcontext context  irubyobject recv
argsfiledata data   argsfiledata getdatafrom recv
if data currentfile    null     data nextargsfile context
return recv
data currentfile   null
data currentlinenumber   0
return recv
@jrubymethod name
public static irubyobject closed_p threadcontext context  irubyobject recv
argsfiledata data   argsfiledata getdatafrom recv
if data currentfile    null     data nextargsfile context
return recv
return   rubyio data currentfile  closed_p
@jrubymethod name
public static irubyobject binmode threadcontext context  irubyobject recv
argsfiledata data   argsfiledata getdatafrom recv
if data currentfile    null     data nextargsfile context
throw recv getruntime   newargumenterror
return   rubyio data currentfile  binmode
@jrubymethod name
public static irubyobject lineno irubyobject recv
return recv getruntime   newfixnum argsfiledata getdatafrom recv  currentlinenumber
@jrubymethod name      alias
public static irubyobject tell threadcontext context  irubyobject recv
argsfiledata data   argsfiledata getdatafrom recv
if data currentfile    null     data nextargsfile context
throw recv getruntime   newargumenterror
return   rubyio data currentfile  pos
@jrubymethod name
public static irubyobject rewind threadcontext context  irubyobject recv
argsfiledata data   argsfiledata getdatafrom recv
if data currentfile    null     data nextargsfile context
throw recv getruntime   newargumenterror
return   rubyio data currentfile  rewind
@jrubymethod name
public static irubyobject eof threadcontext context  irubyobject recv
argsfiledata data   argsfiledata getdatafrom recv
if data currentfile    null     data nextargsfile context
return recv getruntime   gettrue
return   rubyio data currentfile  eof_p
@jrubymethod name      required   1
public static irubyobject set_pos threadcontext context  irubyobject recv  irubyobject offset
argsfiledata data   argsfiledata getdatafrom recv
if data currentfile    null     data nextargsfile context
throw recv getruntime   newargumenterror
return   rubyio data currentfile  pos_set offset
@jrubymethod name      required   1  optional   1
public static irubyobject seek threadcontext context  irubyobject recv  irubyobject args
argsfiledata data   argsfiledata getdatafrom recv
if data currentfile    null     data nextargsfile context
throw recv getruntime   newargumenterror
return   rubyio data currentfile  seek args
@jrubymethod name      required   1
public static irubyobject set_lineno irubyobject recv  irubyobject line
argsfiledata data   argsfiledata getdatafrom recv
data currentlinenumber   rubynumeric fix2int line
return recv getruntime   getnil
@jrubymethod name
public static irubyobject readchar threadcontext context  irubyobject recv
irubyobject c   getc context  recv
if c isnil
throw recv getruntime   neweoferror
return c
@jrubymethod name
public static irubyobject getc threadcontext context  irubyobject recv
argsfiledata data   argsfiledata getdatafrom recv
irubyobject bt
while true
if data currentfile    null     data nextargsfile context
return recv getruntime   getnil
if   data currentfile instanceof rubyfile
bt   data currentfile callmethod context
else
bt     rubyio data currentfile  getc
if bt isnil
data currentfile   null
continue
return bt
@jrubymethod name      optional   2
public static irubyobject read threadcontext context  irubyobject recv  irubyobject args
argsfiledata data   argsfiledata getdatafrom recv
irubyobject tmp  str  length
long len   0
if args length > 0
length   args
if args length > 1
str   args
else
str   recv getruntime   getnil
else
length   recv getruntime   getnil
str   recv getruntime   getnil
if  length isnil
len   rubynumeric num2long length
if  str isnil
str   str converttostring
rubystring str  modify
rubystring str  getbytelist   length 0
args   recv getruntime   getnil
while true
if data currentfile    null     data nextargsfile context
return str
if   data currentfile instanceof rubyio
tmp   data currentfile callmethod context     args
else
tmp     rubyio data currentfile  read args
if str isnil
str   tmp
else if  tmp isnil
rubystring str  append tmp
if tmp isnil      length isnil
data currentfile   null
continue
else if args length >  1
if   rubystring str  getbytelist   length   < len
len      rubystring str  getbytelist   length
args   recv getruntime   newfixnum len
continue
return str
@jrubymethod name      alias
public static rubystring filename irubyobject recv
return  rubystring recv getruntime   getglobalvariables   get
@jrubymethod name
public static irubyobject to_s irubyobject recv
return recv getruntime   newstring