/***** begin license block *****
* version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public
* license version 1.0 (the "license"); you may not use this file
* except in compliance with the license. you may obtain a copy of
* the license at http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as
* is" basis, without warranty of any kind, either express or
* implied. see the license for the specific language governing
* rights and limitations under the license.
*
* copyright (c) 2007 ola bini <ola.bini@gmail.com>
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"),
* or the gnu lesser general public license version 2.1 or later (the "lgpl"),
* in which case the provisions of the gpl or the lgpl are applicable instead
* of those above. if you wish to allow use of your version of this file only
* under the terms of either the gpl or the lgpl, and not to allow others to
* use your version of this file under the terms of the cpl, indicate your
* decision by deleting the provisions above and replace them with the notice
* and other provisions required by the gpl or the lgpl. if you do not delete
* the provisions above, a recipient may use your version of this file under
* the terms of any one of the cpl, the gpl or the lgpl.
***** end license block *****/
package org jruby ast executable
import java io inputstream
import java io reader
import java io ioexception
import java util map
import java util hashmap
import org jruby ruby
import org jruby rubyarray
import org jruby parser staticscope
import org jruby parser localstaticscope
import org jruby runtime dynamicscope
import org jruby runtime threadcontext
import org jruby runtime builtin irubyobject
import org jruby lexer yacc simplesourceposition
/**
* @author <a href="mailto:ola.bini@ki.se">ola bini</a>
*/
public class rubiniusrunner implements runnable
private ruby runtime
public final static int rubinius_bytecode_version   3
public rubiniusrunner ruby runtime  inputstream in  string filename
try
this runtime   runtime
readmagic in
readversion in
readrest in
in close
catch ioexception e
throw new runtimeexception     e
private final void readmagic inputstream in  throws ioexception
byte first   new byte
in read first
if first         first         first         first
throw new runtimeexception
private final void readversion inputstream in  throws ioexception
int version   readint in
if version    rubinius_bytecode_version
throw new runtimeexception     version
public static int readint inputstream in  throws ioexception
byte theint   new byte
in read theint
int val   0
val     theint<<24
val     theint<<16
val     theint<<8
val     theint
return val
private map methods   new hashmap
private final void readrest inputstream in  throws ioexception
rubiniuscmethod obj   null
while  obj   unmarshalcmethod in      null
methods put obj name  obj
private final byte unmarshalchararray inputstream in  throws ioexception
int length   readint in
byte arr   new byte
in read arr
return arr
private final string unmarshalstring inputstream in  throws ioexception
int length   readint in
byte arr   new byte
in read arr
return string valueof arr
private final int unmarshalint inputstream in  throws ioexception
int neg   in read
int val   readint in
if neg
val    val
return val
private final irubyobject unmarshaltuple inputstream in  throws ioexception
int length   readint in
irubyobject vals   new irubyobject
for int i 0 i<length i
vals   unmarshal in
return vals
private final rubiniuscmethod unmarshalcmethod inputstream in  throws ioexception
rubyarray obj    rubyarray unmarshal in
if obj    null
return null
return new rubiniuscmethod obj
private final irubyobject unmarshal inputstream in   throws ioexception
int tag   in read
int len    1
byte data
switch tag
case    return runtime newfixnum unmarshalint in
case    return runtime newstring unmarshalstring in
case    return runtime newsymbol unmarshalstring in
case    return runtime newarray unmarshaltuple in
case    return runtime newstring unmarshalstring in
case    return runtime newarray unmarshaltuple in
case    system err println     return null
case    system err println     return null
case    system err println     return null
case    return runtime getnil
case    return runtime gettrue
case    return runtime getfalse
return null
public void run
rubiniuscmethod method    rubiniuscmethod methods get
threadcontext context   runtime getcurrentcontext
staticscope scope   new localstaticscope null
if  scope getmodule      null
scope setmodule runtime getobject
scope setvariables new string
context setfile method file
context setline  1
context prescopedbody dynamicscope newdynamicscope scope null
rubiniusmachine instance exec context  runtime getobject    method code  method literals  new irubyobject
rubiniusrunner