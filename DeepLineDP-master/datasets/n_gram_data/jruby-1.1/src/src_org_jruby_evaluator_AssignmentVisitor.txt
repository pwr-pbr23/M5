/*
***** begin license block *****
* version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public
* license version 1.0 (the "license"); you may not use this file
* except in compliance with the license. you may obtain a copy of
* the license at http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as
* is" basis, without warranty of any kind, either express or
* implied. see the license for the specific language governing
* rights and limitations under the license.
*
* copyright (c) 2002-2004 anders bengtsson <ndrsbngtssn@yahoo.se>
* copyright (c) 2002-2004 jan arne petersen <jpetersen@uni-bonn.de>
* copyright (c) 2003-2004 thomas e enebo <enebo@acm.org>
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"),
* or the gnu lesser general public license version 2.1 or later (the "lgpl"),
* in which case the provisions of the gpl or the lgpl are applicable instead
* of those above. if you wish to allow use of your version of this file only
* under the terms of either the gpl or the lgpl, and not to allow others to
* use your version of this file under the terms of the cpl, indicate your
* decision by deleting the provisions above and replace them with the notice
* and other provisions required by the gpl or the lgpl. if you do not delete
* the provisions above, a recipient may use your version of this file under
* the terms of any one of the cpl, the gpl or the lgpl.
***** end license block *****/
package org jruby evaluator
import org jruby ruby
import org jruby rubyarray
import org jruby rubymodule
import org jruby ast attrassignnode
import org jruby ast callnode
import org jruby ast classvarasgnnode
import org jruby ast classvardeclnode
import org jruby ast colon2node
import org jruby ast constdeclnode
import org jruby ast dasgnnode
import org jruby ast globalasgnnode
import org jruby ast instasgnnode
import org jruby ast localasgnnode
import org jruby ast multipleasgnnode
import org jruby ast node
import org jruby ast nodetype
import org jruby ast util argsutil
import org jruby common irubywarnings id
import org jruby javasupport util runtimehelpers
import org jruby runtime block
import org jruby runtime calltype
import org jruby runtime threadcontext
import org jruby runtime builtin irubyobject
/**
*
* @author jpetersen
*/
public class assignmentvisitor
public static irubyobject assign ruby runtime  threadcontext context  irubyobject self  node node  irubyobject value  block block  boolean checkarity
irubyobject result   null
switch  node nodeid
case attrassignnode
attrassignnode runtime  context  self  node  value  block
break
case callnode
callnode runtime  context  self  node  value  block
break
case classvarasgnnode
classvarasgnnode context  node  value
break
case classvardeclnode
classvardeclnode runtime  context  node  value
break
case constdeclnode
constdeclnode runtime  context  self  node  value  block
break
case dasgnnode
dasgnnode context  node  value
break
case globalasgnnode
globalasgnnode runtime  node  value
break
case instasgnnode
instasgnnode self  node  value
break
case localasgnnode
localasgnnode context  node  value
break
case multipleasgnnode
result   multipleasgnnode runtime  context  self  node  value  checkarity
break
default
throw new runtimeexception
return result
private static void attrassignnode ruby runtime  threadcontext context  irubyobject self  node node  irubyobject value  block block
attrassignnode ivisited    attrassignnode  node
irubyobject receiver   astinterpreter eval runtime  context  ivisited getreceivernode    self  block
// if reciever is self then we do the call the same way as vcall
calltype calltype    receiver    self ? calltype variable   calltype normal
if  ivisited getargsnode      null       attribute set
runtimehelpers invoke context  receiver  ivisited getname    new irubyobject  value   calltype  block null_block
else      element set
rubyarray args    rubyarray astinterpreter eval runtime  context  ivisited getargsnode    self  block
args append value
runtimehelpers invoke context  receiver  ivisited getname    args tojavaarray    calltype  block null_block
private static void callnode ruby runtime  threadcontext context  irubyobject self  node node  irubyobject value  block block
callnode ivisited    callnode node
irubyobject receiver   astinterpreter eval runtime  context  ivisited getreceivernode    self  block
if  ivisited getargsnode      null       attribute set
runtimehelpers invoke context  receiver  ivisited getname    new irubyobject  value   calltype normal  block null_block
else      element set
rubyarray args    rubyarray astinterpreter eval runtime  context  ivisited getargsnode    self  block
args append value
runtimehelpers invoke context  receiver  ivisited getname    args tojavaarray    calltype normal  block null_block
private static void classvarasgnnode threadcontext context  node node  irubyobject value
classvarasgnnode ivisited    classvarasgnnode node
rubymodule rubyclass   astinterpreter getclassvariablebase context  context getruntime
rubyclass fastsetclassvar ivisited getname    value
private static void classvardeclnode ruby runtime  threadcontext context  node node  irubyobject value
classvardeclnode ivisited    classvardeclnode node
if  runtime getverbose   istrue
context getrubyclass   issingleton
runtime getwarnings   warn id declaring_sclass_variable  ivisited getposition
rubymodule rubyclass   astinterpreter getclassvariablebase context  context getruntime
rubyclass fastsetclassvar ivisited getname    value
private static void constdeclnode ruby runtime  threadcontext context  irubyobject self  node node  irubyobject value  block block
constdeclnode ivisited    constdeclnode node
node constnode   ivisited getconstnode
irubyobject module
if  constnode    null
module   context getcurrentscope   getstaticscope   getmodule
if  module    null
// todo: wire into new exception handling mechanism
throw runtime newtypeerror
else if  constnode instanceof colon2node
module   astinterpreter eval runtime  context    colon2node  ivisited getconstnode    getleftnode    self  block
else      colon3
module   runtime getobject
rubymodule  module  fastsetconstant ivisited getname    value
private static void dasgnnode threadcontext context  node node  irubyobject value
dasgnnode ivisited    dasgnnode node
context getcurrentscope   setvalue ivisited getindex    value  ivisited getdepth
private static void globalasgnnode ruby runtime  node node  irubyobject value
globalasgnnode ivisited    globalasgnnode node
runtime getglobalvariables   set ivisited getname    value
private static void instasgnnode irubyobject self  node node  irubyobject value
instasgnnode ivisited    instasgnnode node
self getinstancevariables   fastsetinstancevariable ivisited getname    value
private static void localasgnnode threadcontext context  node node  irubyobject value
localasgnnode ivisited    localasgnnode node
context getcurrentscope   setvalue ivisited getindex    value  ivisited getdepth
public static irubyobject multiassign ruby runtime  threadcontext context  irubyobject self  multipleasgnnode node  rubyarray value  boolean checkarity
// assign the values.
int valuelen   value getlength
int varlen   node getheadnode      null ? 0   node getheadnode   size
int j   0
for    j < valuelen    j < varlen  j
node lnode   node getheadnode   get j
assign runtime  context  self  lnode  value eltinternal j   block null_block  checkarity
if  checkarity    j < varlen
throw runtime newargumenterror     valuelen       varlen
node argsnode   node getargsnode
if  argsnode    null
if  argsnode nodeid    nodetype starnode
// no check for '*'
else if  varlen < valuelen
assign runtime  context  self  argsnode  value subseqlight varlen  valuelen   block null_block  checkarity
else
assign runtime  context  self  argsnode  rubyarray newarraylight runtime  0   block null_block  checkarity
else if  checkarity    valuelen < varlen
throw runtime newargumenterror     valuelen       varlen
while  j < varlen
assign runtime  context  self  node getheadnode   get j     runtime getnil    block null_block  checkarity
return value
private static irubyobject multipleasgnnode ruby runtime  threadcontext context  irubyobject self  node node  irubyobject value  boolean check
irubyobject result
multipleasgnnode ivisited    multipleasgnnode node
if    value instanceof rubyarray
value   argsutil converttorubyarray runtime  value  ivisited getheadnode      null
result   multiassign runtime  context  self  ivisited   rubyarray  value  check
return result