/***** begin license block *****
* version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public
* license version 1.0 (the "license"); you may not use this file
* except in compliance with the license. you may obtain a copy of
* the license at http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as
* is" basis, without warranty of any kind, either express or
* implied. see the license for the specific language governing
* rights and limitations under the license.
*
* copyright (c) 2007 ola bini <ola@ologix.com>
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"),
* or the gnu lesser general public license version 2.1 or later (the "lgpl"),
* in which case the provisions of the gpl or the lgpl are applicable instead
* of those above. if you wish to allow use of your version of this file only
* under the terms of either the gpl or the lgpl, and not to allow others to
* use your version of this file under the terms of the cpl, indicate your
* decision by deleting the provisions above and replace them with the notice
* and other provisions required by the gpl or the lgpl. if you do not delete
* the provisions above, a recipient may use your version of this file under
* the terms of any one of the cpl, the gpl or the lgpl.
***** end license block *****/
package org jvyamlb
import java io fileinputstream
import java io inputstream
import java util hashmap
import java util hashset
import java util iterator
import java util list
import java util map
import java util set
import java util regex matcher
import java util regex pattern
import org jvyamlb nodes node
import org jvyamlb util base64coder
import org jruby util bytelist
import org joda time datetime
import org joda time datetimezone
/**
* @author <a href="mailto:ola.bini@ki.se">ola bini</a>
*/
public class safeconstructorimpl extends baseconstructorimpl
private final static map yamlconstructors   new hashmap
private final static map yamlmulticonstructors   new hashmap
private final static map yamlmultiregexps   new hashmap
public yamlconstructor getyamlconstructor final object key
yamlconstructor mine    yamlconstructor yamlconstructors get key
if mine    null
mine   super getyamlconstructor key
return mine
public yamlmulticonstructor getyamlmulticonstructor final object key
yamlmulticonstructor mine    yamlmulticonstructor yamlmulticonstructors get key
if mine    null
mine   super getyamlmulticonstructor key
return mine
public pattern getyamlmultiregexp final object key
pattern mine    pattern yamlmultiregexps get key
if mine    null
mine   super getyamlmultiregexp key
return mine
public set getyamlmultiregexps
final set all   new hashset super getyamlmultiregexps
all addall yamlmultiregexps keyset
return all
public static void addconstructor final string tag  final yamlconstructor ctor
yamlconstructors put tag ctor
public static void addmulticonstructor final string tagprefix  final yamlmulticonstructor ctor
yamlmulticonstructors put tagprefix ctor
yamlmultiregexps put tagprefix pattern compile   tagprefix
public safeconstructorimpl final composer composer
super composer
private static bytelist into string v
return new bytelist v getbytes   false
private final static map bool_values   new hashmap
static
bool_values put into    boolean true
bool_values put into    boolean true
bool_values put into    boolean true
bool_values put into    boolean false
bool_values put into    boolean false
bool_values put into    boolean false
bool_values put into    boolean true
bool_values put into    boolean true
bool_values put into    boolean true
bool_values put into    boolean false
bool_values put into    boolean false
bool_values put into    boolean false
bool_values put into    boolean true
bool_values put into    boolean true
bool_values put into    boolean true
bool_values put into    boolean false
bool_values put into    boolean false
bool_values put into    boolean false
public static object constructyamlnull final constructor ctor  final node node
return null
public static object constructyamlbool final constructor ctor  final node node
final object val   ctor constructscalar node
return bool_values get val
public static object constructyamlomap final constructor ctor  final node node
return ctor constructpairs node
public static object constructyamlpairs final constructor ctor  final node node
return constructyamlomap ctor node
public static object constructyamlset final constructor ctor  final node node
return   map ctor constructmapping node   keyset
public static object constructyamlstr final constructor ctor  final node node
final bytelist value    bytelist ctor constructscalar node
return value length      0 ?  bytelist null   value
public static object constructyamlseq final constructor ctor  final node node
return ctor constructsequence node
public static object constructyamlmap final constructor ctor  final node node
return ctor constructmapping node
public static object constructundefined final constructor ctor  final node node
throw new constructorexception null     node gettag   null
private final static pattern timestamp_regexp   pattern compile
public final static pattern ymd_regexp   pattern compile
public static object constructyamltimestamp final constructor ctor  final node node
matcher match   ymd_regexp matcher node getvalue   tostring
if match matches
final string year_s   match group 1
final string month_s   match group 2
final string day_s   match group 3
datetime dt   new datetime 0 1 1 0 0 0 0
if year_s    null
dt   dt withyear integer parseint year_s
if month_s    null
dt   dt withmonthofyear integer parseint month_s
if day_s    null
dt   dt withdayofmonth integer parseint day_s
return new object dt
match   timestamp_regexp matcher node getvalue   tostring
if  match matches
return new object ctor constructprivatetype node
final string year_s   match group 1
final string month_s   match group 2
final string day_s   match group 3
final string hour_s   match group 4
final string min_s   match group 5
final string sec_s   match group 6
final string fract_s   match group 7
final string utc   match group 8
final string timezoneh_s   match group 9
final string timezonem_s   match group 10
int usec   0
if fract_s    null
usec   integer parseint fract_s
if usec    0
while 10 usec < 1000
usec    10
datetime dt   new datetime 0 1 1 0 0 0 0
if   equalsignorecase utc
dt   dt withzone datetimezone forid
else
if timezoneh_s    null    timezonem_s    null
int zone   0
int sign    1
if timezoneh_s    null
if timezoneh_s startswith
sign    1
zone    integer parseint timezoneh_s substring 1   3600000
if timezonem_s    null
zone    integer parseint timezonem_s  60000
dt   dt withzone datetimezone foroffsetmillis sign zone
if year_s    null
dt   dt withyear integer parseint year_s
if month_s    null
dt   dt withmonthofyear integer parseint month_s
if day_s    null
dt   dt withdayofmonth integer parseint day_s
if hour_s    null
dt   dt withhourofday integer parseint hour_s
if min_s    null
dt   dt withminuteofhour integer parseint min_s
if sec_s    null
dt   dt withsecondofminute integer parseint sec_s
dt   dt withmillisofsecond usec 1000
return new object dt  new integer usec%1000
public static object constructyamlint final constructor ctor  final node node
string value   ctor constructscalar node  tostring   replaceall      replaceall
int sign    1
char first   value charat 0
if first
sign    1
value   value substring 1
else if first
value   value substring 1
int base   10
if value equals
return new long 0
else if value startswith
value   value substring 2
base   2
else if value startswith
value   value substring 2
base   16
else if value startswith
value   value substring 1
base   8
else if value indexof        1
final string digits   value split
int bes   1
int val   0
for int i 0 j digits length i<j i
val     long parselong digits  bes
bes    60
return new integer sign val
else
try
return new long sign   long parselong value
catch exception e
if sign < 0
return new java math biginteger value  negate
else
return new java math biginteger value
try
return new long sign   long parselong value base
catch exception e
if sign < 0
return new java math biginteger value base  negate
else
return new java math biginteger value base
private final static double inf_value_pos   new double double positive_infinity
private final static double inf_value_neg   new double double negative_infinity
private final static double nan_value   new double double nan
public static object constructyamlfloat final constructor ctor  final node node
string value   ctor constructscalar node  tostring   replaceall      replaceall
int sign    1
char first   value charat 0
if first
sign    1
value   value substring 1
else if first
value   value substring 1
final string vallower   value tolowercase
if vallower equals
return sign     1 ? inf_value_neg   inf_value_pos
else if vallower equals
return nan_value
else if value indexof        1
final string digits   value split
int bes   1
double val   0 0
for int i 0 j digits length i<j i
val     double parsedouble digits  bes
bes    60
return new double sign val
else
return new double sign double parsedouble value
public static object constructyamlbinary final constructor ctor  final node node
final string values   ctor constructscalar node  tostring   split
final stringbuffer vals   new stringbuffer
for int i 0 j values length i<j i
vals append values trim
return base64coder decode bytelist plain vals
public static object constructspecializedsequence final constructor ctor  final string pref  final node node
list outp   null
try
final class seqclass   class forname pref
outp    list seqclass newinstance
catch final exception e
throw new yamlexception     pref       e tostring
outp addall  list ctor constructsequence node
return outp
public static object constructspecializedmap final constructor ctor  final string pref  final node node
map outp   null
try
final class mapclass   class forname pref
outp    map mapclass newinstance
catch final exception e
throw new yamlexception     pref       e tostring
outp putall  map ctor constructmapping node
return outp
private static object fixvalue final object inp  final class outp
if inp    null
return null
final class inclass   inp getclass
if outp isassignablefrom inclass
return inp
if inclass    long class     outp    integer class    outp    integer type
return new integer   long inp  intvalue
if inclass    long class     outp    short class    outp    short type
return new short  short   long inp  intvalue
if inclass    long class     outp    character class    outp    character type
return new character  char   long inp  intvalue
if inclass    double class     outp    float class    outp    float type
return new float   double inp  floatvalue
return inp
public static object constructjava final constructor ctor  final string pref  final node node
object outp   null
try
final class cl   class forname pref
outp   cl newinstance
final map values    map ctor constructmapping node
java lang reflect method ems   cl getmethods
for final iterator iter   values keyset   iterator   iter hasnext
final object key   iter next
final object value   values get key
final string keyname   key tostring
final string mname       character touppercase keyname charat 0     keyname substring 1
for int i 0 j ems length i<j i
if ems getname   equals mname     ems getparametertypes   length    1
ems invoke outp  new object fixvalue value  ems getparametertypes
break
catch final exception e
throw new yamlexception     pref       e tostring
return outp
static
baseconstructorimpl addconstructor   new yamlconstructor
public object call final constructor self  final node node
return constructyamlnull self node
addconstructor   new yamlconstructor
public object call final constructor self  final node node
return constructyamlbool self node
addconstructor   new yamlconstructor
public object call final constructor self  final node node
return constructyamlomap self node
addconstructor   new yamlconstructor
public object call final constructor self  final node node
return constructyamlpairs self node
addconstructor   new yamlconstructor
public object call final constructor self  final node node
return constructyamlset self node
addconstructor   new yamlconstructor
public object call final constructor self  final node node
return constructyamlint self node
addconstructor   new yamlconstructor
public object call final constructor self  final node node
return constructyamlfloat self node
addconstructor   new yamlconstructor
public object call final constructor self  final node node
return   object constructyamltimestamp self node
addconstructor   new yamlconstructor
public object call final constructor self  final node node
return   object constructyamltimestamp self node
addconstructor   new yamlconstructor
public object call final constructor self  final node node
return constructyamlstr self node
addconstructor   new yamlconstructor
public object call final constructor self  final node node
return constructyamlbinary self node
addconstructor   new yamlconstructor
public object call final constructor self  final node node
return constructyamlseq self node
addconstructor   new yamlconstructor
public object call final constructor self  final node node
return constructyamlmap self node
addconstructor null new yamlconstructor
public object call final constructor self  final node node
return self constructprivatetype node
addmulticonstructor   new yamlmulticonstructor
public object call final constructor self  final string pref  final node node
return constructspecializedsequence self pref node
addmulticonstructor   new yamlmulticonstructor
public object call final constructor self  final string pref  final node node
return constructspecializedmap self pref node
addmulticonstructor   new yamlmulticonstructor
public object call final constructor self  final string pref  final node node
return constructjava self pref node
addmulticonstructor   new yamlmulticonstructor
public object call final constructor self  final string pref  final node node
return constructjava self pref node
public static void main final string args  throws exception
final string filename   args
system out println
final bytelist input   new bytelist 1024
final inputstream reader   new fileinputstream filename
byte buff   new byte
int read   0
while true
read   reader read buff
input append buff 0 read
if read < 1024
break
reader close
final long before   system currenttimemillis
for int i 0 i<1 i
final constructor ctor   new safeconstructorimpl new composerimpl new parserimpl new scannerimpl input   new resolverimpl
for final iterator iter   ctor eachdocument   iter hasnext
iter next
//system.out.println(iter.next());
final long after   system currenttimemillis
final long time   after before
final double times    after before  1000 0
system out println     filename       time       times
safeconstructorimpl