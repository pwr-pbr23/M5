/*
***** begin license block *****
* version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public
* license version 1.0 (the "license"); you may not use this file
* except in compliance with the license. you may obtain a copy of
* the license at http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as
* is" basis, without warranty of any kind, either express or
* implied. see the license for the specific language governing
* rights and limitations under the license.
*
* copyright (c) 2007 charles o nutter <headius@headius.com>
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"),
* or the gnu lesser general public license version 2.1 or later (the "lgpl"),
* in which case the provisions of the gpl or the lgpl are applicable instead
* of those above. if you wish to allow use of your version of this file only
* under the terms of either the gpl or the lgpl, and not to allow others to
* use your version of this file under the terms of the cpl, indicate your
* decision by deleting the provisions above and replace them with the notice
* and other provisions required by the gpl or the lgpl. if you do not delete
* the provisions above, a recipient may use your version of this file under
* the terms of any one of the cpl, the gpl or the lgpl.
***** end license block *****/
package org jruby compiler
import java util hashset
import java util set
import org jruby ast andnode
import org jruby ast argscatnode
import org jruby ast argsnode
import org jruby ast argspushnode
import org jruby ast assignablenode
import org jruby ast attrassignnode
import org jruby ast beginnode
import org jruby ast binaryoperatornode
import org jruby ast blockacceptingnode
import org jruby ast blocknode
import org jruby ast blockpassnode
import org jruby ast breaknode
import org jruby ast callnode
import org jruby ast casenode
import org jruby ast colon2node
import org jruby ast dotnode
import org jruby ast evstrnode
import org jruby ast flipnode
import org jruby ast fornode
import org jruby ast globalasgnnode
import org jruby ast hashnode
import org jruby ast iargumentnode
import org jruby ast iscopingnode
import org jruby ast ifnode
import org jruby ast listnode
import org jruby ast match2node
import org jruby ast match3node
import org jruby ast matchnode
import org jruby ast multipleasgnnode
import org jruby ast newlinenode
import org jruby ast nextnode
import org jruby ast node
import org jruby ast notnode
import org jruby ast opasgnandnode
import org jruby ast opasgnnode
import org jruby ast opelementasgnnode
import org jruby ast ornode
import org jruby ast postexenode
import org jruby ast preexenode
import org jruby ast returnnode
import org jruby ast rootnode
import org jruby ast svaluenode
import org jruby ast splatnode
import org jruby ast supernode
import org jruby ast toarynode
import org jruby ast untilnode
import org jruby ast whennode
import org jruby ast whilenode
import org jruby ast yieldnode
import org jruby ast zsupernode
import org jruby ast types inamenode
import org jruby util safepropertyaccessor
/**
*
* @author headius
*/
public class astinspector
private boolean hasclosure
private boolean hasclass
private boolean hasdef
private boolean hasscopeawaremethods
private boolean hasframeawaremethods
private boolean hasblockarg
private boolean hasoptargs
private boolean hasrestarg
public static set<string> frame_aware_methods   new hashset<string>
private static set<string> scope_aware_methods   new hashset<string>
static
frame_aware_methods add
frame_aware_methods add
frame_aware_methods add
frame_aware_methods add
frame_aware_methods add
frame_aware_methods add
frame_aware_methods add
frame_aware_methods add
frame_aware_methods add
frame_aware_methods add
frame_aware_methods add
scope_aware_methods add
scope_aware_methods add
scope_aware_methods add
scope_aware_methods add
scope_aware_methods add
scope_aware_methods add
public void disable
hasclosure   true
hasclass   true
hasdef   true
hasscopeawaremethods   true
hasframeawaremethods   true
hasblockarg   true
hasoptargs   true
hasrestarg   true
public static final boolean enabled   safepropertyaccessor getproperty       equals
public void inspect node node
// todo: this code effectively disables all inspection-based optimizations; none of them are 100% safe yet
if   enabled  disable
if  node    null  return
switch  node nodeid
case aliasnode
break
case andnode
andnode andnode    andnode node
inspect andnode getfirstnode
inspect andnode getsecondnode
break
case argscatnode
argscatnode argscatnode    argscatnode node
inspect argscatnode getfirstnode
inspect argscatnode getsecondnode
break
case argspushnode
argspushnode argspushnode    argspushnode node
inspect argspushnode getfirstnode
inspect argspushnode getsecondnode
break
case argumentnode
break
case arraynode
case blocknode
case dregexpnode
case dstrnode
case dsymbolnode
case dxstrnode
case listnode
listnode listnode    listnode node
for  int i   0  i < listnode size    i
inspect listnode get i
break
case argsnode
argsnode argsnode    argsnode node
if  argsnode getblockargnode      null  hasblockarg   true
if  argsnode getoptargs      null
hasoptargs   true
inspect argsnode getoptargs
if  argsnode getrestarg       2    argsnode getrestarg   >  0  hasrestarg   true
break
case assignablenode
assignablenode assignablenode    assignablenode node
inspect assignablenode getvaluenode
break
case attrassignnode
attrassignnode attrassignnode    attrassignnode node
inspect attrassignnode getargsnode
inspect attrassignnode getreceivernode
break
case backrefnode
hasframeawaremethods   true
break
case beginnode
inspect   beginnode node  getbodynode
break
case bignumnode
break
case binaryoperatornode
binaryoperatornode binaryoperatornode    binaryoperatornode node
inspect binaryoperatornode getfirstnode
inspect binaryoperatornode getsecondnode
break
case blockargnode
break
case blockpassnode
blockpassnode blockpassnode    blockpassnode node
inspect blockpassnode getargsnode
inspect blockpassnode getbodynode
break
case breaknode
inspect   breaknode node  getvaluenode
break
case callnode
callnode callnode    callnode node
inspect callnode getreceivernode
case fcallnode
inspect   iargumentnode node  getargsnode
inspect   blockacceptingnode node  getiternode
case vcallnode
inamenode namenode    inamenode node
if  frame_aware_methods contains namenode getname
hasframeawaremethods   true
if  scope_aware_methods contains namenode getname
hasscopeawaremethods   true
break
case casenode
casenode casenode    casenode node
inspect casenode getcasenode
inspect casenode getfirstwhennode
break
case classnode
hasscopeawaremethods   true
hasclass   true
break
case classvarnode
hasscopeawaremethods   true
break
case globalasgnnode
globalasgnnode globalasgnnode    globalasgnnode node
if  globalasgnnode getname   equals       globalasgnnode getname   equals
hasscopeawaremethods   true
break
case constdeclnode
case classvarasgnnode
case classvardeclnode
hasscopeawaremethods   true
case dasgnnode
case instasgnnode
case localasgnnode
inspect   assignablenode node  getvaluenode
break
case colon2node
inspect   colon2node node  getleftnode
break
case colon3node
break
case constnode
hasscopeawaremethods   true
break
case defnnode
case defsnode
hasdef   true
hasscopeawaremethods   true
break
case definednode
disable
break
case dotnode
dotnode dotnode    dotnode node
inspect dotnode getbeginnode
inspect dotnode getendnode
break
case dvarnode
break
case ensurenode
disable
break
case evstrnode
inspect   evstrnode node  getbody
break
case falsenode
break
case fixnumnode
break
case flipnode
inspect   flipnode node  getbeginnode
inspect   flipnode node  getendnode
break
case floatnode
break
case fornode
hasclosure   true
hasscopeawaremethods   true
hasframeawaremethods   true
inspect   fornode node  getiternode
inspect   fornode node  getbodynode
inspect   fornode node  getvarnode
break
case globalvarnode
break
case hashnode
hashnode hashnode    hashnode node
inspect hashnode getlistnode
break
case ifnode
ifnode ifnode    ifnode node
inspect ifnode getcondition
inspect ifnode getthenbody
inspect ifnode getelsebody
break
case instvarnode
break
case iscopingnode
iscopingnode iscopingnode    iscopingnode node
inspect iscopingnode getcpath
break
case iternode
hasclosure   true
hasframeawaremethods   true
break
case localvarnode
break
case matchnode
inspect   matchnode node  getregexpnode
break
case match2node
match2node match2node    match2node node
inspect match2node getreceivernode
inspect match2node getvaluenode
break
case match3node
match3node match3node    match3node node
inspect match3node getreceivernode
inspect match3node getvaluenode
break
case modulenode
hasclass   true
hasscopeawaremethods   true
break
case multipleasgnnode
multipleasgnnode multipleasgnnode    multipleasgnnode node
inspect multipleasgnnode getargsnode
inspect multipleasgnnode getheadnode
inspect multipleasgnnode getvaluenode
break
case newlinenode
inspect   newlinenode node  getnextnode
break
case nextnode
inspect   nextnode node  getvaluenode
break
case nilnode
break
case notnode
inspect   notnode node  getconditionnode
break
case nthrefnode
break
case opasgnandnode
opasgnandnode opasgnandnode    opasgnandnode node
inspect opasgnandnode getfirstnode
inspect opasgnandnode getsecondnode
break
case opasgnnode
opasgnnode opasgnnode    opasgnnode node
inspect opasgnnode getreceivernode
inspect opasgnnode getvaluenode
break
case opasgnornode
disable       depends on defined
break
case opelementasgnnode
opelementasgnnode opelementasgnnode    opelementasgnnode node
inspect opelementasgnnode getargsnode
inspect opelementasgnnode getreceivernode
inspect opelementasgnnode getvaluenode
break
case ornode
ornode ornode    ornode node
inspect ornode getfirstnode
inspect ornode getsecondnode
break
case postexenode
postexenode postexenode    postexenode node
hasclosure   true
hasframeawaremethods   true
hasscopeawaremethods   true
inspect postexenode getbodynode
inspect postexenode getvarnode
break
case preexenode
preexenode preexenode    preexenode node
hasclosure   true
hasframeawaremethods   true
hasscopeawaremethods   true
inspect preexenode getbodynode
inspect preexenode getvarnode
break
case redonode
break
case regexpnode
break
case rootnode
inspect   rootnode node  getbodynode
if    rootnode node  getbodynode   instanceof blocknode
blocknode blocknode    blocknode   rootnode node  getbodynode
if  blocknode size   > 500
// method has more than 500 lines; we'll need to split it
// and therefore need to use a heap-based scope
hasscopeawaremethods   true
break
case rescuebodynode
disable
break
case rescuenode
disable
break
case retrynode
disable
break
case returnnode
inspect   returnnode node  getvaluenode
break
case sclassnode
hasclass   true
hasscopeawaremethods   true
break
case scopenode
break
case selfnode
break
case splatnode
inspect   splatnode node  getvalue
break
case starnode
break
case strnode
break
case supernode
supernode supernode    supernode node
inspect supernode getargsnode
inspect supernode getiternode
break
case svaluenode
inspect   svaluenode node  getvalue
break
case symbolnode
break
case toarynode
inspect   toarynode node  getvalue
break
case truenode
break
case undefnode
hasscopeawaremethods   true
break
case untilnode
untilnode untilnode    untilnode node
inspect untilnode getconditionnode
inspect untilnode getbodynode
break
case valiasnode
break
case whennode
inspect   whennode node  getbodynode
inspect   whennode node  getexpressionnodes
inspect   whennode node  getnextcase
break
case whilenode
whilenode whilenode    whilenode node
inspect whilenode getconditionnode
inspect whilenode getbodynode
break
case xstrnode
break
case yieldnode
inspect   yieldnode node  getargsnode
break
case zarraynode
break
case zeroargnode
break
case zsupernode
hasscopeawaremethods   true
hasframeawaremethods   true
inspect   zsupernode node  getiternode
break
default
// encountered a node we don't recognize, set everything to true to disable optz
assert false       node
disable
public boolean hasclass
return hasclass
public boolean hasclosure
return hasclosure
public boolean hasdef
return hasdef
public boolean hasframeawaremethods
return hasframeawaremethods
public boolean hasscopeawaremethods
return hasscopeawaremethods
public boolean hasblockarg
return hasblockarg
public boolean hasoptargs
return hasoptargs
public boolean hasrestarg
return hasrestarg