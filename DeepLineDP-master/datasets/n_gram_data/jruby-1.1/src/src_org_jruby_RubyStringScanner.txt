package org jruby
import org joni matcher
import org joni option
import org joni regex
import org joni region
import org joni encoding encoding
import org jruby anno jrubymethod
import org jruby common irubywarnings id
import org jruby runtime arity
import org jruby runtime block
import org jruby runtime objectallocator
import org jruby runtime builtin irubyobject
import org jruby util bytelist
/**
* @author kscott
*
*/
public class rubystringscanner extends rubyobject
private rubystring str
private int pos   0
private int lastpos    1
private region regs
private int beg    1
private int end    1
private static final int matched_str_scn_f   1 << 11
private static objectallocator stringscanner_allocator   new objectallocator
public irubyobject allocate ruby runtime  rubyclass klass
return new rubystringscanner runtime  klass
public static rubyclass createscannerclass final ruby runtime
rubyclass scannerclass   runtime defineclass    runtime getobject    stringscanner_allocator
scannerclass defineannotatedmethods rubystringscanner class
scannerclass setconstant    runtime newstring    freeze
scannerclass setconstant    runtime newstring    freeze
return scannerclass
private void clearmatched
flags    ~matched_str_scn_f
private void setmatched
flags    matched_str_scn_f
private boolean ismatched
return  flags   matched_str_scn_f     0
private void check
if  str    null  throw getruntime   newargumenterror
protected rubystringscanner ruby runtime  rubyclass type
super runtime  type
// second argument is allowed, but ignored (mri)
@jrubymethod name      required   1  optional   1  frame   true
public irubyobject initialize irubyobject args  block unusedblock
str   args converttostring
return this
@jrubymethod name      required   1
public irubyobject initialize_copy irubyobject other
if  this    other  return this
if    other instanceof rubystringscanner   throw getruntime   newtypeerror     other getmetaclass
rubystringscanner otherscanner    rubystringscanner other
str   otherscanner str
pos   otherscanner pos
lastpos   otherscanner lastpos
flags   otherscanner flags
regs   otherscanner regs    null ? otherscanner regs clone     null
beg   otherscanner beg
end   otherscanner end
return this
@jrubymethod name
public irubyobject reset
check
pos   0
clearmatched
return this
@jrubymethod name
public irubyobject terminate
check
pos   str getbytelist   realsize
clearmatched
return this
@jrubymethod name
public irubyobject clear
check
getruntime   getwarnings   warn id deprecated_method
return terminate
@jrubymethod name
public rubystring string
return str
@jrubymethod name      required   1
public irubyobject set_string irubyobject str
this str    rubystring str converttostring   strdup   freeze
pos   0
clearmatched
return str
@jrubymethod name           required   1
public irubyobject concat irubyobject obj
check
str append obj      append will call converttostring
return this
@jrubymethod name
public rubyfixnum pos
check
return rubyfixnum newfixnum getruntime    pos
@jrubymethod name      required   1
public irubyobject set_pos irubyobject pos
check
int i   rubynumeric num2int pos
int size   str getbytelist   realsize
if  i < 0  i    size
if  i < 0    i > size  throw getruntime   newrangeerror
this pos   i
return rubyfixnum newfixnum getruntime    i
private irubyobject extractrange int beg  int end
int size   str getbytelist   realsize
if  beg > size  return getruntime   getnil
if  end > size  end   size
return str makeshared beg  end   beg
private irubyobject extractbeglen int beg  int len
int size   str getbytelist   realsize
if  beg > size  return getruntime   getnil
if  beg   len > size  len   size   beg
return str makeshared beg  len
private irubyobject scan irubyobject regex  boolean succptr  boolean getstr  boolean headonly
if    regex instanceof rubyregexp   throw getruntime   newtypeerror     regex getmetaclass
check
regex pattern     rubyregexp regex  getpattern
clearmatched
int rest   str getbytelist   realsize   pos
if  rest < 0  return getruntime   getnil
bytelist value   str getbytelist
matcher matcher   pattern matcher value bytes  value begin   pos  value begin   value realsize
final int ret
if  headonly
ret   matcher match value begin   pos  value begin   value realsize  option none
else
ret   matcher search value begin   pos  value begin   value realsize  option none
regs   matcher getregion
if  regs    null
beg   matcher getbegin
end   matcher getend
else
beg   regs beg
end   regs end
if  ret < 0  return getruntime   getnil
setmatched
lastpos   pos
if  succptr  pos    end
return  getstr ? extractbeglen lastpos  end    rubyfixnum newfixnum getruntime    end
@jrubymethod name      required   1
public irubyobject scan irubyobject regex
return scan regex  true  true  true
@jrubymethod name      required   1
public irubyobject match_p irubyobject regex
return scan regex  false  false  true
@jrubymethod name      required   1
public irubyobject skip irubyobject regex
return scan regex  true  false  true
@jrubymethod name      required   1
public irubyobject check irubyobject regex
return scan regex  false  true  true
@jrubymethod name      required   3
public irubyobject scan_full irubyobject regex  irubyobject s  irubyobject f
return scan regex  s istrue    f istrue    true
@jrubymethod name      required   1
public irubyobject scan_until irubyobject regex
return scan regex  true  true  false
@jrubymethod name      required   1
public irubyobject exist_p irubyobject regex
return scan regex  false  false  false
@jrubymethod name      required   1
public irubyobject skip_until irubyobject regex
return scan regex  true  false  false
@jrubymethod name      required   1
public irubyobject check_until irubyobject regex
return scan regex  false  true  false
@jrubymethod name      required   3
public irubyobject search_full irubyobject regex  irubyobject s  irubyobject f
return scan regex  s istrue    f istrue    false
private void adjustregisters
beg   0
end   pos   lastpos
regs   null
@jrubymethod name
public irubyobject getch
check
clearmatched
bytelist value   str getbytelist
if  pos >  value realsize  return getruntime   getnil
encoding enc   getruntime   getkcode   getencoding
int len
if  enc issinglebyte
len   1
else
len   enc length value bytes
if  pos   len > value realsize  len   value realsize   pos
lastpos   pos
pos    len
setmatched
adjustregisters
return extractrange lastpos   beg  lastpos   end
@jrubymethod name
public irubyobject get_byte
check
clearmatched
if  pos >  str getbytelist   realsize  return getruntime   getnil
lastpos   pos
pos
setmatched
adjustregisters
return extractrange lastpos   beg  lastpos   end
@jrubymethod name
public irubyobject getbyte
getruntime   getwarnings   warn id deprecated_method
return getbyte
@jrubymethod name      required   1
public irubyobject peek irubyobject length
check
int len   rubynumeric num2int length
bytelist value   str getbytelist
if  pos >  value realsize  return rubystring newemptystring getruntime    infectby str
if  pos   len > value realsize  len   value realsize   pos
return extractbeglen pos  len
@jrubymethod name      required   1
public irubyobject peep irubyobject length
getruntime   getwarnings   warn id deprecated_method
return peek length
@jrubymethod name
public irubyobject unscan
check
// todo: should be scanerror here
if   ismatched    throw getruntime   neweoferror
pos   lastpos
clearmatched
return this
@jrubymethod name      alias
public irubyobject bol_p
check
bytelist value   str getbytelist
if  pos > value realsize  return getruntime   getnil
if  pos    0  return getruntime   gettrue
return value bytes     byte   ? getruntime   gettrue     getruntime   getfalse
@jrubymethod name
public rubyboolean eos_p
check
return pos >  str getbytelist   realsize ? getruntime   gettrue     getruntime   getfalse
@jrubymethod name
public rubyboolean empty_p
getruntime   getwarnings   warn id deprecated_method
return eos_p
@jrubymethod name
public rubyboolean rest_p
check
return pos >  str getbytelist   realsize ? getruntime   getfalse     getruntime   gettrue
@jrubymethod name
public rubyboolean matched_p
check
return ismatched   ? getruntime   gettrue     getruntime   getfalse
@jrubymethod name
public irubyobject matched
check
if   ismatched    return getruntime   getnil
return extractrange lastpos   beg  lastpos   end
@jrubymethod name
public irubyobject matched_size
check
if   ismatched    return getruntime   getnil
return rubyfixnum newfixnum getruntime    end   beg
@jrubymethod name
public irubyobject matchedsize
getruntime   getwarnings   warn id deprecated_method
return matched_size
@jrubymethod name      required   1
public irubyobject op_aref irubyobject idx
check
if   ismatched    return getruntime   getnil
int i   rubynumeric num2int idx
int numregs   regs    null ? 1   regs numregs
if  i < 0  i    numregs
if  i < 0    i >  numregs  return getruntime   getnil
if  regs    null
assert i    0
if  beg     1  return getruntime   getnil
return extractrange lastpos   beg  lastpos   end
else
if  regs beg     1  return getruntime   getnil
return extractrange lastpos   regs beg  lastpos   regs end
@jrubymethod name
public irubyobject pre_match
check
if   ismatched    return getruntime   getnil
return extractrange 0  lastpos   beg
@jrubymethod name
public irubyobject post_match
check
if   ismatched    return getruntime   getnil
return extractrange lastpos   end  str getbytelist   realsize
@jrubymethod name
public irubyobject rest
check
bytelist value   str getbytelist
if  pos >  value realsize  return rubystring newemptystring getruntime    infectby str
return extractrange pos  value realsize
@jrubymethod name
public rubyfixnum rest_size
check
bytelist value   str getbytelist
if  pos >  value realsize  return rubyfixnum zero getruntime
return rubyfixnum newfixnum getruntime    value realsize   pos
@jrubymethod name
public rubyfixnum restsize
getruntime   getwarnings   warn id deprecated_method
return rest_size
@jrubymethod name
public irubyobject inspect
if  str    null  return inspect
if  pos >  str getbytelist   realsize  return inspect
if  pos    0  return inspect pos       str getbytelist   realsize       inspect2
return inspect pos       str getbytelist   realsize       inspect1         inspect2
private irubyobject inspect string msg
irubyobject result   getruntime   newstring     getmetaclass         msg
if  str    null  result infectby str
return result
private static final int inspect_length   5
private irubyobject inspect1
if  pos    0  return rubystring newemptystring getruntime
if  pos > inspect_length
return rubystring newstring getruntime      getbytes    append str substr pos   inspect_length  inspect_length   inspect
else
return str substr 0  pos  inspect
private irubyobject inspect2
if  pos >  str getbytelist   realsize  return rubystring newemptystring getruntime
int len   str getbytelist   realsize   pos
if  len > inspect_length
return   rubystring str substr pos  inspect_length   cat   getbytes    inspect
else
return str substr pos  len  inspect
@jrubymethod name      meta   true
public static irubyobject mustcversion irubyobject recv
return recv