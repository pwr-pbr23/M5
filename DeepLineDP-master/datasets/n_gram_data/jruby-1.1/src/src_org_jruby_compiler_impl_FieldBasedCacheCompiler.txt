/*
* to change this template, choose tools | templates
* and open the template in the editor.
*/
package org jruby compiler impl
import java math biginteger
import java util hashmap
import java util map
import org jruby ruby
import org jruby rubysymbol
import org jruby compiler cachecompiler
import org jruby javasupport util runtimehelpers
import org jruby lexer yacc isourceposition
import org jruby runtime callsite
import org jruby runtime calltype
import org jruby runtime methodindex
import org jruby util bytelist
import org jruby util javanamemangler
import org objectweb asm classvisitor
import org objectweb asm label
import org objectweb asm opcodes
import static org jruby util codegenutils
/**
*
* @author headius
*/
public class fieldbasedcachecompiler implements cachecompiler
protected standardasmcompiler scriptcompiler
map<string  string> sourcepositions   new hashmap<string  string>
map<string  string> bytelists   new hashmap<string  string>
map<biginteger  string> bigintegers   new hashmap<biginteger  string>
map<string  string> symbols   new hashmap<string  string>
public fieldbasedcachecompiler standardasmcompiler scriptcompiler
this scriptcompiler   scriptcompiler
public void cachecallsite skinnymethodadapter method  string name  calltype calltype
string fieldname   scriptcompiler getnewconstant ci callsite class   javanamemangler manglestringforcleanjavaidentifier name
// retrieve call adapter
skinnymethodadapter initmethod   scriptcompiler getinitmethod
initmethod aload standardasmcompiler this
initmethod ldc name
if  calltype equals calltype normal
initmethod invokestatic p methodindex class      sig callsite class  params string class
else if  calltype equals calltype functional
initmethod invokestatic p methodindex class      sig callsite class  params string class
else if  calltype equals calltype variable
initmethod invokestatic p methodindex class      sig callsite class  params string class
initmethod putfield scriptcompiler getclassname    fieldname  ci callsite class
method getfield scriptcompiler getclassname    fieldname  ci callsite class
public void cacheposition skinnymethodadapter method  string file  int line
string cleanname   javanamemangler manglestringforcleanjavaidentifier file       line
string fieldname   sourcepositions get cleanname
if  fieldname    null
skinnymethodadapter clinitmethod   scriptcompiler getclassinitmethod
fieldname   scriptcompiler getnewstaticconstant ci isourceposition class   cleanname
sourcepositions put javanamemangler manglestringforcleanjavaidentifier file       line   fieldname
clinitmethod ldc file
clinitmethod ldc line
clinitmethod invokestatic p runtimehelpers class      sig isourceposition class  string class  int class
clinitmethod putstatic scriptcompiler getclassname    fieldname  ci isourceposition class
method getstatic scriptcompiler getclassname    fieldname  ci isourceposition class
public void cachebytelist skinnymethodadapter method  string contents
string fieldname   bytelists get contents
if  fieldname    null
skinnymethodadapter clinitmethod   scriptcompiler getclassinitmethod
fieldname   scriptcompiler getnewstaticconstant ci bytelist class
bytelists put contents  fieldname
clinitmethod ldc contents
clinitmethod invokestatic p bytelist class      sig bytelist class  charsequence class
clinitmethod putstatic scriptcompiler getclassname    fieldname  ci bytelist class
method getstatic scriptcompiler getclassname    fieldname  ci bytelist class
public void cachebiginteger skinnymethodadapter method  biginteger bigint
string fieldname   bigintegers get bigint
if  fieldname    null
skinnymethodadapter clinitmethod   scriptcompiler getclassinitmethod
fieldname   scriptcompiler getnewstaticconstant ci biginteger class
bigintegers put bigint  fieldname
clinitmethod newobj p biginteger class
clinitmethod dup
clinitmethod ldc bigint tostring
clinitmethod invokespecial p biginteger class      sig void class  string class
clinitmethod putstatic scriptcompiler getclassname    fieldname  ci biginteger class
method getstatic scriptcompiler getclassname    fieldname  ci biginteger class
public void cachesymbol skinnymethodadapter method  string symbol
string methodname   symbols get symbol
if  methodname    null
string fieldname   scriptcompiler getnewconstant ci rubysymbol class
methodname       fieldname
symbols put symbol  methodname
classvisitor cv   scriptcompiler getclassvisitor
skinnymethodadapter symmethod   new skinnymethodadapter
cv visitmethod opcodes acc_private   opcodes acc_synthetic  methodname
sig rubysymbol class  ruby class   null  null
symmethod start
symmethod aload 0
symmethod getfield scriptcompiler getclassname    fieldname  ci rubysymbol class
symmethod dup
symmethod astore 2
label ifnullend   new label
symmethod ifnull ifnullend
symmethod aload 2
symmethod areturn
symmethod label ifnullend
symmethod aload 0
symmethod aload 1
symmethod ldc symbol
symmethod invokevirtual p ruby class      sig rubysymbol class  string class
symmethod dup_x1
symmethod putfield scriptcompiler getclassname    fieldname  ci rubysymbol class
symmethod areturn
symmethod end
method aload 0
method aload standardasmcompiler runtime_index
method invokevirtual scriptcompiler getclassname    methodname
sig rubysymbol class  params ruby class