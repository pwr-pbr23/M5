/***** begin license block *****
* version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public
* license version 1.0 (the "license"); you may not use this file
* except in compliance with the license. you may obtain a copy of
* the license at http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as
* is" basis, without warranty of any kind, either express or
* implied. see the license for the specific language governing
* rights and limitations under the license.
*
* copyright (c) 2007 ola bini <ola@ologix.com>
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"),
* or the gnu lesser general public license version 2.1 or later (the "lgpl"),
* in which case the provisions of the gpl or the lgpl are applicable instead
* of those above. if you wish to allow use of your version of this file only
* under the terms of either the gpl or the lgpl, and not to allow others to
* use your version of this file under the terms of the cpl, indicate your
* decision by deleting the provisions above and replace them with the notice
* and other provisions required by the gpl or the lgpl. if you do not delete
* the provisions above, a recipient may use your version of this file under
* the terms of any one of the cpl, the gpl or the lgpl.
***** end license block *****/
package org jruby ast executable
import java io inputstream
import java io ioexception
import java util iterator
import java util list
import java util map
import java util hashmap
import java util identityhashmap
import org jruby ruby
import org jruby rubyfile
import org jruby rubyarray
import org jruby rubynumeric
import org jruby rubystring
import org jruby rubysymbol
import org jruby parser localstaticscope
import org jruby parser staticscope
import org jruby runtime threadcontext
import org jruby runtime builtin irubyobject
/**
* @author <a href="mailto:ola.bini@ki.se">ola bini</a>
*/
public class yarvcompiledrunner
private ruby runtime
private yarvmachine ym   yarvmachine instance
private yarvmachine instructionsequence iseq
private map jumps   new identityhashmap
private map labels   new hashmap
public yarvcompiledrunner ruby runtime  inputstream in  string filename
this runtime   runtime
byte first   new byte
try
in read first
if first         first         first         first
throw new runtimeexception
rubyfile f   new rubyfile runtime filename in
irubyobject arr   runtime getmarshal   callmethod runtime getcurrentcontext     f
iseq   transformintosequence arr
catch ioexception e
throw new runtimeexception   e
public yarvcompiledrunner ruby runtime  yarvmachine instructionsequence iseq
this runtime   runtime
this iseq   iseq
public irubyobject run
threadcontext context   runtime getcurrentcontext
staticscope scope   new localstaticscope null
scope setvariables iseq locals
context setfile iseq filename
context setline  1
return ym exec context  scope  iseq body
private yarvmachine instructionsequence transformintosequence irubyobject arr
if   arr instanceof rubyarray
throw new runtimeexception
labels clear
jumps clear
yarvmachine instructionsequence seq   new yarvmachine instructionsequence runtime null null null
iterator internal      rubyarray arr  getlist    iterator
seq magic   internal next   tostring
seq major   rubynumeric fix2int  irubyobject internal next
seq minor   rubynumeric fix2int  irubyobject internal next
seq format_type   rubynumeric fix2int  irubyobject internal next
irubyobject misc    irubyobject internal next
if misc isnil
seq misc   null
else
seq misc   misc
seq name   internal next   tostring
seq filename   internal next   tostring
seq line   new object  internal next
seq type   internal next   tostring
seq locals   tostringarray  irubyobject internal next
irubyobject argo    irubyobject internal next
if argo instanceof rubyarray
list arglist     rubyarray argo  getlist
seq args_argc   rubynumeric fix2int  irubyobject arglist get 0
seq args_arg_opts   rubynumeric fix2int  irubyobject arglist get 1
seq args_opt_labels   tostringarray  irubyobject arglist get 2
seq args_rest   rubynumeric fix2int  irubyobject arglist get 3
seq args_block   rubynumeric fix2int  irubyobject arglist get 4
else
seq args_argc   rubynumeric fix2int argo
seq exception   getexceptioninformation  irubyobject internal next
list bodyl     rubyarray internal next    getlist
yarvmachine instruction body   new yarvmachine instruction
int real 0
int i 0
for iterator iter   bodyl iterator   iter hasnext   i
irubyobject is    irubyobject iter next
if is instanceof rubyarray
body   intoinstruction  rubyarray is real seq
real
else if is instanceof rubysymbol
labels put is tostring    new integer real 1
yarvmachine instruction nbody   new yarvmachine instruction
system arraycopy body 0 nbody 0 real
seq body   nbody
for iterator iter   jumps keyset   iterator   iter hasnext
yarvmachine instruction k    yarvmachine instruction iter next
k l_op0     integer labels get jumps get k    intvalue     1
return seq
private string tostringarray irubyobject obj
if obj isnil
return new string
else
list l     rubyarray obj  getlist
string s   new string
int i 0
for iterator iter   l iterator   iter hasnext   i
s   iter next   tostring
return s
private yarvmachine instruction intoinstruction rubyarray obj  int n  yarvmachine instructionsequence iseq
list internal   obj getlist
string name   internal get 0  tostring
int instruction   yarvmachine instruction name
yarvmachine instruction i   new yarvmachine instruction instruction
if internal size   > 1
irubyobject first    irubyobject internal get 1
if instruction    yarvinstructions getlocal    instruction    yarvinstructions setlocal
i l_op0    iseq locals length   1    rubynumeric fix2long first
else if instruction    yarvinstructions putobject    instruction    yarvinstructions opt_regexpmatch1    instruction    yarvinstructions getinlinecache
i o_op0   first
else if first instanceof rubystring    first instanceof rubysymbol
i s_op0   first tostring
else if first instanceof rubynumeric
i l_op0   rubynumeric fix2long first
if instruction    yarvinstructions send
i i_op1   rubynumeric fix2int  irubyobject internal get 2
i i_op3   rubynumeric fix2int  irubyobject internal get 4
if instruction    yarvinstructions definemethod
i iseq_op   transformintosequence  irubyobject internal get 2
if isjump instruction
i index   n
jumps put i  internal get jumpindex instruction   tostring
return i
private boolean isjump int i
return i    yarvinstructions jump    i    yarvinstructions branchif    i    yarvinstructions branchunless
i    yarvinstructions getinlinecache    i    yarvinstructions setinlinecache
private int jumpindex int i
if i    yarvinstructions getinlinecache
return 2
else
return 1
private object getexceptioninformation irubyobject obj
//        system.err.println(obj.callmethod(runtime.getcurrentcontext(),"inspect"));
return new object
yarvcompiledrunner