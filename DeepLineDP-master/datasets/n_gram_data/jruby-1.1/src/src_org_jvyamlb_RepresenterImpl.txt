/***** begin license block *****
* version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public
* license version 1.0 (the "license"); you may not use this file
* except in compliance with the license. you may obtain a copy of
* the license at http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as
* is" basis, without warranty of any kind, either express or
* implied. see the license for the specific language governing
* rights and limitations under the license.
*
* copyright (c) 2007 ola bini <ola@ologix.com>
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"),
* or the gnu lesser general public license version 2.1 or later (the "lgpl"),
* in which case the provisions of the gpl or the lgpl are applicable instead
* of those above. if you wish to allow use of your version of this file only
* under the terms of either the gpl or the lgpl, and not to allow others to
* use your version of this file under the terms of the cpl, indicate your
* decision by deleting the provisions above and replace them with the notice
* and other provisions required by the gpl or the lgpl. if you do not delete
* the provisions above, a recipient may use your version of this file under
* the terms of any one of the cpl, the gpl or the lgpl.
***** end license block *****/
package org jvyamlb
import java io ioexception
import java io serializable
import java lang reflect method
import java text dateformat
import java text simpledateformat
import java util iterator
import java util map
import java util identityhashmap
import java util hashmap
import java util list
import java util arraylist
import java util linkedlist
import java util set
import java util date
import java util calendar
import org jvyamlb nodes node
import org jvyamlb nodes linknode
import org jvyamlb nodes collectionnode
import org jvyamlb nodes mappingnode
import org jvyamlb nodes scalarnode
import org jvyamlb nodes sequencenode
import org jruby rubyhash
import org jruby util bytelist
import org jruby util collections inthashmap
/**
* @author <a href="mailto:ola.bini@ki.se">ola bini</a>
*/
public class representerimpl implements representer
private final serializer serializer
private final char defaultstyle
private final map representedobjects
private final map links
public representerimpl final serializer serializer  final yamlconfig opts
this serializer   serializer
this defaultstyle   opts usedouble   ?      opts usesingle   ?     0
this representedobjects   new identityhashmap
this links   new identityhashmap
private node representdata final object data  throws ioexception
node node   null
boolean ignorealias   ignorealiases data
if  ignorealias
if this representedobjects containskey data
node    node this representedobjects get data
if null    node
node   new linknode
list ll    list links get data
if ll    null
ll   new arraylist
links put data ll
ll add node
return node
this representedobjects put data null
node   getnodecreatorfor data  toyamlnode this
if  ignorealias
this representedobjects put data node
list ll    list this links remove data
if ll    null
for iterator iter   ll iterator   iter hasnext
linknode iter next    setanchor node
return node
public node scalar final string tag  final bytelist value  char style  throws ioexception
return representscalar tag value style
public node representscalar final string tag  final bytelist value  char style  throws ioexception
char realstyle   style    0 ? this defaultstyle   style
return new scalarnode tag value style
public node seq final string tag  final list sequence  final boolean flowstyle  throws ioexception
return representsequence tag sequence flowstyle
public node representsequence final string tag  final list sequence  final boolean flowstyle  throws ioexception
list value   new arraylist sequence size
for final iterator iter   sequence iterator   iter hasnext
value add representdata iter next
return new sequencenode tag value flowstyle
public node map final string tag  final map mapping  final boolean flowstyle  throws ioexception
return representmapping tag mapping flowstyle
public node representmapping final string tag  final map mapping  final boolean flowstyle  throws ioexception
map value   new hashmap
final iterator iter    mapping instanceof rubyhash  ?   rubyhash mapping  directentryset   iterator     mapping entryset   iterator
while iter hasnext
map entry entry    map entry iter next
value put representdata entry getkey    representdata entry getvalue
return new mappingnode tag value flowstyle
public void represent final object data  throws ioexception
node node   representdata data
this serializer serialize node
this representedobjects clear
protected boolean ignorealiases final object data
return false
protected yamlnodecreator getnodecreatorfor final object data
if data instanceof yamlnodecreator
return  yamlnodecreator data
else if data instanceof map
return new mappingyamlnodecreator data
else if data instanceof list
return new sequenceyamlnodecreator data
else if data instanceof set
return new setyamlnodecreator data
else if data instanceof date
return new dateyamlnodecreator data
else if data instanceof string
return new stringyamlnodecreator data
else if data instanceof bytelist
return new bytelistyamlnodecreator data
else if data instanceof number
return new numberyamlnodecreator data
else if data instanceof boolean
return new scalaryamlnodecreator   data
else if data    null
return new scalaryamlnodecreator
else if data getclass   isarray
return new arrayyamlnodecreator data
else      fallback  handles javabeans and other
return new javabeanyamlnodecreator data
public static class dateyamlnodecreator implements yamlnodecreator
private final date data
public dateyamlnodecreator final object data
this data    date data
public string taguri
return
private static dateformat dateoutput   new simpledateformat
private static dateformat dateoutputusec   new simpledateformat
public node toyamlnode final representer representer  throws ioexception
final calendar c   calendar getinstance
c settime data
string out   null
if c get calendar millisecond     0
out   dateoutputusec format data
else
out   dateoutput format data
out   out substring 0  23        out substring 23
return representer scalar taguri    bytelist create out    char 0
public static class setyamlnodecreator implements yamlnodecreator
private final set data
public setyamlnodecreator final object data
this data    set data
public string taguri
return
public node toyamlnode final representer representer  throws ioexception
final map entries   new hashmap
for final iterator iter   data iterator   iter hasnext
entries put iter next   null
return representer map taguri    entries  false
public static class arrayyamlnodecreator implements yamlnodecreator
private final object data
public arrayyamlnodecreator final object data
this data   data
public string taguri
return
public node toyamlnode final representer representer  throws ioexception
final int l   java lang reflect array getlength data
final list lst   new arraylist l
for int i 0 i<l i
lst add java lang reflect array get data i
return representer seq taguri    lst  false
public static class numberyamlnodecreator implements yamlnodecreator
private final number data
public numberyamlnodecreator final object data
this data    number data
public string taguri
if data instanceof float    data instanceof double    data instanceof java math bigdecimal
return
else
return
public node toyamlnode representer representer  throws ioexception
string str   data tostring
if str equals
str
else if str equals
str
else if str equals
str
return representer scalar taguri    bytelist create str    char 0
public static class scalaryamlnodecreator implements yamlnodecreator
private final string tag
private final object data
public scalaryamlnodecreator final string tag  final object data
this tag   tag
this data   data
public string taguri
return this tag
public node toyamlnode representer representer  throws ioexception
return representer scalar taguri    bytelist create data tostring      char 0
public static class stringyamlnodecreator implements yamlnodecreator
private final object data
public stringyamlnodecreator final object data
this data   data
public string taguri
if data instanceof string
return
else
return   data getclass   getname
public node toyamlnode representer representer  throws ioexception
return representer scalar taguri    bytelist create data tostring      char 0
public static class bytelistyamlnodecreator implements yamlnodecreator
private final object data
public bytelistyamlnodecreator final object data
this data   data
public string taguri
return
public node toyamlnode representer representer  throws ioexception
return representer scalar taguri     bytelist data   char 0
public static class sequenceyamlnodecreator implements yamlnodecreator
private final list data
public sequenceyamlnodecreator final object data
this data    list data
public string taguri
if data instanceof arraylist
return
else
return   data getclass   getname
public node toyamlnode representer representer  throws ioexception
return representer seq taguri    data  false
public static class mappingyamlnodecreator implements yamlnodecreator
private final map data
public mappingyamlnodecreator final object data
this data    map data
public string taguri
if data instanceof hashmap
return
else
return   data getclass   getname
public node toyamlnode representer representer  throws ioexception
return representer map taguri    data  false
public static class javabeanyamlnodecreator implements yamlnodecreator
private final object data
public javabeanyamlnodecreator final object data
this data   data
public string taguri
return     data getclass   getname
public node toyamlnode representer representer  throws ioexception
final map values   new hashmap
final method ems   data getclass   getmethods
for int i 0 j ems length i<j i
if ems getparametertypes   length    0
final string name   ems getname
if name equals
continue
string pname   null
if name startswith
pname       character tolowercase name charat 3     name substring 4
else if name startswith
pname       character tolowercase name charat 2     name substring 3
if null    pname
try
values put pname  ems invoke data
catch final exception exe
values put pname  null
return representer map taguri   values false
public static void main final string args  throws ioexception
final yamlconfig cfg   yaml config
final serializer s   new serializerimpl new emitterimpl system out cfg  new resolverimpl   cfg
s open
final representer r   new representerimpl s  cfg
final map test1   new hashmap
final list test1val   new linkedlist
test1val add
test1val add boolean true
test1val add new integer 31337
test1 put   test1val
final list test2val   new arraylist
test2val add
test2val add boolean false
test2val add new integer 31337
test1 put   test2val
test1 put
testjavabean bean1   new testjavabean
bean1 setname
bean1 setsurname
bean1 setage 24
test1 put new integer 25  bean1
r represent test1
s close
private static class testjavabean implements serializable
private string val1
private string val2
private int val3
public testjavabean
public void setname final string name
this val1   name
public string getname
return this val1
public void setsurname final string sname
this val2   sname
public string getsurname
return this val2
public void setage final int age
this val3   age
public int getage
return this val3
representerimpl