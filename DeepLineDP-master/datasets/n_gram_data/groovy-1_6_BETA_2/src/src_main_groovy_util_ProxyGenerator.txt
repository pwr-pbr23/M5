/*
* copyright 2003-2008 the original author or authors.
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package groovy util
import groovy lang
import org codehaus groovy control multiplecompilationerrorsexception
import org codehaus groovy runtime defaultgroovymethods
import org codehaus groovy runtime invokerhelper
import java lang reflect method
import java lang reflect modifier
import java util
/**
* classes to generate 'proxy' objects which implement interfaces
* and/or extend classes.
*
* @author paul king
* @author guillaume laforge
*/
public class proxygenerator
public static final proxygenerator instance   new proxygenerator
static
// wrap the standard metaclass with the delegate
setmetaclass groovysystem getmetaclassregistry   getmetaclass proxygenerator class
private classloader override   null
private boolean debug   false
private list objectmethods   getinheritedmethods object class  new arraylist
private list groovyobjectmethods   getinheritedmethods groovyobject class  new arraylist
public boolean getdebug
return debug
public void setdebug boolean debug
this debug   debug
public classloader getoverride
return override
public void setoverride classloader override
this override   override
public object instantiateaggregatefrombaseclass class clazz
return instantiateaggregatefrombaseclass  map null  clazz
public object instantiateaggregatefrombaseclass map map  class clazz
return instantiateaggregatefrombaseclass map  clazz  null
public object instantiateaggregatefrombaseclass closure cl  class clazz
map m   new hashmap
m put    cl
return instantiateaggregatefrombaseclass m  clazz  null
public object instantiateaggregatefrombaseclass map map  class clazz  object constructorargs
return instantiateaggregate map  null  clazz  constructorargs
public object instantiateaggregatefrominterface class clazz
return instantiateaggregatefrominterface null  clazz
public object instantiateaggregatefrominterface map map  class clazz
list interfaces   new arraylist
interfaces add clazz
return instantiateaggregate map  interfaces
public object instantiateaggregate list interfaces
return instantiateaggregate null  interfaces
public object instantiateaggregate map closuremap  list interfaces
return instantiateaggregate closuremap  interfaces  null
public object instantiateaggregate map closuremap  list interfaces  class clazz
return instantiateaggregate closuremap  interfaces  clazz  null
public object instantiateaggregate map closuremap  list interfaces  class clazz  object constructorargs
map map   new hashmap
if  closuremap    null
map   closuremap
list interfacestoimplement   new arraylist
if  interfaces    null
interfacestoimplement   interfaces
class baseclass   groovyobjectsupport class
if  clazz    null
baseclass   clazz
boolean hasargs   constructorargs    null    constructorargs length > 0
string name   shortname baseclass getname
stringbuffer buffer   new stringbuffer
// add class header and fields
buffer append    append name
if  clazz    null
buffer append    append baseclass getname
for  int i   0  i < interfacestoimplement size    i
class thisinterface    class  interfacestoimplement get i
if  i    0
buffer append
else
buffer append
buffer append thisinterface getname
buffer append    append
// add constructor
buffer append name  append
if  hasargs
buffer append
buffer append
buffer append
if  hasargs
buffer append
buffer append
buffer append
buffer append
// add overwriting methods
map<string  method> selectedmethods   new hashmap<string  method>
list<method> publicandprotectedmethods   getinheritedmethods baseclass  new arraylist<method>
boolean closureindicator   map containskey
for  method method   publicandprotectedmethods
if  method getname   indexof        1
modifier isfinal method getmodifiers
containsequivalentmethod objectmethods  method
containsequivalentmethod selectedmethods values    method
continue
if  map containskey method getname       closureindicator
selectedmethods put method getname    method
addoverridingmapcall buffer  method  closureindicator
// add interface methods
arraylist interfacemethods   new arraylist
for  int i   0  i < interfacestoimplement size    i
class thisinterface    class  interfacestoimplement get i
getinheritedmethods thisinterface  interfacemethods
for  int i   0  i < interfacemethods size    i
method method    method  interfacemethods get i
if   containsequivalentmethod publicandprotectedmethods  method
selectedmethods put method getname    method
addmapordummycall map  buffer  method
// add leftover methods from the map
for  iterator iterator   map keyset   iterator    iterator hasnext
string methodname    string  iterator next
if  methodname indexof        1    methodname indexof        1
continue
if  selectedmethods keyset   contains methodname   continue
addnewmapcall buffer  methodname
// end class
buffer append    append    append name
buffer append
if  hasargs
buffer append
buffer append
binding binding   new binding
binding setvariable    map
binding setvariable    constructorargs
classloader cl   override    null ? override   baseclass getclassloader
if  clazz    null    interfacestoimplement size   > 0
class c    class  interfacestoimplement get 0
cl   c getclassloader
groovyshell shell   new groovyshell cl  binding
if  debug
system out println     buffer tostring
try
return shell evaluate buffer tostring
catch  multiplecompilationerrorsexception err
throw new groovyruntimeexception     err getmessage
public object instantiatedelegate object delegate
return instantiatedelegate null  delegate
public object instantiatedelegate list interfaces  object delegate
return instantiatedelegate null  interfaces  delegate
public object instantiatedelegate map closuremap  list interfaces  object delegate
return instantiatedelegatewithbaseclass closuremap  interfaces  delegate  null
public object instantiatedelegatewithbaseclass map closuremap  list interfaces  object delegate
return instantiatedelegatewithbaseclass closuremap  interfaces  delegate  delegate getclass
public object instantiatedelegatewithbaseclass map closuremap  list interfaces  object delegate  class baseclass
string name   shortname delegate getclass   getname
return instantiatedelegatewithbaseclass closuremap  interfaces  delegate  baseclass  name
public object instantiatedelegatewithbaseclass map closuremap  list interfaces  object delegate  class baseclass  string name
map map   new hashmap
if  closuremap    null
map   closuremap
list selectedmethods   new arraylist
list interfacestoimplement   new arraylist
if  interfaces    null
interfacestoimplement   interfaces
stringbuffer buffer   new stringbuffer
// add class header and fields
buffer append    append name
if  baseclass    null
buffer append    append baseclass getname
for  int i   0  i < interfacestoimplement size    i
class thisinterface    class  interfacestoimplement get i
if  i    0
buffer append
else
buffer append
buffer append thisinterface getname
buffer append    append    append
// add constructor
buffer append name  append
buffer append
buffer append
buffer append
// add interface methods
arraylist interfacemethods   new arraylist
for  int i   0  i < interfacestoimplement size    i
class thisinterface    class  interfacestoimplement get i
getinheritedmethods thisinterface  interfacemethods
for  int i   0  i < interfacemethods size    i
method method    method  interfacemethods get i
if   containsequivalentmethod objectmethods  method
containsequivalentmethod groovyobjectmethods  method
selectedmethods add method getname
addwrappedcall buffer  method  map
arraylist additionalmethods   getinheritedmethods delegate getclass    new arraylist
for  int i   0  i < additionalmethods size    i
method method    method  additionalmethods get i
if  method getname   indexof        1
continue
if   containsequivalentmethod interfacemethods  method
containsequivalentmethod objectmethods  method
containsequivalentmethod groovyobjectmethods  method
selectedmethods add method getname
addwrappedcall buffer  method  map
// add leftover methods from the map
for  iterator iterator   map keyset   iterator    iterator hasnext
string methodname    string  iterator next
if  selectedmethods contains methodname   continue
addnewmapcall buffer  methodname
// end class
buffer append    append    append name
buffer append
binding binding   new binding
binding setvariable    map
binding setvariable    delegate
classloader cl   override    null ? override   delegate getclass   getclassloader
groovyshell shell   new groovyshell cl  binding
if  debug
system out println     buffer tostring
try
return shell evaluate buffer tostring
catch  multiplecompilationerrorsexception err
throw new groovyruntimeexception     err getmessage
private void addwrappedcall stringbuffer buffer  method method  map map
if  map containskey method getname
addoverridingmapcall buffer  method  false
else
class parametertypes   addmethodprefix buffer  method
addwrappedmethodbody buffer  method  parametertypes
addmethodsuffix buffer
private boolean containsequivalentmethod collection<method> publicandprotectedmethods  method candidate
for  method method   publicandprotectedmethods
if  candidate getname   equals method getname
candidate getreturntype   equals method getreturntype
hasmatchingparametertypes candidate  method
return true
return false
private boolean hasmatchingparametertypes method method  method candidate
class candidateparamtypes   candidate getparametertypes
class methodparamtypes   method getparametertypes
if  candidateparamtypes length    methodparamtypes length  return false
for  int i   0  i < methodparamtypes length  i
if   candidateparamtypes equals methodparamtypes   return false
return true
private arraylist<method> getinheritedmethods class baseclass  arraylist<method> methods
methods addall defaultgroovymethods tolist baseclass getmethods
class currentclass   baseclass
while  currentclass    null
method protectedmethods   currentclass getdeclaredmethods
for  int i   0  i < protectedmethods length  i
method method   protectedmethods
if  method getname   indexof        1
continue
if  modifier isprotected method getmodifiers        containsequivalentmethod methods  method
methods add method
currentclass   currentclass getsuperclass
return methods
private void addnewmapcall stringbuffer buffer  string methodname
buffer append    append methodname  append
append    append methodname  append
private void addoverridingmapcall stringbuffer buffer  method method  boolean closureindicator
class parametertypes   addmethodprefix buffer  method
addmethodbody buffer  closureindicator ?     method getname    parametertypes
addmethodsuffix buffer
private void addmapordummycall map map  stringbuffer buffer  method method
class parametertypes   addmethodprefix buffer  method
if  map containskey method getname
addmethodbody buffer  method getname    parametertypes
addmethodsuffix buffer
private class addmethodprefix stringbuffer buffer  method method
buffer append    append getsimplename method getreturntype
append    append method getname    append
class parametertypes   method getparametertypes
for  int parametertypeindex   0  parametertypeindex < parametertypes length  parametertypeindex
class parameter   parametertypes
if  parametertypeindex    0
buffer append
buffer append getsimplename parameter   append
append    append parametertypeindex
buffer append
return parametertypes
private void addmethodbody stringbuffer buffer  string method  class parametertypes
buffer append    append method  append
for  int j   0  j < parametertypes length  j
if  j    0
buffer append
buffer append    append j
buffer append
private void addwrappedmethodbody stringbuffer buffer  method method  class parametertypes
buffer append
for  int j   0  j < parametertypes length  j
if  j    0
buffer append
buffer append    append j
buffer append
buffer append    append method getname    append
private void addmethodsuffix stringbuffer buffer
buffer append
/**
* todo once we switch to java 1.5 bt default, use class#getsimplename() directly
*
* @param c the class of which we want the readable simple name
* @return the readable simple name
*/
public string getsimplename class c
if  c isarray
int dimension   0
class componentclass   c
while  componentclass isarray
componentclass   componentclass getcomponenttype
dimension
return componentclass getname   replaceall
defaultgroovymethods multiply    integer valueof dimension
else
return c getname   replaceall
public string shortname string name
int index   name lastindexof
if  index     1  return name
return name substring index   1  name length
private static void setmetaclass final metaclass metaclass
final metaclass newmetaclass   new delegatingmetaclass metaclass
/* (non-javadoc)
* @see groovy.lang.metaclass#invokestaticmethod(java.lang.object, java.lang.string, java.lang.object[])
*/
public object invokestaticmethod object object  string methodname  object arguments
return invokerhelper invokemethod instance  methodname  arguments
groovysystem getmetaclassregistry   setmetaclass proxygenerator class  newmetaclass