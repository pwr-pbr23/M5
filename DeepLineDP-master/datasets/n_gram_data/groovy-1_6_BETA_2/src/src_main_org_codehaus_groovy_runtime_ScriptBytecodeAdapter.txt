/*
* copyright 2003-2007 the original author or authors.
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org codehaus groovy runtime
import groovy lang
import org codehaus groovy runtime metaclass missingmethodexceptionnostack
import org codehaus groovy runtime metaclass missingmethodexecutionfailed
import org codehaus groovy runtime metaclass missingpropertyexceptionnostack
import org codehaus groovy runtime typehandling defaulttypetransformation
import org codehaus groovy runtime wrappers groovyobjectwrapper
import org codehaus groovy runtime wrappers pojowrapper
import org codehaus groovy runtime wrappers wrapper
import java util
import java util regex matcher
import java util regex pattern
/**
* a static helper class to interface bytecode and runtime
*
* @author jochen theodorou
* @version $revision$
*/
public class scriptbytecodeadapter
public static final object empty_args
private static final integer zero   integer valueof 0
private static final integer minus_one   integer valueof  1
private static final integer one   integer valueof 1
//  --------------------------------------------------------
//                   exception handling
//  --------------------------------------------------------
public static throwable unwrap groovyruntimeexception gre
if  gre instanceof missingpropertyexceptionnostack
missingpropertyexceptionnostack nostack    missingpropertyexceptionnostack  gre
return new missingpropertyexception nostack getproperty    nostack gettype
if  gre instanceof missingmethodexceptionnostack
missingmethodexceptionnostack nostack    missingmethodexceptionnostack  gre
return new missingmethodexception nostack getmethod    nostack gettype    nostack getarguments    nostack isstatic
throwable th   gre
if  th getcause      null    th getcause      gre  th   th getcause
if  th    gre     th instanceof groovyruntimeexception   return unwrap  groovyruntimeexception  th
return th
//  --------------------------------------------------------
//                       methods for this
//  --------------------------------------------------------
public static object invokemethodoncurrentn class senderclass  groovyobject receiver  string messagename  object messagearguments  throws throwable
object result   null
boolean intercepting   receiver instanceof groovyinterceptable
try
// if it's a pure interceptable object (even intercepting tostring(), clone(), ...)
if  intercepting
result   receiver invokemethod messagename  messagearguments
//else if there's a statically typed method or a gdk method
else
result   receiver getmetaclass   invokemethod senderclass  receiver  messagename  messagearguments  false  true
catch  missingmethodexception e
if  e instanceof missingmethodexecutionfailed
throw  missingmethodexception e getcause
else if   intercepting    receiver getclass      e gettype      e getmethod   equals messagename
// in case there's nothing else, invoke the object's own invokemethod()
result   receiver invokemethod messagename  messagearguments
else
throw e
return result
public static object invokemethodoncurrentnsafe class senderclass  groovyobject receiver  string messagename  object messagearguments  throws throwable
return invokemethodoncurrentn senderclass  receiver  messagename  messagearguments
public static object invokemethodoncurrentnspreadsafe class senderclass  groovyobject receiver  string messagename  object messagearguments  throws throwable
list answer   new arraylist
for  iterator it   invokerhelper asiterator receiver   it hasnext
answer add invokemethodnsafe senderclass  it next    messagename  messagearguments
return answer
public static object invokemethodoncurrent0 class senderclass  groovyobject receiver  string messagename  throws throwable
return invokemethodoncurrentn senderclass  receiver  messagename  empty_args
public static object invokemethodoncurrent0safe class senderclass  groovyobject receiver  string messagename  object messagearguments  throws throwable
return invokemethodoncurrentnsafe senderclass  receiver  messagename  empty_args
public static object invokemethodoncurrent0spreadsafe class senderclass  groovyobject receiver  string messagename  object messagearguments  throws throwable
return invokemethodoncurrentnspreadsafe senderclass  receiver  messagename  empty_args
//  --------------------------------------------------------
//                       methods for super
//  --------------------------------------------------------
public static object invokemethodonsupern class senderclass  groovyobject receiver  string messagename  object messagearguments  throws throwable
metaclass metaclass   receiver getmetaclass
// ignore interception and missing method fallback
object result   null
result   metaclass invokemethod senderclass  receiver  messagename  messagearguments  true  true
return result
public static object invokemethodonsupernsafe class senderclass  groovyobject receiver  string messagename  object messagearguments  throws throwable
return invokemethodonsupern senderclass  receiver  messagename  messagearguments
public static object invokemethodonsupernspreadsafe class senderclass  groovyobject receiver  string messagename  object messagearguments  throws throwable
list answer   new arraylist
for  iterator it   invokerhelper asiterator receiver   it hasnext
answer add invokemethodnsafe senderclass  it next    messagename  messagearguments
return answer
public static object invokemethodonsuper0 class senderclass  groovyobject receiver  string messagename  throws throwable
return invokemethodonsupern senderclass  receiver  messagename  empty_args
public static object invokemethodonsuper0safe class senderclass  groovyobject receiver  string messagename  object messagearguments  throws throwable
return invokemethodonsupernsafe senderclass  receiver  messagename  empty_args
public static object invokemethodonsuper0spreadsafe class senderclass  groovyobject receiver  string messagename  object messagearguments  throws throwable
return invokemethodonsupernspreadsafe senderclass  receiver  messagename  empty_args
//  --------------------------------------------------------
//              normal method invocation
//  --------------------------------------------------------
public static object invokemethodn class senderclass  object receiver  string messagename  object messagearguments  throws throwable
return invokerhelper invokemethod receiver  messagename  messagearguments
public static object invokemethodnsafe class senderclass  object receiver  string messagename  object messagearguments  throws throwable
if  receiver    null  return null
return invokemethodn senderclass  receiver  messagename  messagearguments
public static object invokemethodnspreadsafe class senderclass  object receiver  string messagename  object messagearguments  throws throwable
if  receiver    null  return null
list answer   new arraylist
for  iterator it   invokerhelper asiterator receiver   it hasnext
answer add invokemethodnsafe senderclass  it next    messagename  messagearguments
return answer
private static object getboxeditems object receiver
return defaulttypetransformation primitivearraytolist receiver  toarray
public static object invokemethod0 class senderclass  object receiver  string messagename  throws throwable
return invokemethodn senderclass  receiver  messagename  empty_args
public static object invokemethod0safe class senderclass  object receiver  string messagename  throws throwable
if  receiver    null  return null
return invokemethodnsafe senderclass  receiver  messagename  empty_args
public static object invokemethod0spreadsafe class senderclass  object receiver  string messagename  throws throwable
return invokemethodnspreadsafe senderclass  receiver  messagename  empty_args
//  --------------------------------------------------------
//                static normal method invocation
//  --------------------------------------------------------
public static object invokestaticmethodn class senderclass  class receiver  string messagename  object messagearguments  throws throwable
return invokerhelper invokestaticmethod receiver  messagename  messagearguments
public static object invokestaticmethod0 class senderclass  class receiver  string messagename  throws throwable
return invokestaticmethodn senderclass  receiver  messagename  empty_args
//  --------------------------------------------------------
//              normal constructor invocation (via new)
//  --------------------------------------------------------
public static object invokenewn class senderclass  class receiver  object arguments  throws throwable
return invokerhelper invokeconstructorof receiver  arguments
public static object invokenew0 class senderclass  class receiver  throws throwable
return invokenewn senderclass  receiver  empty_args
//  --------------------------------------------------------
//       special constructor invocation (via this/super)
//  --------------------------------------------------------
public static int selectconstructorandtransformarguments object arguments  int numberofconstructors  class which
metaclass metaclass   groovysystem getmetaclassregistry   getmetaclass which
return metaclass selectconstructorandtransformarguments numberofconstructors  arguments
//  --------------------------------------------------------
//              field handling super: get
//  --------------------------------------------------------
public static object getfieldonsuper class senderclass  object receiver  string messagename  throws throwable
if  receiver instanceof class
return invokerhelper getattribute receiver  messagename
else
metaclass mc     groovyobject  receiver  getmetaclass
return mc getattribute senderclass  receiver  messagename  true
public static object getfieldonsupersafe class senderclass  object receiver  string messagename  throws throwable
return getfieldonsuper senderclass  receiver  messagename
public static object getfieldonsuperspreadsafe class senderclass  object receiver  string messagename  throws throwable
list answer   new arraylist
for  iterator it   invokerhelper asiterator receiver   it hasnext
answer add getfieldonsuper senderclass  it next    messagename
return answer
//  --------------------------------------------------------
//              field handling super: set
//  --------------------------------------------------------
public static void setfieldonsuper object messageargument  class senderclass  object receiver  string messagename  throws throwable
if  receiver instanceof class
invokerhelper setattribute receiver  messagename  messageargument
else
metaclass mc     groovyobject  receiver  getmetaclass
mc setattribute senderclass  receiver  messagename  messageargument  true  true
public static void setfieldonsupersafe object messageargument  class senderclass  object receiver  string messagename  throws throwable
setfieldonsuper messageargument  senderclass  receiver  messagename
public static void setfieldonsuperspreadsafe object messageargument  class senderclass  object receiver  string messagename  throws throwable
for  iterator it   invokerhelper asiterator receiver   it hasnext
setfieldonsuper messageargument  senderclass  it next    messagename
//  --------------------------------------------------------
//              normal field handling : get
//  --------------------------------------------------------
public static object getfield class senderclass  object receiver  string messagename  throws throwable
return invokerhelper getattribute receiver  messagename
public static object getfieldsafe class senderclass  object receiver  string messagename  throws throwable
if  receiver    null  return null
return getfield senderclass  receiver  messagename
public static object getfieldspreadsafe class senderclass  object receiver  string messagename  throws throwable
if  receiver    null  return null
list answer   new arraylist
for  iterator it   invokerhelper asiterator receiver   it hasnext
answer add getfieldsafe senderclass  it next    messagename
return answer
//  --------------------------------------------------------
//              normal field handling : set
//  --------------------------------------------------------
public static void setfield object messageargument  class senderclass  object receiver  string messagename  throws throwable
invokerhelper setattribute receiver  messagename  messageargument
public static void setfieldsafe object messageargument  class senderclass  object receiver  string messagename  throws throwable
if  receiver    null  return
setfield messageargument  senderclass  receiver  messagename
public static void setfieldspreadsafe object messageargument  class senderclass  object receiver  string messagename  throws throwable
if  receiver    null  return
for  iterator it   invokerhelper asiterator receiver   it hasnext
setfieldsafe messageargument  senderclass  it next    messagename
//  --------------------------------------------------------
//              normal groovyobject field handling : get
//  --------------------------------------------------------
public static object getgroovyobjectfield class senderclass  groovyobject receiver  string messagename  throws throwable
return receiver getmetaclass   getattribute receiver  messagename
public static object getgroovyobjectfieldsafe class senderclass  groovyobject receiver  string messagename  throws throwable
if  receiver    null  return null
return receiver getmetaclass   getattribute receiver  messagename
public static object getgroovyobjectfieldspreadsafe class senderclass  groovyobject receiver  string messagename  throws throwable
if  receiver    null  return null
list answer   new arraylist
for  iterator it   invokerhelper asiterator receiver   it hasnext
answer add getfieldsafe senderclass  it next    messagename
return answer
//  --------------------------------------------------------
//              normal field handling : set
//  --------------------------------------------------------
public static void setgroovyobjectfield object messageargument  class senderclass  groovyobject receiver  string messagename  throws throwable
receiver getmetaclass   setattribute receiver  messagename  messageargument
public static void setgroovyobjectfieldsafe object messageargument  class senderclass  groovyobject receiver  string messagename  throws throwable
if  receiver    null  return
receiver getmetaclass   setattribute receiver  messagename  messageargument
public static void setgroovyobjectfieldspreadsafe object messageargument  class senderclass  groovyobject receiver  string messagename  throws throwable
if  receiver    null  return
for  iterator it   invokerhelper asiterator receiver   it hasnext
setfieldsafe messageargument  senderclass  it next    messagename
//  --------------------------------------------------------
//              property handling super: get
//  --------------------------------------------------------
public static object getpropertyonsuper class senderclass  groovyobject receiver  string messagename  throws throwable
return invokemethodonsupern senderclass  receiver     new object messagename
public static object getpropertyonsupersafe class senderclass  groovyobject receiver  string messagename  throws throwable
return getpropertyonsuper senderclass  receiver  messagename
public static object getpropertyonsuperspreadsafe class senderclass  groovyobject receiver  string messagename  throws throwable
list answer   new arraylist
for  iterator it   invokerhelper asiterator receiver   it hasnext
answer add getpropertysafe senderclass  it next    messagename
return answer
//  --------------------------------------------------------
//              property handling super: set
//  --------------------------------------------------------
public static void setpropertyonsuper object messageargument  class senderclass  groovyobject receiver  string messagename  throws throwable
invokerhelper setattribute receiver  messagename  messageargument
public static void setpropertyonsupersafe object messageargument  class senderclass  groovyobject receiver  string messagename  throws throwable
setpropertyonsuper messageargument  senderclass  receiver  messagename
public static void setpropertyonsuperspreadsafe object messageargument  class senderclass  groovyobject receiver  string messagename  throws throwable
for  iterator it   invokerhelper asiterator receiver   it hasnext
setpropertysafe messageargument  senderclass  it next    messagename
//  --------------------------------------------------------
//              normal property handling : get
//  --------------------------------------------------------
public static object getproperty class senderclass  object receiver  string messagename  throws throwable
return invokerhelper getproperty receiver  messagename
public static object getpropertysafe class senderclass  object receiver  string messagename  throws throwable
if  receiver    null  return null
return getproperty senderclass  receiver  messagename
public static object getpropertyspreadsafe class senderclass  object receiver  string messagename  throws throwable
if  receiver    null  return null
list answer   new arraylist
for  iterator it   invokerhelper asiterator receiver   it hasnext
answer add getpropertysafe senderclass  it next    messagename
return answer
//  --------------------------------------------------------
//              normal property handling : set
//  --------------------------------------------------------
public static void setproperty object messageargument  class senderclass  object receiver  string messagename  throws throwable
invokerhelper setproperty receiver  messagename  messageargument
public static void setpropertysafe object messageargument  class senderclass  object receiver  string messagename  throws throwable
if  receiver    null  return
setproperty messageargument  senderclass  receiver  messagename
public static void setpropertyspreadsafe object messageargument  class senderclass  object receiver  string messagename  throws throwable
if  receiver    null  return
for  iterator it   invokerhelper asiterator receiver   it hasnext
setpropertysafe messageargument  senderclass  it next    messagename
//  --------------------------------------------------------
//              normal groovyobject property handling : get
//  --------------------------------------------------------
public static object getgroovyobjectproperty class senderclass  groovyobject receiver  string messagename  throws throwable
return receiver getproperty messagename
public static object getgroovyobjectpropertysafe class senderclass  groovyobject receiver  string messagename  throws throwable
if  receiver    null  return null
return getgroovyobjectproperty senderclass  receiver  messagename
public static object getgroovyobjectpropertyspreadsafe class senderclass  groovyobject receiver  string messagename  throws throwable
if  receiver    null  return null
list answer   new arraylist
for  iterator it   invokerhelper asiterator receiver   it hasnext
answer add getpropertysafe senderclass  it next    messagename
return answer
//  --------------------------------------------------------
//              normal groovyobject property handling : set
//  --------------------------------------------------------
public static void setgroovyobjectproperty object messageargument  class senderclass  groovyobject receiver  string messagename  throws throwable
receiver setproperty messagename  messageargument
public static void setgroovyobjectpropertysafe object messageargument  class senderclass  groovyobject receiver  string messagename  throws throwable
if  receiver    null  return
receiver setproperty messagename  messageargument
public static void setgroovyobjectpropertyspreadsafe object messageargument  class senderclass  groovyobject receiver  string messagename  throws throwable
if  receiver    null  return
for  iterator it   invokerhelper asiterator receiver   it hasnext
setpropertysafe messageargument  senderclass  it next    messagename
//  **********************************************************************************
//  **********************************************************************************
//  **************          methods not covered by the new mop          **************
//  **********************************************************************************
//  **********************************************************************************
//  --------------------------------------------------------
//                     closures
//  --------------------------------------------------------
/**
* returns the method pointer for the given object name
*
* @param object the object containing the method
* @param methodname the name of the method of interest
* @return the resulting closure
*/
public static closure getmethodpointer object object  string methodname
return invokerhelper getmethodpointer object  methodname
// todo: set sender class
public static object invokeclosure object closure  object arguments  throws throwable
return invokemethodn closure getclass    closure     arguments
//  --------------------------------------------------------
//                     type conversion
//  --------------------------------------------------------
/**
* provides a hook for type coercion of the given object to the required type
*
* @param type   of object to convert the given object to
* @param object the object to be converted
* @return the original object or a new converted value
* @throws throwable if the coercion fails
*/
public static object astype object object  class type  throws throwable
if  object    null  object   nullobject getnullobject
return invokemethodn object getclass    object     new object type
/**
* provides a hook for type casting of the given object to the required type
*
* @param type   of object to convert the given object to
* @param object the object to be converted
* @return the original object or a new converted value
* @throws throwable if the type casting fails
*/
public static object casttotype object object  class type  throws throwable
return defaulttypetransformation casttotype object  type
public static tuple createtuple object array
return new tuple array
public static list createlist object values
return invokerhelper createlist values
public static wrapper createpojowrapper object val  class clazz
return new pojowrapper val  clazz
public static wrapper creategroovyobjectwrapper groovyobject val  class clazz
return new groovyobjectwrapper val  clazz
public static map createmap object values
return invokerhelper createmap values
//todo: refactor
public static list createrange object from  object to  boolean inclusive  throws throwable
if  from instanceof integer    to instanceof integer
int ito     integer  to  intvalue
int ifrom     integer  from  intvalue
if   inclusive
if  ifrom    ito
return new emptyrange  comparable  from
if  ifrom > ito
ito
else
ito
return new intrange ifrom  ito
else
if   inclusive
if  compareequal from  to
return new emptyrange  comparable  from
if  comparegreaterthan from  to
to   invokemethod0 scriptbytecodeadapter class  to
else
to   invokemethod0 scriptbytecodeadapter class  to
if  from instanceof integer    to instanceof integer
return new intrange defaulttypetransformation intunbox from   defaulttypetransformation intunbox from
else
return new objectrange  comparable  from   comparable  to
//assert
public static void assertfailed object expression  object message
invokerhelper assertfailed expression  message
//iscase
//todo: set sender class
public static boolean iscase object switchvalue  object caseexpression  throws throwable
if  caseexpression    null
return switchvalue    null
return defaulttypetransformation casttoboolean invokemethodn caseexpression getclass    caseexpression     new object switchvalue
//compare
public static boolean compareidentical object left  object right
return left    right
public static boolean compareequal object left  object right
return defaulttypetransformation compareequal left  right
public static boolean comparenotequal object left  object right
return  compareequal left  right
public static integer compareto object left  object right
int answer   defaulttypetransformation compareto left  right
if  answer    0
return zero
else
return answer > 0 ? one   minus_one
public static boolean comparelessthan object left  object right
return compareto left  right  intvalue   < 0
public static boolean comparelessthanequal object left  object right
return compareto left  right  intvalue   <  0
public static boolean comparegreaterthan object left  object right
return compareto left  right  intvalue   > 0
public static boolean comparegreaterthanequal object left  object right
return compareto left  right  intvalue   >  0
//regexpr
public static pattern regexpattern object regex
return defaultgroovymethods bitwisenegate regex tostring
public static matcher findregex object left  object right  throws throwable
return invokerhelper findregex left  right
public static boolean matchregex object left  object right
return invokerhelper matchregex left  right
//spread expressions
public static object despreadlist object args  object spreads  int positions
list ret   new arraylist
int argspos   0
int spreadpos   0
for  int pos   0  pos < positions length  pos
for    argspos < positions  argspos
ret add args
object value   spreads
if  value    null
ret add null
else if  value instanceof list
ret addall  list  value
else if  value getclass   isarray
ret addall defaulttypetransformation primitivearraytolist value
else
throw new illegalargumentexception     value getclass   getname         value
spreadpos
for    argspos < args length  argspos
ret add args
return ret toarray
public static object spreadmap object value
return invokerhelper spreadmap value
public static object unaryminus object value  throws throwable
return invokerhelper unaryminus value
public static object unaryplus object value
return invokerhelper unaryplus value
public static object bitwisenegate object value
return invokerhelper bitwisenegate value
public static metaclass initmetaclass object object
return invokerhelper getmetaclass object getclass