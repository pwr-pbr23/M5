/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq transport stomp
import java io ioexception
import java io serializable
import java io stringreader
import java io stringwriter
import java util hashmap
import java util map
import javax jms jmsexception
import org apache activemq command activemqmapmessage
import org apache activemq command activemqmessage
import org apache activemq command activemqobjectmessage
import org springframework beans beansexception
import org springframework context applicationcontext
import org springframework context applicationcontextaware
import com thoughtworks xstream xstream
import com thoughtworks xstream io hierarchicalstreamreader
import com thoughtworks xstream io hierarchicalstreamwriter
import com thoughtworks xstream io json jettisonmappedxmldriver
import com thoughtworks xstream io xml prettyprintwriter
import com thoughtworks xstream io xml xppreader
/**
* frame translator implementation that uses xstream to convert messages to and
* from xml and json
*
* @author <a href="mailto:dejan@nighttale.net">dejan bosanac</a>
*/
public class jmsframetranslator extends legacyframetranslator implements
applicationcontextaware
xstream xstream   null
applicationcontext applicationcontext
public activemqmessage convertframe protocolconverter converter
stompframe command  throws jmsexception  protocolexception
map headers   command getheaders
activemqmessage msg
string transformation    string  headers get stomp headers transformation
if  headers containskey stomp headers content_length     transformation equals stomp transformations jms_byte tostring
msg   super convertframe converter  command
else
hierarchicalstreamreader in
try
string text   new string command getcontent
switch  stomp transformations getvalue transformation
case jms_object_xml
in   new xppreader new stringreader text
msg   createobjectmessage in
break
case jms_object_json
in   new jettisonmappedxmldriver   createreader new stringreader text
msg   createobjectmessage in
break
case jms_map_xml
in   new xppreader new stringreader text
msg   createmapmessage in
break
case jms_map_json
in   new jettisonmappedxmldriver   createreader new stringreader text
msg   createmapmessage in
break
default
throw new exception     transformation
catch  throwable e
command getheaders   put stomp headers transformation_error  e getmessage
msg   super convertframe converter  command
frametranslator helper copystandardheadersfromframetomessage converter  command  msg  this
return msg
public stompframe convertmessage protocolconverter converter
activemqmessage message  throws ioexception  jmsexception
if  message getdatastructuretype      activemqobjectmessage data_structure_type
stompframe command   new stompframe
command setaction stomp responses message
map<string  string> headers   new hashmap<string  string> 25
command setheaders headers
frametranslator helper copystandardheadersfrommessagetoframe
converter  message  command  this
activemqobjectmessage msg    activemqobjectmessage  message copy
command setcontent marshall msg getobject
headers get stomp headers transformation
getbytes
return command
else if  message getdatastructuretype      activemqmapmessage data_structure_type
stompframe command   new stompframe
command setaction stomp responses message
map<string  string> headers   new hashmap<string  string> 25
command setheaders headers
frametranslator helper copystandardheadersfrommessagetoframe
converter  message  command  this
activemqmapmessage msg    activemqmapmessage  message copy
command setcontent marshall  serializable msg getcontentmap
headers get stomp headers transformation
getbytes
return command
else
return super convertmessage converter  message
/**
* marshalls the object to a string using xml or json encoding
*/
protected string marshall serializable object  string transformation
throws jmsexception
stringwriter buffer   new stringwriter
hierarchicalstreamwriter out
if  transformation tolowercase   endswith
out   new jettisonmappedxmldriver   createwriter buffer
else
out   new prettyprintwriter buffer
getxstream   marshal object  out
return buffer tostring
protected activemqobjectmessage createobjectmessage hierarchicalstreamreader in  throws jmsexception
activemqobjectmessage objmsg   new activemqobjectmessage
object obj   getxstream   unmarshal in
objmsg setobject  serializable  obj
return objmsg
protected activemqmapmessage createmapmessage hierarchicalstreamreader in  throws jmsexception
activemqmapmessage mapmsg   new activemqmapmessage
map<string  object> map    map<string  object> getxstream   unmarshal in
for  string key   map keyset
mapmsg setobject key  map get key
return mapmsg
// properties
// -------------------------------------------------------------------------
public xstream getxstream
if  xstream    null
xstream   createxstream
return xstream
public void setxstream xstream xstream
this xstream   xstream
// implementation methods
// -------------------------------------------------------------------------
protected xstream createxstream
xstream xstream   null
if  applicationcontext    null
string names   applicationcontext
getbeannamesfortype xstream class
for  int i   0  i < names length  i
string name   names
xstream    xstream  applicationcontext getbean name
if  xstream    null
break
if  xstream    null
xstream   new xstream
return xstream
public void setapplicationcontext applicationcontext applicationcontext
throws beansexception
this applicationcontext   applicationcontext