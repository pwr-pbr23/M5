/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq util
import java io ioexception
import java sql sqlexception
import java util concurrent timeunit
import java util concurrent atomic atomicboolean
import org apache activemq broker brokerservice
import org slf4j logger
import org slf4j loggerfactory
/**
* @org.apache.xbean.xbean
*/
public class defaultioexceptionhandler implements ioexceptionhandler
private static final logger log   loggerfactory
getlogger defaultioexceptionhandler class
protected brokerservice broker
private boolean ignoreallerrors   false
private boolean ignorenospaceerrors   true
private boolean ignoresqlexceptions   true
private boolean stopstartconnectors   false
private string nospacemessage
private string sqlexceptionmessage         match all
private long resumechecksleepperiod   5 1000
private atomicboolean stopstartinprogress   new atomicboolean false
public void handle ioexception exception
if  ignoreallerrors
log info     exception  exception
return
if  ignorenospaceerrors
throwable cause   exception
while  cause    null    cause instanceof ioexception
string message   cause getmessage
if  message    null    message contains nospacemessage
log info     exception  exception
return
cause   cause getcause
if  ignoresqlexceptions
throwable cause   exception
while  cause    null
string message   cause getmessage
if  cause instanceof sqlexception    message contains sqlexceptionmessage
log info     exception  cause
return
cause   cause getcause
if  stopstartconnectors
if   stopstartinprogress compareandset false  true
// we are already working on it
return
log info     exception  exception
new thread
public void run
try
servicestopper stopper   new servicestopper
broker stopallconnectors stopper
catch  exception e
log warn    e
start
// resume again
new thread
public void run
try
while  haslockownership      ispersistenceadapterdown
log info
timeunit milliseconds sleep resumechecksleepperiod
broker startallconnectors
catch  exception e
log warn    e
stopbroker e
finally
stopstartinprogress compareandset true  false
private boolean ispersistenceadapterdown
boolean checkpointsuccess   false
try
broker getpersistenceadapter   checkpoint true
checkpointsuccess   true
catch  throwable ignored
return  checkpointsuccess
start
return
stopbroker exception
private void stopbroker exception exception
log info     exception  exception
new thread
public void run
try
broker stop
catch  exception e
log warn    e
start
protected boolean haslockownership   throws ioexception
return true
public void setbrokerservice brokerservice broker
this broker   broker
public boolean isignoreallerrors
return ignoreallerrors
public void setignoreallerrors boolean ignoreallerrors
this ignoreallerrors   ignoreallerrors
public boolean isignorenospaceerrors
return ignorenospaceerrors
public void setignorenospaceerrors boolean ignorenospaceerrors
this ignorenospaceerrors   ignorenospaceerrors
public string getnospacemessage
return nospacemessage
public void setnospacemessage string nospacemessage
this nospacemessage   nospacemessage
public boolean isignoresqlexceptions
return ignoresqlexceptions
public void setignoresqlexceptions boolean ignoresqlexceptions
this ignoresqlexceptions   ignoresqlexceptions
public string getsqlexceptionmessage
return sqlexceptionmessage
public void setsqlexceptionmessage string sqlexceptionmessage
this sqlexceptionmessage   sqlexceptionmessage
public boolean isstopstartconnectors
return stopstartconnectors
public void setstopstartconnectors boolean stopstartconnectors
this stopstartconnectors   stopstartconnectors
public long getresumechecksleepperiod
return resumechecksleepperiod
public void setresumechecksleepperiod long resumechecksleepperiod
this resumechecksleepperiod   resumechecksleepperiod