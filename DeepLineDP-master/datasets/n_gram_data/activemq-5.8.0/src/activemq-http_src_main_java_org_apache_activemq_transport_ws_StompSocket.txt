/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq transport ws
import java io ioexception
import java util concurrent countdownlatch
import org apache activemq command command
import org apache activemq transport transportsupport
import org apache activemq transport stomp protocolconverter
import org apache activemq transport stomp stomp
import org apache activemq transport stomp stompframe
import org apache activemq transport stomp stompinactivitymonitor
import org apache activemq transport stomp stomptransport
import org apache activemq transport stomp stompwireformat
import org apache activemq util bytesequence
import org apache activemq util ioexceptionsupport
import org apache activemq util servicestopper
import org eclipse jetty websocket websocket
import org slf4j logger
import org slf4j loggerfactory
/**
* implements web socket and mediates between servlet and the broker
*/
class stompsocket extends transportsupport implements websocket ontextmessage  stomptransport
private static final logger log   loggerfactory getlogger stompsocket class
connection outbound
protocolconverter protocolconverter   new protocolconverter this  null
stompwireformat wireformat   new stompwireformat
private final countdownlatch sockettransportstarted   new countdownlatch 1
@override
public void onopen connection connection
this outbound   connection
@override
public void onclose int closecode  string message
try
protocolconverter onstompcommand new stompframe stomp commands disconnect
catch  exception e
log warn    e
@override
public void onmessage string data
if   transportstartedatleastonce
log debug
try
sockettransportstarted await
catch  interruptedexception e
log warn
try
protocolconverter onstompcommand  stompframe wireformat unmarshal new bytesequence data getbytes
catch  exception e
onexception ioexceptionsupport create e
private boolean transportstartedatleastonce
return sockettransportstarted getcount      0
@override
protected void dostart   throws exception
sockettransportstarted countdown
@override
protected void dostop servicestopper stopper  throws exception
@override
public int getreceivecounter
return 0
@override
public string getremoteaddress
return     this hashcode
@override
public void oneway object command  throws ioexception
try
protocolconverter onactivemqcommand  command command
catch  exception e
onexception ioexceptionsupport create e
@override
public void sendtoactivemq command command
doconsume command
@override
public void sendtostomp stompframe command  throws ioexception
outbound sendmessage command format
@override
public stompinactivitymonitor getinactivitymonitor
return null
@override
public stompwireformat getwireformat
return this wireformat