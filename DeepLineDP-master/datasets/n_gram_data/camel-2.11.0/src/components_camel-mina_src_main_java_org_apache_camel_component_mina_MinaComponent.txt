/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component mina
import java net inetsocketaddress
import java net socketaddress
import java net uri
import java nio charset charset
import java util list
import java util map
import java util concurrent executorservice
import org apache camel camelcontext
import org apache camel endpoint
import org apache camel exchangepattern
import org apache camel impl defaultcomponent
import org apache camel util objecthelper
import org apache mina common defaultiofilterchainbuilder
import org apache mina common ioacceptor
import org apache mina common ioconnector
import org apache mina common iofilter
import org apache mina common ioserviceconfig
import org apache mina common threadmodel
import org apache mina filter loggingfilter
import org apache mina filter codec protocolcodecfactory
import org apache mina filter codec protocolcodecfilter
import org apache mina filter codec serialization objectserializationcodecfactory
import org apache mina filter codec textline linedelimiter
import org apache mina filter executor executorfilter
import org apache mina transport socket nio datagramacceptor
import org apache mina transport socket nio datagramacceptorconfig
import org apache mina transport socket nio datagramconnector
import org apache mina transport socket nio datagramconnectorconfig
import org apache mina transport socket nio socketacceptor
import org apache mina transport socket nio socketacceptorconfig
import org apache mina transport socket nio socketconnector
import org apache mina transport socket nio socketconnectorconfig
import org apache mina transport vmpipe vmpipeacceptor
import org apache mina transport vmpipe vmpipeaddress
import org apache mina transport vmpipe vmpipeconnector
import org slf4j logger
import org slf4j loggerfactory
/**
* component for apache mina.
*
* @version
*/
public class minacomponent extends defaultcomponent
private static final transient logger log   loggerfactory getlogger minacomponent class
private minaconfiguration configuration
public minacomponent
public minacomponent camelcontext context
super context
@override
protected endpoint createendpoint string uri  string remaining  map<string  object> parameters  throws exception
// using the configuration which set by the component as a default one
// since the configuration's properties will be set by the uri
// we need to copy or create a new minaconfiguration here
minaconfiguration config
if  configuration    null
config   configuration copy
else
config   new minaconfiguration
uri u   new uri remaining
config sethost u gethost
config setport u getport
config setprotocol u getscheme
config setfilters resolveandremovereferencelistparameter parameters     iofilter class
setproperties config  parameters
return createendpoint uri  config
public endpoint createendpoint minaconfiguration config  throws exception
return createendpoint null  config
private endpoint createendpoint string uri  minaconfiguration config  throws exception
objecthelper notnull getcamelcontext
string protocol   config getprotocol
// if mistyped uri then protocol can be null
if  protocol    null
if  protocol equals
return createsocketendpoint uri  config
else if  config isdatagramprotocol
return createdatagramendpoint uri  config
else if  protocol equals
return createvmendpoint uri  config
// protocol not resolved so error
throw new illegalargumentexception     protocol       uri
// implementation methods
//-------------------------------------------------------------------------
protected minaendpoint createvmendpoint string uri  minaconfiguration configuration
boolean minalogger   configuration isminalogger
boolean sync   configuration issync
list<iofilter> filters   configuration getfilters
ioacceptor acceptor   new vmpipeacceptor
socketaddress address   new vmpipeaddress configuration getport
ioconnector connector   new vmpipeconnector
// connector config
configurecodecfactory    connector getdefaultconfig    configuration
if  minalogger
connector getfilterchain   addlast    new loggingfilter
appendiofilterstochain filters  connector getfilterchain
// acceptor connectorconfig
configurecodecfactory    acceptor getdefaultconfig    configuration
if  minalogger
acceptor getfilterchain   addlast    new loggingfilter
appendiofilterstochain filters  acceptor getfilterchain
minaendpoint endpoint   new minaendpoint uri  this
endpoint setaddress address
endpoint setacceptor acceptor
endpoint setconnector connector
endpoint setconfiguration configuration
// set sync or async mode after endpoint is created
if  sync
endpoint setexchangepattern exchangepattern inout
else
endpoint setexchangepattern exchangepattern inonly
return endpoint
protected minaendpoint createsocketendpoint string uri  minaconfiguration configuration
boolean minalogger   configuration isminalogger
long timeout   configuration gettimeout
boolean sync   configuration issync
list<iofilter> filters   configuration getfilters
final int processorcount   runtime getruntime   availableprocessors     1
executorservice acceptorpool   getcamelcontext   getexecutorservicemanager   newcachedthreadpool this
executorservice connectorpool   getcamelcontext   getexecutorservicemanager   newcachedthreadpool this
executorservice workerpool   getcamelcontext   getexecutorservicemanager   newcachedthreadpool this
ioacceptor acceptor   new socketacceptor processorcount  acceptorpool
ioconnector connector   new socketconnector processorcount  connectorpool
socketaddress address   new inetsocketaddress configuration gethost    configuration getport
// connector config
socketconnectorconfig connectorconfig   new socketconnectorconfig
// must use manual thread model according to mina documentation
connectorconfig setthreadmodel threadmodel manual
configurecodecfactory    connectorconfig  configuration
connectorconfig getfilterchain   addlast    new executorfilter workerpool
if  minalogger
connectorconfig getfilterchain   addlast    new loggingfilter
appendiofilterstochain filters  connectorconfig getfilterchain
// set connect timeout to mina in seconds
connectorconfig setconnecttimeout  int   timeout   1000
// acceptor connectorconfig
socketacceptorconfig acceptorconfig   new socketacceptorconfig
// must use manual thread model according to mina documentation
acceptorconfig setthreadmodel threadmodel manual
configurecodecfactory    acceptorconfig  configuration
acceptorconfig setreuseaddress true
acceptorconfig setdisconnectonunbind true
acceptorconfig getfilterchain   addlast    new executorfilter workerpool
if  minalogger
acceptorconfig getfilterchain   addlast    new loggingfilter
appendiofilterstochain filters  acceptorconfig getfilterchain
minaendpoint endpoint   new minaendpoint uri  this
endpoint setaddress address
endpoint setacceptor acceptor
endpoint setacceptorconfig acceptorconfig
endpoint setconnector connector
endpoint setconnectorconfig connectorconfig
endpoint setconfiguration configuration
// enlist threads pools in use on endpoint
endpoint addthreadpool acceptorpool
endpoint addthreadpool connectorpool
endpoint addthreadpool workerpool
// set sync or async mode after endpoint is created
if  sync
endpoint setexchangepattern exchangepattern inout
else
endpoint setexchangepattern exchangepattern inonly
return endpoint
protected void configurecodecfactory string type  ioserviceconfig config  minaconfiguration configuration
if  configuration getcodec      null
addcodecfactory config  configuration getcodec
else if  configuration isallowdefaultcodec
configuredefaultcodecfactory type  config  configuration
protected void configuredefaultcodecfactory string type  ioserviceconfig config  minaconfiguration configuration
if  configuration istextline
charset charset   getencodingparameter type  configuration
linedelimiter delimiter   getlinedelimiterparameter configuration gettextlinedelimiter
textlinecodecfactory codecfactory   new textlinecodecfactory charset  delimiter
if  configuration getencodermaxlinelength   > 0
codecfactory setencodermaxlinelength configuration getencodermaxlinelength
if  configuration getdecodermaxlinelength   > 0
codecfactory setdecodermaxlinelength configuration getdecodermaxlinelength
addcodecfactory config  codecfactory
if  log isdebugenabled
log debug
new object type  codecfactory  charset  configuration gettextlinedelimiter    delimiter
log debug
codecfactory getencodermaxlinelength    codecfactory getdecodermaxlinelength
else
objectserializationcodecfactory codecfactory   new objectserializationcodecfactory
addcodecfactory config  codecfactory
log debug    type  codecfactory
protected minaendpoint createdatagramendpoint string uri  minaconfiguration configuration
boolean minalogger   configuration isminalogger
long timeout   configuration gettimeout
boolean transferexchange   configuration istransferexchange
boolean sync   configuration issync
list<iofilter> filters   configuration getfilters
executorservice acceptorpool   getcamelcontext   getexecutorservicemanager   newcachedthreadpool this
executorservice connectorpool   getcamelcontext   getexecutorservicemanager   newcachedthreadpool this
executorservice workerpool   getcamelcontext   getexecutorservicemanager   newcachedthreadpool this
ioacceptor acceptor   new datagramacceptor acceptorpool
ioconnector connector   new datagramconnector connectorpool
socketaddress address   new inetsocketaddress configuration gethost    configuration getport
if  transferexchange
throw new illegalargumentexception
datagramconnectorconfig connectorconfig   new datagramconnectorconfig
// must use manual thread model according to mina documentation
connectorconfig setthreadmodel threadmodel manual
configuredatagramcodecfactory    connectorconfig  configuration
connectorconfig getfilterchain   addlast    new executorfilter workerpool
if  minalogger
connectorconfig getfilterchain   addlast    new loggingfilter
appendiofilterstochain filters  connectorconfig getfilterchain
// set connect timeout to mina in seconds
connectorconfig setconnecttimeout  int   timeout   1000
datagramacceptorconfig acceptorconfig   new datagramacceptorconfig
// must use manual thread model according to mina documentation
acceptorconfig setthreadmodel threadmodel manual
configuredatagramcodecfactory    acceptorconfig  configuration
acceptorconfig setdisconnectonunbind true
// reuse address is default true for datagram
acceptorconfig getfilterchain   addlast    new executorfilter workerpool
if  minalogger
acceptorconfig getfilterchain   addlast    new loggingfilter
appendiofilterstochain filters  acceptorconfig getfilterchain
minaendpoint endpoint   new minaendpoint uri  this
endpoint setaddress address
endpoint setacceptor acceptor
endpoint setacceptorconfig acceptorconfig
endpoint setconnector connector
endpoint setconnectorconfig connectorconfig
endpoint setconfiguration configuration
// enlist threads pools in use on endpoint
endpoint addthreadpool acceptorpool
endpoint addthreadpool connectorpool
endpoint addthreadpool workerpool
// set sync or async mode after endpoint is created
if  sync
endpoint setexchangepattern exchangepattern inout
else
endpoint setexchangepattern exchangepattern inonly
return endpoint
/**
* for datagrams the entire message is available as a single bytebuffer so lets just pass those around by default
* and try converting whatever they payload is into bytebuffers unless some custom converter is specified
*/
protected void configuredatagramcodecfactory final string type  final ioserviceconfig config  final minaconfiguration configuration
protocolcodecfactory codecfactory   configuration getcodec
if  codecfactory    null
final charset charset   getencodingparameter type  configuration
codecfactory   new minaudpprotocolcodecfactory getcamelcontext    charset
if  log isdebugenabled
log debug    new object type  codecfactory  charset
addcodecfactory config  codecfactory
private void addcodecfactory ioserviceconfig config  protocolcodecfactory codecfactory
config getfilterchain   addlast    new protocolcodecfilter codecfactory
private static linedelimiter getlinedelimiterparameter textlinedelimiter delimiter
if  delimiter    null
return linedelimiter default
switch  delimiter
case default
return linedelimiter default
case auto
return linedelimiter auto
case unix
return linedelimiter unix
case windows
return linedelimiter windows
case mac
return linedelimiter mac
default
throw new illegalargumentexception     delimiter
private static charset getencodingparameter string type  minaconfiguration configuration
string encoding   configuration getencoding
if  encoding    null
encoding   charset defaultcharset   name
// set in on configuration so its updated
configuration setencoding encoding
log debug    type  encoding
if   charset issupported encoding
throw new illegalargumentexception     encoding
return charset forname encoding
private void appendiofilterstochain list<iofilter> filters  defaultiofilterchainbuilder filterchain
if  filters    null    filters size   > 0
for  iofilter iofilter   filters
filterchain addlast iofilter getclass   getcanonicalname    iofilter
// properties
//-------------------------------------------------------------------------
public minaconfiguration getconfiguration
return configuration
public void setconfiguration minaconfiguration configuration
this configuration   configuration