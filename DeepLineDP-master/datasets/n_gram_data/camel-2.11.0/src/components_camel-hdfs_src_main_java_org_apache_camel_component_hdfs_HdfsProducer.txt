/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component hdfs
import java io ioexception
import java util list
import java util concurrent scheduledexecutorservice
import java util concurrent timeunit
import java util concurrent atomic atomicboolean
import javax security auth login configuration
import org apache camel exchange
import org apache camel impl defaultproducer
import org apache camel util iohelper
public class hdfsproducer extends defaultproducer
private final hdfsconfiguration config
private final stringbuilder hdfspath
private final atomicboolean idle   new atomicboolean false
private volatile scheduledexecutorservice scheduler
private volatile hdfsoutputstream ostream
private long splitnum
public static final class splitstrategy
private splitstrategytype type
private long value
public splitstrategy splitstrategytype type  long value
this type   type
this value   value
public splitstrategytype gettype
return type
public long getvalue
return value
public enum splitstrategytype
bytes
@override
public boolean split hdfsoutputstream oldostream  long value  hdfsproducer producer
return oldostream getnumofwrittenbytes   >  value
messages
@override
public boolean split hdfsoutputstream oldostream  long value  hdfsproducer producer
return oldostream getnumofwrittenmessages   >  value
idle
@override
public boolean split hdfsoutputstream oldostream  long value  hdfsproducer producer
return producer idle get
public abstract boolean split hdfsoutputstream oldostream  long value  hdfsproducer producer
public hdfsproducer hdfsendpoint endpoint  hdfsconfiguration config
super endpoint
this config   config
this hdfspath   config getfilesystemtype   gethdfspath config
@override
public hdfsendpoint getendpoint
return  hdfsendpoint  super getendpoint
@override
protected void dostart   throws exception
// need to remember auth as hadoop will override that, which otherwise means the auth is broken afterwards
configuration auth   configuration getconfiguration
log trace    auth
try
super dostart
// setup hdfs if configured to do on startup
if  getendpoint   getconfig   isconnectonstartup
ostream   setuphdfs true
splitstrategy idlestrategy   null
for  splitstrategy strategy   config getsplitstrategies
if  strategy type    splitstrategytype idle
idlestrategy   strategy
break
if  idlestrategy    null
scheduler   getendpoint   getcamelcontext   getexecutorservicemanager   newsinglethreadscheduledexecutor this
log debug    config getcheckidleinterval
scheduler scheduleatfixedrate new idlecheck idlestrategy   config getcheckidleinterval    config getcheckidleinterval    timeunit milliseconds
finally
if  auth    null
log trace    auth
configuration setconfiguration auth
private synchronized hdfsoutputstream setuphdfs boolean onstartup  throws exception
if  ostream    null
return ostream
stringbuilder actualpath   new stringbuilder hdfspath
if  config getsplitstrategies   size   > 0
actualpath   newfilename
// if we are starting up then log at info level, and if runtime then log at debug level to not flood the log
if  onstartup
log info    new object config gethostname    config getport    actualpath tostring
else
if  log isdebugenabled
log debug    new object config gethostname    config getport    actualpath tostring
hdfsoutputstream answer   hdfsoutputstream createoutputstream actualpath tostring    config
if  onstartup
log info    new object config gethostname    config getport    actualpath tostring
else
if  log isdebugenabled
log debug    new object config gethostname    config getport    actualpath tostring
return answer
@override
protected void dostop   throws exception
super dostop
if  scheduler    null
getendpoint   getcamelcontext   getexecutorservicemanager   shutdown scheduler
scheduler   null
if  ostream    null
iohelper close ostream     log
ostream   null
@override
public void process exchange exchange  throws exception
// need to remember auth as hadoop will override that, which otherwise means the auth is broken afterwards
configuration auth   configuration getconfiguration
log trace    auth
try
doprocess exchange
finally
if  auth    null
log trace    auth
configuration setconfiguration auth
void doprocess exchange exchange  throws exception
object body   exchange getin   getbody
object key   exchange getin   getheader hdfsheader key name
// must have ostream
if  ostream    null
ostream   setuphdfs false
boolean split   false
list<splitstrategy> strategies   config getsplitstrategies
for  splitstrategy splitstrategy   strategies
split    splitstrategy gettype   split ostream  splitstrategy value  this
if  split
if  ostream    null
iohelper close ostream     log
stringbuilder actualpath   newfilename
ostream   hdfsoutputstream createoutputstream actualpath tostring    config
string path   ostream getactualpath
log trace    path
ostream append key  body  exchange getcontext   gettypeconverter
idle set false
// close if we do not have idle checker task to do this for us
boolean close   scheduler    null
// but user may have a header to explict control the close
boolean closeheader   exchange getin   getheader hdfsconstants hdfs_close  boolean class
if  closeheader    null
close   closeheader
// if no idle checker then we need to explicit close the stream after usage
if  close
try
hdfsproducer this log trace
ostream close
ostream   null
catch  ioexception e
// ignore
log debug    path
private stringbuilder newfilename
stringbuilder actualpath   new stringbuilder hdfspath
actualpath append splitnum
splitnum
return actualpath
/**
* idle check background task
*/
private final class idlecheck implements runnable
private final splitstrategy strategy
private idlecheck splitstrategy strategy
this strategy   strategy
@override
public void run
// only run if ostream has been created
if  ostream    null
return
hdfsproducer this log trace
if  system currenttimemillis     ostream getlastaccess   > strategy value     idle get       ostream isbusy   get
idle set true
try
hdfsproducer this log trace
ostream close
catch  ioexception e
// ignore
@override
public string tostring
return