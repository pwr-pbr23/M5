/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component gae http
import java io bytearrayinputstream
import java io inputstream
import java net url
import java util zip gzipinputstream
import javax servlet http httpservletrequest
import javax servlet http httpservletresponse
import com google appengine api urlfetch httpheader
import com google appengine api urlfetch httpmethod
import com google appengine api urlfetch httprequest
import com google appengine api urlfetch httpresponse
import org apache camel exchange
import org apache camel message
import org apache camel component gae bind inboundbinding
import org apache camel component gae bind outboundbinding
import org apache camel spi headerfilterstrategy
import org apache camel util unsafeuricharactersencoder
import static org apache camel component gae http ghttpendpoint getendpointurl
import static org apache camel util gziphelper isgzip
/**
* binds the {@link httprequest}/{@link httpresponse} pair of the url fetch
* service to a camel {@link exchange}.
*/
public class ghttpbinding implements
outboundbinding <ghttpendpoint  httprequest  httpresponse>
inboundbinding  <ghttpendpoint  httpservletrequest  httpservletresponse>
// ----------------------------------------------------------------
//  outbound binding
// ----------------------------------------------------------------
/**
* reads data from <code>response</code> and writes it to the out-message of
* the <code>exchange</code>.
*
* @return the original <code>exchange</code> instance populated with response data.
* @throws ghttpexception if the response code is >= 400 and
*             {@link ghttpendpoint#isthrowexceptiononfailure()} returns
*             <code>true</code>.
*/
public exchange readresponse ghttpendpoint endpoint  exchange exchange  httpresponse response  throws exception
int responsecode   response getresponsecode
readresponseheaders endpoint  exchange  response
readresponsebody endpoint  exchange  response
if  responsecode >  400    endpoint isthrowexceptiononfailure
throw new ghttpexception responsecode
exchange getout   getbody inputstream class
exchange getout   getheaders
return exchange
/**
* reads data from <code>exchange</code> and writes it to a newly created
* {@link httprequest} instance. the <code>request</code> parameter is
* ignored.
*
* @return a newly created {@link httprequest} instance containing data from
*         <code>exchange</code>.
*/
public httprequest writerequest ghttpendpoint endpoint  exchange exchange  httprequest request  throws exception
httprequest answer   new httprequest
getrequesturl endpoint  exchange
getrequestmethod endpoint  exchange
writerequestheaders endpoint  exchange  answer
writerequestbody endpoint  exchange  answer
return answer
// ----------------------------------------------------------------
//  inbound binding
// ----------------------------------------------------------------
public exchange readrequest ghttpendpoint endpoint  exchange exchange  httpservletrequest request
readrequestheaders endpoint  exchange  request
return exchange
public httpservletresponse writeresponse ghttpendpoint endpoint  exchange exchange  httpservletresponse response
return response
// ----------------------------------------------------------------
//  customization points
// ----------------------------------------------------------------
protected void readresponseheaders ghttpendpoint endpoint  exchange exchange  httpresponse response
headerfilterstrategy strategy   endpoint getheaderfilterstrategy
message in   exchange getin
message out   exchange getout
out setheaders in getheaders
out setheader exchange http_response_code  response getresponsecode
string contenttype   getresponseheader    response
if  contenttype    null
out setheader exchange content_type  contenttype
for  httpheader header   response getheaders
string name   header getname
string value   header getvalue
if  strategy    null     strategy applyfiltertoexternalheaders name  value  exchange
out setheader name  value
protected void readrequestheaders ghttpendpoint endpoint  exchange exchange  httpservletrequest request
// experimental // todo: resolve gzip encoding issues
exchange getin   removeheader
exchange getin   removeheader
protected void writerequestheaders ghttpendpoint endpoint  exchange exchange  httprequest request
headerfilterstrategy strategy   endpoint getheaderfilterstrategy
for  string headername   exchange getin   getheaders   keyset
string headervalue   exchange getin   getheader headername  string class
if  strategy    null     strategy applyfiltertocamelheaders headername  headervalue  exchange
request addheader new httpheader headername  headervalue
protected void readresponsebody ghttpendpoint endpoint  exchange exchange  httpresponse response  throws exception
byte content   response getcontent
if  content    null
inputstream stream   new bytearrayinputstream content
if  isgzip getresponseheader    response
stream   new gzipinputstream stream
exchange getout   setbody stream
protected void writerequestbody ghttpendpoint endpoint  exchange exchange  httprequest request
request setpayload exchange getin   getbody byte class
protected url getrequesturl ghttpendpoint endpoint  exchange exchange  throws exception
string uri   exchange getin   getheader exchange http_uri  string class
string query   exchange getin   getheader exchange http_query  string class
if  uri    null     endpoint isbridgeendpoint
return getendpointurl unsafeuricharactersencoder encode uri   query
return getendpointurl endpoint getendpointuri    query
protected httpmethod getrequestmethod ghttpendpoint endpoint  exchange exchange
string method    string exchange getin   getheader exchange http_method
if  method    null
return httpmethod valueof method
else if  exchange getin   getbody      null
return httpmethod post
else
return httpmethod get
protected string getresponseheader string name  httpresponse response
for  httpheader header   response getheaders
if  header getname   equalsignorecase name
return header getvalue
return null