/**
* copyright 2011 the apache software foundation
*
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hbase master handler
import java util list
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop hbase hregioninfo
import org apache hadoop hbase server
import org apache hadoop hbase servername
import org apache hadoop hbase executor eventhandler
import org apache hadoop hbase master assignmentmanager
import org apache hadoop hbase zookeeper zkassign
import org apache hadoop hbase zookeeper zkutil
import org apache zookeeper keeperexception
import org apache zookeeper keeperexception nonodeexception
/**
* handles split region event on master.
*/
public class splitregionhandler extends eventhandler implements toteshregioninfo
private static final log log   logfactory getlog splitregionhandler class
private final assignmentmanager assignmentmanager
private final hregioninfo parent
private final servername sn
private final list<hregioninfo> daughters
/**
* for testing only!  set to true to skip handling of split.
*/
public static boolean test_skip   false
public splitregionhandler server server
assignmentmanager assignmentmanager  hregioninfo regioninfo
servername sn  final list<hregioninfo> daughters
super server  eventtype rs_zk_region_split
this assignmentmanager   assignmentmanager
this parent   regioninfo
this sn   sn
this daughters   daughters
@override
public hregioninfo gethregioninfo
return this parent
@override
public string tostring
string name
if server    null    server getservername      null
name   server getservername   tostring
string parentregion
if parent    null
parentregion   parent getregionnameasstring
return getclass   getsimplename         name       getseqid         parentregion
@override
public void process
string encodedregionname   this parent getencodedname
log debug     encodedregionname
// the below is for testing only!  we can't do fault injection easily, so
// resort to this kinda uglyness -- st.ack 02/25/2011.
if  test_skip
log warn
return
this assignmentmanager handlesplitreport this sn  this parent
this daughters get 0   this daughters get 1
// remove region from zk
try
boolean successful   false
while   successful
// it's possible that the rs tickles in between the reading of the
// znode and the deleting, so it's safe to retry.
successful   zkassign deletenode this server getzookeeper
encodedregionname
eventhandler eventtype rs_zk_region_split
catch  keeperexception e
if  e instanceof nonodeexception
string znodepath   zkutil joinznode
this server getzookeeper   splitlogznode  encodedregionname
log debug     znodepath
else
server abort
parent getencodedname        e
log info
this parent getregionnameasstring
this daughters get 0  getregionnameasstring
this daughters get 1  getregionnameasstring