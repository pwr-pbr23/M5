/**
* copyright 2011 the apache software foundation
*
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hbase thrift2
import java net inetaddress
import java net inetsocketaddress
import java net unknownhostexception
import java util list
import java util concurrent executorservice
import java util concurrent linkedblockingqueue
import java util concurrent threadpoolexecutor
import java util concurrent timeunit
import org apache commons cli commandline
import org apache commons cli commandlineparser
import org apache commons cli helpformatter
import org apache commons cli option
import org apache commons cli optiongroup
import org apache commons cli options
import org apache commons cli parseexception
import org apache commons cli posixparser
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop conf configuration
import org apache hadoop hbase hbaseconfiguration
import org apache hadoop hbase thrift callqueue
import org apache hadoop hbase thrift callqueue call
import org apache hadoop hbase thrift thriftmetrics
import org apache hadoop hbase thrift2 generated thbaseservice
import org apache thrift protocol tbinaryprotocol
import org apache thrift protocol tcompactprotocol
import org apache thrift protocol tprotocolfactory
import org apache thrift server thshaserver
import org apache thrift server tnonblockingserver
import org apache thrift server tserver
import org apache thrift server tthreadpoolserver
import org apache thrift transport tframedtransport
import org apache thrift transport tnonblockingserversocket
import org apache thrift transport tnonblockingservertransport
import org apache thrift transport tserversocket
import org apache thrift transport tservertransport
import org apache thrift transport ttransportexception
import org apache thrift transport ttransportfactory
import com google common util concurrent threadfactorybuilder
/**
* thriftserver - this class starts up a thrift server which implements the hbase api specified in the
* hbaseclient.thrift idl file.
*/
public class thriftserver
private static final log log   logfactory getlog thriftserver class
public static final string default_listen_port
public thriftserver
private static void printusage
helpformatter formatter   new helpformatter
formatter printhelp    null  getoptions
true
private static options getoptions
options options   new options
options addoption       true
options addoption       true      default_listen_port
options addoption       false
options addoption       false
options addoption       false
optiongroup servers   new optiongroup
servers addoption
new option    false
servers addoption new option    false
servers addoption new option    false
options addoptiongroup servers
return options
private static commandline parsearguments options options  string args  throws parseexception
commandlineparser parser   new posixparser
return parser parse options  args
private static tprotocolfactory gettprotocolfactory boolean iscompact
if  iscompact
log debug
return new tcompactprotocol factory
else
log debug
return new tbinaryprotocol factory
private static ttransportfactory getttransportfactory boolean framed
if  framed
log debug
return new tframedtransport factory
else
return new ttransportfactory
/*
* if bindvalue is null, we don't bind.
*/
private static inetsocketaddress bindtoport string bindvalue  int listenport
throws unknownhostexception
try
if  bindvalue    null
return new inetsocketaddress listenport
else
return new inetsocketaddress inetaddress getbyname bindvalue   listenport
catch  unknownhostexception e
throw new runtimeexception    e
private static tserver gettnonblockingserver tprotocolfactory protocolfactory  thbaseservice processor processor
ttransportfactory transportfactory  inetsocketaddress inetsocketaddress  throws ttransportexception
tnonblockingservertransport servertransport   new tnonblockingserversocket inetsocketaddress
log info     inetsocketaddress tostring
tnonblockingserver args serverargs   new tnonblockingserver args servertransport
serverargs processor processor
serverargs transportfactory transportfactory
serverargs protocolfactory protocolfactory
return new tnonblockingserver serverargs
private static tserver getthshaserver tprotocolfactory protocolfactory
thbaseservice processor processor  ttransportfactory transportfactory
inetsocketaddress inetsocketaddress  thriftmetrics metrics
throws ttransportexception
tnonblockingservertransport servertransport   new tnonblockingserversocket inetsocketaddress
log info     inetsocketaddress tostring
thshaserver args serverargs   new thshaserver args servertransport
executorservice executorservice   createexecutor
serverargs getworkerthreads    metrics
serverargs executorservice executorservice
serverargs processor processor
serverargs transportfactory transportfactory
serverargs protocolfactory protocolfactory
return new thshaserver serverargs
private static executorservice createexecutor
int workerthreads  thriftmetrics metrics
callqueue callqueue   new callqueue
new linkedblockingqueue<call>    metrics
threadfactorybuilder tfb   new threadfactorybuilder
tfb setdaemon true
tfb setnameformat
return new threadpoolexecutor workerthreads  workerthreads
long max_value  timeunit seconds  callqueue  tfb build
private static tserver gettthreadpoolserver tprotocolfactory protocolfactory  thbaseservice processor processor
ttransportfactory transportfactory  inetsocketaddress inetsocketaddress  throws ttransportexception
tservertransport servertransport   new tserversocket inetsocketaddress
log info     inetsocketaddress tostring
tthreadpoolserver args serverargs   new tthreadpoolserver args servertransport
serverargs processor processor
serverargs transportfactory transportfactory
serverargs protocolfactory protocolfactory
return new tthreadpoolserver serverargs
/**
* start up the thrift2 server.
*
* @param args
*/
public static void main string args  throws exception
tserver server   null
options options   getoptions
try
commandline cmd   parsearguments options  args
/**
* this is to please both bin/hbase and bin/hbase-daemon. hbase-daemon provides "start" and "stop" arguments hbase
* should print the help if no argument is provided
*/
list<?> arglist   cmd getarglist
if  cmd hasoption        arglist contains       arglist contains
printusage
system exit 1
// get port to bind to
int listenport   0
try
listenport   integer parseint cmd getoptionvalue    default_listen_port
catch  numberformatexception e
throw new runtimeexception    e
boolean nonblocking   cmd hasoption
boolean hsha   cmd hasoption
configuration conf   hbaseconfiguration create
thriftmetrics metrics   new thriftmetrics
listenport  conf  thbaseservice iface class
// construct correct protocolfactory
tprotocolfactory protocolfactory   gettprotocolfactory cmd hasoption
thbaseservice iface handler
thrifthbaseservicehandler newinstance conf  metrics
thbaseservice processor processor   new thbaseservice processor handler
boolean framed   cmd hasoption       nonblocking    hsha
ttransportfactory transportfactory   getttransportfactory framed
// todo: remove once hbase-2155 is resolved
if  cmd hasoption        nonblocking    hsha
log error
printusage
system exit 1
inetsocketaddress inetsocketaddress   bindtoport cmd getoptionvalue     listenport
if  nonblocking
server   gettnonblockingserver protocolfactory  processor  transportfactory  inetsocketaddress
else if  hsha
server   getthshaserver protocolfactory  processor  transportfactory  inetsocketaddress  metrics
else
server   gettthreadpoolserver protocolfactory  processor  transportfactory  inetsocketaddress
catch  exception e
log error e getmessage    e
printusage
system exit 1
server serve