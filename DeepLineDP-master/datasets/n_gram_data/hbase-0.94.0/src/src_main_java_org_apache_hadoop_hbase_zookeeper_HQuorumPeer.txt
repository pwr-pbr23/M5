/**
* copyright 2010 the apache software foundation
*
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hbase zookeeper
import java io file
import java io ioexception
import java io printwriter
import java net inetaddress
import java net networkinterface
import java net unknownhostexception
import java util arraylist
import java util enumeration
import java util list
import java util properties
import java util map entry
import org apache hadoop conf configuration
import org apache hadoop hbase hbaseconfiguration
import org apache hadoop hbase util strings
import org apache hadoop net dns
import org apache hadoop util stringutils
import org apache zookeeper server serverconfig
import org apache zookeeper server zookeeperservermain
import org apache zookeeper server quorum quorumpeerconfig
import org apache zookeeper server quorum quorumpeermain
/**
* hbase's version of zookeeper's quorumpeer. when hbase is set to manage
* zookeeper, this class is used to start up quorumpeer instances. by doing
* things in here rather than directly calling to zookeeper, we have more
* control over the process. this class uses {@link zkconfig} to parse the
* zoo.cfg and inject variables from hbase's site.xml configuration in.
*/
public class hquorumpeer
/**
* parse zookeeper configuration from hbase xml config and run a quorumpeer.
* @param args string[] of command line arguments. not used.
*/
public static void main string args
configuration conf   hbaseconfiguration create
try
properties zkproperties   zkconfig makezkprops conf
writemyid zkproperties
quorumpeerconfig zkconfig   new quorumpeerconfig
zkconfig parseproperties zkproperties
runzkserver zkconfig
catch  exception e
e printstacktrace
system exit  1
private static void runzkserver quorumpeerconfig zkconfig  throws unknownhostexception  ioexception
if  zkconfig isdistributed
quorumpeermain qp   new quorumpeermain
qp runfromconfig zkconfig
else
zookeeperservermain zk   new zookeeperservermain
serverconfig serverconfig   new serverconfig
serverconfig readfrom zkconfig
zk runfromconfig serverconfig
private static boolean addressislocalhost string address
return address equals       address equals
static void writemyid properties properties  throws ioexception
long myid    1
configuration conf   hbaseconfiguration create
string myaddress   strings domainnamepointertohostname dns getdefaulthost
conf get
conf get
list<string> ips   new arraylist<string>
// add what could be the best (configured) match
ips add myaddress contains    ?
myaddress
stringutils simplehostname myaddress
// for all nics get all hostnames and ips
enumeration<?> nics   networkinterface getnetworkinterfaces
while nics hasmoreelements
enumeration<?> rawadrs
networkinterface nics nextelement    getinetaddresses
while rawadrs hasmoreelements
inetaddress inet    inetaddress  rawadrs nextelement
ips add stringutils simplehostname inet gethostname
ips add inet gethostaddress
for  entry<object  object> entry   properties entryset
string key   entry getkey   tostring   trim
string value   entry getvalue   tostring   trim
if  key startswith
int dot   key indexof
long id   long parselong key substring dot   1
string parts   value split
string address   parts
if  addressislocalhost address     ips contains address
myid   id
break
// set the max session timeout from the provided client-side timeout
properties setproperty
conf get
if  myid     1
throw new ioexception     myaddress
string datadirstr   properties get    tostring   trim
file datadir   new file datadirstr
if   datadir isdirectory
if   datadir mkdirs
throw new ioexception     datadir
file myidfile   new file datadir
printwriter w   new printwriter myidfile
w println myid
w close