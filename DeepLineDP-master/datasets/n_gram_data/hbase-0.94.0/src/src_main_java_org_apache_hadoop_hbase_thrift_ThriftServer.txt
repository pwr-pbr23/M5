/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hbase thrift
import java util arrays
import java util list
import org apache commons cli commandline
import org apache commons cli commandlineparser
import org apache commons cli helpformatter
import org apache commons cli options
import org apache commons cli posixparser
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop conf configuration
import org apache hadoop hbase hbaseconfiguration
import org apache hadoop hbase thrift thriftserverrunner impltype
import org apache hadoop hbase util versioninfo
import org apache hadoop util shell exitcodeexception
/**
* thriftserver- this class starts up a thrift server which implements the
* hbase api specified in the hbase.thrift idl file. the server runs in an
* independent process.
*/
public class thriftserver
private static final log log   logfactory getlog thriftserver class
private static final string min_workers_option
private static final string max_workers_option
private static final string max_queue_size_option
private static final string keep_alive_sec_option
static final string bind_option
static final string compact_option
static final string framed_option
static final string port_option
private static final string default_bind_addr
private static final int default_listen_port   9090
private configuration conf
thriftserverrunner serverrunner
//
// main program and support routines
//
public thriftserver configuration conf
this conf   hbaseconfiguration create conf
private static void printusageandexit options options  int exitcode
throws exitcodeexception
helpformatter formatter   new helpformatter
formatter printhelp    null  options
true
throw new exitcodeexception exitcode
/**
* start up or shuts down the thrift server, depending on the arguments.
* @param args
*/
void domain final string args  throws exception
processoptions args
serverrunner   new thriftserverrunner conf
serverrunner run
/**
* parse the command line options to set parameters the conf.
*/
private void processoptions final string args  throws exception
options options   new options
options addoption    bind_option  true
default_bind_addr
options addoption    port_option  true
default_listen_port
options addoption    framed_option  false
options addoption    compact_option  false
options addoption       false
options addoption    min_workers_option  true
impltype thread_pool simpleclassname
options addoption    max_workers_option  true
impltype thread_pool simpleclassname
options addoption    max_queue_size_option  true
impltype thread_pool simpleclassname
options addoption    keep_alive_sec_option  true
impltype thread_pool simpleclassname
options addoptiongroup impltype createoptiongroup
commandlineparser parser   new posixparser
commandline cmd   parser parse options  args
// this is so complicated to please both bin/hbase and bin/hbase-daemon.
// hbase-daemon provides "start" and "stop" arguments
// hbase should print the help if no argument is provided
list<string> commandline   arrays aslist args
boolean stop   commandline contains
boolean start   commandline contains
boolean invalidstartstop    start    stop       start     stop
if  cmd hasoption       invalidstartstop
if  invalidstartstop
log error
printusageandexit options  1
// get port to bind to
try
int listenport   integer parseint cmd getoptionvalue port_option
string valueof default_listen_port
conf setint thriftserverrunner port_conf_key  listenport
catch  numberformatexception e
log error    e
printusageandexit options   1
// make optional changes to the configuration based on command-line options
optiontoconf cmd  min_workers_option
conf  tboundedthreadpoolserver min_worker_threads_conf_key
optiontoconf cmd  max_workers_option
conf  tboundedthreadpoolserver max_worker_threads_conf_key
optiontoconf cmd  max_queue_size_option
conf  tboundedthreadpoolserver max_queued_requests_conf_key
optiontoconf cmd  keep_alive_sec_option
conf  tboundedthreadpoolserver thread_keep_alive_time_sec_conf_key
// set general thrift server options
conf setboolean
thriftserverrunner compact_conf_key  cmd hasoption compact_option
conf setboolean
thriftserverrunner framed_conf_key  cmd hasoption framed_option
if  cmd hasoption bind_option
conf set
thriftserverrunner bind_conf_key  cmd getoptionvalue bind_option
impltype setserverimpl cmd  conf
public void stop
serverrunner shutdown
private static void optiontoconf commandline cmd  string option
configuration conf  string destconfkey
if  cmd hasoption option
string value   cmd getoptionvalue option
log info     destconfkey       value
conf set destconfkey  value
/**
* @param args
* @throws exception
*/
public static void main string  args  throws exception
versioninfo logversion
try
new thriftserver hbaseconfiguration create    domain args
catch  exitcodeexception ex
system exit ex getexitcode