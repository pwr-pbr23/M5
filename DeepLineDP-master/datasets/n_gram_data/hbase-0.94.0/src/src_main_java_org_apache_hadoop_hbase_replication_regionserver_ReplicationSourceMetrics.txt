/**
* copyright 2010 the apache software foundation
*
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hbase replication regionserver
import java io unsupportedencodingexception
import java net urlencoder
import org apache hadoop hbase metrics metricsrate
import org apache hadoop metrics metricscontext
import org apache hadoop metrics metricsrecord
import org apache hadoop metrics metricsutil
import org apache hadoop metrics updater
import org apache hadoop metrics jvm jvmmetrics
import org apache hadoop metrics util metricsintvalue
import org apache hadoop metrics util metricslongvalue
import org apache hadoop metrics util metricsregistry
/**
* this class is for maintaining the various replication statistics
* for a source and publishing them through the metrics interfaces.
*/
public class replicationsourcemetrics implements updater
private final metricsrecord metricsrecord
private metricsregistry registry   new metricsregistry
/** rate of shipped operations by the source */
public final metricsrate shippedopsrate
new metricsrate    registry
/** rate of shipped batches by the source */
public final metricsrate shippedbatchesrate
new metricsrate    registry
/** rate of log entries (can be multiple puts) read from the logs */
public final metricsrate logeditsreadrate
new metricsrate    registry
/** rate of log entries filtered by the source */
public final metricsrate logeditsfilteredrate
new metricsrate    registry
/** age of the last operation that was shipped by the source */
private final metricslongvalue ageoflastshippedop
new metricslongvalue    registry
/**
* current size of the queue of logs to replicate,
* excluding the one being processed at the moment
*/
public final metricsintvalue sizeoflogqueue
new metricsintvalue    registry
// it's a little dirty to preset the age to now since if we fail
// to replicate the very first time then it will show that age instead
// of nothing (although that might not be good either).
private long lasttimestampforage   system currenttimemillis
/**
* constructor used to register the metrics
* @param id name of the source this class is monitoring
*/
public replicationsourcemetrics string id
metricscontext context   metricsutil getcontext
string name   thread currentthread   getname
metricsrecord   metricsutil createrecord context
metricsrecord settag    name
context registerupdater this
try
id   urlencoder encode id
catch  unsupportedencodingexception e
id
// export for jmx
new replicationstatistics this registry      id
/**
* set the age of the last edit that was shipped
* @param timestamp write time of the edit
*/
public void setageoflastshippedop long timestamp
lasttimestampforage   timestamp
ageoflastshippedop set system currenttimemillis     lasttimestampforage
/**
* convenience method to use the last given timestamp to refresh the age
* of the last edit. used when replication fails and need to keep that
* metric accurate.
*/
public void refreshageoflastshippedop
setageoflastshippedop lasttimestampforage
@override
public void doupdates metricscontext metricscontext
synchronized  this
this shippedopsrate pushmetric this metricsrecord
this shippedbatchesrate pushmetric this metricsrecord
this logeditsreadrate pushmetric this metricsrecord
this logeditsfilteredrate pushmetric this metricsrecord
this ageoflastshippedop pushmetric this metricsrecord
this sizeoflogqueue pushmetric this metricsrecord
this metricsrecord update