/**
* copyright 2011 the apache software foundation
*
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hbase monitoring
import java io printwriter
import java text simpledateformat
import java util date
import java util linkedlist
import java util list
import com google common base charsets
import com google common base preconditions
import com google common collect lists
/**
* a size-bounded repository of alerts, which are kept
* in a linked list. alerts can be added, and they will
* automatically be removed one by one when the specified heap
* usage is exhausted.
*/
public class memoryboundedlogmessagebuffer
private final long maxsizebytes
private long usage   0
private linkedlist<logmessage> messages
public memoryboundedlogmessagebuffer long maxsizebytes
preconditions checkargument
maxsizebytes > 0
this maxsizebytes   maxsizebytes
this messages   lists newlinkedlist
/**
* append the given message to this buffer, automatically evicting
* older messages until the desired memory limit is achieved.
*/
public synchronized void add string messagetext
logmessage message   new logmessage messagetext  system currenttimemillis
usage    message estimateheapusage
messages add message
while  usage > maxsizebytes
logmessage removed   messages remove
usage    removed estimateheapusage
assert usage >  0
/**
* dump the contents of the buffer to the given stream.
*/
public synchronized void dumpto printwriter out
simpledateformat df   new simpledateformat
for  logmessage msg   messages
out write df format new date msg timestamp
out write
out println new string msg message  charsets utf_8
synchronized list<logmessage> getmessages
// defensive copy
return lists newarraylist messages
/**
* estimate the number of bytes this buffer is currently
* using.
*/
synchronized long estimateheapusage
return usage
private static class logmessage
/** the error text, encoded in bytes to save memory */
public final byte message
public final long timestamp
/**
* completely non-scientific estimate of how much one of these
* objects takes, along with the linkedlist overhead. this doesn't
* need to be exact, since we don't expect a ton of these alerts.
*/
private static final long base_usage 100
public logmessage string message  long timestamp
this message   message getbytes charsets utf_8
this timestamp   timestamp
public long estimateheapusage
return message length   base_usage