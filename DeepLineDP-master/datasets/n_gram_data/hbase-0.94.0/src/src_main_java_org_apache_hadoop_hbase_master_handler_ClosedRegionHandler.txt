/**
* copyright 2010 the apache software foundation
*
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hbase master handler
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop hbase hregioninfo
import org apache hadoop hbase server
import org apache hadoop hbase executor eventhandler
import org apache hadoop hbase master assignmentmanager
/**
* handles closed region event on master.
* <p>
* if table is being disabled, deletes zk unassigned node and removes from
* regions in transition.
* <p>
* otherwise, assigns the region to another server.
*/
public class closedregionhandler extends eventhandler implements toteshregioninfo
private static final log log   logfactory getlog closedregionhandler class
private final assignmentmanager assignmentmanager
private final hregioninfo regioninfo
private final closedpriority priority
private enum closedpriority
root  1
meta  2
user  3
private final int value
closedpriority int value
this value   value
public int getvalue
return value
public closedregionhandler server server  assignmentmanager assignmentmanager
hregioninfo regioninfo
super server  eventtype rs_zk_region_closed
this assignmentmanager   assignmentmanager
this regioninfo   regioninfo
if regioninfo isrootregion
priority   closedpriority root
else if regioninfo ismetaregion
priority   closedpriority meta
else
priority   closedpriority user
@override
public int getpriority
return priority getvalue
@override
public hregioninfo gethregioninfo
return this regioninfo
@override
public string tostring
string name
if server    null    server getservername      null
name   server getservername   tostring
return getclass   getsimplename         name       getseqid
@override
public void process
log debug     regioninfo getencodedname
// check if this table is being disabled or not
if  this assignmentmanager getzktable
isdisablingordisabledtable this regioninfo gettablenameasstring
assignmentmanager offlinedisabledregion regioninfo
return
// zk node is in closed state, assign it.
// todo: should we remove the region from rit too?  we don't?  makes for
// a 'forcing' log message when we go to update state from closed to offline
assignmentmanager setoffline regioninfo
// this below has to do w/ online enable/disable of a table
assignmentmanager removeclosedregion regioninfo
assignmentmanager assign regioninfo  true