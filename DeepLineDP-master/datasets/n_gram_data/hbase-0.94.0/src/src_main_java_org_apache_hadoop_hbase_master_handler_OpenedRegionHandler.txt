/**
* copyright 2010 the apache software foundation
*
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hbase master handler
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop hbase hregioninfo
import org apache hadoop hbase server
import org apache hadoop hbase servername
import org apache hadoop hbase executor eventhandler
import org apache hadoop hbase master assignmentmanager
import org apache hadoop hbase master assignmentmanager regionstate
import org apache hadoop hbase zookeeper zkassign
import org apache zookeeper keeperexception
/**
* handles opened region event on master.
*/
public class openedregionhandler extends eventhandler implements toteshregioninfo
private static final log log   logfactory getlog openedregionhandler class
private final assignmentmanager assignmentmanager
private final hregioninfo regioninfo
private final servername sn
private final openedpriority priority
private final int expectedversion
private enum openedpriority
root  1
meta  2
user  3
private final int value
openedpriority int value
this value   value
public int getvalue
return value
public openedregionhandler server server
assignmentmanager assignmentmanager  hregioninfo regioninfo
servername sn  int expectedversion
super server  eventtype rs_zk_region_opened
this assignmentmanager   assignmentmanager
this regioninfo   regioninfo
this sn   sn
this expectedversion   expectedversion
if regioninfo isrootregion
priority   openedpriority root
else if regioninfo ismetaregion
priority   openedpriority meta
else
priority   openedpriority user
@override
public int getpriority
return priority getvalue
@override
public hregioninfo gethregioninfo
return this regioninfo
@override
public string tostring
string name
if server    null    server getservername      null
name   server getservername   tostring
return getclass   getsimplename         name       getseqid
@override
public void process
// code to defend against case where we get split before region open
// processing completes; temporary till we make splits go via zk -- 0.92.
regionstate regionstate   this assignmentmanager isregionintransition regioninfo
boolean openednodedeleted   false
if  regionstate    null
regionstate getstate   equals regionstate state open
openednodedeleted   deleteopenednode expectedversion
if   openednodedeleted
log error     regioninfo getregionnameasstring
else
log warn     regioninfo getregionnameasstring
if   openednodedeleted
if  this assignmentmanager getzktable   isdisablingordisabledtable
regioninfo gettablenameasstring
debuglog regioninfo
regioninfo getregionnameasstring
assignmentmanager unassign regioninfo
private boolean deleteopenednode int expectedversion
debuglog regioninfo
this regioninfo getregionnameasstring         this sn tostring
try
// delete the opened znode only if the version matches.
return zkassign deletenode server getzookeeper
regioninfo getencodedname    eventtype rs_zk_region_opened  expectedversion
catch keeperexception nonodeexception e
// getting no node exception here means that already the region has been opened.
log warn     regioninfo getregionnameasstring
return false
catch  keeperexception e
server abort
regioninfo getregionnameasstring        e
return false
private void debuglog hregioninfo region  string string
if  region ismetatable
log info string
else
log debug string