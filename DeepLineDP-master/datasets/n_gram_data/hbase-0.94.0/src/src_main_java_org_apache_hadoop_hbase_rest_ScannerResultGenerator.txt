/*
* copyright 2010 the apache software foundation
*
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hbase rest
import java io ioexception
import java util iterator
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop hbase hcolumndescriptor
import org apache hadoop hbase keyvalue
import org apache hadoop hbase unknownscannerexception
import org apache hadoop hbase client htableinterface
import org apache hadoop hbase client htablepool
import org apache hadoop hbase client result
import org apache hadoop hbase client resultscanner
import org apache hadoop hbase client scan
import org apache hadoop hbase filter filter
import org apache hadoop hbase rest model scannermodel
import org apache hadoop util stringutils
public class scannerresultgenerator extends resultgenerator
private static final log log
logfactory getlog scannerresultgenerator class
public static filter buildfilterfrommodel final scannermodel model
throws exception
string filter   model getfilter
if  filter    null    filter length      0
return null
return buildfilter filter
private string id
private iterator<keyvalue> rowi
private keyvalue cache
private resultscanner scanner
private result cached
public scannerresultgenerator final string tablename  final rowspec rowspec
final filter filter  throws illegalargumentexception  ioexception
htablepool pool   restservlet getinstance   gettablepool
htableinterface table   pool gettable tablename
try
scan scan
if  rowspec hasendrow
scan   new scan rowspec getstartrow    rowspec getendrow
else
scan   new scan rowspec getstartrow
if  rowspec hascolumns
byte columns   rowspec getcolumns
for  byte column  columns
byte split   keyvalue parsecolumn column
if  split length > 1     split    null    split length    0
scan addcolumn split  split
else
scan addfamily split
else
for  hcolumndescriptor family
table gettabledescriptor   getfamilies
scan addfamily family getname
scan settimerange rowspec getstarttime    rowspec getendtime
scan setmaxversions rowspec getmaxversions
if  filter    null
scan setfilter filter
// always disable block caching on the cluster when scanning
scan setcacheblocks false
scanner   table getscanner scan
cached   null
id   long tostring system currenttimemillis
integer tohexstring scanner hashcode
finally
pool puttable table
public string getid
return id
public void close
public boolean hasnext
if  cache    null
return true
if  rowi    null    rowi hasnext
return true
if  cached    null
return true
try
result result   scanner next
if  result    null     result isempty
cached   result
catch  unknownscannerexception e
throw new illegalargumentexception e
catch  ioexception e
log error stringutils stringifyexception e
return cached    null
public keyvalue next
if  cache    null
keyvalue kv   cache
cache   null
return kv
boolean loop
do
loop   false
if  rowi    null
if  rowi hasnext
return rowi next
else
rowi   null
if  cached    null
rowi   cached list   iterator
loop   true
cached   null
else
result result   null
try
result   scanner next
catch  unknownscannerexception e
throw new illegalargumentexception e
catch  ioexception e
log error stringutils stringifyexception e
if  result    null     result isempty
rowi   result list   iterator
loop   true
while  loop
return null
public void putback keyvalue kv
this cache   kv
public void remove
throw new unsupportedoperationexception