/**
* copyright 2010 the apache software foundation
*
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hbase mapreduce
import org apache hadoop conf configuration
import org apache hadoop hbase hbaseconfiguration
import org apache hadoop hbase hconstants
import org apache hadoop hbase util bytes
import org apache hadoop hbase client scan
import org apache hadoop mapreduce job
import org apache hadoop util genericoptionsparser
import java io ioexception
import java util hashmap
import java util map
/**
* tool used to copy a table to another one which can be on a different setup.
* it is also configurable with a start and time as well as a specification
* of the region server implementation if different from the local cluster.
*/
public class copytable
final static string name
static string rsclass   null
static string rsimpl   null
static long starttime   0
static long endtime   0
static int versions    1
static string tablename   null
static string newtablename   null
static string peeraddress   null
static string families   null
static boolean allcells   false
/**
* sets up the actual job.
*
* @param conf  the current configuration.
* @param args  the command line parameters.
* @return the newly created job.
* @throws ioexception when setting up the job fails.
*/
public static job createsubmittablejob configuration conf  string args
throws ioexception
if   docommandline args
return null
job job   new job conf  name       tablename
job setjarbyclass copytable class
scan scan   new scan
scan setcacheblocks false
if  starttime    0
scan settimerange starttime
endtime    0 ? hconstants latest_timestamp   endtime
if  allcells
scan setraw true
if  versions >  0
scan setmaxversions versions
if families    null
string fams   families split
map<string string> cfrenamemap   new hashmap<string string>
for string fam   fams
string sourcecf
if fam contains
// fam looks like "sourcecfname:destcfname"
string srcanddest   fam split    2
sourcecf   srcanddest
string destcf   srcanddest
cfrenamemap put sourcecf  destcf
else
// fam is just "sourcecf"
sourcecf   fam
scan addfamily bytes tobytes sourcecf
import configurecfrenaming job getconfiguration    cfrenamemap
tablemapreduceutil inittablemapperjob tablename  scan
import importer class  null  null  job
tablemapreduceutil inittablereducerjob
newtablename    null ? tablename   newtablename  null  job
null  peeraddress  rsclass  rsimpl
job setnumreducetasks 0
return job
/*
* @param errormsg error message.  can be null.
*/
private static void printusage final string errormsg
if  errormsg    null    errormsg length   > 0
system err println     errormsg
system err println
system err println
system err println
system err println
system err println
system err println
system err println
system err println
system err println
system err println
system err println
system err println
system err println
system err println
system err println
system err println  cfname
system err println
system err println
system err println
system err println
system err println
system err println
system err println
system err println
system err println
private static boolean docommandline final string args
// process command-line args. todo: better cmd-line processing
// (but hopefully something not as painful as cli options).
if  args length < 1
printusage null
return false
try
for  int i   0  i < args length  i
string cmd   args
if  cmd equals       cmd startswith
printusage null
return false
final string rsclassargkey
if  cmd startswith rsclassargkey
rsclass   cmd substring rsclassargkey length
continue
final string rsimplargkey
if  cmd startswith rsimplargkey
rsimpl   cmd substring rsimplargkey length
continue
final string starttimeargkey
if  cmd startswith starttimeargkey
starttime   long parselong cmd substring starttimeargkey length
continue
final string endtimeargkey
if  cmd startswith endtimeargkey
endtime   long parselong cmd substring endtimeargkey length
continue
final string versionsargkey
if  cmd startswith versionsargkey
versions   integer parseint cmd substring versionsargkey length
continue
final string newnameargkey
if  cmd startswith newnameargkey
newtablename   cmd substring newnameargkey length
continue
final string peeradrargkey
if  cmd startswith peeradrargkey
peeraddress   cmd substring peeradrargkey length
continue
final string familiesargkey
if  cmd startswith familiesargkey
families   cmd substring familiesargkey length
continue
if  cmd startswith
allcells   true
continue
if  i    args length 1
tablename   cmd
if  newtablename    null    peeraddress    null
printusage
return false
catch  exception e
e printstacktrace
printusage     e getmessage
return false
return true
/**
* main entry point.
*
* @param args  the command line parameters.
* @throws exception when running the job fails.
*/
public static void main string args  throws exception
configuration conf   hbaseconfiguration create
string otherargs
new genericoptionsparser conf  args  getremainingargs
job job   createsubmittablejob conf  otherargs
if  job    null
system exit job waitforcompletion true  ? 0   1