/*
* copyright 2010 the apache software foundation
*
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hbase rest
import java io ioexception
import javax ws rs delete
import javax ws rs get
import javax ws rs produces
import javax ws rs queryparam
import javax ws rs webapplicationexception
import javax ws rs core cachecontrol
import javax ws rs core context
import javax ws rs core response
import javax ws rs core response responsebuilder
import javax ws rs core uriinfo
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop hbase keyvalue
import org apache hadoop hbase rest model cellmodel
import org apache hadoop hbase rest model cellsetmodel
import org apache hadoop hbase rest model rowmodel
import org apache hadoop hbase util base64
import org apache hadoop hbase util bytes
public class scannerinstanceresource extends resourcebase
private static final log log
logfactory getlog scannerinstanceresource class
static cachecontrol cachecontrol
static
cachecontrol   new cachecontrol
cachecontrol setnocache true
cachecontrol setnotransform false
resultgenerator generator
string id
int batch   1
public scannerinstanceresource string table  string id
resultgenerator generator  int batch  throws ioexception
this id   id
this generator   generator
this batch   batch
@get
@produces  mimetype_xml  mimetype_json  mimetype_protobuf
public response get final @context uriinfo uriinfo
@queryparam    int maxrows  final @queryparam    int maxvalues
if  log isdebugenabled
log debug     uriinfo getabsolutepath
servlet getmetrics   incrementrequests 1
cellsetmodel model   new cellsetmodel
rowmodel rowmodel   null
byte rowkey   null
int limit   batch
if  maxvalues > 0
limit   maxvalues
int count   limit
do
keyvalue value   null
try
value   generator next
catch  illegalstateexception e
if  scannerresource delete id
servlet getmetrics   incrementsucessfuldeleterequests 1
else
servlet getmetrics   incrementfaileddeleterequests 1
servlet getmetrics   incrementfailedgetrequests 1
throw new webapplicationexception response status gone
if  value    null
log info
// respond with 204 (no content) if an empty cell set would be
// returned
if  count    limit
return response nocontent   build
break
if  rowkey    null
rowkey   value getrow
rowmodel   new rowmodel rowkey
if   bytes equals value getrow    rowkey
// if maxrows was given as a query param, stop if we would exceed the
// specified number of rows
if  maxrows > 0
if    maxrows    0
generator putback value
break
model addrow rowmodel
rowkey   value getrow
rowmodel   new rowmodel rowkey
rowmodel addcell
new cellmodel value getfamily    value getqualifier
value gettimestamp    value getvalue
while    count > 0
model addrow rowmodel
responsebuilder response   response ok model
response cachecontrol cachecontrol
servlet getmetrics   incrementsucessfulgetrequests 1
return response build
@get
@produces mimetype_binary
public response getbinary final @context uriinfo uriinfo
if  log isdebugenabled
log debug     uriinfo getabsolutepath
mimetype_binary
servlet getmetrics   incrementrequests 1
try
keyvalue value   generator next
if  value    null
log info
return response nocontent   build
responsebuilder response   response ok value getvalue
response cachecontrol cachecontrol
response header    base64 encodebytes value getrow
response header
base64 encodebytes
keyvalue makecolumn value getfamily    value getqualifier
response header    value gettimestamp
servlet getmetrics   incrementsucessfulgetrequests 1
return response build
catch  illegalstateexception e
if  scannerresource delete id
servlet getmetrics   incrementsucessfuldeleterequests 1
else
servlet getmetrics   incrementfaileddeleterequests 1
servlet getmetrics   incrementfailedgetrequests 1
throw new webapplicationexception response status gone
@delete
public response delete final @context uriinfo uriinfo
if  log isdebugenabled
log debug     uriinfo getabsolutepath
servlet getmetrics   incrementrequests 1
if  servlet isreadonly
throw new webapplicationexception response status forbidden
if  scannerresource delete id
servlet getmetrics   incrementsucessfuldeleterequests 1
else
servlet getmetrics   incrementfaileddeleterequests 1
return response ok   build