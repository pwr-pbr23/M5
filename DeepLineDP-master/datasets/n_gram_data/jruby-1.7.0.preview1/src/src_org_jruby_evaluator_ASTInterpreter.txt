/*
******************************************************************************
* begin license block *** version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public license version
* 1.0 (the "license"); you may not use this file except in compliance with the
* license. you may obtain a copy of the license at
* http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as is" basis,
* without warranty of any kind, either express or implied. see the license for
* the specific language governing rights and limitations under the license.
*
* copyright (c) 2006 charles oliver nutter <headius@headius.com>
* copytight (c) 2006-2007 thomas e enebo <enebo@acm.org>
* copyright (c) 2007 miguel covarrubias <mlcovarrubias@gmail.com>
* copyright (c) 2007 ola bini <ola@ologix.com>
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"), or
* the gnu lesser general public license version 2.1 or later (the "lgpl"), in
* which case the provisions of the gpl or the lgpl are applicable instead of
* those above. if you wish to allow use of your version of this file only under
* the terms of either the gpl or the lgpl, and not to allow others to use your
* version of this file under the terms of the cpl, indicate your decision by
* deleting the provisions above and replace them with the notice and other
* provisions required by the gpl or the lgpl. if you do not delete the
* provisions above, a recipient may use your version of this file under the
* terms of any one of the cpl, the gpl or the lgpl. end license block ****
******************************************************************************/
package org jruby evaluator
import org jruby ruby
import org jruby rubyarray
import org jruby rubylocaljumperror
import org jruby rubymodule
import org jruby rubystring
import org jruby ast arraynode
import org jruby ast blockpassnode
import org jruby ast iternode
import org jruby ast multipleasgnnode
import org jruby ast node
import org jruby ast util argsutil
import org jruby common irubywarnings id
import org jruby exceptions jumpexception
import org jruby javasupport util runtimehelpers
import org jruby parser staticscope
import org jruby runtime block
import org jruby runtime dynamicscope
import org jruby runtime rubyevent
import org jruby runtime threadcontext
import org jruby runtime builtin irubyobject
import org jruby runtime binding
import org jruby runtime frame
import org jruby runtime interpretedblock
import org jruby util bytelist
import org jruby rubyinstanceconfig compilemode
import org jruby ir interpreter interpreter
public class astinterpreter
public static irubyobject interpret_method
ruby runtime
threadcontext context
string file
int line
rubymodule implclass
node node  string name
irubyobject self
block block
boolean istraceable
try
threadcontext pushbacktrace context  name  file  line
if  istraceable  methodpretrace runtime  context  name  implclass
return node interpret runtime  context  self  block
finally
if  istraceable
try  methodposttrace runtime  context  name  implclass
finally  threadcontext popbacktrace context
else
threadcontext popbacktrace context
public static irubyobject interpret_eval ruby runtime  threadcontext context  node node  string name  irubyobject self  block block
try
threadcontext pushbacktrace context  name  node getposition
return node interpret runtime  context  self  block
finally
threadcontext popbacktrace context
public static irubyobject interpret_eval ruby runtime  threadcontext context  string file  int line  node node  string name  irubyobject self  block block
try
threadcontext pushbacktrace context  name  file  line
return node interpret runtime  context  self  block
finally
threadcontext popbacktrace context
public static irubyobject interpret_class ruby runtime  threadcontext context  node node  string name  irubyobject self  block block
try
threadcontext pushbacktrace context  name  node getposition
return node interpret runtime  context  self  block
finally
threadcontext popbacktrace context
public static irubyobject interpret_block ruby runtime  threadcontext context  string file  int line  node node  string name  irubyobject self  block block
try
threadcontext pushbacktrace context  name  file  line
return node interpret runtime  context  self  block
finally
threadcontext popbacktrace context
public static irubyobject interpret_root ruby runtime  threadcontext context  node node  irubyobject self  block block
try
threadcontext pushbacktrace context     node getposition
return node interpret runtime  context  self  block
finally
threadcontext popbacktrace context
private static void methodpretrace ruby runtime  threadcontext context  string name  rubymodule implclass
if  runtime haseventhooks    context trace rubyevent call  name  implclass
private static void methodposttrace ruby runtime  threadcontext context  string name  rubymodule implclass
if  runtime haseventhooks    context trace rubyevent return  name  implclass
@deprecated
public static irubyobject evalwithbinding threadcontext context  irubyobject src  binding binding
return evalwithbinding context  binding getself    src  binding
/**
* evaluate the given string under the specified binding object. if the binding is not a proc or binding object
* (rubyproc or rubybinding) throw an appropriate type error.
* @param context the thread context for the current thread
* @param self the self against which eval was called; used as self in the eval in 1.9 mode
* @param src the string containing the text to be evaluated
* @param binding the binding object under which to perform the evaluation
* @return an irubyobject result from the evaluation
*/
public static irubyobject evalwithbinding threadcontext context  irubyobject self  irubyobject src  binding binding
ruby runtime   src getruntime
dynamicscope evalscope   binding getdynamicscope   getevalscope runtime
// fixme:  this determine module is in a strange location and should somehow be in block
evalscope getstaticscope   determinemodule
frame lastframe   context preevalwithbinding binding
try
// binding provided for scope, use it
rubystring source   src converttostring
node node   runtime parseeval source getbytelist    binding getfile    evalscope  binding getline
block block   binding getframe   getblock
if  runtime getinstanceconfig   getcompilemode      compilemode offir
// sss fixme: ast interpreter passed both a runtime (which comes from the source string)
// and the thread-context rather than fetch one from the other.  why is that?
return interpreter interpretbindingeval runtime  binding getfile    binding getline    binding getmethod    node  self  block
else
return interpret_eval runtime  context  binding getfile    binding getline    node  binding getmethod    self  block
catch  jumpexception breakjump bj
throw runtime newlocaljumperror rubylocaljumperror reason break   irubyobject bj getvalue
catch  jumpexception redojump rj
throw runtime newlocaljumperror rubylocaljumperror reason redo   irubyobject rj getvalue
catch  stackoverflowerror soe
throw runtime newsystemstackerror    soe
finally
context postevalwithbinding binding  lastframe
/**
* evaluate the given string.
* @param context the current thread's context
* @param self the self to evaluate under
* @param src the string containing the text to be evaluated
* @param file the filename to use when reporting errors during the evaluation
* @param linenumber that the eval supposedly starts from
* @return an irubyobject result from the evaluation
*/
public static irubyobject evalsimple threadcontext context  irubyobject self  rubystring src  string file  int linenumber
// this is ensured by the callers
assert file    null
ruby runtime   src getruntime
// no binding, just eval in "current" frame (caller's frame)
rubystring source   src converttostring
dynamicscope evalscope   context getcurrentscope   getevalscope runtime
evalscope getstaticscope   determinemodule
try
node node   runtime parseeval source getbytelist    file  evalscope  linenumber
if  runtime getinstanceconfig   getcompilemode      compilemode offir
// sss fixme: ast interpreter passed both a runtime (which comes from the source string)
// and the thread-context rather than fetch one from the other.  why is that?
return interpreter interpretsimpleeval runtime  file  linenumber     node  self
else
return interpret_eval runtime  context  file  linenumber  node     self  block null_block
catch  jumpexception breakjump bj
throw runtime newlocaljumperror rubylocaljumperror reason break   irubyobject bj getvalue
catch  stackoverflowerror soe
throw runtime newsystemstackerror    soe
public static void calltracefunction ruby runtime  threadcontext context  rubyevent event
string name   context getframename
rubymodule type   context getframeklazz
runtime calleventhooks context  event  context getfile    context getline    name  type
public static irubyobject pollandreturn threadcontext context  irubyobject result
context pollthreadevents
return result
public static irubyobject multipleasgnarraynode ruby runtime  threadcontext context  multipleasgnnode ivisited  arraynode node  irubyobject self  block ablock
irubyobject array   new irubyobject
for  int i   0  i < node size    i
array   node get i  interpret runtime context  self  ablock
return assignmentvisitor multiassign runtime  context  self  ivisited  rubyarray newarraynocopylight runtime  array   false
/** evaluates the body in a class or module definition statement.
*
*/
public static irubyobject evalclassdefinitionbody ruby runtime  threadcontext context  staticscope scope
node bodynode  rubymodule type  irubyobject self  block block
context preclasseval scope  type
try
if  runtime haseventhooks
calltracefunction runtime  context  rubyevent class
if  bodynode    null  return runtime getnil
string name   type getbasename
if  name    null
if  type issingleton
name
else if  type ismodule         can these two happen?
name
else
name
return interpret_class runtime  context  bodynode  name  type  block
finally
try
if  runtime haseventhooks
calltracefunction runtime  context  rubyevent end
finally
context postclasseval
public static bytelist getargumentdefinition ruby runtime  threadcontext context  node node  bytelist type  irubyobject self  block block
if  node    null  return type
if  node instanceof arraynode
arraynode list    arraynode  node
int size   list size
for  int i   0  i < size  i
if  list get i  definition runtime  context  self  block     null  return null
else if  node definition runtime  context  self  block     null
return null
return type
public static block getblock ruby runtime  threadcontext context  irubyobject self  block currentblock  node blocknode
if  blocknode    null  return block null_block
if  blocknode instanceof iternode
return getiternodeblock blocknode  context self
else if  blocknode instanceof blockpassnode
return getblockpassblock blocknode  runtime context  self  currentblock
assert false
return null
private static block getblockpassblock node blocknode  ruby runtime  threadcontext context  irubyobject self  block currentblock
node bodynode     blockpassnode  blocknode  getbodynode
irubyobject proc
if  bodynode    null
proc   runtime getnil
else
proc   bodynode interpret runtime  context  self  currentblock
return runtimehelpers getblockfromblockpassbody proc  currentblock
private static block getiternodeblock node blocknode  threadcontext context  irubyobject self
iternode iternode    iternode  blocknode
staticscope scope   iternode getscope
scope determinemodule
// create block for this iter node
// fixme: we shouldn't use the current scope if it's not actually from the same hierarchy of static scopes
return interpretedblock newinterpretedclosure context  iternode getblockbody    self
/* something like cvar_cbase() from eval.c, factored out for the benefit
* of all the classvar-related node evaluations */
public static rubymodule getclassvariablebase threadcontext context  ruby runtime
staticscope scope   context getcurrentscope   getstaticscope
rubymodule rubyclass   scope getmodule
while  rubyclass issingleton      rubyclass    runtime getdummy
// we ran out of scopes to check
if  scope    null  return null
scope   scope getpreviouscrefscope
rubyclass   scope getmodule
if  scope getpreviouscrefscope      null
runtime getwarnings   warn id cvar_from_toplevel_singleton_method
return rubyclass
public static irubyobject setupargs ruby runtime  threadcontext context  node node  irubyobject self  block ablock
if  node    null  return irubyobject null_array
if  node instanceof arraynode
arraynode argsarraynode    arraynode  node
string savedfile   context getfile
int savedline   context getline
int size   argsarraynode size
irubyobject argsarray   new irubyobject
for  int i   0  i < size  i
argsarray   argsarraynode get i  interpret runtime  context  self  ablock
context setfileandline savedfile  savedline
return argsarray
return argsutil converttojavaarray node interpret runtime context  self  ablock