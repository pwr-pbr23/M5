/**
* **** begin license block *****
* version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public
* license version 1.0 (the "license"); you may not use this file
* except in compliance with the license. you may obtain a copy of
* the license at http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as
* is" basis, without warranty of any kind, either express or
* implied. see the license for the specific language governing
* rights and limitations under the license.
*
* copyright (c) 2009-2010 yoko harada <yokolet@gmail.com>
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"),
* or the gnu lesser general public license version 2.1 or later (the "lgpl"),
* in which case the provisions of the gpl or the lgpl are applicable instead
* of those above. if you wish to allow use of your version of this file only
* under the terms of either the gpl or the lgpl, and not to allow others to
* use your version of this file under the terms of the cpl, indicate your
* decision by deleting the provisions above and replace them with the notice
* and other provisions required by the gpl or the lgpl. if you do not delete
* the provisions above, a recipient may use your version of this file under
* the terms of any one of the cpl, the gpl or the lgpl.
* **** end license block *****
*/
package org jruby embed jsr223
import java io ioexception
import java io printwriter
import java io reader
import java io writer
import javax script bindings
import javax script compilable
import javax script compiledscript
import javax script invocable
import javax script scriptcontext
import javax script scriptengine
import javax script scriptenginefactory
import javax script scriptexception
import javax script simplebindings
import javax script simplescriptcontext
import org jruby embed embedevalunit
import org jruby embed scriptingcontainer
import org jruby javasupport javaembedutils
import org jruby runtime builtin irubyobject
/**
* implementation of javax.script.scriptengine/compilable/invocable.
*
* @author yoko harada <yokolet@gmail.com>
*/
public class jrubyengine implements compilable  invocable  scriptengine
private final scriptingcontainer container
private jrubyenginefactory factory
private scriptcontext context
jrubyengine scriptingcontainer container  jrubyenginefactory factory
this container   container
this factory   factory
this context   new jrubycontext container
public compiledscript compile string script  throws scriptexception
if  script    null
throw new nullpointerexception
return new jrubycompiledscript container  this  script
public compiledscript compile reader reader  throws scriptexception
if  reader    null
throw new nullpointerexception
return new jrubycompiledscript container  this  reader
public object eval string script  scriptcontext context  throws scriptexception
if  script    null    context    null
throw new nullpointerexception
container setscriptfilename utils getfilename context
try
utils preeval container  context
embedevalunit unit   container parse script  utils getlinenumber context
irubyobject ret   unit run
return javaembedutils rubytojava ret
catch  exception e
throw wrapexception e
finally
utils posteval container  context
boolean termination   utils isterminationon context
if  termination
container terminate
private scriptexception wrapexception exception e
return new scriptexception e
public object eval reader reader  scriptcontext context  throws scriptexception
if  reader    null    context    null
throw new nullpointerexception
string filename   utils getfilename context
try
utils preeval container  context
embedevalunit unit   container parse reader  filename  utils getlinenumber context
irubyobject ret   unit run
return javaembedutils rubytojava ret
catch  exception e
throw wrapexception e
finally
utils posteval container  context
boolean termination   utils isterminationon context
if  termination
container terminate
public object eval string script  bindings bindings  throws scriptexception
scriptcontext context   getscriptcontext bindings
return eval script  context
public object eval reader reader  bindings bindings  throws scriptexception
scriptcontext context   getscriptcontext bindings
return eval reader  context
public object eval string script  throws scriptexception
return eval script  context
public object eval reader reader  throws scriptexception
return eval reader  context
protected scriptcontext getscriptcontext bindings bindings
if  bindings    null
throw new nullpointerexception
scriptcontext newcontext   new simplescriptcontext
newcontext setbindings bindings  scriptcontext engine_scope
bindings global   getbindings scriptcontext global_scope
if  global    null
newcontext setbindings global  scriptcontext global_scope
newcontext setreader context getreader
newcontext setwriter context getwriter
newcontext seterrorwriter context geterrorwriter
return newcontext
public object get string key
return context getattribute key  scriptcontext engine_scope
public void put string key  object value
context getbindings scriptcontext engine_scope  put key  value
public bindings getbindings int scope
return context getbindings scope
public void setbindings bindings bindings  int scope
context setbindings bindings  scope
public bindings createbindings
return new simplebindings
public scriptcontext getcontext
return context
public void setcontext scriptcontext ctx
if  ctx    null
throw new nullpointerexception
context   ctx
public scriptenginefactory getfactory
return factory
public object invokemethod object receiver  string method  object    args
throws scriptexception  nosuchmethodexception
if  method    null
throw new nullpointerexception
if  receiver    null
throw new nullpointerexception
try
utils preeval container  context
if  args    null    args length    0
return container callmethod receiver  method  object class
return container callmethod receiver  method  args  object class
catch  exception e
if  e getcause   getmessage   contains
throw wrapmethodexception e
throw wrapexception e
finally
utils posteval container  context
private nosuchmethodexception wrapmethodexception exception e
return  nosuchmethodexception new nosuchmethodexception e getcause   getmessage    initcause e
public object invokefunction string method  object    args
throws scriptexception  nosuchmethodexception
if  method    null
throw new nullpointerexception
try
utils preeval container  context
if  args    null    args length    0
return container callmethod null  method  object class
return container callmethod null  method  args  object class
catch  exception e
if  e getcause   getmessage   contains
throw wrapmethodexception e
throw wrapexception e
finally
utils posteval container  context
public <t> t getinterface class<t> returntype
return getinterface null  returntype
public <t> t getinterface object receiver  class<t> returntype
return container getinstance receiver  returntype