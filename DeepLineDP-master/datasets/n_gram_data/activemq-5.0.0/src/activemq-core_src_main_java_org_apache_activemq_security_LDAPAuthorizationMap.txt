/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq security
import java text messageformat
import java util hashset
import java util hashtable
import java util iterator
import java util map
import java util set
import javax naming context
import javax naming namingenumeration
import javax naming namingexception
import javax naming directory attribute
import javax naming directory attributes
import javax naming directory dircontext
import javax naming directory initialdircontext
import javax naming directory searchcontrols
import javax naming directory searchresult
import org apache activemq command activemqdestination
import org apache activemq jaas groupprincipal
import org apache activemq jaas ldaploginmodule
import org apache commons logging log
import org apache commons logging logfactory
/**
* an {@link authorizationmap} which uses ldap
*
* @org.apache.xbean.xbean
* @author ngcutura
*/
public class ldapauthorizationmap implements authorizationmap
public static final string initial_context_factory
public static final string connection_url
public static final string connection_username
public static final string connection_password
public static final string connection_protocol
public static final string authentication
public static final string topic_search_matching
public static final string topic_search_subtree
public static final string queue_search_matching
public static final string queue_search_subtree
public static final string admin_base
public static final string admin_attribute
public static final string read_base
public static final string read_attribute
public static final string write_base
public static final string write_attribute
private static final log log   logfactory getlog ldaploginmodule class
private string initialcontextfactory
private string connectionurl
private string connectionusername
private string connectionpassword
private string connectionprotocol
private string authentication
private dircontext context
private messageformat topicsearchmatchingformat
private messageformat queuesearchmatchingformat
private boolean topicsearchsubtreebool   true
private boolean queuesearchsubtreebool   true
private string adminbase
private string adminattribute
private string readbase
private string readattribute
private string writebase
private string writeattribute
public ldapauthorizationmap
// lets setup some sensible defaults
initialcontextfactory
connectionurl
connectionusername
connectionpassword
connectionprotocol
authentication
topicsearchmatchingformat   new messageformat
queuesearchmatchingformat   new messageformat
adminbase
adminattribute
readbase
readattribute
writebase
writeattribute
public ldapauthorizationmap map options
initialcontextfactory    string options get initial_context_factory
connectionurl    string options get connection_url
connectionusername    string options get connection_username
connectionpassword    string options get connection_password
connectionprotocol    string options get connection_protocol
authentication    string options get authentication
adminbase    string options get admin_base
adminattribute    string options get admin_attribute
readbase    string options get read_base
readattribute    string options get read_attribute
writebase    string options get write_base
writeattribute    string options get write_attribute
string topicsearchmatching    string options get topic_search_matching
string topicsearchsubtree    string options get topic_search_subtree
string queuesearchmatching    string options get queue_search_matching
string queuesearchsubtree    string options get queue_search_subtree
topicsearchmatchingformat   new messageformat topicsearchmatching
queuesearchmatchingformat   new messageformat queuesearchmatching
topicsearchsubtreebool   boolean valueof topicsearchsubtree  booleanvalue
queuesearchsubtreebool   boolean valueof queuesearchsubtree  booleanvalue
public set<groupprincipal> gettempdestinationadminacls
// todo insert implementation
return null
public set<groupprincipal> gettempdestinationreadacls
// todo insert implementation
return null
public set<groupprincipal> gettempdestinationwriteacls
// todo insert implementation
return null
public set<groupprincipal> getadminacls activemqdestination destination
return getacls destination  adminbase  adminattribute
public set<groupprincipal> getreadacls activemqdestination destination
return getacls destination  readbase  readattribute
public set<groupprincipal> getwriteacls activemqdestination destination
return getacls destination  writebase  writeattribute
// properties
// -------------------------------------------------------------------------
public string getadminattribute
return adminattribute
public void setadminattribute string adminattribute
this adminattribute   adminattribute
public string getadminbase
return adminbase
public void setadminbase string adminbase
this adminbase   adminbase
public string getauthentication
return authentication
public void setauthentication string authentication
this authentication   authentication
public string getconnectionpassword
return connectionpassword
public void setconnectionpassword string connectionpassword
this connectionpassword   connectionpassword
public string getconnectionprotocol
return connectionprotocol
public void setconnectionprotocol string connectionprotocol
this connectionprotocol   connectionprotocol
public string getconnectionurl
return connectionurl
public void setconnectionurl string connectionurl
this connectionurl   connectionurl
public string getconnectionusername
return connectionusername
public void setconnectionusername string connectionusername
this connectionusername   connectionusername
public dircontext getcontext
return context
public void setcontext dircontext context
this context   context
public string getinitialcontextfactory
return initialcontextfactory
public void setinitialcontextfactory string initialcontextfactory
this initialcontextfactory   initialcontextfactory
public messageformat getqueuesearchmatchingformat
return queuesearchmatchingformat
public void setqueuesearchmatchingformat messageformat queuesearchmatchingformat
this queuesearchmatchingformat   queuesearchmatchingformat
public boolean isqueuesearchsubtreebool
return queuesearchsubtreebool
public void setqueuesearchsubtreebool boolean queuesearchsubtreebool
this queuesearchsubtreebool   queuesearchsubtreebool
public string getreadattribute
return readattribute
public void setreadattribute string readattribute
this readattribute   readattribute
public string getreadbase
return readbase
public void setreadbase string readbase
this readbase   readbase
public messageformat gettopicsearchmatchingformat
return topicsearchmatchingformat
public void settopicsearchmatchingformat messageformat topicsearchmatchingformat
this topicsearchmatchingformat   topicsearchmatchingformat
public boolean istopicsearchsubtreebool
return topicsearchsubtreebool
public void settopicsearchsubtreebool boolean topicsearchsubtreebool
this topicsearchsubtreebool   topicsearchsubtreebool
public string getwriteattribute
return writeattribute
public void setwriteattribute string writeattribute
this writeattribute   writeattribute
public string getwritebase
return writebase
public void setwritebase string writebase
this writebase   writebase
// implementation methods
// -------------------------------------------------------------------------
protected set<groupprincipal> getacls activemqdestination destination  string rolebase  string roleattribute
try
context   open
catch  namingexception e
log error e
return new hashset<groupprincipal>
// if ((destination.getdestinationtype() &
// (activemqdestination.queue_type | activemqdestination.topic_type)) !=
// 0)
// return new hashset();
string destinationbase
searchcontrols constraints   new searchcontrols
if   destination getdestinationtype     activemqdestination queue_type     activemqdestination queue_type
destinationbase   queuesearchmatchingformat format new string  destination getphysicalname
if  queuesearchsubtreebool
constraints setsearchscope searchcontrols subtree_scope
else
constraints setsearchscope searchcontrols onelevel_scope
if   destination getdestinationtype     activemqdestination topic_type     activemqdestination topic_type
destinationbase   topicsearchmatchingformat format new string  destination getphysicalname
if  topicsearchsubtreebool
constraints setsearchscope searchcontrols subtree_scope
else
constraints setsearchscope searchcontrols onelevel_scope
constraints setreturningattributes new string  roleattribute
try
set<groupprincipal> roles   new hashset<groupprincipal>
set<string> acls   new hashset<string>
namingenumeration results   context search destinationbase  rolebase  constraints
while  results hasmore
searchresult result    searchresult results next
attributes attrs   result getattributes
if  attrs    null
continue
acls   addattributevalues roleattribute  attrs  acls
for  iterator<string> iter   acls iterator    iter hasnext
string rolename   iter next
roles add new groupprincipal rolename
return roles
catch  namingexception e
log error e
return new hashset<groupprincipal>
protected set<string> addattributevalues string attrid  attributes attrs  set<string> values  throws namingexception
if  attrid    null    attrs    null
return values
if  values    null
values   new hashset<string>
attribute attr   attrs get attrid
if  attr    null
return values
namingenumeration e   attr getall
while  e hasmore
string value    string e next
values add value
return values
protected dircontext open   throws namingexception
if  context    null
return context
try
hashtable<string  string> env   new hashtable<string  string>
env put context initial_context_factory  initialcontextfactory
if  connectionusername    null       equals connectionusername
env put context security_principal  connectionusername
if  connectionpassword    null       equals connectionpassword
env put context security_credentials  connectionpassword
env put context security_protocol  connectionprotocol
env put context provider_url  connectionurl
env put context security_authentication  authentication
context   new initialdircontext env
catch  namingexception e
log error e
throw e
return context