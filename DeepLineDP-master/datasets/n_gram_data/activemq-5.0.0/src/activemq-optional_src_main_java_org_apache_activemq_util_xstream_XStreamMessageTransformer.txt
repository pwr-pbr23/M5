/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq util xstream
import java io serializable
import java io stringreader
import java io stringwriter
import javax jms jmsexception
import javax jms message
import javax jms messageconsumer
import javax jms messageproducer
import javax jms objectmessage
import javax jms session
import javax jms textmessage
import com thoughtworks xstream xstream
import com thoughtworks xstream io hierarchicalstreamreader
import com thoughtworks xstream io hierarchicalstreamwriter
import com thoughtworks xstream io xml prettyprintwriter
import com thoughtworks xstream io xml xppreader
import org apache activemq messagetransformersupport
/**
* transforms object messages to text messages and vice versa using
* {@link xstream}
*
* @version $revision$
*/
public class xstreammessagetransformer extends messagetransformersupport
protected messagetransform transformtype
private xstream xstream
/**
* defines the type of transformation. if xml (default), - producer
* transformation transforms from object to xml. - consumer transformation
* transforms from xml to object. if object, - producer transformation
* transforms from xml to object. - consumer transformation transforms from
* object to xml. if adaptive, - producer transformation transforms from
* object to xml, or xml to object depending on the type of the original
* message - consumer transformation transforms from xml to object, or
* object to xml depending on the type of the original message
*/
public enum messagetransform
xml  object  adaptive
public xstreammessagetransformer
this messagetransform xml
public xstreammessagetransformer messagetransform transformtype
this transformtype   transformtype
public message consumertransform session session  messageconsumer consumer  message message  throws jmsexception
switch  transformtype
case xml
return  message instanceof textmessage  ? texttoobject session   textmessage message    message
case object
return  message instanceof objectmessage  ? objecttotext session   objectmessage message    message
case adaptive
return  message instanceof textmessage  ? texttoobject session   textmessage message     message instanceof objectmessage  ? objecttotext session   objectmessage message    message
default
return message
public message producertransform session session  messageproducer producer  message message  throws jmsexception
switch  transformtype
case xml
return  message instanceof objectmessage  ? objecttotext session   objectmessage message    message
case object
return  message instanceof textmessage  ? texttoobject session   textmessage message    message
case adaptive
return  message instanceof textmessage  ? texttoobject session   textmessage message     message instanceof objectmessage  ? objecttotext session   objectmessage message    message
default
return message
// properties
// -------------------------------------------------------------------------
public xstream getxstream
if  xstream    null
xstream   createxstream
return xstream
public void setxstream xstream xstream
this xstream   xstream
// implementation methods
// -------------------------------------------------------------------------
protected xstream createxstream
return new xstream
public messagetransform gettransformtype
return transformtype
public void settransformtype messagetransform transformtype
this transformtype   transformtype
/**
* transforms an incoming xml encoded {@link textmessage} to an
* {@link objectmessage}
*
* @param session - jms session currently being used
* @param textmessage - text message to transform to object message
* @return objectmessage
* @throws jmsexception
*/
protected objectmessage texttoobject session session  textmessage textmessage  throws jmsexception
object object   unmarshall session  textmessage
if  object instanceof serializable
objectmessage answer   session createobjectmessage  serializable object
copyproperties textmessage  answer
return answer
else
throw new jmsexception     object
/**
* transforms an incoming {@link objectmessage} to an xml encoded
* {@link textmessage}
*
* @param session - jms session currently being used
* @param objectmessage - object message to transform to text message
* @return xml encoded textmessage
* @throws jmsexception
*/
protected textmessage objecttotext session session  objectmessage objectmessage  throws jmsexception
textmessage answer   session createtextmessage marshall session  objectmessage
copyproperties objectmessage  answer
return answer
/**
* marshalls the object in the {@link objectmessage} to a string using xml
* encoding
*/
protected string marshall session session  objectmessage objectmessage  throws jmsexception
serializable object   objectmessage getobject
stringwriter buffer   new stringwriter
hierarchicalstreamwriter out   new prettyprintwriter buffer
getxstream   marshal object  out
return buffer tostring
/**
* unmarshalls the xml encoded message in the {@link textmessage} to an
* object
*/
protected object unmarshall session session  textmessage textmessage  throws jmsexception
hierarchicalstreamreader in   new xppreader new stringreader textmessage gettext
return getxstream   unmarshal in