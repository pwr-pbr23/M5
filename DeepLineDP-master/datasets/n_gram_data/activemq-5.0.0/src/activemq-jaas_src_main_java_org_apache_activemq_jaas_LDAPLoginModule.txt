/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq jaas
import java io ioexception
import java security principal
import java text messageformat
import java util arraylist
import java util hashset
import java util hashtable
import java util iterator
import java util map
import java util set
import javax naming authenticationexception
import javax naming communicationexception
import javax naming context
import javax naming name
import javax naming nameparser
import javax naming namingenumeration
import javax naming namingexception
import javax naming directory attribute
import javax naming directory attributes
import javax naming directory dircontext
import javax naming directory initialdircontext
import javax naming directory searchcontrols
import javax naming directory searchresult
import javax security auth subject
import javax security auth callback callback
import javax security auth callback callbackhandler
import javax security auth callback namecallback
import javax security auth callback passwordcallback
import javax security auth callback unsupportedcallbackexception
import javax security auth login failedloginexception
import javax security auth login loginexception
import javax security auth spi loginmodule
import org apache commons logging log
import org apache commons logging logfactory
/**
* @version $rev: $ $date: $
*/
public class ldaploginmodule implements loginmodule
private static final string initial_context_factory
private static final string connection_url
private static final string connection_username
private static final string connection_password
private static final string connection_protocol
private static final string authentication
private static final string user_base
private static final string user_search_matching
private static final string user_search_subtree
private static final string role_base
private static final string role_name
private static final string role_search_matching
private static final string role_search_subtree
private static final string user_role_name
private static log log   logfactory getlog ldaploginmodule class
protected dircontext context
private subject subject
private callbackhandler handler
private string initialcontextfactory
private string connectionurl
private string connectionusername
private string connectionpassword
private string connectionprotocol
private string authentication
private string userbase
private string rolebase
private string rolename
private string userrolename
private string username
private messageformat usersearchmatchingformat
private messageformat rolesearchmatchingformat
private boolean usersearchsubtreebool
private boolean rolesearchsubtreebool
private set<groupprincipal> groups   new hashset<groupprincipal>
public void initialize subject subject  callbackhandler callbackhandler  map sharedstate  map options
this subject   subject
this handler   callbackhandler
initialcontextfactory    string options get initial_context_factory
connectionurl    string options get connection_url
connectionusername    string options get connection_username
connectionpassword    string options get connection_password
connectionprotocol    string options get connection_protocol
authentication    string options get authentication
userbase    string options get user_base
string usersearchmatching    string options get user_search_matching
string usersearchsubtree    string options get user_search_subtree
rolebase    string options get role_base
rolename    string options get role_name
string rolesearchmatching    string options get role_search_matching
string rolesearchsubtree    string options get role_search_subtree
userrolename    string options get user_role_name
usersearchmatchingformat   new messageformat usersearchmatching
rolesearchmatchingformat   new messageformat rolesearchmatching
usersearchsubtreebool   boolean valueof usersearchsubtree  booleanvalue
rolesearchsubtreebool   boolean valueof rolesearchsubtree  booleanvalue
public boolean login   throws loginexception
callback callbacks   new callback
callbacks   new namecallback
callbacks   new passwordcallback    false
try
handler handle callbacks
catch  ioexception ioe
throw  loginexception new loginexception   initcause ioe
catch  unsupportedcallbackexception uce
throw  loginexception new loginexception   initcause uce
username     namecallback callbacks  getname
string password   new string   passwordcallback callbacks  getpassword
if  username    null      equals username     password    null      equals password
return false
try
boolean result   authenticate username  password
if   result
throw new failedloginexception
else
return true
catch  exception e
throw  loginexception new loginexception    initcause e
public boolean logout   throws loginexception
username   null
return true
public boolean commit   throws loginexception
set<principal> principals   subject getprincipals
principals add new userprincipal username
iterator<groupprincipal> iter   groups iterator
while  iter hasnext
principals add iter next
return true
public boolean abort   throws loginexception
username   null
return true
protected void close dircontext context
try
context close
catch  exception e
log error e
protected boolean authenticate string username  string password  throws exception
dircontext context   null
context   open
try
string filter   usersearchmatchingformat format new string
username
searchcontrols constraints   new searchcontrols
if  usersearchsubtreebool
constraints setsearchscope searchcontrols subtree_scope
else
constraints setsearchscope searchcontrols onelevel_scope
// setup attributes
arraylist<string> list   new arraylist<string>
if  userrolename    null
list add userrolename
string attribs   new string
list toarray attribs
constraints setreturningattributes attribs
namingenumeration results   context search userbase  filter  constraints
if  results    null     results hasmore
return false
searchresult result    searchresult results next
if  results hasmore
// ignore for now
nameparser parser   context getnameparser
name contextname   parser parse context getnameinnamespace
name basename   parser parse userbase
name entryname   parser parse result getname
name name   contextname addall basename
name   name addall entryname
string dn   name tostring
attributes attrs   result getattributes
if  attrs    null
return false
arraylist<string> roles   null
if  userrolename    null
roles   addattributevalues userrolename  attrs  roles
// check the credentials by binding to server
if  binduser context  dn  password
// if authenticated add more roles
roles   getroles context  dn  username  roles
for  int i   0  i < roles size    i
groups add new groupprincipal roles get i
else
return false
catch  communicationexception e
catch  namingexception e
if  context    null
close context
return false
return true
protected arraylist<string> getroles dircontext context  string dn  string username  arraylist<string> currentroles  throws namingexception
arraylist<string> list   currentroles
if  list    null
list   new arraylist<string>
if  rolename    null      equals rolename
return list
string filter   rolesearchmatchingformat format new string
dorfc2254encoding dn   username
searchcontrols constraints   new searchcontrols
if  rolesearchsubtreebool
constraints setsearchscope searchcontrols subtree_scope
else
constraints setsearchscope searchcontrols onelevel_scope
namingenumeration results   context search rolebase  filter  constraints
while  results hasmore
searchresult result    searchresult results next
attributes attrs   result getattributes
if  attrs    null
continue
list   addattributevalues rolename  attrs  list
return list
protected string dorfc2254encoding string inputstring
stringbuffer buf   new stringbuffer inputstring length
for  int i   0  i < inputstring length    i
char c   inputstring charat i
switch  c
case
buf append
break
case
buf append
break
case
buf append
break
case
buf append
break
case
buf append
break
default
buf append c
break
return buf tostring
protected boolean binduser dircontext context  string dn  string password  throws namingexception
boolean isvalid   false
context addtoenvironment context security_principal  dn
context addtoenvironment context security_credentials  password
try
context getattributes    null
isvalid   true
catch  authenticationexception e
isvalid   false
log debug     dn
if  connectionusername    null
context addtoenvironment context security_principal  connectionusername
else
context removefromenvironment context security_principal
if  connectionpassword    null
context addtoenvironment context security_credentials  connectionpassword
else
context removefromenvironment context security_credentials
return isvalid
private arraylist<string> addattributevalues string attrid  attributes attrs  arraylist<string> values  throws namingexception
if  attrid    null    attrs    null
return values
if  values    null
values   new arraylist<string>
attribute attr   attrs get attrid
if  attr    null
return values
namingenumeration e   attr getall
while  e hasmore
string value    string e next
values add value
return values
protected dircontext open   throws namingexception
if  context    null
return context
try
hashtable<string  string> env   new hashtable<string  string>
env put context initial_context_factory  initialcontextfactory
if  connectionusername    null       equals connectionusername
env put context security_principal  connectionusername
if  connectionpassword    null       equals connectionpassword
env put context security_credentials  connectionpassword
env put context security_protocol  connectionprotocol
env put context provider_url  connectionurl
env put context security_authentication  authentication
context   new initialdircontext env
catch  namingexception e
log error e
throw e
return context