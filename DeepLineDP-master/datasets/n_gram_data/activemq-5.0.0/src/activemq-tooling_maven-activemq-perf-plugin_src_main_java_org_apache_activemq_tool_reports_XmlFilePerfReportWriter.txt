/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq tool reports
import java io bufferedoutputstream
import java io bufferedreader
import java io file
import java io fileinputstream
import java io filenotfoundexception
import java io fileoutputstream
import java io ioexception
import java io inputstreamreader
import java io printwriter
import java util arraylist
import java util hashmap
import java util iterator
import java util list
import java util map
import java util properties
import java util stringtokenizer
import org apache activemq tool reports plugins cpureportplugin
import org apache activemq tool reports plugins throughputreportplugin
import org apache commons logging log
import org apache commons logging logfactory
public class xmlfileperfreportwriter extends abstractperfreportwriter
private static final log log   logfactory getlog xmlfileperfreportwriter class
private file templogfile
private printwriter templogfilewriter
private file xmlfile
private printwriter xmlfilewriter
private string reportdir
private string reportname
private map<string  properties> testpropsmap
private list<properties> testpropslist
public xmlfileperfreportwriter
this
public xmlfileperfreportwriter string reportdir  string reportname
this testpropsmap   new hashmap<string  properties>
this testpropslist   new arraylist<properties>
this reportdir   reportdir
this reportname   reportname
public void openreportwriter
if  templogfile    null
templogfile   createtemplogfile
try
// disable auto-flush and allocate 100kb of buffer
templogfilewriter   new printwriter new bufferedoutputstream new fileoutputstream templogfile   102400   false
catch  filenotfoundexception e
e printstacktrace
public void closereportwriter
// flush and close log file writer
templogfilewriter flush
templogfilewriter close
writetoxml
public string getreportdir
return reportdir
public void setreportdir string reportdir
this reportdir   reportdir
public string getreportname
return reportname
public void setreportname string reportname
this reportname   reportname
public file getxmlfile
return xmlfile
public void setxmlfile file xmlfile
this xmlfile   xmlfile
public void writeinfo string info
templogfilewriter println     info
public void writecsvdata int csvtype  string csvdata
if  csvtype    report_plugin_throughput
templogfilewriter println     csvdata
else if  csvtype    report_plugin_cpu
templogfilewriter println     csvdata
public void writeproperties string header  properties props
testpropsmap put header  props
public void writeproperties properties props
testpropslist add props
protected file createtemplogfile
file f
try
f   file createtempfile    null
catch  ioexception e
f   new file     system currenttimemillis
f deleteonexit
return f
protected file createxmlfile
string filename   getreportname   endswith    ? getreportname      getreportname
string path    getreportdir      null  ?     getreportdir
return new file path   filename
protected void writetoxml
try
xmlfile   createxmlfile
xmlfilewriter   new printwriter new fileoutputstream xmlfile
writexmlheader
writexmltestsettings
writexmllogfile
writexmlperfsummary
writexmlfooter
xmlfilewriter close
log info     xmlfile getabsolutepath
catch  exception e
e printstacktrace
protected void writexmlheader
xmlfilewriter println
protected void writexmlfooter
xmlfilewriter println
protected void writexmltestsettings
properties props
// write test settings
for  iterator<string> i   testpropsmap keyset   iterator    i hasnext
string key   i next
props   testpropsmap get key
writemap key  props
int count   1
for  iterator<properties> i   testpropslist iterator    i hasnext
props   i next
writemap     count    props
protected void writexmllogfile   throws ioexception
// write throughput data
xmlfilewriter println
xmlfilewriter println
bufferedreader reader   new bufferedreader new inputstreamreader new fileinputstream templogfile
string line
while   line   reader readline       null
if  line startswith
handlecsvdata report_plugin_throughput  line substring   length
parseperfcsvdata    line substring   length
else if  line startswith
handlecsvdata report_plugin_cpu  line substring   length
parseperfcsvdata    line substring   length
else if  line startswith
xmlfilewriter println     line
else
xmlfilewriter println     line
xmlfilewriter println
xmlfilewriter println
protected void writexmlperfsummary
map summary
summary   getsummary report_plugin_throughput
if  summary    null    summary size   > 0
writethroughputsummary summary
summary   getsummary report_plugin_cpu
if  summary    null    summary size   > 0
writecpusummary summary
protected void writethroughputsummary map summary
// write throughput summary
xmlfilewriter println
xmlfilewriter println
string val
string clientname
string clientval
system out println
system out println
system out println
val    string summary get throughputreportplugin key_sys_total_tp
system out println     val
xmlfilewriter println     throughputreportplugin key_sys_total_tp       val
val    string summary get throughputreportplugin key_sys_total_clients
system out println     val
xmlfilewriter println     throughputreportplugin key_sys_total_clients       val
val    string summary get throughputreportplugin key_sys_ave_tp
system out println     val
xmlfilewriter println     throughputreportplugin key_sys_ave_tp       val
val    string summary get throughputreportplugin key_sys_ave_emm_tp
system out println     val
xmlfilewriter println     throughputreportplugin key_sys_ave_emm_tp       val
val    string summary get throughputreportplugin key_sys_ave_client_tp
system out println     val
xmlfilewriter println     throughputreportplugin key_sys_ave_client_tp       val
val    string summary get throughputreportplugin key_sys_ave_client_emm_tp
system out println     val
xmlfilewriter println     throughputreportplugin key_sys_ave_client_emm_tp       val
val    string summary get throughputreportplugin key_min_client_tp
clientname   val substring 0  val indexof
clientval   val substring val indexof      1
system out println     clientname       clientval
xmlfilewriter println     throughputreportplugin key_min_client_tp       clientname       clientval
val    string summary get throughputreportplugin key_max_client_tp
clientname   val substring 0  val indexof
clientval   val substring val indexof      1
system out println     clientname       clientval
xmlfilewriter println     throughputreportplugin key_max_client_tp       clientname       clientval
val    string summary get throughputreportplugin key_min_client_total_tp
clientname   val substring 0  val indexof
clientval   val substring val indexof      1
system out println     clientname       clientval
xmlfilewriter println     throughputreportplugin key_min_client_total_tp       clientname       clientval
val    string summary get throughputreportplugin key_max_client_total_tp
clientname   val substring 0  val indexof
clientval   val substring val indexof      1
system out println     clientname       clientval
xmlfilewriter println     throughputreportplugin key_max_client_total_tp       clientname       clientval
val    string summary get throughputreportplugin key_min_client_ave_tp
clientname   val substring 0  val indexof
clientval   val substring val indexof      1
system out println     clientname       clientval
xmlfilewriter println     throughputreportplugin key_min_client_ave_tp       clientname       clientval
val    string summary get throughputreportplugin key_max_client_ave_tp
clientname   val substring 0  val indexof
clientval   val substring val indexof      1
system out println     clientname       clientval
xmlfilewriter println     throughputreportplugin key_max_client_ave_tp       clientname       clientval
val    string summary get throughputreportplugin key_min_client_ave_emm_tp
clientname   val substring 0  val indexof
clientval   val substring val indexof      1
system out println     clientname       clientval
xmlfilewriter println     throughputreportplugin key_min_client_ave_emm_tp       clientname       clientval
val    string summary get throughputreportplugin key_max_client_ave_emm_tp
clientname   val substring 0  val indexof
clientval   val substring val indexof      1
system out println     clientname       clientval
xmlfilewriter println     throughputreportplugin key_max_client_ave_emm_tp       clientname       clientval
xmlfilewriter println
xmlfilewriter println
protected void writecpusummary map summary
xmlfilewriter println
xmlfilewriter println
system out println
system out println
system out println
xmlfilewriter println     cpureportplugin key_block_recv       summary get cpureportplugin key_block_recv
system out println     summary get cpureportplugin key_block_recv
xmlfilewriter println     cpureportplugin key_ave_block_recv       summary get cpureportplugin key_ave_block_recv
system out println     summary get cpureportplugin key_ave_block_recv
xmlfilewriter println     cpureportplugin key_block_sent       summary get cpureportplugin key_block_sent
system out println     summary get cpureportplugin key_block_sent
xmlfilewriter println     cpureportplugin key_ave_block_sent       summary get cpureportplugin key_ave_block_sent
system out println     summary get cpureportplugin key_ave_block_sent
xmlfilewriter println     cpureportplugin key_ctx_switch       summary get cpureportplugin key_ctx_switch
system out println     summary get cpureportplugin key_ctx_switch
xmlfilewriter println     cpureportplugin key_ave_ctx_switch       summary get cpureportplugin key_ave_ctx_switch
system out println     summary get cpureportplugin key_ave_ctx_switch
xmlfilewriter println     cpureportplugin key_user_time       summary get cpureportplugin key_user_time
system out println     summary get cpureportplugin key_user_time
xmlfilewriter println     cpureportplugin key_ave_user_time       summary get cpureportplugin key_ave_user_time
system out println     summary get cpureportplugin key_ave_user_time
xmlfilewriter println     cpureportplugin key_sys_time       summary get cpureportplugin key_sys_time
system out println     summary get cpureportplugin key_sys_time
xmlfilewriter println     cpureportplugin key_ave_sys_time       summary get cpureportplugin key_ave_sys_time
system out println     summary get cpureportplugin key_ave_sys_time
xmlfilewriter println     cpureportplugin key_idle_time       summary get cpureportplugin key_idle_time
system out println     summary get cpureportplugin key_idle_time
xmlfilewriter println     cpureportplugin key_ave_idle_time       summary get cpureportplugin key_ave_idle_time
system out println     summary get cpureportplugin key_ave_idle_time
xmlfilewriter println     cpureportplugin key_wait_time       summary get cpureportplugin key_wait_time
system out println     summary get cpureportplugin key_wait_time
xmlfilewriter println     cpureportplugin key_ave_wait_time       summary get cpureportplugin key_ave_wait_time
system out println     summary get cpureportplugin key_ave_wait_time
xmlfilewriter println
xmlfilewriter println
protected void writemap string name  map map
xmlfilewriter println     name
xmlfilewriter println
for  iterator i   map keyset   iterator    i hasnext
string propkey    string i next
object propval   map get propkey
xmlfilewriter println     propkey       propval tostring
xmlfilewriter println
xmlfilewriter println
protected void parseperfcsvdata string elementname  string csvdata
stringtokenizer tokenizer   new stringtokenizer csvdata
string xmlelement
xmlelement       elementname
string data
string key
string val
while  tokenizer hasmoretokens
data   tokenizer nexttoken
key   data substring 0  data indexof
val   data substring data indexof      1
xmlelement        key       val
xmlelement
xmlfilewriter println xmlelement