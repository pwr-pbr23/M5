/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq store jpa
import java io ioexception
import java util arraylist
import java util list
import java util map
import java util concurrent concurrenthashmap
import java util concurrent atomic atomiclong
import javax persistence entitymanager
import javax persistence query
import org apache activemq broker connectioncontext
import org apache activemq command activemqdestination
import org apache activemq command message
import org apache activemq command messageid
import org apache activemq command subscriptioninfo
import org apache activemq store messagerecoverylistener
import org apache activemq store topicmessagestore
import org apache activemq store jpa model storedmessage
import org apache activemq store jpa model storedsubscription
import org apache activemq store jpa model storedsubscription subscriptionid
import org apache activemq util bytesequence
import org apache activemq util ioexceptionsupport
public class jpatopicmessagestore extends jpamessagestore implements topicmessagestore
private map<subscriptionid  atomiclong> subscriberlastmessagemap   new concurrenthashmap<subscriptionid  atomiclong>
public jpatopicmessagestore jpapersistenceadapter adapter  activemqdestination destination
super adapter  destination
public void acknowledge connectioncontext context  string clientid  string subscriptionname  messageid messageid  throws ioexception
entitymanager manager   adapter beginentitymanager context
try
storedsubscription ss   findstoredsubscription manager  clientid  subscriptionname
ss setlastackedid messageid getbrokersequenceid
catch  throwable e
adapter rollbackentitymanager context  manager
throw ioexceptionsupport create e
adapter commitentitymanager context  manager
public void addsubsciption subscriptioninfo info  boolean retroactive  throws ioexception
entitymanager manager   adapter beginentitymanager null
try
storedsubscription ss   new storedsubscription
ss setclientid info getclientid
ss setsubscriptionname info getsubscriptionname
ss setdestination destinationname
ss setselector info getselector
ss setsubscribeddestination info getsubscribeddestination   getqualifiedname
ss setlastackedid  1
if   retroactive
query query   manager createquery
long rc    long query getsingleresult
if  rc    null
ss setlastackedid rc
manager persist ss
catch  throwable e
adapter rollbackentitymanager null  manager
throw ioexceptionsupport create e
adapter commitentitymanager null  manager
public void deletesubscription string clientid  string subscriptionname  throws ioexception
entitymanager manager   adapter beginentitymanager null
try
storedsubscription ss   findstoredsubscription manager  clientid  subscriptionname
manager remove ss
catch  throwable e
adapter rollbackentitymanager null  manager
throw ioexceptionsupport create e
adapter commitentitymanager null  manager
private storedsubscription findstoredsubscription entitymanager manager  string clientid  string subscriptionname
query query   manager createquery
query setparameter 1  clientid
query setparameter 2  subscriptionname
query setparameter 3  destinationname
list<storedsubscription> resultlist   query getresultlist
if  resultlist isempty
return null
return resultlist get 0
public subscriptioninfo getallsubscriptions   throws ioexception
subscriptioninfo rc
entitymanager manager   adapter beginentitymanager null
try
arraylist<subscriptioninfo> l   new arraylist<subscriptioninfo>
query query   manager createquery
query setparameter 1  destinationname
for  storedsubscription ss    list<storedsubscription> query getresultlist
subscriptioninfo info   new subscriptioninfo
info setclientid ss getclientid
info setdestination destination
info setselector ss getselector
info setsubscriptionname ss getsubscriptionname
info setsubscribeddestination tosubscribeddestination ss
l add info
rc   new subscriptioninfo
l toarray rc
catch  throwable e
adapter rollbackentitymanager null  manager
throw ioexceptionsupport create e
adapter commitentitymanager null  manager
return rc
public int getmessagecount string clientid  string subscriptionname  throws ioexception
long rc
entitymanager manager   adapter beginentitymanager null
try
query query   manager createquery
query setparameter 1  clientid
query setparameter 2  subscriptionname
query setparameter 3  destinationname
rc    long query getsingleresult
catch  throwable e
adapter rollbackentitymanager null  manager
throw ioexceptionsupport create e
adapter commitentitymanager null  manager
return rc intvalue
public subscriptioninfo lookupsubscription string clientid  string subscriptionname  throws ioexception
subscriptioninfo rc   null
entitymanager manager   adapter beginentitymanager null
try
storedsubscription ss   findstoredsubscription manager  clientid  subscriptionname
if  ss    null
rc   new subscriptioninfo
rc setclientid ss getclientid
rc setdestination destination
rc setselector ss getselector
rc setsubscriptionname ss getsubscriptionname
rc setsubscribeddestination tosubscribeddestination ss
catch  throwable e
adapter rollbackentitymanager null  manager
throw ioexceptionsupport create e
adapter commitentitymanager null  manager
return rc
private activemqdestination tosubscribeddestination storedsubscription ss
if  ss getsubscribeddestination      null
return null
return activemqdestination createdestination ss getsubscribeddestination    activemqdestination queue_type
public void recovernextmessages string clientid  string subscriptionname  int maxreturned  messagerecoverylistener listener  throws exception
entitymanager manager   adapter beginentitymanager null
try
subscriptionid id   new subscriptionid
id setclientid clientid
id setsubscriptionname subscriptionname
id setdestination destinationname
atomiclong last   subscriberlastmessagemap get id
if  last    null
storedsubscription ss   findstoredsubscription manager  clientid  subscriptionname
last   new atomiclong ss getlastackedid
subscriberlastmessagemap put id  last
final atomiclong lastmessageid   last
query query   manager createquery
query setparameter 1  destinationname
query setparameter 2  lastmessageid get
query setmaxresults maxreturned
int count   0
for  storedmessage m    list<storedmessage> query getresultlist
message message    message wireformat unmarshal new bytesequence m getdata
listener recovermessage message
lastmessageid set m getid
count
if  count >  maxreturned
return
catch  throwable e
adapter rollbackentitymanager null  manager
throw ioexceptionsupport create e
adapter commitentitymanager null  manager
public void recoversubscription string clientid  string subscriptionname  messagerecoverylistener listener  throws exception
entitymanager manager   adapter beginentitymanager null
try
storedsubscription ss   findstoredsubscription manager  clientid  subscriptionname
query query   manager createquery
query setparameter 1  destinationname
query setparameter 2  ss getlastackedid
for  storedmessage m    list<storedmessage> query getresultlist
message message    message wireformat unmarshal new bytesequence m getdata
listener recovermessage message
catch  throwable e
adapter rollbackentitymanager null  manager
throw ioexceptionsupport create e
adapter commitentitymanager null  manager
public void resetbatching string clientid  string subscriptionname
subscriptionid id   new subscriptionid
id setclientid clientid
id setsubscriptionname subscriptionname
id setdestination destinationname
subscriberlastmessagemap remove id