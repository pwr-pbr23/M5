/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq security
import java security principal
import java security cert x509certificate
import java util iterator
import javax security auth subject
import javax security auth callback callbackhandler
import javax security auth login logincontext
import org apache activemq broker broker
import org apache activemq broker brokerfilter
import org apache activemq broker connectioncontext
import org apache activemq command connectioninfo
import org apache activemq jaas jaascertificatecallbackhandler
import org apache activemq jaas userprincipal
/**
* a jaas authentication broker that uses ssl certificates. this class will
* provide the jaas framework with a jaascertificatecallbackhandler that will
* grant jaas access to incoming connections' ssl certificate chains. note:
* there is a chance that the incoming connection does not have a valid
* certificate (has null).
*
* @author sepandm@gmail.com (sepand)
*/
public class jaascertificateauthenticationbroker extends brokerfilter
private final string jaasconfiguration
/**
* simple constructor. leaves everything to superclass.
*
* @param next the broker that does the actual work for this filter.
* @param jassconfiguration the jaas domain configuration name (refere to
*                jaas documentation).
*/
public jaascertificateauthenticationbroker broker next  string jaasconfiguration
super next
this jaasconfiguration   jaasconfiguration
/**
* overridden to allow for authentication based on client certificates.
* connections being added will be authenticated based on their certificate
* chain and the jaas module specified through the jaas framework. note: the
* security context's username will be set to the first userprincipal
* created by the login module.
*
* @param context the context for the incoming connection.
* @param info the connectioninfo command representing the incoming
*                connection.
*/
public void addconnection connectioncontext context  connectioninfo info  throws exception
if  context getsecuritycontext      null
if    info gettransportcontext   instanceof x509certificate
throw new securityexception
// set the tccl since it seems jaas needs it to find the login
// module classes.
classloader original   thread currentthread   getcontextclassloader
thread currentthread   setcontextclassloader jaasauthenticationbroker class getclassloader
try
// do the login.
try
callbackhandler callback   new jaascertificatecallbackhandler  x509certificate info gettransportcontext
logincontext lc   new logincontext jaasconfiguration  callback
lc login
subject subject   lc getsubject
string dnname
for  iterator iter   subject getprincipals   iterator    iter hasnext
principal nextprincipal    principal iter next
if  nextprincipal instanceof userprincipal
dnname     userprincipal nextprincipal  getname
break
securitycontext s   new jaascertificatesecuritycontext dnname  subject   x509certificate info gettransportcontext
context setsecuritycontext s
catch  exception e
throw new securityexception     e getmessage    e
finally
thread currentthread   setcontextclassloader original
super addconnection context  info
/**
* overriding removeconnection to make sure the security context is cleaned.
*/
public void removeconnection connectioncontext context  connectioninfo info  throwable error  throws exception
super removeconnection context  info  error
context setsecuritycontext null