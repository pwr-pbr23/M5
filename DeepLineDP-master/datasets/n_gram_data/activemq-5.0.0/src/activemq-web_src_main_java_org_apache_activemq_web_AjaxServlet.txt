//========================================================================
//copyright 2006 mort bay consulting pty. ltd.
//------------------------------------------------------------------------
//licensed under the apache license, version 2.0 (the "license");
//you may not use this file except in compliance with the license.
//you may obtain a copy of the license at
//http://www.apache.org/licenses/license-2.0
//unless required by applicable law or agreed to in writing, software
//distributed under the license is distributed on an "as is" basis,
//without warranties or conditions of any kind, either express or implied.
//see the license for the specific language governing permissions and
//limitations under the license.
//========================================================================
package org apache activemq web
import java io bytearrayoutputstream
import java io ioexception
import java io inputstream
import java net url
import java util hashmap
import java util map
import javax servlet servletexception
import javax servlet http httpservletrequest
import javax servlet http httpservletresponse
/* ------------------------------------------------------------ */
/**
* ajaxservlet. the ajaxservlet extends the {@link messagelistenerservlet} with
* the capability to server the <code>amq.js</code> script and associated
* scripts from resources within the activemq-web jar. the amq.js script is the
* client side companion to the messagelistenerservlet and supports sending
* messages and long polling for receiving messages (also called comet style
* ajax).
*/
public class ajaxservlet extends messagelistenerservlet
private map<string  byte> jscache   new hashmap<string  byte>
private long jslastmodified   1000    system currenttimemillis     1000
protected void doget httpservletrequest request  httpservletresponse response  throws servletexception  ioexception
if  request getpathinfo      null    request getpathinfo   endswith
dojavascript request  response
else
super doget request  response
protected void dojavascript httpservletrequest request  httpservletresponse response  throws ioexception  servletexception
// look for a local resource first.
string js   request getservletpath     request getpathinfo
url url   getservletcontext   getresource js
if  url    null
getservletcontext   getnameddispatcher    forward request  response
return
// serve from the classpath resources
string resource       request getpathinfo
synchronized  jscache
byte data   jscache get resource
if  data    null
inputstream in   thread currentthread   getcontextclassloader   getresourceasstream resource
if  in    null
bytearrayoutputstream out   new bytearrayoutputstream
byte buf   new byte
int len   in read buf
while  len >  0
out write buf  0  len
len   in read buf
in close
out close
data   out tobytearray
jscache put resource  data
if  data    null
long ifmodified   request getdateheader
if  ifmodified    jslastmodified
response senderror httpservletresponse sc_not_modified
else
response setcontenttype
response setcontentlength data length
response setdateheader    jslastmodified
response getoutputstream   write data
else
response senderror httpservletresponse sc_not_found