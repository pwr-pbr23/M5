/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq network jms
import javax jms connection
import javax jms destination
import javax jms jmsexception
import javax jms session
import javax jms topic
import javax jms topicconnection
import javax jms topicconnectionfactory
import javax jms topicsession
import javax naming namingexception
import org apache commons logging log
import org apache commons logging logfactory
/**
* a bridge to other jms topic providers
*
* @org.apache.xbean.xbean
*
* @version $revision: 1.1.1.1 $
*/
public class jmstopicconnector extends jmsconnector
private static final log log   logfactory getlog jmstopicconnector class
private string outboundtopicconnectionfactoryname
private string localconnectionfactoryname
private topicconnectionfactory outboundtopicconnectionfactory
private topicconnectionfactory localtopicconnectionfactory
private topicconnection outboundtopicconnection
private topicconnection localtopicconnection
private inboundtopicbridge inboundtopicbridges
private outboundtopicbridge outboundtopicbridges
public boolean init
boolean result   super init
if  result
try
initializeforeigntopicconnection
initializelocaltopicconnection
initializeinboundjmsmessageconvertor
initializeoutboundjmsmessageconvertor
initializeinboundtopicbridges
initializeoutboundtopicbridges
catch  exception e
log error    e
return result
/**
* @return returns the inboundtopicbridges.
*/
public inboundtopicbridge getinboundtopicbridges
return inboundtopicbridges
/**
* @param inboundtopicbridges the inboundtopicbridges to set.
*/
public void setinboundtopicbridges inboundtopicbridge inboundtopicbridges
this inboundtopicbridges   inboundtopicbridges
/**
* @return returns the outboundtopicbridges.
*/
public outboundtopicbridge getoutboundtopicbridges
return outboundtopicbridges
/**
* @param outboundtopicbridges the outboundtopicbridges to set.
*/
public void setoutboundtopicbridges outboundtopicbridge outboundtopicbridges
this outboundtopicbridges   outboundtopicbridges
/**
* @return returns the localtopicconnectionfactory.
*/
public topicconnectionfactory getlocaltopicconnectionfactory
return localtopicconnectionfactory
/**
* @param localtopicconnectionfactory the localtopicconnectionfactory to
*                set.
*/
public void setlocaltopicconnectionfactory topicconnectionfactory localconnectionfactory
this localtopicconnectionfactory   localconnectionfactory
/**
* @return returns the outboundtopicconnectionfactory.
*/
public topicconnectionfactory getoutboundtopicconnectionfactory
return outboundtopicconnectionfactory
/**
* @return returns the outboundtopicconnectionfactoryname.
*/
public string getoutboundtopicconnectionfactoryname
return outboundtopicconnectionfactoryname
/**
* @param outboundtopicconnectionfactoryname the
*                outboundtopicconnectionfactoryname to set.
*/
public void setoutboundtopicconnectionfactoryname string foreigntopicconnectionfactoryname
this outboundtopicconnectionfactoryname   foreigntopicconnectionfactoryname
/**
* @return returns the localconnectionfactoryname.
*/
public string getlocalconnectionfactoryname
return localconnectionfactoryname
/**
* @param localconnectionfactoryname the localconnectionfactoryname to set.
*/
public void setlocalconnectionfactoryname string localconnectionfactoryname
this localconnectionfactoryname   localconnectionfactoryname
/**
* @return returns the localtopicconnection.
*/
public topicconnection getlocaltopicconnection
return localtopicconnection
/**
* @param localtopicconnection the localtopicconnection to set.
*/
public void setlocaltopicconnection topicconnection localtopicconnection
this localtopicconnection   localtopicconnection
/**
* @return returns the outboundtopicconnection.
*/
public topicconnection getoutboundtopicconnection
return outboundtopicconnection
/**
* @param outboundtopicconnection the outboundtopicconnection to set.
*/
public void setoutboundtopicconnection topicconnection foreigntopicconnection
this outboundtopicconnection   foreigntopicconnection
/**
* @param outboundtopicconnectionfactory the outboundtopicconnectionfactory
*                to set.
*/
public void setoutboundtopicconnectionfactory topicconnectionfactory foreigntopicconnectionfactory
this outboundtopicconnectionfactory   foreigntopicconnectionfactory
public void restartproducerconnection   throws namingexception  jmsexception
outboundtopicconnection   null
initializeforeigntopicconnection
protected void initializeforeigntopicconnection   throws namingexception  jmsexception
if  outboundtopicconnection    null
// get the connection factories
if  outboundtopicconnectionfactory    null
// look it up from jndi
if  outboundtopicconnectionfactoryname    null
outboundtopicconnectionfactory    topicconnectionfactory jndioutboundtemplate
lookup outboundtopicconnectionfactoryname  topicconnectionfactory class
if  outboundusername    null
outboundtopicconnection   outboundtopicconnectionfactory
createtopicconnection outboundusername  outboundpassword
else
outboundtopicconnection   outboundtopicconnectionfactory createtopicconnection
else
throw new jmsexception
else
if  outboundusername    null
outboundtopicconnection   outboundtopicconnectionfactory
createtopicconnection outboundusername  outboundpassword
else
outboundtopicconnection   outboundtopicconnectionfactory createtopicconnection
outboundtopicconnection start
protected void initializelocaltopicconnection   throws namingexception  jmsexception
if  localtopicconnection    null
// get the connection factories
if  localtopicconnectionfactory    null
if  embeddedconnectionfactory    null
// look it up from jndi
if  localconnectionfactoryname    null
localtopicconnectionfactory    topicconnectionfactory jndilocaltemplate
lookup localconnectionfactoryname  topicconnectionfactory class
if  localusername    null
localtopicconnection   localtopicconnectionfactory
createtopicconnection localusername  localpassword
else
localtopicconnection   localtopicconnectionfactory createtopicconnection
else
throw new jmsexception
else
localtopicconnection   embeddedconnectionfactory createtopicconnection
else
if  localusername    null
localtopicconnection   localtopicconnectionfactory createtopicconnection localusername
localpassword
else
localtopicconnection   localtopicconnectionfactory createtopicconnection
localtopicconnection start
protected void initializeinboundjmsmessageconvertor
inboundmessageconvertor setconnection localtopicconnection
protected void initializeoutboundjmsmessageconvertor
outboundmessageconvertor setconnection outboundtopicconnection
protected void initializeinboundtopicbridges   throws jmsexception
if  inboundtopicbridges    null
topicsession outboundsession   outboundtopicconnection
createtopicsession false  session auto_acknowledge
topicsession localsession   localtopicconnection createtopicsession false
session auto_acknowledge
for  int i   0  i < inboundtopicbridges length  i
inboundtopicbridge bridge   inboundtopicbridges
string localtopicname   bridge getlocaltopicname
topic activemqtopic   createactivemqtopic localsession  localtopicname
string topicname   bridge getinboundtopicname
topic foreigntopic   createforeigntopic outboundsession  topicname
bridge setconsumertopic foreigntopic
bridge setproducertopic activemqtopic
bridge setproducerconnection localtopicconnection
bridge setconsumerconnection outboundtopicconnection
if  bridge getjmsmessageconvertor      null
bridge setjmsmessageconvertor getinboundmessageconvertor
bridge setjmsconnector this
addinboundbridge bridge
outboundsession close
localsession close
protected void initializeoutboundtopicbridges   throws jmsexception
if  outboundtopicbridges    null
topicsession outboundsession   outboundtopicconnection
createtopicsession false  session auto_acknowledge
topicsession localsession   localtopicconnection createtopicsession false
session auto_acknowledge
for  int i   0  i < outboundtopicbridges length  i
outboundtopicbridge bridge   outboundtopicbridges
string localtopicname   bridge getlocaltopicname
topic activemqtopic   createactivemqtopic localsession  localtopicname
string topicname   bridge getoutboundtopicname
topic foreigntopic   createforeigntopic outboundsession  topicname
bridge setconsumertopic activemqtopic
bridge setproducertopic foreigntopic
bridge setproducerconnection outboundtopicconnection
bridge setconsumerconnection localtopicconnection
if  bridge getjmsmessageconvertor      null
bridge setjmsmessageconvertor getoutboundmessageconvertor
bridge setjmsconnector this
addoutboundbridge bridge
outboundsession close
localsession close
protected destination createreplytobridge destination destination  connection replytoproducerconnection
connection replytoconsumerconnection
topic replytoproducertopic    topic destination
boolean isinbound   replytoproducerconnection equals localtopicconnection
if  isinbound
inboundtopicbridge bridge    inboundtopicbridge replytobridges get replytoproducertopic
if  bridge    null
bridge   new inboundtopicbridge
protected destination processreplytodestination destination destination
return null
try
topicsession replytoconsumersession     topicconnection replytoconsumerconnection
createtopicsession false  session auto_acknowledge
topic replytoconsumertopic   replytoconsumersession createtemporarytopic
replytoconsumersession close
bridge setconsumertopic replytoconsumertopic
bridge setproducertopic replytoproducertopic
bridge setproducerconnection  topicconnection replytoproducerconnection
bridge setconsumerconnection  topicconnection replytoconsumerconnection
bridge setdohandlereplyto false
if  bridge getjmsmessageconvertor      null
bridge setjmsmessageconvertor getinboundmessageconvertor
bridge setjmsconnector this
bridge start
log info     replytoproducertopic
catch  exception e
log error     replytoproducertopic  e
return null
replytobridges put replytoproducertopic  bridge
return bridge getconsumertopic
else
outboundtopicbridge bridge    outboundtopicbridge replytobridges get replytoproducertopic
if  bridge    null
bridge   new outboundtopicbridge
protected destination processreplytodestination destination destination
return null
try
topicsession replytoconsumersession     topicconnection replytoconsumerconnection
createtopicsession false  session auto_acknowledge
topic replytoconsumertopic   replytoconsumersession createtemporarytopic
replytoconsumersession close
bridge setconsumertopic replytoconsumertopic
bridge setproducertopic replytoproducertopic
bridge setproducerconnection  topicconnection replytoproducerconnection
bridge setconsumerconnection  topicconnection replytoconsumerconnection
bridge setdohandlereplyto false
if  bridge getjmsmessageconvertor      null
bridge setjmsmessageconvertor getoutboundmessageconvertor
bridge setjmsconnector this
bridge start
log info     replytoproducertopic
catch  exception e
log error     replytoproducertopic  e
return null
replytobridges put replytoproducertopic  bridge
return bridge getconsumertopic
protected topic createactivemqtopic topicsession session  string topicname  throws jmsexception
return session createtopic topicname
protected topic createforeigntopic topicsession session  string topicname  throws jmsexception
topic result   null
try
result   session createtopic topicname
catch  jmsexception e
// look-up the topic
try
result    topic jndioutboundtemplate lookup topicname  topic class
catch  namingexception e1
string errstr       topicname
log error errstr  e
jmsexception jmsex   new jmsexception errstr
jmsex setlinkedexception e1
throw jmsex
return result