/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq broker region policy
import java util concurrent atomic atomiclong
import javax jms jmsexception
import javax jms message
import javax jms messagelistener
import org apache activemq activemqmessagetransformation
import org apache activemq broker connectioncontext
import org apache activemq broker region destination
import org apache activemq broker region messagereference
import org apache activemq broker region subscriptionrecovery
import org apache activemq broker region topic
import org apache activemq command activemqdestination
import org apache activemq command activemqmessage
import org apache activemq command connectionid
import org apache activemq command messageid
import org apache activemq command producerid
import org apache activemq command sessionid
import org apache activemq util idgenerator
import org apache commons logging log
import org apache commons logging logfactory
/**
* this implementation of {@link subscriptionrecoverypolicy} will perform a user
* specific query mechanism to load any messages they may have missed.
*
* @org.apache.xbean.xbean
* @version $revision$
*/
public class querybasedsubscriptionrecoverypolicy implements subscriptionrecoverypolicy
private static final log log   logfactory getlog querybasedsubscriptionrecoverypolicy class
private messagequery query
private atomiclong messagesequence   new atomiclong 0
private idgenerator idgenerator   new idgenerator
private producerid producerid   createproducerid
public subscriptionrecoverypolicy copy
querybasedsubscriptionrecoverypolicy rc   new querybasedsubscriptionrecoverypolicy
rc setquery query
return rc
public boolean add connectioncontext context  messagereference message  throws exception
return query validateupdate message getmessage
public void recover final connectioncontext context  final topic topic  final subscriptionrecovery sub  throws exception
if  query    null
activemqdestination destination   sub getactivemqdestination
query execute destination  new messagelistener
public void onmessage message message
dispatchinitialmessage message  topic  context  sub
public void start   throws exception
if  query    null
throw new illegalargumentexception
public void stop   throws exception
public messagequery getquery
return query
/**
* sets the query strategy to load initial messages
*/
public void setquery messagequery query
this query   query
public org apache activemq command message browse activemqdestination dest  throws exception
return new org apache activemq command message
protected void dispatchinitialmessage message message  destination regiondestination  connectioncontext context  subscriptionrecovery sub
try
activemqmessage activemessage   activemqmessagetransformation transformmessage message  null
activemqdestination destination   activemessage getdestination
if  destination    null
destination   sub getactivemqdestination
activemessage setdestination destination
activemessage setregiondestination regiondestination
configure activemessage
sub addrecoveredmessage context  activemessage
catch  throwable e
log warn     message       e  e
protected void configure activemqmessage msg  throws jmsexception
long sequencenumber   messagesequence incrementandget
msg setmessageid new messageid producerid  sequencenumber
msg onsend
msg setproducerid producerid
protected producerid createproducerid
string id   idgenerator generateid
connectionid connectionid   new connectionid id
sessionid sessionid   new sessionid connectionid  1
return new producerid sessionid  1