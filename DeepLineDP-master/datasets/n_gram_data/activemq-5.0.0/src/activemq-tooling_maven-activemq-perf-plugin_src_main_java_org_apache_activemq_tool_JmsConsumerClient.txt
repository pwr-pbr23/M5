/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq tool
import java util concurrent atomic atomicinteger
import javax jms connectionfactory
import javax jms destination
import javax jms jmsexception
import javax jms message
import javax jms messageconsumer
import javax jms messagelistener
import javax jms topic
import org apache activemq tool properties jmsclientproperties
import org apache activemq tool properties jmsconsumerproperties
import org apache commons logging log
import org apache commons logging logfactory
public class jmsconsumerclient extends abstractjmsmeasurableclient
private static final log log   logfactory getlog jmsconsumerclient class
protected messageconsumer jmsconsumer
protected jmsconsumerproperties client
public jmsconsumerclient connectionfactory factory
this new jmsconsumerproperties    factory
public jmsconsumerclient jmsconsumerproperties clientprops  connectionfactory factory
super factory
client   clientprops
public void receivemessages   throws jmsexception
if  client isasyncrecv
if  client getrecvtype   equalsignorecase jmsconsumerproperties time_based_receiving
receiveasynctimebasedmessages client getrecvduration
else
receiveasynccountbasedmessages client getrecvcount
else
if  client getrecvtype   equalsignorecase jmsconsumerproperties time_based_receiving
receivesynctimebasedmessages client getrecvduration
else
receivesynccountbasedmessages client getrecvcount
public void receivemessages int destcount  throws jmsexception
this destcount   destcount
receivemessages
public void receivemessages int destindex  int destcount  throws jmsexception
this destindex   destindex
receivemessages destcount
public void receivesynctimebasedmessages long duration  throws jmsexception
if  getjmsconsumer      null
createjmsconsumer
try
getconnection   start
log info     duration
long endtime   system currenttimemillis     duration
while  system currenttimemillis   < endtime
getjmsconsumer   receive
incthroughput
finally
if  client isdurable      client isunsubscribe
log info     getclientname
getjmsconsumer   close
getsession   unsubscribe getclientname
getconnection   close
public void receivesynccountbasedmessages long count  throws jmsexception
if  getjmsconsumer      null
createjmsconsumer
try
getconnection   start
log info     count
int recvcount   0
while  recvcount < count
getjmsconsumer   receive
incthroughput
recvcount
finally
if  client isdurable      client isunsubscribe
log info     getclientname
getjmsconsumer   close
getsession   unsubscribe getclientname
getconnection   close
public void receiveasynctimebasedmessages long duration  throws jmsexception
if  getjmsconsumer      null
createjmsconsumer
getjmsconsumer   setmessagelistener new messagelistener
public void onmessage message msg
incthroughput
try
getconnection   start
log info     duration
try
thread sleep duration
catch  interruptedexception e
throw new jmsexception     e getmessage
finally
if  client isdurable      client isunsubscribe
log info     getclientname
getjmsconsumer   close
getsession   unsubscribe getclientname
getconnection   close
public void receiveasynccountbasedmessages long count  throws jmsexception
if  getjmsconsumer      null
createjmsconsumer
final atomicinteger recvcount   new atomicinteger 0
getjmsconsumer   setmessagelistener new messagelistener
public void onmessage message msg
incthroughput
recvcount incrementandget
recvcount notify
try
getconnection   start
log info     client getrecvcount
try
while  recvcount get   < count
recvcount wait
catch  interruptedexception e
throw new jmsexception     e getmessage
finally
if  client isdurable      client isunsubscribe
log info     getclientname
getjmsconsumer   close
getsession   unsubscribe getclientname
getconnection   close
public messageconsumer createjmsconsumer   throws jmsexception
destination dest   createdestination destindex  destcount
return createjmsconsumer dest
public messageconsumer createjmsconsumer destination dest  throws jmsexception
if  client isdurable
string clientname   getclientname
if  clientname    null
clientname
setclientname clientname
log info     clientname       dest tostring
jmsconsumer   getsession   createdurablesubscriber  topic  dest  clientname
else
log info     dest tostring
jmsconsumer   getsession   createconsumer dest
return jmsconsumer
public messageconsumer createjmsconsumer destination dest  string selector  boolean nolocal  throws jmsexception
if  client isdurable
string clientname   getclientname
if  clientname    null
clientname
setclientname clientname
log info     clientname       dest tostring
jmsconsumer   getsession   createdurablesubscriber  topic  dest  clientname  selector  nolocal
else
log info     dest tostring
jmsconsumer   getsession   createconsumer dest  selector  nolocal
return jmsconsumer
public messageconsumer getjmsconsumer
return jmsconsumer
public jmsclientproperties getclient
return client
public void setclient jmsclientproperties clientprops
client    jmsconsumerproperties clientprops