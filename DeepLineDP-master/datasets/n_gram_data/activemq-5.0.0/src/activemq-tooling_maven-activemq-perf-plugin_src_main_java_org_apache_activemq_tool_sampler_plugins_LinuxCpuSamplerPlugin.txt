/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq tool sampler plugins
import java io bufferedreader
import java io ioexception
import java io inputstreamreader
import java util stringtokenizer
import java util concurrent atomic atomicboolean
public class linuxcpusamplerplugin implements cpusamplerplugin  runnable
private process vmstatprocess
private string vmstat
private string result
private final object mutex   new object
private atomicboolean stop   new atomicboolean false
public linuxcpusamplerplugin long intervalinms
vmstat        int  intervalinms   1000
public void start
stop set false
thread t   new thread this
t start
public void stop
stop set true
try
vmstatprocess waitfor
catch  interruptedexception e
e printstacktrace
public void run
try
vmstatprocess   runtime getruntime   exec vmstat
bufferedreader br   new bufferedreader new inputstreamreader vmstatprocess getinputstream     1024
br readline       throw away the first line
string header   br readline
string data
while   stop get
data   br readline
if  data    null
string csvdata   converttocsv header  data
synchronized  mutex
result   csvdata
br close
vmstatprocess destroy
catch  ioexception ioe
ioe printstacktrace
public string getcpuutilizationstats
string data
synchronized  mutex
data   result
result
return data
public string getvmstat
return vmstat
public void setvmstat string vmstat
this vmstat   vmstat
protected string converttocsv string header  string data
stringtokenizer headertokens   new stringtokenizer header
stringtokenizer datatokens   new stringtokenizer data
string csv
while  headertokens hasmoretokens
csv    headertokens nexttoken         datatokens nexttoken
return csv