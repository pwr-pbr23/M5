/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hive ql udf generic
import java io serializable
import java lang reflect method
import java lang reflect type
import java util arrays
import org apache hadoop hive ql exec functionregistry
import org apache hadoop hive ql exec udaf
import org apache hadoop hive ql exec udafevaluator
import org apache hadoop hive ql metadata hiveexception
import org apache hadoop hive ql parse semanticexception
import org apache hadoop hive ql udf generic genericudfutils conversionhelper
import org apache hadoop hive serde2 objectinspector objectinspector
import org apache hadoop hive serde2 objectinspector objectinspectorfactory
import org apache hadoop hive serde2 objectinspector objectinspectorfactory objectinspectoroptions
import org apache hadoop hive serde2 typeinfo typeinfo
import org apache hadoop util reflectionutils
/**
* this class is a bridge between genericudaf and udaf. old udaf can be used
* with the genericudaf infrastructure through this bridge.
*/
public class genericudafbridge extends abstractgenericudafresolver
udaf udaf
public genericudafbridge udaf udaf
this udaf   udaf
public class<? extends udaf> getudafclass
return udaf getclass
@override
public genericudafevaluator getevaluator typeinfo parameters  throws semanticexception
class<? extends udafevaluator> udafevaluatorclass   udaf getresolver
getevaluatorclass arrays aslist parameters
return new genericudafbridgeevaluator udafevaluatorclass
/**
* genericudafbridgeevaluator.
*
*/
public static class genericudafbridgeevaluator extends genericudafevaluator
implements serializable
private static final long serialversionuid   1l
// used by serialization only
public genericudafbridgeevaluator
public class<? extends udafevaluator> getudafevaluator
return udafevaluator
public void setudafevaluator class<? extends udafevaluator> udafevaluator
this udafevaluator   udafevaluator
public genericudafbridgeevaluator
class<? extends udafevaluator> udafevaluator
this udafevaluator   udafevaluator
class<? extends udafevaluator> udafevaluator
transient objectinspector parameterois
transient object result
transient method iteratemethod
transient method mergemethod
transient method terminatepartialmethod
transient method terminatemethod
transient conversionhelper conversionhelper
@override
public objectinspector init mode m  objectinspector parameters  throws hiveexception
super init m  parameters
parameterois   parameters
// get the reflection methods from ue
for  method method   udafevaluator getmethods
method setaccessible true
if  method getname   equals
iteratemethod   method
if  method getname   equals
mergemethod   method
if  method getname   equals
terminatepartialmethod   method
if  method getname   equals
terminatemethod   method
// input: do java/writable conversion if needed
method aggregatemethod   null
if  mode    mode partial1    mode    mode complete
aggregatemethod   iteratemethod
else
aggregatemethod   mergemethod
conversionhelper   new conversionhelper aggregatemethod  parameters
// output: get the evaluate method
method evaluatemethod   null
if  mode    mode partial1    mode    mode partial2
evaluatemethod   terminatepartialmethod
else
evaluatemethod   terminatemethod
// get the output objectinspector from the return type.
type returntype   evaluatemethod getgenericreturntype
try
return objectinspectorfactory getreflectionobjectinspector returntype
objectinspectoroptions java
catch  runtimeexception e
throw new hiveexception     returntype
evaluatemethod  e
/** class for storing udafevaluator value. */
static class udafagg implements aggregationbuffer
udafevaluator ueobject
udafagg udafevaluator ueobject
this ueobject   ueobject
@override
public aggregationbuffer getnewaggregationbuffer
return new udafagg  udafevaluator reflectionutils newinstance udafevaluator  null
@override
public void reset aggregationbuffer agg  throws hiveexception
udafagg  agg  ueobject init
@override
public void iterate aggregationbuffer agg  object parameters  throws hiveexception
functionregistry invoke iteratemethod    udafagg  agg  ueobject
conversionhelper convertifnecessary parameters
@override
public void merge aggregationbuffer agg  object partial  throws hiveexception
functionregistry invoke mergemethod    udafagg  agg  ueobject
conversionhelper convertifnecessary partial
@override
public object terminate aggregationbuffer agg  throws hiveexception
return functionregistry invoke terminatemethod    udafagg  agg  ueobject
@override
public object terminatepartial aggregationbuffer agg  throws hiveexception
return functionregistry invoke terminatepartialmethod
udafagg  agg  ueobject