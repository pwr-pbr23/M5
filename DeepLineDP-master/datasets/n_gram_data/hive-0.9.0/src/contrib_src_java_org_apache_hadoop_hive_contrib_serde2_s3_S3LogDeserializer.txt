/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hive contrib serde2 s3
import java nio charset charactercodingexception
import java util list
import java util properties
import java util regex matcher
import java util regex pattern
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop conf configuration
import org apache hadoop hive serde2 deserializer
import org apache hadoop hive serde2 serdeexception
import org apache hadoop hive serde2 serdestats
import org apache hadoop hive serde2 objectinspector objectinspector
import org apache hadoop hive serde2 objectinspector objectinspectorfactory
import org apache hadoop hive serde2 objectinspector reflectionstructobjectinspector
import org apache hadoop hive serde2 objectinspector structfield
import org apache hadoop io byteswritable
import org apache hadoop io text
import org apache hadoop io writable
/**
* s3logdeserializer.
*
*/
public class s3logdeserializer implements deserializer
public static final log log   logfactory getlog s3logdeserializer class
getname
static
stacktraceelement strace   new exception   getstacktrace
strace getclassname
private objectinspector cachedobjectinspector
@override
public string tostring
return
public s3logdeserializer   throws serdeexception
// this regex is a bit lax in order to compensate for lack of any escaping
// done by amazon s3 ... for example useragent string can have double quotes
// inside!
static pattern regexpat   pattern
compile
// static pattern regexrid = pattern.compile("x-id=([-0-9a-f]{36})");
// static simpledateformat dateparser = new
// simpledateformat("dd/mmm/yyyy:hh:mm:ss zzzzz");
s3logstruct deserializecache   new s3logstruct
public void initialize configuration job  properties tbl
throws serdeexception
cachedobjectinspector   objectinspectorfactory
getreflectionobjectinspector s3logstruct class
objectinspectorfactory objectinspectoroptions java
log debug getclass   getname
public static integer toint string s
if  s compareto       0
return null
else
return integer valueof s
public static object deserialize s3logstruct c  string row  throws exception
matcher match   regexpat matcher row
int t   1
try
match matches
c bucketowner   match group t
c bucketname   match group t
catch  exception e
throw new serdeexception     row  e
c rdatetime   match group t
// should we convert the datetime to the format hive understands by default
// - either yyyy-mm-dd hh:mm:ss or seconds since epoch?
// date d = dateparser.parse(c.rdatetime);
// c.rdatetimeepoch = d.gettime() / 1000;
c rip   match group t
c requester   match group t
c requestid   match group t
c operation   match group t
c rkey   match group t
c requesturi   match group t
// system.err.println(c.requesturi);
/*
* // zemanta specific data extractor try { matcher m2 =
* regexrid.matcher(c.requesturi); m2.find(); c.rid = m2.group(1); } catch
* (exception e) { c.rid = null; }
*/
c httpstatus   toint match group t
c errorcode   match group t
c bytessent   toint match group t
c objsize   toint match group t
c totaltime   toint match group t
c turnaroundtime   toint match group t
c referer   match group t
c useragent   match group t
return  c
public object deserialize writable field  throws serdeexception
string row   null
if  field instanceof byteswritable
byteswritable b    byteswritable  field
try
row   text decode b getbytes    0  b getlength
catch  charactercodingexception e
throw new serdeexception e
else if  field instanceof text
row   field tostring
try
deserialize deserializecache  row
return deserializecache
catch  classcastexception e
throw new serdeexception this getclass   getname
e
catch  exception e
throw new serdeexception e
public objectinspector getobjectinspector   throws serdeexception
return cachedobjectinspector
/**
* @param args
*/
public static void main string args
system err println
try
s3logdeserializer serde   new s3logdeserializer
configuration conf   new configuration
properties tbl   new properties
// some nasty examples that show how s3 log format is broken ... and to
// test the regex
// these are all sourced from genuine s3 logs
// text sample = new
// text("04ff331638adc13885d6c42059584deabbdeabcd55bf0bee491172a79a87b196 img.zemanta.com [09/apr/2009:22:00:07 +0000] 190.225.84.114 65a011a29cdf8ec533ec3d1ccaae921c f4fc3fead8c00024 rest.get.object pixy.gif \"get /pixy.gif?x-id=23d25db1-160b-48bb-a932-e7dc1e88c321 http/1.1\" 304 - - 828 3 - \"http://www.viamujer.com/2009/03/horoscopo-acuario-abril-mayo-y-junio-2009/\" \"mozilla/4.0 (compatible; msie 7.0; windows nt 5.1; .net clr 1.1.4322; .net clr 2.0.50727)\"");
// text sample = new
// text("04ff331638adc13885d6c42059584deabbdeabcd55bf0bee491172a79a87b196 img.zemanta.com [09/apr/2009:22:19:49 +0000] 60.28.204.7 65a011a29cdf8ec533ec3d1ccaae921c 7d87b6835125671e rest.get.object pixy.gif \"get /pixy.gif?x-id=b50a4544-938b-4a63-992c-721d1a644b28 http/1.1\" 200 - 828 828 4 3 \"\" \"zhuaxia.com\"");
// text sample = new
// text("04ff331638adc13885d6c42059584deabbdeabcd55bf0bee491172a79a87b196 static.zemanta.com [09/apr/2009:23:12:39 +0000] 65.94.12.181 65a011a29cdf8ec533ec3d1ccaae921c eee6ffe9b9f9ea29 rest.head.object readside/loader.js%22+defer%3d%22defer \"head /readside/loader.js\"+defer=\"defer http/1.0\" 403 accessdenied 231 - 7 - \"-\" \"mozilla/4.0 (compatible; msie 6.0; windows nt 5.0)\"");
text sample   new text
get  reblog_b png?x id 79ca9376 6326 41b7 9257 eea43d112eb2 http 1 0     firefox 0 8  linux   mozilla 5 0  x11  u  linux i686  en us  rv 1 6  gecko 20040614 firefox 0 8
serde initialize conf  tbl
object row   serde deserialize sample
system err println serde getobjectinspector   getclass   tostring
reflectionstructobjectinspector oi    reflectionstructobjectinspector  serde
getobjectinspector
list<? extends structfield> fieldrefs   oi getallstructfieldrefs
for  int i   0  i < fieldrefs size    i
system err println fieldrefs get i  tostring
object fielddata   oi getstructfielddata row  fieldrefs get i
if  fielddata    null
system err println
else
system err println fielddata tostring
catch  exception e
system err println     e
e printstacktrace
public serdestats getserdestats
// no support for statistics
return null