/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hive ql io
import java io ioexception
import java util properties
import org apache commons lang stringutils
import org apache hadoop conf configuration
import org apache hadoop fs filesystem
import org apache hadoop fs path
import org apache hadoop hive ql exec utilities
import org apache hadoop hive serde2 columnar bytesrefarraywritable
import org apache hadoop io writable
import org apache hadoop io writablecomparable
import org apache hadoop io compress compressioncodec
import org apache hadoop io compress defaultcodec
import org apache hadoop mapred fileoutputformat
import org apache hadoop mapred jobconf
import org apache hadoop mapred recordwriter
import org apache hadoop mapred reporter
import org apache hadoop util progressable
import org apache hadoop util reflectionutils
/**
* rcfileoutputformat.
*
*/
public class rcfileoutputformat extends
fileoutputformat<writablecomparable  bytesrefarraywritable> implements
hiveoutputformat<writablecomparable  bytesrefarraywritable>
/**
* set number of columns into the given configuration.
*
* @param conf
*          configuration instance which need to set the column number
* @param columnnum
*          column number for rcfile's writer
*
*/
public static void setcolumnnumber configuration conf  int columnnum
assert columnnum > 0
conf setint rcfile column_number_conf_str  columnnum
/**
* returns the number of columns set in the conf for writers.
*
* @param conf
* @return number of columns for rcfile's writer
*/
public static int getcolumnnumber configuration conf
return conf getint rcfile column_number_conf_str  0
/** {@inheritdoc} */
@override
public recordwriter<writablecomparable  bytesrefarraywritable> getrecordwriter
filesystem ignored  jobconf job  string name  progressable progress  throws ioexception
path outputpath   getworkoutputpath job
filesystem fs   outputpath getfilesystem job
path file   new path outputpath  name
compressioncodec codec   null
if  getcompressoutput job
class<?> codecclass   getoutputcompressorclass job  defaultcodec class
codec    compressioncodec  reflectionutils newinstance codecclass  job
final rcfile writer out   new rcfile writer fs  job  file  progress  codec
return new recordwriter<writablecomparable  bytesrefarraywritable>
@override
public void close reporter reporter  throws ioexception
out close
@override
public void write writablecomparable key  bytesrefarraywritable value
throws ioexception
out append value
/**
* create the final out file.
*
* @param jc
*          the job configuration file
* @param finaloutpath
*          the final output file to be created
* @param valueclass
*          the value class used for create
* @param iscompressed
*          whether the content is compressed or not
* @param tableproperties
*          the tableinfo of this file's corresponding table
* @param progress
*          progress used for status report
* @throws ioexception
*/
@override
public org apache hadoop hive ql exec filesinkoperator recordwriter gethiverecordwriter
jobconf jc  path finaloutpath  class<? extends writable> valueclass
boolean iscompressed  properties tableproperties  progressable progress  throws ioexception
string cols   null
string columns   tableproperties getproperty
if  columns    null    columns trim   equals
cols   new string
else
cols   stringutils split columns
rcfileoutputformat setcolumnnumber jc  cols length
final rcfile writer outwriter   utilities creatercfilewriter
jc  finaloutpath getfilesystem jc
finaloutpath  iscompressed
return new org apache hadoop hive ql exec filesinkoperator recordwriter
public void write writable r  throws ioexception
outwriter append r
public void close boolean abort  throws ioexception
outwriter close