/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hive ql parse
import java io ioexception
import java io serializable
import java util arraylist
import java util linkedlist
import java util hashmap
import java util hashset
import java util iterator
import java util linkedhashmap
import java util list
import java util map
import java util map entry
import java util set
import java util treeset
import org apache hadoop hive ql exec task
import org apache hadoop hive ql plan loadtabledesc
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop fs contentsummary
import org apache hadoop hive metastore api index
import org apache hadoop hive ql exec filteroperator
import org apache hadoop hive ql exec mapredtask
import org apache hadoop hive ql exec tablescanoperator
import org apache hadoop hive ql exec task
import org apache hadoop hive ql exec utilities
import org apache hadoop hive ql hooks readentity
import org apache hadoop hive ql index hiveindexhandler
import org apache hadoop hive ql index hiveindexquerycontext
import org apache hadoop hive ql lib node
import org apache hadoop hive ql lib nodeprocessor
import org apache hadoop hive ql lib nodeprocessorctx
import org apache hadoop hive ql metadata hive
import org apache hadoop hive ql metadata hiveexception
import org apache hadoop hive ql metadata hiveutils
import org apache hadoop hive ql metadata partition
import org apache hadoop hive ql metadata table
import org apache hadoop hive ql parse parsecontext
import org apache hadoop hive ql parse prunedpartitionlist
import org apache hadoop hive ql parse semanticexception
import org apache hadoop hive ql plan exprnodedesc
import org apache hadoop hive ql plan filterdesc
import org apache hadoop hive ql plan tabledesc
import org apache hadoop hive ql plan tablescandesc
import org apache hadoop conf configuration
import org apache hadoop hive conf hiveconf
import org apache hadoop hive ql driver
public class indexupdater
private list<loadtabledesc> loadtablework
private hiveconf conf
private hive hive
private list<task<? extends serializable>> tasks
private set<readentity> inputs
public indexupdater list<loadtabledesc> loadtablework  set<readentity> inputs  configuration conf
this loadtablework   loadtablework
this inputs   inputs
this conf   new hiveconf conf  indexupdater class
this tasks   new linkedlist<task<? extends serializable>>
public indexupdater loadtabledesc loadtablework  set<readentity> inputs
configuration conf
this loadtablework   new linkedlist<loadtabledesc>
this loadtablework add loadtablework
this conf   new hiveconf conf  indexupdater class
this tasks   new linkedlist<task<? extends serializable>>
this inputs   inputs
public list<task<? extends serializable>> generateupdatetasks   throws
hiveexception
hive   hive get this conf
for  loadtabledesc ltd   loadtablework
tabledesc td   ltd gettable
table srctable   hive gettable td gettablename
list<index> tblindexes   srctable getallindexes  short  1
map<string  string> partspec   ltd getpartitionspec
if  partspec    null    partspec size      0
//unpartitioned table, update whole index
doindexupdate tblindexes
else
doindexupdate tblindexes  partspec
return tasks
private void doindexupdate list<index> tblindexes  throws hiveexception
driver driver   new driver this conf
for  index idx   tblindexes
stringbuilder sb   new stringbuilder
sb append
sb append idx getindexname
sb append
sb append idx getorigtablename
sb append
driver compile sb tostring
tasks addall driver getplan   getroottasks
inputs addall driver getplan   getinputs
private void doindexupdate list<index> tblindexes  map<string  string>
partspec  throws hiveexception
for  index index   tblindexes
if  containspartition index  partspec
doindexupdate index  partspec
private void doindexupdate index index  map<string  string> partspec  throws
hiveexception
stringbuilder ps   new stringbuilder
boolean first   true
ps append
for  string key   partspec keyset
if   first
ps append
else
first   false
ps append key
ps append
ps append partspec get key
ps append
stringbuilder sb   new stringbuilder
sb append
sb append index getindexname
sb append
sb append index getorigtablename
sb append
sb append ps tostring
sb append
driver driver   new driver this conf
driver compile sb tostring    false
tasks addall driver getplan   getroottasks
inputs addall driver getplan   getinputs
private boolean containspartition index index  map<string  string> partspec
throws hiveexception
table indextable   hive gettable index getindextablename
list<partition> parts   hive getpartitions indextable  partspec
return  parts    null    parts size      0