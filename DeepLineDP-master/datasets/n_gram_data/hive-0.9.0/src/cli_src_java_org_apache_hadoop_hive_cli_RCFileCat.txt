/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hive cli
import java io bufferedoutputstream
import java io filedescriptor
import java io fileoutputstream
import java io ioexception
import java io printstream
import java nio bytebuffer
import java nio charset charset
import java nio charset charsetdecoder
import java nio charset codingerroraction
import org apache hadoop conf configuration
import org apache hadoop fs filesystem
import org apache hadoop fs path
import org apache hadoop hive ql io rcfilerecordreader
import org apache hadoop hive serde2 columnar bytesrefarraywritable
import org apache hadoop hive serde2 columnar bytesrefwritable
import org apache hadoop io longwritable
import org apache hadoop io text
import org apache hadoop mapred filesplit
import org apache hadoop mapred jobconf
import org apache hadoop util tool
import org apache hadoop util toolrunner
public class rcfilecat implements tool
// size of string buffer in bytes
private static final int string_buffer_size   16   1024
// the size to flush the string buffer at
private static final int string_buffer_flush_size   14   1024
// size of stdout buffer in bytes
private static final int stdout_buffer_size   128   1024
// in verbose mode, print an update per record_print_interval records
private static final int record_print_interval    1024 1024
public rcfilecat
super
decoder   charset forname    newdecoder
onmalformedinput codingerroraction replace
onunmappablecharacter codingerroraction replace
private static charsetdecoder decoder
configuration conf   null
private static string tab
private static string newline
@override
public int run string args  throws exception
long start   0l
long length    1l
int recordcount   0
long startt   system currenttimemillis
boolean verbose   false
//get options from arguments
if  args length < 1    args length > 3
printusage null
path filename   null
for  int i   0  i < args length  i
string arg   args
if arg startswith
start   long parselong arg substring   length
else if  arg startswith
length   long parselong arg substring   length
else if  arg equals
verbose   true
else if  filename    null
filename   new path arg
else
printusage null
setupbufferedoutput
filesystem fs   filesystem get filename touri    conf
long filelen   fs getfilestatus filename  getlen
if  start < 0
start   0
if  start > filelen
return 0
if  length < 0     start   length  > filelen
length   filelen   start
//share the code with recordreader.
filesplit split   new filesplit filename start  length  new jobconf conf
rcfilerecordreader recordreader   new rcfilerecordreader conf  split
longwritable key   new longwritable
bytesrefarraywritable value   new bytesrefarraywritable
stringbuilder buf   new stringbuilder string_buffer_size      extra capacity in case we overrun  to avoid resizing
while  recordreader next key  value
printrecord value  buf
recordcount
if  verbose     recordcount % record_print_interval     0
long now   system currenttimemillis
system err println     recordcount 1024
system err println       recordreader getpos      1024l 1024l
system err printf
recordreader getpos     1 0    now   startt     1024 0
if  buf length   > string_buffer_flush_size
system out print buf tostring
buf setlength 0
// print out last part of buffer
system out print buf tostring
system out flush
return 0
/**
* print record to string builder
* @param value
* @param buf
* @throws ioexception
*/
private void printrecord bytesrefarraywritable value  stringbuilder buf
throws ioexception
int n   value size
if  n > 0
bytesrefwritable v   value uncheckedget 0
bytebuffer bb   bytebuffer wrap v getdata    v getstart    v getlength
buf append decoder decode bb
for  int i   1  i < n  i
// do not put the tab for the last column
buf append rcfilecat tab
v   value uncheckedget i
bb   bytebuffer wrap v getdata    v getstart    v getlength
buf append decoder decode bb
buf append rcfilecat newline
@override
public configuration getconf
return conf
@override
public void setconf configuration conf
this conf   conf
private static string usage
public static void main string args
try
configuration conf   new configuration
rcfilecat instance   new rcfilecat
instance setconf conf
toolrunner run instance  args
catch  exception e
e printstacktrace
system err println
printusage e getmessage
private static void setupbufferedoutput
fileoutputstream fdout
new fileoutputstream filedescriptor out
bufferedoutputstream bos
new bufferedoutputstream fdout  stdout_buffer_size
printstream ps
new printstream bos  false
system setout ps
private static void printusage string errormsg
system err println usage
if errormsg    null
system err println errormsg
system exit 1