/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hive ql udf generic
import java io ioexception
import java util arraylist
import java util list
import javaewah ewahcompressedbitmap
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop hive ql exec description
import org apache hadoop hive ql exec udfargumenttypeexception
import org apache hadoop hive ql index bitmap bitmapobjectinput
import org apache hadoop hive ql index bitmap bitmapobjectoutput
import org apache hadoop hive ql metadata hiveexception
import org apache hadoop hive ql parse semanticexception
import org apache hadoop hive serde2 objectinspector objectinspector
import org apache hadoop hive serde2 objectinspector objectinspectorfactory
import org apache hadoop hive serde2 objectinspector objectinspectorutils
import org apache hadoop hive serde2 objectinspector primitiveobjectinspector
import org apache hadoop hive serde2 objectinspector standardlistobjectinspector
import org apache hadoop hive serde2 objectinspector primitive longobjectinspector
import org apache hadoop hive serde2 objectinspector primitive primitiveobjectinspectorfactory
import org apache hadoop hive serde2 objectinspector primitive primitiveobjectinspectorutils
import org apache hadoop hive serde2 typeinfo typeinfo
import org apache hadoop hive serde2 typeinfo typeinfoutils
import org apache hadoop io longwritable
import org apache hadoop util stringutils
/**
* genericudafewahbitmap.
*
*/
@description name      value
public class genericudafewahbitmap extends abstractgenericudafresolver
static final log log   logfactory getlog genericudafewahbitmap class getname
@override
public genericudafevaluator getevaluator typeinfo parameters
throws semanticexception
if  parameters length    1
throw new udfargumenttypeexception parameters length   1
objectinspector oi   typeinfoutils getstandardjavaobjectinspectorfromtypeinfo parameters
if   objectinspectorutils comparesupported oi
throw new udfargumenttypeexception parameters length   1
return new genericudafewahbitmapevaluator
//the udaf evaluator assumes that all rows it's evaluating have
//the same (desired) value.
public static class genericudafewahbitmapevaluator extends genericudafevaluator
// for partial1 and complete: objectinspectors for original data
private primitiveobjectinspector inputoi
private longobjectinspector bitmaplongoi
// for partial2 and final: objectinspectors for partial aggregations
// (lists of bitmaps)
private standardlistobjectinspector loi
private standardlistobjectinspector internalmergeoi
@override
public objectinspector init mode m  objectinspector parameters
throws hiveexception
super init m  parameters
// init output object inspectors
// the output of a partial aggregation is a list
if  m    mode partial1
inputoi    primitiveobjectinspector  parameters
return objectinspectorfactory
getstandardlistobjectinspector primitiveobjectinspectorfactory writablelongobjectinspector
else if  m    mode partial2    m    mode final
internalmergeoi    standardlistobjectinspector  parameters
bitmaplongoi   primitiveobjectinspectorfactory writablelongobjectinspector
inputoi   primitiveobjectinspectorfactory writablebyteobjectinspector
loi    standardlistobjectinspector  objectinspectorfactory
getstandardlistobjectinspector primitiveobjectinspectorfactory writablelongobjectinspector
return loi
else      mode complete  ie  no map side aggregation  requires ordering
bitmaplongoi   primitiveobjectinspectorfactory writablelongobjectinspector
inputoi   primitiveobjectinspectorfactory writablebyteobjectinspector
loi    standardlistobjectinspector  objectinspectorfactory
getstandardlistobjectinspector primitiveobjectinspectorfactory writablelongobjectinspector
return loi
/** class for storing the current partial result aggregation */
static class bitmapagg implements aggregationbuffer
ewahcompressedbitmap bitmap
@override
public void reset aggregationbuffer agg  throws hiveexception
bitmapagg  agg  bitmap   new ewahcompressedbitmap
@override
public aggregationbuffer getnewaggregationbuffer   throws hiveexception
bitmapagg result   new bitmapagg
reset result
return result
@override
public void iterate aggregationbuffer agg  object parameters
throws hiveexception
assert  parameters length    1
object p   parameters
if  p    null
bitmapagg myagg    bitmapagg  agg
try
int row   primitiveobjectinspectorutils getint p  inputoi
addbitmap row  myagg
catch  numberformatexception e
log warn getclass   getsimplename
stringutils stringifyexception e
@override
public object terminate aggregationbuffer agg  throws hiveexception
bitmapagg myagg    bitmapagg  agg
bitmapobjectoutput bitmapobjout   new bitmapobjectoutput
try
myagg bitmap writeexternal bitmapobjout
catch  ioexception e
throw new runtimeexception e
return bitmapobjout list
@override
public void merge aggregationbuffer agg  object partial
throws hiveexception
bitmapagg myagg    bitmapagg  agg
arraylist<longwritable> partialresult    arraylist<longwritable>  internalmergeoi getlist partial
bitmapobjectinput bitmapobjin   new bitmapobjectinput partialresult
ewahcompressedbitmap partialbitmap   new ewahcompressedbitmap
try
partialbitmap readexternal bitmapobjin
catch  ioexception e
throw new runtimeexception e
myagg bitmap   myagg bitmap or partialbitmap
@override
public object terminatepartial aggregationbuffer agg  throws hiveexception
bitmapagg myagg    bitmapagg  agg
bitmapobjectoutput bitmapobjout   new bitmapobjectoutput
try
myagg bitmap writeexternal bitmapobjout
catch  ioexception e
throw new runtimeexception e
return bitmapobjout list
private void addbitmap int newrow  bitmapagg myagg
if   myagg bitmap set newrow
throw new runtimeexception