/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hive ql io rcfile merge
import java io ioexception
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop fs filestatus
import org apache hadoop fs filesystem
import org apache hadoop fs path
import org apache hadoop hive conf hiveconf
import org apache hadoop hive ql exec utilities
import org apache hadoop hive ql io rcfile
import org apache hadoop hive ql metadata hiveexception
import org apache hadoop hive ql session sessionstate loghelper
import org apache hadoop hive shims combinehivekey
import org apache hadoop hive shims shimloader
import org apache hadoop io writable
import org apache hadoop io compress compressioncodec
import org apache hadoop mapred jobconf
import org apache hadoop mapred mapreducebase
import org apache hadoop mapred mapper
import org apache hadoop mapred outputcollector
import org apache hadoop mapred reporter
@suppresswarnings
public class rcfilemergemapper extends mapreducebase implements
mapper<object  rcfilevaluebufferwrapper  object  object>
private jobconf jc
class<? extends writable> outputclass
rcfile writer outwriter
path finalpath
filesystem fs
boolean exception   false
boolean autodelete   false
path outpath
compressioncodec codec   null
int columnnumber   0
boolean hasdynamicpartitions   false
boolean tmppathfixed   false
path tmppath
path tasktmppath
path dppath
public final static log log   logfactory getlog
public rcfilemergemapper
@override
public void configure jobconf job
jc   job
hasdynamicpartitions   hiveconf getboolvar job
hiveconf confvars hivemergecurrentjobhasdynamicpartitions
string specpath   rcfileblockmergeoutputformat getmergeoutputpath job
tostring
path tmppath   utilities totemppath specpath
path tasktmppath   utilities totasktemppath specpath
updatepaths tmppath  tasktmppath
try
fs    new path specpath   getfilesystem job
autodelete   shimloader gethadoopshims   filesystemdeleteonexit fs
outpath
catch  ioexception e
this exception   true
throw new runtimeexception e
private void updatepaths path tmppath  path tasktmppath
string taskid   utilities gettaskid jc
this tmppath   tmppath
this tasktmppath   tasktmppath
finalpath   new path tmppath  taskid
outpath   new path tasktmppath  utilities totemppath taskid
@override
public void map object k  rcfilevaluebufferwrapper value
outputcollector<object  object> output  reporter reporter
throws ioexception
try
rcfilekeybufferwrapper key   null
if  k instanceof combinehivekey
key    rcfilekeybufferwrapper    combinehivekey  k  getkey
else
key    rcfilekeybufferwrapper  k
if  hasdynamicpartitions
if  tmppathfixed
checkpartitionsmatch key inputpath getparent
else
// we haven't fixed the tmp path for this mapper yet
fixtmppath key inputpath getparent
tmppathfixed   true
if  outwriter    null
codec   key codec
columnnumber   key keybuffer getcolumnnumber
jc setint rcfile column_number_conf_str  columnnumber
outwriter   new rcfile writer fs  jc  outpath  null  codec
boolean samecodec     codec    key codec     codec getclass   equals
key codec getclass
if   key keybuffer getcolumnnumber      columnnumber       samecodec
throw new ioexception
outwriter flushblock key keybuffer  value valuebuffer  key recordlength
key keylength  key compressedkeylength
catch  throwable e
this exception   true
close
throw new ioexception e
/**
* validates that each input path belongs to the same partition
* since each mapper merges the input to a single output directory
*
* @param inputpath
* @throws hiveexception
*/
private void checkpartitionsmatch path inputpath  throws hiveexception
if   dppath equals inputpath
// temp partition input path does not match exist temp path
string msg
dppath       inputpath
log error msg
throw new hiveexception msg
/**
* fixes tmppath to point to the correct partition.
* before this is called, tmppath will default to the root tmp table dir
*
* @param inputpath
* @throws hiveexception
* @throws ioexception
*/
private void fixtmppath path inputpath
throws hiveexception  ioexception
dppath   inputpath
path newpath   new path
int inputdepth   inputpath depth
int tmpdepth   tmppath depth
// build the path from bottom up
while  inputpath    null    inputpath depth   > tmpdepth
newpath   new path inputpath getname    newpath
inputdepth
inputpath   inputpath getparent
path newtmppath   new path tmppath  newpath
path newtasktmppath   new path tasktmppath  newpath
if   fs exists newtmppath
fs mkdirs newtmppath
updatepaths newtmppath  newtasktmppath
@override
public void close   throws ioexception
// close writer
if  outwriter    null
return
outwriter close
outwriter   null
if   exception
filestatus fss   fs getfilestatus outpath
system out println     outpath       finalpath
fss getlen
if   fs rename outpath  finalpath
throw new ioexception     finalpath
else
if   autodelete
fs delete outpath  true
public static string backup_prefix
public static path backupoutputpath filesystem fs  path outpath  jobconf job
throws ioexception  hiveexception
if  fs exists outpath
path backuppath   new path outpath getparent    backup_prefix
outpath getname
utilities rename fs  outpath  backuppath
return backuppath
else
return null
public static void jobclose string outputpath  boolean success  jobconf job
loghelper console  throws hiveexception  ioexception
path outpath   new path outputpath
filesystem fs   outpath getfilesystem job
path backuppath   backupoutputpath fs  outpath  job
utilities mvfiletofinalpath outputpath  job  success  log  null  null
fs delete backuppath  true