/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hive ql exec
import java util iterator
import java util list
import java util map
import org apache commons logging log
import org apache hadoop fs path
import org apache hadoop hive conf hiveconf
import org apache hadoop hive ql io iocontext
import org apache hadoop hive ql plan mapredlocalwork
import org apache hadoop hive ql plan mapredlocalwork bucketmapjoincontext
import org apache hadoop mapred jobconf
import org apache hadoop util reflectionutils
public class execmappercontext
public static final log l4j   execmapper l4j
// lastinputfile should be changed by the root of the operator tree execmapper.map()
// but kept unchanged throughout the operator tree for one row
private string lastinputfile   null
// currentinputfile will be updated only by inputfilechanged(). if inputfilechanged()
// is not called throughout the opertor tree, currentinputfile won't be used anyways
// so it won't be updated.
private string currentinputfile   null
private boolean inputfilechecked   false
private integer fileid   new integer  1
private mapredlocalwork localwork   null
private map<string  fetchoperator> fetchoperators
private jobconf jc
private iocontext iocxt
private string currentbigbucketfile null
public string getcurrentbigbucketfile
return currentbigbucketfile
public void setcurrentbigbucketfile string currentbigbucketfile
this currentbigbucketfile   currentbigbucketfile
public execmappercontext
iocxt   iocontext get
/**
* for compbinefileinputformat, the mapper's input file will be changed on the
* fly, and the input file name is passed to jobconf by shims/initnextrecordreader.
* if the map local work has any mapping depending on the current
* mapper's input file, the work need to clear context and re-initialization
* after the input file changed. this is first introduced to process bucket
* map join.
*
* @return is the input file changed?
*/
public boolean inputfilechanged
if   inputfilechecked
currentinputfile   this iocxt getinputfile
inputfilechecked   true
return lastinputfile    null     lastinputfile equals currentinputfile
/**
* reset the execution context for each new row. this function should be called only
* once at the root of the operator tree -- execmapper.map().
* note: this function should be kept minimum since it is called for each input row.
*/
public void resetrow
// update the lastinputfile with the currentinputfile.
lastinputfile   currentinputfile
inputfilechecked   false
public string getlastinputfile
return lastinputfile
public void setlastinputfile string lastinputfile
this lastinputfile   lastinputfile
private void setupfetchopcontext fetchoperator fetchop  string alias
throws exception
string currentinputfile   hiveconf getvar jc
hiveconf confvars hadoopmapfilename
bucketmapjoincontext bucketmatchercxt   this localwork
getbucketmapjoincontext
class<? extends bucketmatcher> bucketmatchercls   bucketmatchercxt
getbucketmatcherclass
bucketmatcher bucketmatcher    bucketmatcher  reflectionutils newinstance
bucketmatchercls  null
bucketmatcher setaliasbucketfilenamemapping bucketmatchercxt
getaliasbucketfilenamemapping
list<path> aliasfiles   bucketmatcher getaliasbucketfiles currentinputfile
bucketmatchercxt getmapjoinbigtablealias    alias
iterator<path> iter   aliasfiles iterator
fetchop setupcontext iter  null
public string getcurrentinputfile
currentinputfile   this iocxt getinputfile
return currentinputfile
public void setcurrentinputfile string currentinputfile
this currentinputfile   currentinputfile
public jobconf getjc
return jc
public void setjc jobconf jc
this jc   jc
public mapredlocalwork getlocalwork
return localwork
public void setlocalwork mapredlocalwork localwork
this localwork   localwork
public integer getfileid
return fileid
public void setfileid integer fileid
this fileid   fileid
public map<string  fetchoperator> getfetchoperators
return fetchoperators
public void setfetchoperators map<string  fetchoperator> fetchoperators
this fetchoperators   fetchoperators
public iocontext getiocxt
return iocxt
public void setiocxt iocontext iocxt
this iocxt   iocxt