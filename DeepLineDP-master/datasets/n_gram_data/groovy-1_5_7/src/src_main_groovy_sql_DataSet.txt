/*
* copyright 2003-2008 the original author or authors.
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package groovy sql
import groovy lang closure
import groovy lang groovyruntimeexception
import org codehaus groovy ast classnode
import org codehaus groovy ast methodnode
import org codehaus groovy ast codevisitorsupport
import org codehaus groovy ast stmt statement
import java sql connection
import java sql preparedstatement
import java sql sqlexception
import java util arraylist
import java util iterator
import java util list
import java util map
import java util logging level
/**
* represents an extent of objects
*
* @author chris stevenson
* @author paul king
* @author <a href="mailto:james@coredevelopers.net">james strachan</a>
* @version $revision$
*/
public class dataset extends sql
private closure where
private closure sort
private boolean reversed   false
private dataset parent
private string table
private sqlwherevisitor visitor
private sqlorderbyvisitor sortvisitor
private string sql
private list params
public dataset sql sql  class type
super sql
string table   type getname
int idx   table lastindexof
if  idx > 0
table   table substring idx   1
this table   table tolowercase
public dataset sql sql  string table
super sql
this table   table
private dataset dataset parent  closure where
super parent
this table   parent table
this parent   parent
this where   where
private dataset dataset parent  closure where  closure sort
super parent
this table   parent table
this parent   parent
this where   where
this sort   sort
private dataset dataset parent
super parent
this table   parent table
this parent   parent
this reversed   true
public void add map values  throws sqlexception
stringbuffer buffer   new stringbuffer
buffer append table
buffer append
stringbuffer parambuffer   new stringbuffer
boolean first   true
for  iterator iter   values entryset   iterator    iter hasnext
map entry entry    map entry  iter next
string column   entry getkey   tostring
if  first
first   false
parambuffer append
else
buffer append
parambuffer append
buffer append column
buffer append
buffer append parambuffer tostring
buffer append
connection connection   createconnection
preparedstatement statement   null
try
statement   connection preparestatement buffer tostring
int i   1
for  iterator iter   values entryset   iterator    iter hasnext
map entry entry    map entry  iter next
setobject statement  i    entry getvalue
int answer   statement executeupdate
if  answer    1
log log level warning      answer       values
catch  sqlexception e
log log level warning      values  e
throw e
finally
closeresources connection  statement
public dataset findall closure where
return new dataset this  where
public dataset sort closure sort
return new dataset this  null  sort
public dataset reverse
if  sort    null
throw new groovyruntimeexception
return new dataset this
public void each closure closure  throws sqlexception
eachrow getsql    getparameters    closure
private string getsqlwhere
string whereclaus
string parentclaus
if  parent    null
parentclaus   parent getsqlwhere
if  where    null
whereclaus    getsqlwherevisitor   getwhere
if  parentclaus length      0  return whereclaus
if  whereclaus length      0  return parentclaus
return parentclaus       whereclaus
private string getsqlorderby
string sortbyclaus
string parentclaus
if  parent    null
parentclaus   parent getsqlorderby
if  reversed
if  parentclaus length   > 0  parentclaus
if  sort    null
sortbyclaus    getsqlorderbyvisitor   getorderby
if  parentclaus length      0  return sortbyclaus
if  sortbyclaus length      0  return parentclaus
return parentclaus       sortbyclaus
public string getsql
if  sql    null
sql       table
string whereclaus   getsqlwhere
if  whereclaus length   > 0
sql        whereclaus
string orerbyclaus   getsqlorderby
if  orerbyclaus length   > 0
sql        orerbyclaus
return sql
public list getparameters
if  params    null
params   new arraylist
if  parent    null
params addall parent getparameters
params addall getsqlwherevisitor   getparameters
return params
protected sqlwherevisitor getsqlwherevisitor
if  visitor    null
visitor   new sqlwherevisitor
visit where  visitor
return visitor
protected sqlorderbyvisitor getsqlorderbyvisitor
if  sortvisitor    null
sortvisitor   new sqlorderbyvisitor
visit sort  sortvisitor
return sortvisitor
private void visit closure closure  codevisitorsupport visitor
if  closure    null
classnode classnode   closure getmetaclass   getclassnode
if  classnode    null
throw new groovyruntimeexception
closure getmetaclass
list methods   classnode getdeclaredmethods
if   methods isempty
methodnode method    methodnode  methods get 0
if  method    null
statement statement   method getcode
if  statement    null
statement visit visitor
/*
* create a subset of the original dataset
*/
public dataset createview closure criteria
return new dataset this  criteria
/**
* returns a list of all of the rows from the table a dataset
* represents
*
* @return returns a list of groovyrowresult objects from the dataset
* @throws sqlexception if a database error occurs
*/
public list rows   throws sqlexception
return rows getsql    getparameters
/**
* returns the first row from a dataset's underlying table
*
* @return returns the first groovyrowresult object from the dataset
* @throws sqlexception if a database error occurs
*/
public object firstrow   throws sqlexception
list rows   rows
if  rows isempty    return null
return  rows get 0