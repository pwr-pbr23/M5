/*
* copyright 2003-2007 the original author or authors.
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package groovy lang
import groovy lang metaclassregistry metaclasscreationhandle
import org codehaus groovy runtime metaclass concurrentreaderhashmap
import java util
/**
* <p>a handle for the metaclassregistry that changes all classes loaded into the grails vm
* to use expandometaclass instances
*
* <p>the handle should be registered with the groovy runtime <strong>before</before> groovy loads, for example
* in your main method.
*
* <code>groovysystem.metaclassregistry.metaclasscreationhandle = new expandometaclasscreationhandle()</code>
*
* @see groovy.lang.metaclassregistry
* @see groovy.lang.metaclassregistry.metaclasscreationhandle
* @see org.codehaus.groovy.runtime.metaclass.metaclassregistryimpl#setmetaclasscreationhandle(groovy.lang.metaclassregistry.metaclasscreationhandle)
*
* @author graeme rocher
* @since 1.1
*/
public class expandometaclasscreationhandle extends metaclasscreationhandle
public static final expandometaclasscreationhandle instance   new expandometaclasscreationhandle
private final map modifiedexpandos   new concurrentreaderhashmap
/* (non-javadoc)
* @see groovy.lang.metaclassregistry.metaclasscreationhandle#create(java.lang.class, groovy.lang.metaclassregistry)
*/
protected metaclass createnormalmetaclass class theclass  metaclassregistry registry
if theclass    expandometaclass class
expandometaclass emc   new expandometaclass theclass  false  true
set modifiedsuperexpandos   retrievemodifiedsuperexpandos emc
emc refreshinheritedmethods modifiedsuperexpandos
return emc
else
return super create theclass  registry
/*
* looks for modified super class expandometaclass instances for the given child expandometaclass
*/
private set retrievemodifiedsuperexpandos expandometaclass child
set modifiedsupers   new hashset
list superclasses   child getsuperclasses
for  iterator i   superclasses iterator    i hasnext
class c    class  i next
class interfaces   c getinterfaces
populatesupersfrominterfaces modifiedsupers  interfaces
if modifiedexpandos containskey c
modifiedsupers add modifiedexpandos get c
class interfaces   child getjavaclass   getinterfaces
populatesupersfrominterfaces modifiedsupers  interfaces
return modifiedsupers
/*
* searches through a given array of interfaces for modified expandometaclass instances for each interface
*/
private void populatesupersfrominterfaces set modifiedsupers  class interfaces
for  int i   0  i < interfaces length  i
class aninterface   interfaces
final class superinterfaces   aninterface getinterfaces
if modifiedexpandos containskey aninterface
modifiedsupers add modifiedexpandos get aninterface
if superinterfaces length > 0
populatesupersfrominterfaces modifiedsupers  superinterfaces
/**
* registers a modified expandometaclass with the creation handle
*
* @param emc the emc
*/
public void registermodifiedmetaclass expandometaclass emc
modifiedexpandos put emc getjavaclass    emc
public boolean hasmodifiedmetaclass expandometaclass emc
return modifiedexpandos containskey emc getjavaclass
/**
* <p>enables the expandometaclasscreationhandle with the registry
*
* <code>expandometaclasscreationhandle.enable();</code>
*
*/
public static void enable
final metaclassregistry metaclassregistry   groovysystem getmetaclassregistry
if  metaclassregistry getmetaclasscreationhandler      instance
instance modifiedexpandos clear
metaclassregistry setmetaclasscreationhandle instance
public static void disable
final metaclassregistry metaclassregistry   groovysystem getmetaclassregistry
if  metaclassregistry getmetaclasscreationhandler      instance
instance modifiedexpandos clear
metaclassregistry setmetaclasscreationhandle new metaclasscreationhandle