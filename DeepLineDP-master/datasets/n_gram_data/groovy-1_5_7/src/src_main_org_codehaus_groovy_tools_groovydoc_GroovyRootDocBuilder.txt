/*
* copyright 2003-2007 the original author or authors.
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org codehaus groovy tools groovydoc
import java io file
import java io ioexception
import java io stringreader
import java util map
import java util list
import org codehaus groovy antlr antlrastprocessor
import org codehaus groovy antlr sourcebuffer
import org codehaus groovy antlr unicodeescapingreader
import org codehaus groovy antlr java groovifier
import org codehaus groovy antlr java java2groovyconverter
import org codehaus groovy antlr java javalexer
import org codehaus groovy antlr java javarecognizer
import org codehaus groovy antlr parser groovylexer
import org codehaus groovy antlr parser groovyrecognizer
import org codehaus groovy antlr treewalker preordertraversal
import org codehaus groovy antlr treewalker sourcecodetraversal
import org codehaus groovy antlr treewalker visitor
import org codehaus groovy groovydoc groovyrootdoc
import org codehaus groovy runtime defaultgroovymethods
import antlr recognitionexception
import antlr tokenstreamexception
import antlr collections ast
/*
* todo
*  comma at the end of method parameters
*  add comments
*  static modifier
*  order methods alphabetically (implement compareto enough?)
*  provide links to other html files (e.g. return type of a method)
*/
public class groovyrootdocbuilder
private final groovydoctool tool
private final string sourcepath
private final simplegroovyrootdoc rootdoc
private static final char fs
private list links
public groovyrootdocbuilder groovydoctool tool  string sourcepath  list links
this tool   tool
this sourcepath   sourcepath
this links   links
this rootdoc   new simplegroovyrootdoc
// parsing
public map getclassdocsfromsinglesource string packagepath  string file  string src
throws recognitionexception  tokenstreamexception
map classdocsfromsrc   null
if  file indexof    > 0       simple  for now  decision on java or groovy
// java
classdocsfromsrc   parsejava packagepath  file  src
else if  file indexof    > 0
// java (special name used for testing)
classdocsfromsrc   parsejava packagepath  file  src
else
// not java, try groovy instead :-)
classdocsfromsrc   parsegroovy packagepath  file  src
return classdocsfromsrc
private map parsejava string packagepath  string file  string src  throws recognitionexception  tokenstreamexception
sourcebuffer sourcebuffer   new sourcebuffer
javarecognizer parser   getjavaparser src  sourcebuffer
string tokennames   parser gettokennames
parser compilationunit
ast ast   parser getast
// modify the java ast into a groovy ast (just token types)
visitor java2groovyconverter   new java2groovyconverter tokennames
antlrastprocessor java2groovytraverser   new preordertraversal java2groovyconverter
java2groovytraverser process ast
// now mutate (groovify) the ast into groovy
visitor groovifier   new groovifier tokennames
antlrastprocessor groovifiertraverser   new preordertraversal groovifier
groovifiertraverser process ast
// now do the business
visitor visitor   new simplegroovyclassdocassembler packagepath  file  sourcebuffer  links
antlrastprocessor traverser   new sourcecodetraversal visitor
traverser process ast
return   simplegroovyclassdocassembler  visitor  getgroovyclassdocs
private map parsegroovy string packagepath  string file  string src  throws recognitionexception  tokenstreamexception
sourcebuffer sourcebuffer   new sourcebuffer
groovyrecognizer parser   getgroovyparser src  sourcebuffer
string tokennames   parser gettokennames
parser compilationunit
ast ast   parser getast
// now do the business
visitor visitor   new simplegroovyclassdocassembler packagepath  file  sourcebuffer  links
antlrastprocessor traverser   new sourcecodetraversal visitor
traverser process ast
return   simplegroovyclassdocassembler  visitor  getgroovyclassdocs
private javarecognizer getjavaparser string input  sourcebuffer sourcebuffer
javarecognizer parser   null
unicodeescapingreader unicodereader   new unicodeescapingreader new stringreader input  sourcebuffer
javalexer lexer   new javalexer unicodereader
unicodereader setlexer lexer
parser   javarecognizer make lexer
parser setsourcebuffer sourcebuffer
return parser
private groovyrecognizer getgroovyparser string input  sourcebuffer sourcebuffer
groovyrecognizer parser   null
unicodeescapingreader unicodereader   new unicodeescapingreader new stringreader input  sourcebuffer
groovylexer lexer   new groovylexer unicodereader
unicodereader setlexer lexer
parser   groovyrecognizer make lexer
parser setsourcebuffer sourcebuffer
return parser
public void buildtree string filename  throws ioexception  recognitionexception  tokenstreamexception
string srcfilename   sourcepath   fs   filename
string src   defaultgroovymethods gettext new file srcfilename
string packagepath   tool getpath filename
packagepath   packagepath replace    fs
string file   tool getfile filename
try
map classdocs   getclassdocsfromsinglesource packagepath  file  src
rootdoc putallclasses classdocs
simplegroovypackagedoc packagedoc    simplegroovypackagedoc  rootdoc packagenamed packagepath
if  packagedoc    null
packagedoc   new simplegroovypackagedoc packagepath
packagedoc putall classdocs
rootdoc put packagepath  packagedoc
catch  recognitionexception e
system out println     filename
catch  tokenstreamexception e
system out println     filename
public groovyrootdoc getrootdoc
rootdoc resolve
return rootdoc