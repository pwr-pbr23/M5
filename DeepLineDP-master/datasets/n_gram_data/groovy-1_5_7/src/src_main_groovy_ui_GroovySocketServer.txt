/*
* copyright 2003-2007 the original author or authors.
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package groovy ui
import groovy lang groovyshell
import groovy lang script
import java io bufferedreader
import java io fileinputstream
import java io ioexception
import java io inputstreamreader
import java io printwriter
import java net inetaddress
import java net serversocket
import java net socket
import java net url
/**
* simple server that executes supplied script against a socket
*
* @version $id$
* @author jeremy rayner
*/
public class groovysocketserver implements runnable
private url url
private groovyshell groovy
private boolean isscriptfile
private string scriptfilenameortext
private boolean autooutput
public groovysocketserver groovyshell groovy  boolean isscriptfile  string scriptfilenameortext  boolean autooutput  int port
this groovy   groovy
this isscriptfile   isscriptfile
this scriptfilenameortext   scriptfilenameortext
this autooutput   autooutput
try
url   new url    inetaddress getlocalhost   gethostaddress    port
system out println     port
catch  ioexception e
e printstacktrace
new thread this  start
public void run
try
serversocket serversocket   new serversocket url getport
while  true
// create one script per socket connection.
// this is purposefully not caching the script
// so that the script source file can be changed on the fly,
// as each connection is made to the server.
script script
if  isscriptfile
groovymain gm   new groovymain
script   groovy parse new fileinputstream gm huntforthescriptfile scriptfilenameortext
else
script   groovy parse scriptfilenameortext
new groovyclientconnection script  autooutput  serversocket accept
catch  exception e
e printstacktrace
class groovyclientconnection implements runnable
private script script
private socket socket
private bufferedreader reader
private printwriter writer
private boolean autooutputflag
groovyclientconnection script script  boolean autooutput socket socket  throws ioexception
this script   script
this autooutputflag   autooutput
this socket   socket
reader   new bufferedreader new inputstreamreader socket getinputstream
writer   new printwriter socket getoutputstream
new thread this      socket getinetaddress   gethostaddress    start
public void run
try
string line   null
script setproperty    writer
script setproperty    socket
script setproperty    boolean true
while   line   reader readline       null
// system.out.println(line);
script setproperty    line
object o   script run
script setproperty    boolean false
if  o    null
if    equals o
break     to close sockets gracefully etc
else
if  autooutputflag
writer println o
writer flush
catch  ioexception e
e printstacktrace
finally
try
writer flush
writer close
finally
try
socket close
catch  ioexception e3
e3 printstacktrace