/*
* copyright 2003-2007 the original author or authors.
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org codehaus groovy bsf
import groovy lang closure
import groovy lang groovyshell
import org apache bsf bsfdeclaredbean
import org apache bsf bsfexception
import org apache bsf bsfmanager
import org apache bsf util bsfengineimpl
import org apache bsf util bsffunctions
import org codehaus groovy runtime invokerhelper
import java util vector
/**
* a bsf engine for the <a href="http://groovy.codehaus.org/">groovy</a>
* scripting language.
* <p/>
* it's derived from the jython / jpython engine
*
* @author james strachan
*/
public class groovyengine extends bsfengineimpl
protected groovyshell shell
/*
* convert a non java class name to a java classname
* this is used to convert a script name to a name
* that can be used as a classname with the script is
* loaded in groovyclassloader#load()
* the method simply replaces any invalid characters
* with "_".
*/
private string converttovalidjavaclassname string inname
if  inname    null    inname equals
return
stringbuffer output   new stringbuffer inname length
boolean firstchar   true
for  int i   0  i < inname length      i
char ch   inname charat i
if  firstchar     character isjavaidentifierstart ch
ch
else if   firstchar
character isjavaidentifierpart ch     ch
ch
firstchar    ch
output append ch
return output tostring
/**
* allow an anonymous function to be declared and invoked
*/
public object apply string source  int lineno  int columnno  object funcbody  vector paramnames
vector arguments  throws bsfexception
object object   eval source  lineno  columnno  funcbody
if  object instanceof closure
// lets call the function
closure closure    closure  object
return closure call arguments toarray
return object
/**
* call the named method of the given object.
*/
public object call object object  string method  object args  throws bsfexception
return invokerhelper invokemethod object  method  args
/**
* evaluate an expression.
*/
public object eval string source  int lineno  int columnno  object script  throws bsfexception
try
source   converttovalidjavaclassname source
return getevalshell   evaluate script tostring    source
catch  exception e
throw new bsfexception bsfexception reason_execution_error      e  e
/**
* execute a script.
*/
public void exec string source  int lineno  int columnno  object script  throws bsfexception
try
// use evaluate to pass in the bsf variables
source   converttovalidjavaclassname source
getevalshell   evaluate script tostring    source
catch  exception e
throw new bsfexception bsfexception reason_execution_error      e  e
/**
* initialize the engine.
*/
public void initialize bsfmanager mgr  string lang  vector declaredbeans  throws bsfexception
super initialize mgr  lang  declaredbeans
// create a shell
shell   new groovyshell mgr getclassloader
// register the mgr with object name "bsf"
shell setvariable    new bsffunctions mgr  this
int size   declaredbeans size
for  int i   0  i < size  i
declarebean  bsfdeclaredbean  declaredbeans elementat i
/**
* declare a bean
*/
public void declarebean bsfdeclaredbean bean  throws bsfexception
shell setvariable bean name  bean bean
/**
* undeclare a previously declared bean.
*/
public void undeclarebean bsfdeclaredbean bean  throws bsfexception
shell setvariable bean name  null
/**
* @return a newly created groovyshell using the same variable scope but a new class loader
*/
protected groovyshell getevalshell
return new groovyshell shell