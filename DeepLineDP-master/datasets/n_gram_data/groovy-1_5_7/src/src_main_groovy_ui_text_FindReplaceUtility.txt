/*
* copyright 2003-2007 the original author or authors.
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package groovy ui text
import java awt borderlayout
import java awt dimension
import java awt flowlayout
import java awt gridlayout
import java awt event actionevent
import java awt event focusadapter
import java awt event focusevent
import java awt event keyadapter
import java awt event keyevent
import java awt event textevent
import java awt event textlistener
import java util eventlistener
import javax swing action
import javax swing abstractaction
import javax swing boxlayout
import javax swing jbutton
import javax swing jcheckbox
import javax swing jcombobox
import javax swing jdialog
import javax swing jlabel
import javax swing jpanel
import javax swing jrootpane
import javax swing keystroke
import javax swing event eventlistenerlist
import javax swing text attributeset
import javax swing text badlocationexception
import javax swing text document
import javax swing text jtextcomponent
import javax swing text segment
/**
*
* @author evan "hippy" slatis
*/
public final class findreplaceutility
public static final string find_action_command
public static final string replace_action_command
public static final string replace_all_action_command
public static final string close_action_command
public static final action find_action   new findaction
private static final jdialog find_replace_dialog   new jdialog
private static final jpanel text_field_panel   new jpanel new gridlayout 2  1
private static final jpanel entry_panel   new jpanel
private static final jpanel find_panel   new jpanel
private static final jlabel find_label   new jlabel
private static final jcombobox find_field   new jcombobox
private static final jpanel replace_panel   new jpanel
private static final jlabel replace_label   new jlabel
private static final jcombobox replace_field   new jcombobox
private static final jpanel button_panel   new jpanel
private static final jbutton find_button   new jbutton
private static final jbutton replace_button   new jbutton
private static final jbutton replace_all_button   new jbutton
private static final jbutton close_button   new jbutton
private static final action close_action   new closeaction
private static final action replace_action   new replaceaction
private static final jpanel check_box_panel   new jpanel new gridlayout 3  1
private static final jcheckbox match_case_checkbox   new jcheckbox
private static final jcheckbox is_backwards_checkbox   new jcheckbox
private static final jcheckbox wrap_search_checkbox   new jcheckbox
private static jtextcomponent textcomponent
private static attributeset attributeset
private static int findreplacecount
private static string lastaction
private static final eventlistenerlist event_listener_list   new eventlistenerlist
// the document segment
private static final segment segment   new segment
private static final focusadapter text_focus_listener   new focusadapter
public void focusgained focusevent fe
textcomponent    jtextcomponent fe getsource
attributeset
textcomponent getdocument   getdefaultrootelement   getattributes
static
find_replace_dialog setresizable false
find_replace_dialog setdefaultcloseoperation jdialog dispose_on_close
// is next line needed at all?
keystroke keystroke      keystroke getkeystroke
keyadapter keyadapter   new keyadapter
public void keytyped keyevent ke
if  ke getkeychar      keyevent vk_enter
find_button doclick
find_panel setlayout new flowlayout flowlayout right
find_panel add find_label
find_panel add find_field
find_field additem
find_field seteditable true
find_field geteditor   geteditorcomponent   addkeylistener keyadapter
dimension d   find_field getpreferredsize
d width   225
find_field setpreferredsize d
replace_panel add replace_label
replace_panel add replace_field
replace_field seteditable true
replace_field geteditor   geteditorcomponent   addkeylistener keyadapter
replace_field setpreferredsize d
text_field_panel setlayout new boxlayout text_field_panel  boxlayout y_axis
text_field_panel add find_panel
text_field_panel add replace_panel
entry_panel add text_field_panel
find_replace_dialog getcontentpane   add entry_panel  borderlayout west
check_box_panel add match_case_checkbox
check_box_panel add is_backwards_checkbox
check_box_panel add wrap_search_checkbox
entry_panel add check_box_panel
entry_panel setlayout new boxlayout entry_panel  boxlayout y_axis
replace_all_button setaction new replaceallaction
replace_all_button sethorizontalalignment jbutton center
d   replace_all_button getpreferredsize
button_panel setlayout new boxlayout button_panel  boxlayout y_axis
find_button setaction find_action
find_button setpreferredsize d
find_button sethorizontalalignment jbutton center
jpanel panel   new jpanel
panel add find_button
button_panel add panel
find_replace_dialog getrootpane   setdefaultbutton find_button
replace_button setaction replace_action
replace_button setpreferredsize d
replace_button sethorizontalalignment jbutton center
panel   new jpanel
panel add replace_button
button_panel add panel
panel   new jpanel
panel add replace_all_button
button_panel add panel
close_button setaction close_action
close_button setpreferredsize d
close_button sethorizontalalignment jbutton center
panel   new jpanel
panel add close_button
button_panel add panel
find_replace_dialog getcontentpane   add button_panel
keystroke stroke    keystroke  close_action getvalue action accelerator_key
jrootpane rpane   find_replace_dialog getrootpane
rpane getinputmap jbutton when_in_focused_window  put stroke
rpane getactionmap   put    close_action
// singleton
private findreplaceutility
public static void addtextlistener textlistener tl
event_listener_list add textlistener class  tl
private static void firetextevent
eventlistener lstrs
event_listener_list getlisteners textlistener class
if  lstrs    null    lstrs length > 0
textevent te
new textevent find_replace_dialog  textevent text_value_changed
for  int i   0  i < lstrs length  i
textlistener lstrs  textvaluechanged te
/**
* @return the last action
*/
public static string getlastaction
return lastaction
/**
* @return the replacement count
*/
public static int getreplacementcount
return findreplacecount
/**
* @return the search text
*/
public static string getsearchtext
return  string  find_field getselecteditem
/**
* @param textcomponent the text component to listen to
*/
public static void registertextcomponent jtextcomponent textcomponent
textcomponent addfocuslistener text_focus_listener
public static void removetextlistener textlistener tl
event_listener_list remove textlistener class  tl
/**
* find and select the next searchable matching text.
*
* @param reverse look forwards or backwards
* @param pos the starting index to start finding from
* @return the location of the next selected, or -1 if not found
*/
private static int findnext boolean reverse  int pos
boolean backwards   is_backwards_checkbox isselected
backwards   backwards ?  reverse   reverse
string pattern    string  find_field getselecteditem
if  pattern    null    pattern length   > 0
try
document doc   textcomponent getdocument
doc gettext 0  doc getlength    segment
catch  exception e
// should never reach here
e printstacktrace
pos    textcomponent getselectedtext      null ?
backwards ?  1   1    0
char first   backwards ?
pattern charat pattern length     1    pattern charat 0
char oppfirst   character isuppercase first  ?
character tolowercase first    character touppercase first
int start   pos
boolean wrapped   wrap_search_checkbox isselected
int end   backwards ? 0   segment getendindex
pos    backwards ?  1   1
int length   textcomponent getdocument   getlength
if  pos > length
pos   wrapped ? 0   length
boolean found   false
while   found     backwards ? pos > end   pos < end
found    match_case_checkbox isselected      segment array    oppfirst
found   found ? found   segment array    first
if  found
pos    backwards ?   pattern length     1    0
for  int i   0  found    i < pattern length    i
char c   pattern charat i
found    segment array    c
if   match_case_checkbox isselected       found
c   character isuppercase c  ?
character tolowercase c
character touppercase c
found    segment array    c
if   found
pos    backwards ?  1   1
if  pos    end    wrapped
pos   backwards ? segment getendindex     0
end   start
wrapped   false
pos   found ? pos    1
return pos
private static void setliststrings
object findobject   find_field getselecteditem
object replaceobject   replace_field isshowing   ?
string  replace_field getselecteditem
if  findobject    null    replaceobject    null
boolean found   false
for  int i   0   found    i < find_field getitemcount    i
found   find_field getitemat i  equals findobject
if   found
find_field insertitemat findobject  0
if  find_field getitemcount   > 7
find_field removeitemat 7
if  replace_field isshowing
found   false
for  int i   0   found    i < replace_field getitemcount    i
found   replace_field getitemat i  equals findobject
if   found
replace_field insertitemat replaceobject  0
if  replace_field getitemcount   > 7
replace_field removeitemat 7
public static void showdialog
showdialog false
/**
* @param isreplace show a replace dialog rather than a find dialog if true
*/
public static void showdialog boolean isreplace
string title   isreplace ? replace_action_command   find_action_command
find_replace_dialog settitle title
string text   textcomponent getselectedtext
if  text    null
text
find_field geteditor   setitem text
find_field geteditor   selectall
replace_panel setvisible isreplace
replace_all_button setvisible isreplace
close_button setvisible isreplace
action action   isreplace ?
replace_action   close_action
replace_button setaction action
replace_button setpreferredsize null
dimension d   isreplace ?
replace_all_button getpreferredsize
replace_button getpreferredsize
find_button setpreferredsize d
replace_button setpreferredsize d
close_button setpreferredsize d
find_replace_dialog invalidate
find_replace_dialog repaint
find_replace_dialog pack
java awt frame frames   java awt frame getframes
for  int i   0  i < frames length  i
if  frames isfocused
find_replace_dialog setlocationrelativeto frames
find_replace_dialog setvisible true
find_field requestfocusinwindow
/**
* @param textcomponent the text component to stop listening to
*/
public static void unregistertextcomponent jtextcomponent textcomponent
textcomponent removefocuslistener text_focus_listener
private static class findaction extends abstractaction
public findaction
putvalue action name  find_action_command
putvalue action action_command_key  find_action_command
putvalue action mnemonic_key  new integer keyevent vk_f
public void actionperformed actionevent ae
lastaction   find_action_command
findreplacecount   0
if  find_replace_dialog isvisible
find_replace_dialog gettitle   equals find_action_command
int pos   textcomponent getselectedtext      null ?
textcomponent getcaretposition
textcomponent getselectionstart
boolean reverse    ae getmodifiers     actionevent shift_mask     0
pos   findnext reverse  pos
if  pos >  1
string pattern    string  find_field getselecteditem
textcomponent select pos  pos   pattern length
findreplacecount   1
setliststrings
firetextevent
private static class replaceaction extends abstractaction
public replaceaction
putvalue action name  replace_action_command
putvalue action action_command_key  replace_action_command
putvalue action mnemonic_key  new integer keyevent vk_r
public void actionperformed actionevent ae
lastaction   ae getactioncommand
findreplacecount   0
int pos   textcomponent getselectedtext      null ?
textcomponent getcaretposition
textcomponent getselectionstart
pos   findnext false  pos   1
if  pos >  1
string find    string  find_field getselecteditem
string replace    string  replace_field getselecteditem
replace   replace    null ?     replace
document doc   textcomponent getdocument
try
doc remove pos  find length
doc insertstring pos  replace  attributeset
int last   pos
pos   findnext false  pos
if  pos >  1
textcomponent select pos  pos   find length
else
textcomponent setcaretposition last   replace length
catch  badlocationexception ble
ble printstacktrace
findreplacecount   1
setliststrings
firetextevent
private static class replaceallaction extends abstractaction
public replaceallaction
putvalue action name  replace_all_action_command
putvalue action action_command_key  replace_all_action_command
putvalue action mnemonic_key  new integer keyevent vk_a
public void actionperformed actionevent ae
lastaction   ae getactioncommand
findreplacecount   0
int last   textcomponent getselectedtext      null ?
textcomponent getcaretposition
textcomponent getselectionstart
int pos   findnext false  last   1
string find    string  find_field getselecteditem
string replace    string  replace_field getselecteditem
replace   replace    null ?     replace
while  pos >  1
document doc   textcomponent getdocument
try
doc remove pos  find length
doc insertstring pos  replace  attributeset
last   pos
pos   findnext false  pos
catch  badlocationexception ble
ble printstacktrace
findreplacecount
if  pos >  1
textcomponent select pos  pos   find length
else
textcomponent setcaretposition last   replace length
setliststrings
firetextevent
private static class closeaction extends abstractaction
public closeaction
putvalue action name  close_action_command
putvalue action action_command_key  close_action_command
putvalue action mnemonic_key  new integer keyevent vk_c
putvalue action accelerator_key  keystroke getkeystroke
public void actionperformed actionevent ae
find_replace_dialog dispose
public static void dispose
find_replace_dialog dispose