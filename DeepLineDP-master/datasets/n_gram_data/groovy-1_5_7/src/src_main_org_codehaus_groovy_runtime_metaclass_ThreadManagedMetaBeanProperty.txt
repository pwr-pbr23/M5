/*
* copyright 2003-2007 the original author or authors.
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org codehaus groovy runtime metaclass
import groovy lang closure
import groovy lang metabeanproperty
import groovy lang metamethod
import org codehaus groovy reflection cachedclass
import org codehaus groovy reflection reflectioncache
import java lang reflect modifier
import java util map
import java util weakhashmap
/**
* this metabeanproperty will create a pseudo property whose value is bound to the current
* thread using soft references. the values will go out of scope and be garabage collected when
* the thread dies or when memory is required by the jvm
* <p/>
* the property uses an inheritablethreadlocal instance internally so child threads will still be able
* to see the property
*
* @author graeme rocher
* @since 1.1
*/
public class threadmanagedmetabeanproperty extends metabeanproperty
private static final cachedclass zero_argument_list   new cachedclass
private static final threadlocal property_instance_holder   new inheritablethreadlocal
private class declaringclass
private threadboundgetter getter
private threadboundsetter setter
private object initialvalue
private static final string property_set_prefix
private closure initialvaluecreator
/**
* retrieves the initial value of the threadbound property
*
* @return the initial value
*/
public synchronized object getinitialvalue
return getinitialvalue null
public synchronized object getinitialvalue object object
if  initialvaluecreator    null
return initialvaluecreator call object
return initialvalue
/**
* closure responsible for creating the initial value of thread-managed bean properties
*
* @param callable the closure responsible for creating the initial value
*/
public void setinitialvaluecreator closure callable
this initialvaluecreator   callable
/**
* constructs a new threadmanagedbeanproperty for the given arguments
*
* @param declaringclass the class that declares the property
* @param name           the name of the property
* @param type           the type of the property
* @param iv             the properties initial value
*/
public threadmanagedmetabeanproperty class declaringclass  string name  class type  object iv
super name  type  null  null
this type   type
this declaringclass   declaringclass
this getter   new threadboundgetter name
this setter   new threadboundsetter name
initialvalue   iv
/**
* constructs a new threadmanagedbeanproperty for the given arguments
*
* @param declaringclass      the class that declares the property
* @param name                the name of the property
* @param type                the type of the property
* @param initialvaluecreator the closure responsible for creating the initial value
*/
public threadmanagedmetabeanproperty class declaringclass  string name  class type  closure initialvaluecreator
super name  type  null  null
this type   type
this declaringclass   declaringclass
this getter   new threadboundgetter name
this setter   new threadboundsetter name
this initialvaluecreator   initialvaluecreator
private static object getthreadboundpropertyvalue object obj  string name  object initialvalue
map propertymap   getthreadboundpropertmap
string key   system identityhashcode obj    name
if  propertymap containskey key
return propertymap get key
else
propertymap put key  initialvalue
return initialvalue
private static map getthreadboundpropertmap
map propertymap    map  property_instance_holder get
if  propertymap    null
propertymap   new weakhashmap
property_instance_holder set propertymap
return propertymap
private static object setthreadboundpropertyvalue object obj  string name  object value
map propertymap   getthreadboundpropertmap
string key   system identityhashcode obj    name
return propertymap put key  value
/* (non-javadoc)
* @see groovy.lang.metabeanproperty#getgetter()
*/
public metamethod getgetter
return this getter
/* (non-javadoc)
* @see groovy.lang.metabeanproperty#getsetter()
*/
public metamethod getsetter
return this setter
/**
* accesses the threadbound state of the property as a getter
*
* @author graeme rocher
*/
class threadboundgetter extends metamethod
private final string name  name0
public threadboundgetter string name
setparameterstypes new cachedclass
this name   getgettername name  type
this name0   name
public int getmodifiers
return modifier public
public string getname
return name
public class getreturntype
return type
public cachedclass getdeclaringclass
return reflectioncache getcachedclass declaringclass
/* (non-javadoc)
* @see groovy.lang.metamethod#invoke(java.lang.object, java.lang.object[])
*/
public object invoke object object  object arguments
return getthreadboundpropertyvalue object  name0  getinitialvalue
/**
* sets the threadbound state of the property like a setter
*
* @author graeme rocher
*/
private class threadboundsetter extends metamethod
private final string name  name0
public threadboundsetter string name
setparameterstypes  new cachedclass   reflectioncache getcachedclass type
this name   getsettername name
this name0   name
public int getmodifiers
return modifier public
non javadoc
* @see groovy.lang.metamethod#getname()
*/
public string getname
return name
public class getreturntype
return type
public cachedclass getdeclaringclass
return reflectioncache getcachedclass declaringclass
/* (non-javadoc)
* @see groovy.lang.metamethod#invoke(java.lang.object, java.lang.object[])
*/
public object invoke object object  object arguments
return setthreadboundpropertyvalue object  name0  arguments
private string getgettername string propertyname  class type
string prefix   type    boolean class    type    boolean class ?
return prefix   character touppercase propertyname charat 0
propertyname substring 1
private string getsettername string propertyname
return property_set_prefix   propertyname substring 0  1  touppercase     propertyname substring 1