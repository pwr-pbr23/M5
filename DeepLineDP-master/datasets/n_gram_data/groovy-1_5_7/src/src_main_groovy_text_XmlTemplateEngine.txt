/*
* copyright 2003-2007 the original author or authors.
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package groovy text
import groovy lang
import groovy util indentprinter
import groovy util node
import groovy util xmlnodeprinter
import groovy util xmlparser
import groovy xml qname
import java io ioexception
import java io printwriter
import java io reader
import java io stringwriter
import java io writer
import java lang ref weakreference
import java util hashmap
import java util map
import javax xml parsers parserconfigurationexception
import org codehaus groovy control compilationfailedexception
import org codehaus groovy runtime invokerhelper
import org xml sax saxexception
/**
* template engine for xml data input.
*
* @author christian stein
* @author paul king
*/
public class xmltemplateengine extends templateengine
private static int counter   1
private static class gspprinter extends xmlnodeprinter
public gspprinter printwriter out  string indent
this new indentprinter out  indent
public gspprinter indentprinter out
super out   "
setquote
protected void printgroovytag string tag  string text
if  tag equals
out print text
out print
return
if  tag equals
printlinebegin
out print
out print text
out print
printlineend
return
throw new runtimeexception
protected void printsimpleitem object value
this printlinebegin
out print escapespecialchars invokerhelper tostring value
printlineend
private string escapespecialchars string s
stringbuffer sb   new stringbuffer
boolean ingstring   false
for  int i   0  i < s length    i
final char c   s charat i
switch  c
case
sb append
if  i < s length     1    s charat i   1        ingstring   true
break
case
append sb  c     ingstring
break
case
append sb  c     ingstring
break
case
append sb  c     ingstring
break
case
append sb  c     ingstring
break
case
sb append c
ingstring   false
break
default
sb append c
return sb tostring
private void append stringbuffer sb  char plainchar  string xmlstring  boolean ingstring
if  ingstring
sb append plainchar
else
sb append xmlstring
protected void printlinebegin
out print  "
out printindent
protected void printlineend string comment
out print    "
if  comment    null
out print
out print comment
out print
protected boolean printspecialnode node node
object name   node name
if  name    null    name instanceof qname
qname qn    qname  name
if  qn getprefix   equals
string s   qn getlocalpart
if  s length      0
throw new runtimeexception     node
printgroovytag s  node text
return true
return false
private static class xmltemplate implements template
private final script script
public xmltemplate script script
this script   script
public writable make
return make new hashmap
public writable make map map
if  map    null
throw new illegalargumentexception
return new xmlwritable script  new binding map
private static class xmlwritable implements writable
private final binding binding
private final script script
private weakreference result
public xmlwritable script script  binding binding
this script   script
this binding   binding
this result   new weakreference null
public writer writeto writer out
script scriptobject   invokerhelper createscript script getclass    binding
printwriter pw   new printwriter out
scriptobject setproperty    pw
scriptobject run
pw flush
return out
public string tostring
if  result get      null
return result get   tostring
string string   writeto new stringwriter 1024   tostring
result   new weakreference string
return string
public static final string default_indentation
private final groovyshell groovyshell
private final xmlparser xmlparser
private string indentation
public xmltemplateengine   throws saxexception  parserconfigurationexception
this default_indentation  false
public xmltemplateengine string indentation  boolean validating  throws saxexception  parserconfigurationexception
this new xmlparser validating  true   new groovyshell
setindentation indentation
public xmltemplateengine xmlparser xmlparser  classloader parentloader
this xmlparser  new groovyshell parentloader
public xmltemplateengine xmlparser xmlparser  groovyshell groovyshell
this groovyshell   groovyshell
this xmlparser   xmlparser
setindentation default_indentation
public template createtemplate reader reader  throws compilationfailedexception  classnotfoundexception  ioexception
node root   null
try
root   xmlparser parse reader
catch  saxexception e
throw new runtimeexception    e
if  root    null
throw new ioexception
stringwriter writer   new stringwriter 1024
writer write
new gspprinter new printwriter writer   indentation  print root
script script
try
script   groovyshell parse writer tostring        counter
catch  exception e
throw new groovyruntimeexception     e getmessage
return new xmltemplate script
public string getindentation
return indentation
public void setindentation string indentation
if  indentation    null
indentation   default_indentation
this indentation   indentation
public string tostring
return