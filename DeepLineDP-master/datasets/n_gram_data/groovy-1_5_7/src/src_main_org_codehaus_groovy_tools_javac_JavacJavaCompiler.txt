/*
* copyright 2003-2007 the original author or authors.
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org codehaus groovy tools javac
import groovy lang groovyclassloader
import java io file
import java io printwriter
import java io stringwriter
import java lang reflect method
import java lang reflect invocationtargetexception
import java util
import java net urlclassloader
import java net url
import java net uri
import java net urisyntaxexception
import org codehaus groovy control compilationunit
import org codehaus groovy control compilerconfiguration
import org codehaus groovy control messages exceptionmessage
import org codehaus groovy control messages simplemessage
import org codehaus groovy runtime defaultgroovymethods
public class javacjavacompiler implements javacompiler
private compilerconfiguration config
public javacjavacompiler compilerconfiguration config
this config   config
public void compile list files  compilationunit cu
string javacparameters   makeparameters files  cu getclassloader
stringwriter javacoutput null
int javacreturnvalue   0
try
class javac   findjavac cu
method method null
try
method   javac getmethod    new class string class  printwriter class
javacoutput   new stringwriter
printwriter writer   new printwriter javacoutput
object ret   method invoke null  new object javacparameters writer
javacreturnvalue     integer  ret  intvalue
catch  nosuchmethodexception e
if  method  null
method   javac getmethod    new class string class
object ret   method invoke null  new object javacparameters
javacreturnvalue     integer  ret  intvalue
cu getconfiguration   getoutput
catch  invocationtargetexception ite
cu geterrorcollector   addfatalerror new exceptionmessage  exception  ite getcause    true  cu
catch  exception e
cu geterrorcollector   addfatalerror new exceptionmessage e  true  cu
if  javacreturnvalue  0
switch  javacreturnvalue
case 1  addjavacerror   cu javacoutput   break
case 2  addjavacerror   cu javacoutput   break
case 3  addjavacerror   cu javacoutput   break
case 4  addjavacerror   cu javacoutput   break
default  addjavacerror   cu javacoutput   break
private void addjavacerror string header  compilationunit cu  stringwriter msg
if  msg  null
header   header   msg getbuffer   tostring
else
header   header
cu geterrorcollector   addfatalerror new simplemessage header cu
private string makeparameters list files  groovyclassloader parentclassloader
map options   config getjointcompilationoptions
linkedlist paras   new linkedlist
file target   config gettargetdirectory
if  target    null  target   new file
// defaults
paras add
paras add target getabsolutepath
paras add
paras add   file  options get     getabsolutepath
// add flags
string flags    string  options get
if  flags    null
for  int i   0  i < flags length  i
paras add     flags
boolean hadclasspath false
// add namedvalues
string namedvalues    string  options get
if  namedvalues    null
for  int i   0  i < namedvalues length  i    2
string name   namedvalues
if  name equals     hadclasspath   true
paras add     name
paras add namedvalues
// append classpath if not already defined
if   hadclasspath
// add all classpaths that compilation unit sees
stringbuffer resultpath   new stringbuffer defaultgroovymethods join config getclasspath    file pathseparator
classloader cl   parentclassloader
while  cl    null
if  cl instanceof urlclassloader
url urls     urlclassloader cl  geturls
for  int i   0  i < urls length  i
try
resultpath append file pathseparator
resultpath append new file new uri urls toexternalform     getpath
catch  urisyntaxexception e
// ignore it
cl   cl getparent
paras add
paras add resultpath tostring
// files to compile
paras addall files
return  string  paras toarray new string
private class findjavac compilationunit cu  throws classnotfoundexception
string main
try
return class forname main
catch  classnotfoundexception e
try
classloader cl   this getclass   getclassloader
return cl loadclass main
catch  classnotfoundexception e
try
return classloader getsystemclassloader   loadclass main
catch  classnotfoundexception e
try
return cu getclassloader   getparent   loadclass main
catch  classnotfoundexception e3
// couldn't find compiler - try to find tools.jar
// based on java.home setting
string javahome   system getproperty
if  javahome tolowercase locale us  endswith
javahome   javahome substring 0  javahome length     4
file toolsjar   new file  javahome
if  toolsjar exists
groovyclassloader loader   cu getclassloader
loader addclasspath toolsjar getabsolutepath
return loader loadclass main
throw new classnotfoundexception