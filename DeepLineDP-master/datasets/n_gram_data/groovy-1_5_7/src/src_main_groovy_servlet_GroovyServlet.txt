/*
* copyright 2003-2007 the original author or authors.
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package groovy servlet
import groovy lang binding
import groovy lang closure
import groovy util groovyscriptengine
import groovy util resourceexception
import groovy util scriptexception
import java io ioexception
import javax servlet servletconfig
import javax servlet servletexception
import javax servlet http httpservletrequest
import javax servlet http httpservletresponse
import org codehaus groovy runtime groovycategorysupport
/**
* this servlet will run groovy scripts as groovlets.  groovlets are scripts
* with these objects implicit in their scope:
*
* <ul>
*  <li>request - the httpservletrequest</li>
*  <li>response - the httpservletresponse</li>
*  <li>application - the servletcontext associated with the servlet</li>
*  <li>session - the httpsession associated with the httpservletrequest</li>
*  <li>out - the printwriter associated with the servletrequest</li>
* </ul>
*
* <p>your script sources can be placed either in your web application's normal
* web root (allows for subdirectories) or in /web-inf/groovy/* (also allows
* subdirectories).
*
* <p>to make your web application more groovy, you must add the groovyservlet
* to your application's web.xml configuration using any mapping you like, so
* long as it follows the pattern *.* (more on this below).  here is the
* web.xml entry:
*
* <pre>
*    <servlet>
*      <servlet-name>groovy</servlet-name>
*      <servlet-class>groovy.servlet.groovyservlet</servlet-class>
*    </servlet>
*
*    <servlet-mapping>
*      <servlet-name>groovy</servlet-name>
*      <url-pattern>*.groovy</url-pattern>
*      <url-pattern>*.gdo</url-pattern>
*    </servlet-mapping>
* </pre>
*
* <p>the url pattern does not require the "*.groovy" mapping.  you can, for
* example, make it more struts-like but groovy by making your mapping "*.gdo".
*
* @author sam pullara
* @author mark turansky (markturansky at hotmail.com)
* @author guillaume laforge
* @author christian stein
*
* @see groovy.servlet.servletbinding
*/
public class groovyservlet extends abstracthttpservlet
/**
* the script engine executing the groovy scripts for this servlet
*/
private groovyscriptengine gse
/**
* initialize the groovyservlet.
*
* @throws servletexception
*  if this method encountered difficulties
*/
public void init servletconfig config  throws servletexception
super init config
// set up the scripting engine
gse   creategroovyscriptengine
servletcontext log     gse
/**
* handle web requests to the groovyservlet
*/
public void service httpservletrequest request  httpservletresponse response  throws ioexception
// get the script path from the request - include aware (groovy-815)
final string scripturi   getscripturi request
// set it to html by default
response setcontenttype   encoding
// set up the script context
final binding binding   new servletbinding request  response  servletcontext
// run the script
try
closure closure   new closure gse
public object call
try
return   groovyscriptengine  getdelegate    run scripturi  binding
catch  resourceexception e
throw new runtimeexception e
catch  scriptexception e
throw new runtimeexception e
groovycategorysupport use servletcategory class  closure
/*
* set reponse code 200.
*/
response setstatus httpservletresponse sc_ok
catch  runtimeexception runtimeexception
stringbuffer error   new stringbuffer
error append
error append scripturi
error append
throwable e   runtimeexception getcause
/*
* null cause?!
*/
if  e    null
error append
error append runtimeexception getmessage
if  runtimeexception getstacktrace   length > 0
error append runtimeexception getstacktrace   tostring
servletcontext log error tostring
system err println error tostring
runtimeexception printstacktrace system err
response senderror httpservletresponse sc_internal_server_error  error tostring
return
/*
* resource not found.
*/
if  e instanceof resourceexception
error append
servletcontext log error tostring
system err println error tostring
response senderror httpservletresponse sc_not_found
return
/*
* other internal error. perhaps syntax?!
*/
servletcontext log    runtimeexception
error append e getmessage
if  e getstacktrace   length > 0
error append e getstacktrace   tostring
servletcontext log e tostring
system err println e tostring
runtimeexception printstacktrace system err
response senderror httpservletresponse sc_internal_server_error  e tostring
finally
/*
* finally, flush the response buffer.
*/
response flushbuffer
// servletcontext.log("flushed response buffer.");
/**
* hook method to setup the groovyscriptengine to use.<br/>
* subclasses may override this method to provide a custom
* engine.
*/
protected groovyscriptengine creategroovyscriptengine
return new groovyscriptengine this