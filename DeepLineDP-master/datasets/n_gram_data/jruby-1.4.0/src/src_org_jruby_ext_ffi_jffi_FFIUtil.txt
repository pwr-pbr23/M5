package org jruby ext ffi jffi
import java util collection
import java util enummap
import java util map
import org jruby ruby
import org jruby rubyhash
import org jruby rubymodule
import org jruby rubystring
import org jruby ext ffi callbackinfo
import org jruby ext ffi nativetype
import org jruby ext ffi structlayout
import org jruby ext ffi type
import org jruby runtime threadcontext
import org jruby runtime builtin irubyobject
/**
* some utility functions for ffi <=> jffi conversions
*/
public final class ffiutil
private static final com kenai jffi memoryio io   com kenai jffi memoryio getinstance
private ffiutil
private static final map<nativetype  com kenai jffi type> typemap   buildtypemap
private static final map<nativetype  com kenai jffi type> buildtypemap
map<nativetype  com kenai jffi type> m   new enummap<nativetype  com kenai jffi type> nativetype class
m put nativetype void  com kenai jffi type void
m put nativetype bool  com kenai jffi type uint32
m put nativetype char  com kenai jffi type sint8
m put nativetype short  com kenai jffi type sint16
m put nativetype int  com kenai jffi type sint32
m put nativetype long_long  com kenai jffi type sint64
m put nativetype uchar  com kenai jffi type uint8
m put nativetype ushort  com kenai jffi type uint16
m put nativetype uint  com kenai jffi type uint32
m put nativetype ulong_long  com kenai jffi type uint64
if  com kenai jffi platform getplatform   longsize      32
m put nativetype long  com kenai jffi type sint32
m put nativetype ulong  com kenai jffi type uint32
else
m put nativetype long  com kenai jffi type sint64
m put nativetype ulong  com kenai jffi type uint64
m put nativetype float  com kenai jffi type float
m put nativetype double  com kenai jffi type double
m put nativetype pointer  com kenai jffi type pointer
m put nativetype buffer_in  com kenai jffi type pointer
m put nativetype buffer_out  com kenai jffi type pointer
m put nativetype buffer_inout  com kenai jffi type pointer
m put nativetype string  com kenai jffi type pointer
return m
static final com kenai jffi type getffitype type type
if  type instanceof type builtin    type instanceof callbackinfo    type instanceof org jruby ext ffi enum
return ffiutil getffitype type getnativetype
else if  type instanceof org jruby ext ffi structbyvalue
return ffiutil newstruct   org jruby ext ffi structbyvalue  type  getstructlayout
else
return null
static final com kenai jffi type getffitype nativetype type
return typemap get type
/**
* creates a new jffi struct descriptor from a list of struct members
*
* @param the runtime
* @param structmembers the members of the struct
* @return a new struct descriptor.
*/
static final com kenai jffi struct newstruct ruby runtime  collection<structlayout member> structmembers
com kenai jffi type fields   new com kenai jffi type
int i   0
for  structlayout member m   structmembers
com kenai jffi type fieldtype
if  m instanceof structlayout aggregate
fieldtype   newstruct runtime    structlayout aggregate  m  getmembers
else
fieldtype   ffiutil getffitype m getnativetype
if  fieldtype    null
throw runtime newtypeerror     m
fields   fieldtype
return new com kenai jffi struct fields
/**
* creates a new jffi struct descriptor for a structlayout
*
* @param layout the structure layout
* @return a new struct descriptor.
*/
static final com kenai jffi struct newstruct structlayout layout
return newstruct layout getruntime    layout getfields
/**
* reads a nul-terminated string from native memory and boxes it up in a ruby
* string.
*
* @param runtime the ruby runtime for the resulting string.
* @param address the memory address to read the string from.
* @return a ruby string.
*/
static final irubyobject getstring ruby runtime  long address
if  address    0
return runtime getnil
byte bytes   getzeroterminatedbytearray address
if  bytes length    0
return rubystring newemptystring runtime
rubystring s   rubystring newstringnocopy runtime  bytes
s settaint true
return s
static final byte getzeroterminatedbytearray long address
return io getzeroterminatedbytearray address
static final byte getzeroterminatedbytearray long address  int maxlen
return io getzeroterminatedbytearray address  maxlen
static final void putzeroterminatedbytearray long address  byte bytes  int off  int len
io putbytearray address  bytes  off  len
io putbyte address   len   byte  0
static final type resolvetype threadcontext context  irubyobject obj
if  obj instanceof type
return  type  obj
final rubymodule ffi   context getruntime   fastgetmodule
final irubyobject typedefs   ffi fastfetchconstant
if    typedefs instanceof rubyhash
throw context getruntime   newruntimeerror
irubyobject type     rubyhash  typedefs  fastaref obj
if  type    null    type isnil
type   ffi callmethod context     obj
if    type instanceof type
throw context getruntime   newtypeerror     obj
return  type  type