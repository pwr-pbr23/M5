/***** begin license block *****
* version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public
* license version 1.0 (the "license"); you may not use this file
* except in compliance with the license. you may obtain a copy of
* the license at http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as
* is" basis, without warranty of any kind, either express or
* implied. see the license for the specific language governing
* rights and limitations under the license.
*
* copyright (c) 2007-2009 nick sieger <nicksieger@gmail.com>
* copyright (c) 2009 joseph lafata <joe@quibb.org>
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"),
* or the gnu lesser general public license version 2.1 or later (the "lgpl"),
* in which case the provisions of the gpl or the lgpl are applicable instead
* of those above. if you wish to allow use of your version of this file only
* under the terms of either the gpl or the lgpl, and not to allow others to
* use your version of this file under the terms of the cpl, indicate your
* decision by deleting the provisions above and replace them with the notice
* and other provisions required by the gpl or the lgpl. if you do not delete
* the provisions above, a recipient may use your version of this file under
* the terms of any one of the cpl, the gpl or the lgpl.
***** end license block *****/
package org jruby
import java io bufferedinputstream
import java io bytearrayinputstream
import java io file
import java io fileinputstream
import java io ioexception
import java io inputstream
import java io printstream
import java util arraylist
import java util hashmap
import java util hashset
import java util list
import java util map
import java util set
import org jruby ast executable script
import org jruby compiler astcompiler
import org jruby compiler astcompiler19
import org jruby exceptions mainexitexception
import org jruby runtime constants
import org jruby runtime load loadservice
import org jruby util classcache
import org jruby util jrubyfile
import org jruby util kcode
import org jruby util normalizedfile
import org jruby util safepropertyaccessor
import org objectweb asm opcodes
public class rubyinstanceconfig
/**
* the max count of active methods eligible for jit-compilation.
*/
private static final int jit_max_methods_limit   4096
/**
* the max size of jit-compiled methods (full class size) allowed.
*/
private static final int jit_max_size_limit   10000
/**
* the jit threshold to the specified method invocation count.
*/
private static final int jit_threshold   50
/** the version to use for generated classes. set to current jvm version by default */
public static final int java_version
/**
* default size for chained compilation.
*/
private static final int chained_compile_line_count_default   500
/**
* the number of lines at which a method, class, or block body is split into
* chained methods (to dodge 64k method-size limit in jvm).
*/
public static final int chained_compile_line_count
safepropertyaccessor getint    chained_compile_line_count_default
public enum compilemode
jit  force  off
public boolean shouldprecompilecli
switch  this
case jit  case force
return true
return false
public boolean shouldjit
switch  this
case jit  case force
return true
return false
public boolean shouldprecompileall
return this    force
private inputstream input            system in
private printstream output           system out
private printstream error            system err
private profile profile              profile default
private boolean objectspaceenabled
safepropertyaccessor getboolean    false
private compilemode compilemode   compilemode jit
private boolean runrubyinprocess     true
private string currentdirectory
private map environment
private string argv
private final boolean jitlogging
private final boolean jitloggingverbose
private final int jitlogevery
private final int jitthreshold
private final int jitmax
private final int jitmaxsize
private final boolean samplingenabled
private compatversion compatversion
private classloader contextloader   thread currentthread   getcontextclassloader
private classloader loader   contextloader    null ? rubyinstanceconfig class getclassloader     contextloader
private classcache<script> classcache
// from commandlineparser
private list<string> loadpaths   new arraylist<string>
private set<string> excludedmethods   new hashset<string>
private stringbuffer inlinescript   new stringbuffer
private boolean hasinlinescript   false
private string scriptfilename   null
private list<string> requiredlibraries   new arraylist<string>
private boolean benchmarking   false
private boolean argvglobalson   false
private boolean assumeloop   false
private boolean assumeprinting   false
private map optionglobals   new hashmap
private boolean processlineends   false
private boolean split   false
// this property is a boolean, to allow three values, so it can match mri's nil, false and true
private boolean verbose   boolean false
private boolean debug   false
private boolean showversion   false
private boolean showbytecode   false
private boolean showcopyright   false
private boolean endofarguments   false
private boolean shouldruninterpreter   true
private boolean shouldprintusage   false
private boolean shouldprintproperties false
private kcode kcode   kcode none
private string recordseparator
private boolean shouldchecksyntax   false
private string inputfieldseparator   null
private boolean managementenabled   true
private string inplacebackupextension   null
private boolean parserdebug   false
private string threaddumpsignal   null
private int safelevel   0
private string jrubyhome
public static final boolean peephole_optz
safepropertyaccessor getboolean    true
public static boolean fastest_compile_enabled
safepropertyaccessor getboolean
public static boolean fastops_compile_enabled
fastest_compile_enabled
safepropertyaccessor getboolean
public static boolean frameless_compile_enabled
fastest_compile_enabled
safepropertyaccessor getboolean
public static boolean positionless_compile_enabled
fastest_compile_enabled
safepropertyaccessor getboolean
public static boolean threadless_compile_enabled
fastest_compile_enabled
safepropertyaccessor getboolean
public static boolean fastcase_compile_enabled
safepropertyaccessor getboolean
public static boolean fastsend_compile_enabled
safepropertyaccessor getboolean
public static boolean lazyhandles_compile   safepropertyaccessor getboolean    false
public static boolean inline_dyncall_enabled
fastest_compile_enabled
safepropertyaccessor getboolean
public static final boolean fork_enabled
safepropertyaccessor getboolean
public static final boolean pooling_enabled
safepropertyaccessor getboolean
public static final int pool_max
safepropertyaccessor getint    integer max_value
public static final int pool_min
safepropertyaccessor getint    0
public static final int pool_ttl
safepropertyaccessor getint    60
public static final boolean native_net_protocol
safepropertyaccessor getboolean    false
public static boolean full_trace_enabled
safepropertyaccessor getboolean    false
public static final string compile_exclude
safepropertyaccessor getproperty
public static boolean nativeenabled   true
public static final boolean reify_ruby_classes
safepropertyaccessor getboolean    false
public static final boolean use_generated_handles
safepropertyaccessor getboolean    false
public static final boolean debug_load_service
safepropertyaccessor getboolean    false
public static final boolean jumps_have_backtrace
safepropertyaccessor getboolean    false
public static interface loadservicecreator
loadservice create ruby runtime
loadservicecreator default   new loadservicecreator
public loadservice create ruby runtime
return new loadservice runtime
private loadservicecreator creator   loadservicecreator default
static
string specversion   null
try
specversion   system getproperty
if  specversion    null
specversion   system getproperty
if  system getproperty       null
nativeenabled   boolean getboolean
catch  securityexception se
nativeenabled   false
specversion
if  specversion equals
java_version   opcodes v1_5
else
java_version   opcodes v1_6
public int characterindex   0
public rubyinstanceconfig rubyinstanceconfig parentconfig
setcurrentdirectory parentconfig getcurrentdirectory
samplingenabled   parentconfig samplingenabled
compatversion   parentconfig compatversion
compilemode   parentconfig getcompilemode
jitlogging   parentconfig jitlogging
jitloggingverbose   parentconfig jitloggingverbose
jitlogevery   parentconfig jitlogevery
jitthreshold   parentconfig jitthreshold
jitmax   parentconfig jitmax
jitmaxsize   parentconfig jitmaxsize
managementenabled   parentconfig managementenabled
runrubyinprocess   parentconfig runrubyinprocess
excludedmethods   parentconfig excludedmethods
threaddumpsignal   parentconfig threaddumpsignal
classcache   new classcache<script> loader  jitmax
public rubyinstanceconfig
setcurrentdirectory ruby issecurityrestricted   ?     jrubyfile getfileproperty
samplingenabled   safepropertyaccessor getboolean    false
string compatstring   safepropertyaccessor getproperty
if  compatstring equalsignorecase
setcompatversion compatversion ruby1_8
else if  compatstring equalsignorecase
setcompatversion compatversion ruby1_9
else
error println     compatstring
setcompatversion compatversion ruby1_8
if  ruby issecurityrestricted
compilemode   compilemode off
jitlogging   false
jitloggingverbose   false
jitlogevery   0
jitthreshold    1
jitmax   0
jitmaxsize    1
managementenabled   false
else
string threshold   safepropertyaccessor getproperty
string max   safepropertyaccessor getproperty
string maxsize   safepropertyaccessor getproperty
if  compile_exclude    null
string elements   compile_exclude split
for  string element   elements  excludedmethods add element
managementenabled   safepropertyaccessor getboolean    true
runrubyinprocess   safepropertyaccessor getboolean    true
boolean jitproperty   safepropertyaccessor getproperty       null
if  jitproperty
error print
compilemode   safepropertyaccessor getboolean    ? compilemode jit   compilemode off
else
string jitmodeproperty   safepropertyaccessor getproperty
if  jitmodeproperty equals
compilemode   compilemode off
else if  jitmodeproperty equals
compilemode   compilemode jit
else if  jitmodeproperty equals
compilemode   compilemode force
else
error print
compilemode   compilemode jit
jitlogging   safepropertyaccessor getboolean
jitloggingverbose   safepropertyaccessor getboolean
string logevery   safepropertyaccessor getproperty
jitlogevery   logevery    null ? 0   integer parseint logevery
jitthreshold   threshold    null ?
jit_threshold   integer parseint threshold
jitmax   max    null ?
jit_max_methods_limit   integer parseint max
jitmaxsize   maxsize    null ?
jit_max_size_limit   integer parseint maxsize
// default classcache using jitmax as a soft upper bound
classcache   new classcache<script> loader  jitmax
threaddumpsignal   safepropertyaccessor getproperty
if  fork_enabled
error print
public loadservicecreator getloadservicecreator
return creator
public void setloadservicecreator loadservicecreator creator
this creator   creator
public loadservice createloadservice ruby runtime
return this creator create runtime
public string getbasicusagehelp
stringbuilder sb   new stringbuilder
sb
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
//.append("  -x[directory]   strip off text before #!ruby line and perhaps cd to directory\n")
append
append
append
append
append
append
append
append  client
append  server
append
append
append
append
append
append
return sb tostring
public string getextendedhelp
stringbuilder sb   new stringbuilder
sb
append
append
append
append
append
append
return sb tostring
public string getpropertyhelp
stringbuilder sb   new stringbuilder
sb
append
append
append
append
append
append
append
append
append
append
append
append
append  unsafe
append
append
append
append
append
append  chained     chained_compile_line_count_default
append
append
append
append
append
append
append     jit_threshold
append
append
append     jit_max_methods_limit
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
append
return sb tostring
public string getversionstring
string ver   null
string patchdelimeter   null
int patchlevel   0
switch  getcompatversion
case ruby1_8
ver   constants ruby_version
patchlevel   constants ruby_patchlevel
patchdelimeter
break
case ruby1_9
ver   constants ruby1_9_version
patchlevel   constants ruby1_9_patchlevel
patchdelimeter
break
string fullversion   string format
constants version  ver  patchdelimeter  patchlevel
constants compile_date  constants revision
system getproperty     system getproperty
safepropertyaccessor getproperty
return fullversion
public string getcopyrightstring
return
public void processarguments string arguments
new argumentprocessor arguments  processarguments
string rubyopt   system getenv
if  rubyopt    null
string rubyoptargs   rubyopt split
for  int i   0  i < rubyoptargs length  i
if   rubyoptargs startswith
rubyoptargs       rubyoptargs
new argumentprocessor rubyoptargs  false  processarguments
public compilemode getcompilemode
return compilemode
public void setcompilemode compilemode compilemode
this compilemode   compilemode
public boolean isjitlogging
return jitlogging
public boolean isjitloggingverbose
return jitloggingverbose
public int getjitlogevery
return jitlogevery
public boolean issamplingenabled
return samplingenabled
public int getjitthreshold
return jitthreshold
public int getjitmax
return jitmax
public int getjitmaxsize
return jitmaxsize
public boolean isrunrubyinprocess
return runrubyinprocess
public void setrunrubyinprocess boolean flag
this runrubyinprocess   flag
public void setinput inputstream newinput
input   newinput
public inputstream getinput
return input
public compatversion getcompatversion
return compatversion
public void setcompatversion compatversion compatversion
// until we get a little more solid on 1.9 support we will only run interpreted mode
if  compatversion    compatversion ruby1_9  compilemode   compilemode off
if  compatversion    null  compatversion   compatversion ruby1_8
this compatversion   compatversion
public void setoutput printstream newoutput
output   newoutput
public printstream getoutput
return output
public void seterror printstream newerror
error   newerror
public printstream geterror
return error
public void setcurrentdirectory string newcurrentdirectory
currentdirectory   newcurrentdirectory
public string getcurrentdirectory
return currentdirectory
public void setprofile profile newprofile
profile   newprofile
public profile getprofile
return profile
public void setobjectspaceenabled boolean newobjectspaceenabled
objectspaceenabled   newobjectspaceenabled
public boolean isobjectspaceenabled
return objectspaceenabled
public void setenvironment map newenvironment
environment   newenvironment
public map getenvironment
return environment
public classloader getloader
return loader
public void setloader classloader loader
// setting the loader needs to reset the class cache
if this loader    loader
this classcache   new classcache<script> loader  this classcache getmax
this loader   loader
public string getargv
return argv
public void setargv string argv
this argv   argv
public string getjrubyhome
if  jrubyhome    null
// try the normal property first
if   ruby issecurityrestricted
jrubyhome   safepropertyaccessor getproperty
if  jrubyhome    null
// verify it if it's there
jrubyhome   verifyhome jrubyhome
else
try
// try loading from classloader resources
jrubyhome   getclass   getresource
touri   getschemespecificpart
catch  exception e
if  jrubyhome    null
// verify it if it's there
jrubyhome   verifyhome jrubyhome
else
// otherwise fall back on system temp location
jrubyhome   system getproperty
return jrubyhome
public void setjrubyhome string home
jrubyhome   verifyhome home
// we require the home directory to be absolute
private string verifyhome string home
if  home equals
home   system getproperty
if  home startswith
home   home substring 3
else if   home startswith
normalizedfile f   new normalizedfile home
if   f isabsolute
home   f getabsolutepath
if   f exists
system err println        system getproperty
return system getproperty
return home
private class argumentprocessor
private string arguments
private int argumentindex   0
private boolean processargv
public argumentprocessor string arguments
this arguments  true
public argumentprocessor string arguments  boolean processargv
this arguments   arguments
this processargv   processargv
public void processarguments
while  argumentindex < arguments length    isinterpreterargument arguments
processargument
argumentindex
if   hasinlinescript    scriptfilename    null
if  argumentindex < arguments length
setscriptfilename arguments     consume the file name
argumentindex
if  processargv  processargv
private void processargv
list<string> arglist   new arraylist<string>
for    argumentindex < arguments length  argumentindex
string arg   arguments
if  argvglobalson    arg startswith
arg   arg substring 1
if  arg indexof    > 0
string keyvalue   arg split    2
optionglobals put keyvalue  keyvalue
else
optionglobals put arg  null
else
argvglobalson   false
arglist add arg
// remaining arguments are for the script itself
for  string arg   argv  arglist add arg
argv   arglist toarray new string
private boolean isinterpreterargument string argument
return argument length   > 0     argument charat 0          argument charat 0            endofarguments
private string getargumenterror string additionalerror
return     additionalerror
private void processargument
string argument   arguments
for   for  characterindex   1  characterindex < argument length    characterindex
switch  argument charat characterindex
case
string temp   graboptionalvalue
if  null    temp
recordseparator
else if  temp equals
recordseparator
else if  temp equals
recordseparator         specify something that can't separate
else
try
int val   integer parseint temp  8
recordseparator        char  val
catch  exception e
mainexitexception mee   new mainexitexception 1  getargumenterror
mee setusageerror true
throw mee
break for
case
split   true
break
case
benchmarking   true
break
case
shouldchecksyntax   true
break
case
try
string saved   grabvalue getargumenterror
file base   new file currentdirectory
file newdir   new file saved
if  newdir isabsolute
currentdirectory   newdir getcanonicalpath
else
currentdirectory   new file base  newdir getpath    getcanonicalpath
if    new file currentdirectory  isdirectory
mainexitexception mee   new mainexitexception 1      saved
mee setusageerror true
throw mee
catch  ioexception e
mainexitexception mee   new mainexitexception 1  getargumenterror
mee setusageerror true
throw mee
break
case
debug   true
verbose   boolean true
break
case
inlinescript append grabvalue getargumenterror
inlinescript append
hasinlinescript   true
break for
case
inputfieldseparator   grabvalue getargumenterror
break
case
shouldprintusage   true
shouldruninterpreter   false
break
case
inplacebackupextension   graboptionalvalue
if inplacebackupextension    null  inplacebackupextension
break for
case
string s   grabvalue getargumenterror
string ls   s split java io file pathseparator
for  int i   0  i < ls length  i
loadpaths add ls
break for
case
// fixme: no argument seems to work for -k in mri plus this should not
// siphon off additional args 'jruby -k ~/scripts/foo'.  also better error
// processing.
string earg   grabvalue getargumenterror
kcode   kcode create null  earg
break
case
processlineends   true
break
case
assumeloop   true
break
case
assumeprinting   true
assumeloop   true
break
case
requiredlibraries add grabvalue getargumenterror
break for
case
argvglobalson   true
break
case
runbinscript
break for
case
string temp   graboptionalvalue
int value   1
if temp  null
try
value   integer parseint temp  8
catch exception e
value   1
safelevel   value
break for
case
verbose   boolean true
setshowversion true
break
case
verbose   boolean true
break
case
string temp   graboptionalvalue
int value   2
if  null    temp
if  temp equals
value   2
else if  temp equals
value   1
else if  temp equals
value   0
else
mainexitexception mee   new mainexitexception 1  getargumenterror
mee setusageerror true
throw mee
switch  value
case 0
verbose   null
break
case 1
verbose   boolean false
break
case 2
verbose   boolean true
break
break for
// fixme: -x flag not supported
//                    case 'x' :
//                        break;
case
string extendedoption   graboptionalvalue
if  extendedoption    null
throw new mainexitexception 0      getextendedhelp
else if  extendedoption equals
objectspaceenabled   false
else if  extendedoption equals
objectspaceenabled   true
else if  extendedoption equals
compilemode   compilemode off
else if  extendedoption equals
compilemode   compilemode force
else
mainexitexception mee
new mainexitexception 1      extendedoption
mee setusageerror true
throw mee
break for
case
parserdebug   true
break for
case
if  argument equals       argument equals
characterindex   argument length
runbinscript
break
else if  argument equals
characterindex   argument length
setcompatversion compatversion getversionfromstring grabvalue getargumenterror
break for
else if  argument equals
setshowcopyright true
shouldruninterpreter   false
break for
else if  argument equals
compilemode   compilemode off
full_trace_enabled   true
system setproperty
break for
else if  argument equals
debug   true
verbose   boolean true
break
else if  argument equals
shouldprintusage   true
shouldruninterpreter   false
break
else if  argument equals
shouldprintproperties   true
shouldruninterpreter   false
break
else if  argument equals
setshowversion true
break for
else if  argument equals
setshowbytecode true
break for
else if  argument equals
compilemode   compilemode force
fastest_compile_enabled   true
fastops_compile_enabled   true
frameless_compile_enabled   true
positionless_compile_enabled   true
fastcase_compile_enabled   true
fastsend_compile_enabled   true
inline_dyncall_enabled   true
rubyexception trace_type   rubyexception ruby_compiled
break for
else if  argument equals
setcompatversion compatversion ruby1_9
break for
else if  argument equals
setcompatversion compatversion ruby1_8
break for
else
if  argument equals
// ruby interpreter compatibilty
// usage: ruby [switches] [--] [programfile] [arguments])
endofarguments   true
break
default
throw new mainexitexception 1      argument
private void runbinscript
string scriptname   grabvalue
if  scriptname equals
scriptname
scriptfilename   resolvescript scriptname
if  scriptfilename equals scriptname
requiredlibraries add
inlinescript append     scriptname
inlinescript append
hasinlinescript   true
endofarguments   true
private string resolvescript string scriptname
// this try/catch is to allow failing over to the "commands" logic
// when running from within a jruby-complete jar file, which has
// jruby.home = a jar file url that does not resolve correctly with
// jrubyfile.create.
try
// try cwd first
file fullname   jrubyfile create currentdirectory  scriptname
if  fullname exists      fullname isfile
return fullname getabsolutepath
fullname   jrubyfile create getjrubyhome        scriptname
if  fullname exists      fullname isfile
return fullname getabsolutepath
string path   system getenv
if  path    null
string paths   path split system getproperty
for  int i   0  i < paths length  i
fullname   jrubyfile create paths  scriptname
if  fullname exists      fullname isfile
return fullname getabsolutepath
catch  illegalargumentexception iae
if  debug  system err println     scriptname
return scriptname
private string grabvalue string errormessage
characterindex
if  characterindex < arguments length
return arguments substring characterindex
argumentindex
if  argumentindex < arguments length
return arguments
mainexitexception mee   new mainexitexception 1  errormessage
mee setusageerror true
throw mee
private string graboptionalvalue
characterindex
if  characterindex < arguments length
return arguments substring characterindex
return null
public byte inlinescript
return inlinescript tostring   getbytes
public list<string> requiredlibraries
return requiredlibraries
public list<string> loadpaths
return loadpaths
public boolean shouldruninterpreter
if isshowversion       hasinlinescript    scriptfilename    null
return true
return isshouldruninterpreter
public boolean shouldprintusage
return shouldprintusage
public boolean shouldprintproperties
return shouldprintproperties
private boolean issourcefromstdin
return getscriptfilename      null
public boolean isinlinescript
return hasinlinescript
public inputstream getscriptsource
try
// kcode.none is used because kcode does not affect parse in ruby 1.8
// if ruby 2.0 encoding pragmas are implemented, this will need to change
if  hasinlinescript
return new bytearrayinputstream inlinescript
else if  issourcefromstdin
// can't use -v and stdin
if  isshowversion
return null
return getinput
else
file file   jrubyfile create getcurrentdirectory    getscriptfilename
return new bufferedinputstream new fileinputstream file   8192
catch  ioexception e
throw new mainexitexception 1      e getmessage
public string displayedfilename
if  hasinlinescript
if  scriptfilename    null
return scriptfilename
else
return
else if  issourcefromstdin
return
else
return getscriptfilename
private void setscriptfilename string scriptfilename
this scriptfilename   scriptfilename
public string getscriptfilename
return scriptfilename
public boolean isbenchmarking
return benchmarking
public boolean isassumeloop
return assumeloop
public boolean isassumeprinting
return assumeprinting
public boolean isprocesslineends
return processlineends
public boolean issplit
return split
public boolean isverbose
return verbose    boolean true
public boolean getverbose
return verbose
public boolean isdebug
return debug
public boolean isparserdebug
return parserdebug
public boolean isshowversion
return showversion
public boolean isshowbytecode
return showbytecode
public boolean isshowcopyright
return showcopyright
protected void setshowversion boolean showversion
this showversion   showversion
protected void setshowbytecode boolean showbytecode
this showbytecode   showbytecode
protected void setshowcopyright boolean showcopyright
this showcopyright   showcopyright
public boolean isshouldruninterpreter
return shouldruninterpreter
public boolean isshouldchecksyntax
return shouldchecksyntax
public string getinputfieldseparator
return inputfieldseparator
public kcode getkcode
return kcode
public string getrecordseparator
return recordseparator
public int getsafelevel
return safelevel
public void setrecordseparator string recordseparator
this recordseparator   recordseparator
public classcache getclasscache
return classcache
public string getinplacebackupextention
return inplacebackupextension
public void setclasscache classcache classcache
this classcache   classcache
public map getoptionglobals
return optionglobals
public boolean ismanagementenabled
return managementenabled
public set getexcludedmethods
return excludedmethods
public astcompiler newcompiler
if  getcompatversion      compatversion ruby1_8
return new astcompiler
else
return new astcompiler19
public string getthreaddumpsignal
return threaddumpsignal