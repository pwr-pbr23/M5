/***** begin license block *****
* version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public
* license version 1.0 (the "license"); you may not use this file
* except in compliance with the license. you may obtain a copy of
* the license at http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as
* is" basis, without warranty of any kind, either express or
* implied. see the license for the specific language governing
* rights and limitations under the license.
*
* copyright (c) 2008, 2009 jruby project
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"),
* or the gnu lesser general public license version 2.1 or later (the "lgpl"),
* in which case the provisions of the gpl or the lgpl are applicable instead
* of those above. if you wish to allow use of your version of this file only
* under the terms of either the gpl or the lgpl, and not to allow others to
* use your version of this file under the terms of the cpl, indicate your
* decision by deleting the provisions above and replace them with the notice
* and other provisions required by the gpl or the lgpl. if you do not delete
* the provisions above, a recipient may use your version of this file under
* the terms of any one of the cpl, the gpl or the lgpl.
***** end license block *****/
package org jruby ext ffi
import org jruby ruby
import org jruby rubyarray
import org jruby rubyclass
import org jruby rubymodule
import org jruby anno jrubyclass
import org jruby anno jrubymethod
import org jruby runtime arity
import org jruby runtime objectallocator
import org jruby runtime threadcontext
import org jruby runtime builtin irubyobject
/**
* defines a c callback's parameters and return type.
*/
@jrubyclass name      parent
public class callbackinfo extends type implements nativeparam
public static final string class_name
/** the arity of this function. */
protected final arity arity
protected final type parametertypes
protected final type returntype
private volatile object providercallbackinfo
/**
* creates a callbackinfo class for a ruby runtime
*
* @param runtime the runtime to create the class for
* @param module the module to place the class in
*
* @return the newly created ruby class
*/
public static rubyclass createcallbackinfoclass ruby runtime  rubymodule module
rubyclass result   module defineclassunder class_name
module fastgetclass
objectallocator not_allocatable_allocator
result defineannotatedmethods callbackinfo class
result defineannotatedconstants callbackinfo class
module fastgetclass    fastsetconstant    result
return result
/**
* creates a new <tt>callbackinfo</tt> instance.
*
* @param runtime the runtime to create the instance for
* @param klazz the ruby class of the callbackinfo instance
* @param returntype the return type of the callback
* @param paramtypes the parameter types of the callback
*/
public callbackinfo ruby runtime  rubyclass klazz  type returntype  type paramtypes
super runtime  klazz  nativetype pointer
this arity   arity fixed paramtypes length
this parametertypes   paramtypes
this returntype   returntype
/**
* callbackinfo.new
*
* @param context the current ruby thread context
* @param klass the ruby class of the callbackinfo instance
* @param returntype the ruby return type
* @param _paramtypes an array containing the ruby parameter types
*
* @return a new callbackinfo instance
*/
@jrubymethod name      meta   true
public static final irubyobject newcallbackinfo threadcontext context  irubyobject klass
irubyobject returntype  irubyobject paramtypes
if    returntype instanceof type
throw context getruntime   newargumenterror
returntype getmetaclass   getname
if    paramtypes instanceof rubyarray
throw context getruntime   newargumenterror
paramtypes getmetaclass   getname
type nativeparamtypes   new type
for  int i   0  i < nativeparamtypes length    i
irubyobject obj     rubyarray  paramtypes  entry i
if    obj instanceof type
throw context getruntime   newargumenterror
obj getmetaclass   getname
nativeparamtypes    type  obj
try
return new callbackinfo context getruntime     rubyclass  klass
type  returntype  nativeparamtypes
catch  unsatisfiedlinkerror ex
return context getruntime   getnil
/**
* returns the {@link org.jruby.runtime.arity} of this function.
*
* @return the <tt>arity</tt> of the native function.
*/
public final arity getarity
return arity
/**
* gets the native return type the callback should return
*
* @return the native return type
*/
public final type getreturntype
return returntype
/**
* gets the ruby parameter types of the callback
*
* @return an array of the parameter types
*/
public final type getparametertypes
return parametertypes
public final object getprovidercallbackinfo
return providercallbackinfo
public final void setprovidercallbackinfo object info
this providercallbackinfo   info
@jrubymethod name
public final irubyobject to_s threadcontext context
stringbuilder sb   new stringbuilder
sb append
for  int i   0  i < parametertypes length    i
sb append parametertypes tostring   tolowercase
if  i <  parametertypes length   1
sb append
sb append     returntype tostring   tolowercase
return context getruntime   newstring sb tostring
@override
public final string tostring
stringbuilder sb   new stringbuilder
sb append
for  int i   0  i < parametertypes length    i
sb append parametertypes tostring   tolowercase
if  i <  parametertypes length   1
sb append
sb append     returntype tostring   tolowercase
return sb tostring
@jrubymethod
public final irubyobject result_type threadcontext context
return returntype
@jrubymethod
public final irubyobject param_types threadcontext context
return rubyarray newarray context getruntime    parametertypes