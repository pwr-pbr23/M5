/*
***** begin license block *****
* version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public
* license version 1.0 (the "license"); you may not use this file
* except in compliance with the license. you may obtain a copy of
* the license at http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as
* is" basis, without warranty of any kind, either express or
* implied. see the license for the specific language governing
* rights and limitations under the license.
*
* copyright (c) 2006, 2007 ola bini <ola@ologix.com>
* copyright (c) 2007 nick sieger <nicksieger@gmail.com>
* copyright (c) 2008 vladimir sizikov <vsizikov@gmail.com>
* copyright (c) 2009 joseph lafata <joe@quibb.org>
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"),
* or the gnu lesser general public license version 2.1 or later (the "lgpl"),
* in which case the provisions of the gpl or the lgpl are applicable instead
* of those above. if you wish to allow use of your version of this file only
* under the terms of either the gpl or the lgpl, and not to allow others to
* use your version of this file under the terms of the cpl, indicate your
* decision by deleting the provisions above and replace them with the notice
* and other provisions required by the gpl or the lgpl. if you do not delete
* the provisions above, a recipient may use your version of this file under
* the terms of any one of the cpl, the gpl or the lgpl.
***** end license block *****/
package org jruby
import java security accesscontroller
import java security messagedigest
import java security nosuchalgorithmexception
import java security privilegedaction
import java security provider
import java util arrays
import org jruby anno jrubymethod
import org jruby anno jrubymodule
import org jruby anno jrubyclass
import org jruby runtime arity
import org jruby runtime block
import org jruby runtime objectallocator
import org jruby runtime builtin irubyobject
import org jruby runtime callback callback
import org jruby util bytelist
/**
* @author <a href="mailto:ola.bini@ki.se">ola bini</a>
*/
@jrubymodule name
public class rubydigest
private static provider provider   null
public static void createdigest ruby runtime
// we're not setting the provider or anything, but it seems that bouncycastle does some internal things in its
// provider's constructor which require it to be executed in a secure context.
// ideally this hack should be removed. see jruby-3919 and this bc bug:
//   http://www.bouncycastle.org/jira/browse/bja-227
provider    provider  accesscontroller doprivileged new privilegedaction
public object run
try
return class forname    newinstance
catch exception e
// provider is not available
return null
rubymodule mdigest   runtime definemodule
rubyclass cdigestbase   mdigest defineclassunder   runtime getobject    base base_allocator
cdigestbase defineannotatedmethods base class
private static messagedigest createmessagedigest ruby runtime  string providername  throws nosuchalgorithmexception
if provider    null
try
return messagedigest getinstance providername  provider
catch nosuchalgorithmexception e
// bouncy castle doesn't support algorithm
// fall back to system jca providers
return messagedigest getinstance providername
@jrubyclass name    parent
public static class md5
@jrubyclass name    parent
public static class rmd160
@jrubyclass name    parent
public static class sha1
@jrubyclass name    parent
public static class sha256
@jrubyclass name    parent
public static class sha384
@jrubyclass name    parent
public static class sha512
public static void createdigestmd5 ruby runtime
runtime getloadservice   require
rubymodule mdigest   runtime fastgetmodule
rubyclass cdigestbase   mdigest fastgetclass
rubyclass cdigest_md5   mdigest defineclassunder   cdigestbase cdigestbase getallocator
cdigest_md5 definefastmethod    new callback
public arity getarity
return arity no_arguments
public irubyobject execute irubyobject recv  irubyobject args  block block
return rubyfixnum newfixnum recv getruntime    64
cdigest_md5 setinternalmodulevariable   runtime newstring
public static void createdigestrmd160 ruby runtime
runtime getloadservice   require
if provider    null
throw runtime newloaderror
rubymodule mdigest   runtime fastgetmodule
rubyclass cdigestbase   mdigest fastgetclass
rubyclass cdigest_rmd160   mdigest defineclassunder   cdigestbase cdigestbase getallocator
cdigest_rmd160 setinternalmodulevariable   runtime newstring
public static void createdigestsha1 ruby runtime
runtime getloadservice   require
rubymodule mdigest   runtime fastgetmodule
rubyclass cdigestbase   mdigest fastgetclass
rubyclass cdigest_sha1   mdigest defineclassunder   cdigestbase cdigestbase getallocator
cdigest_sha1 setinternalmodulevariable   runtime newstring
public static void createdigestsha2 ruby runtime
runtime getloadservice   require
try
createmessagedigest runtime
catch nosuchalgorithmexception e
throw runtime newloaderror
rubymodule mdigest   runtime fastgetmodule
rubyclass cdigestbase   mdigest fastgetclass
rubyclass cdigest_sha2_256   mdigest defineclassunder   cdigestbase cdigestbase getallocator
cdigest_sha2_256 setinternalmodulevariable   runtime newstring
cdigest_sha2_256 definefastmethod    new callback
public arity getarity
return arity no_arguments
public irubyobject execute irubyobject recv  irubyobject args  block block
return rubyfixnum newfixnum recv getruntime    64
rubyclass cdigest_sha2_384   mdigest defineclassunder   cdigestbase cdigestbase getallocator
cdigest_sha2_384 setinternalmodulevariable   runtime newstring
cdigest_sha2_384 definefastmethod    new callback
public arity getarity
return arity no_arguments
public irubyobject execute irubyobject recv  irubyobject args  block block
return rubyfixnum newfixnum recv getruntime    128
rubyclass cdigest_sha2_512   mdigest defineclassunder   cdigestbase cdigestbase getallocator
cdigest_sha2_512 setinternalmodulevariable   runtime newstring
cdigest_sha2_512 definefastmethod    new callback
public arity getarity
return arity no_arguments
public irubyobject execute irubyobject recv  irubyobject args  block block
return rubyfixnum newfixnum recv getruntime    128
@jrubyclass name
public static class base extends rubyobject
protected static final objectallocator base_allocator   new objectallocator
public irubyobject allocate ruby runtime  rubyclass klass
return new base runtime  klass
@jrubymethod name      required   1  meta   true
public static irubyobject s_digest irubyobject recv  irubyobject str
ruby runtime   recv getruntime
string name     rubyclass recv  searchinternalmodulevariable    tostring
try
messagedigest md   createmessagedigest runtime  name
return rubystring newstringshared runtime  md digest str converttostring   getbytes
catch nosuchalgorithmexception e
throw recv getruntime   newnotimplementederror     name
@jrubymethod name      required   1  meta   true
public static irubyobject s_hexdigest irubyobject recv  irubyobject str
ruby runtime   recv getruntime
string name     rubyclass recv  searchinternalmodulevariable    tostring
try
messagedigest md   createmessagedigest runtime  name
return rubystring newstringnocopy runtime  bytelist plain tohex md digest str converttostring   getbytes
catch nosuchalgorithmexception e
throw recv getruntime   newnotimplementederror     name
private messagedigest algo
public base ruby runtime  rubyclass type
super runtime type
if type    runtime fastgetmodule    fastgetclass
throw runtime newnotimplementederror
if  type hasinternalmodulevariable
throw runtime newnotimplementederror     type
try
setalgorithm type searchinternalmodulevariable
catch nosuchalgorithmexception e
throw runtime newnotimplementederror     type
@jrubymethod name      optional   1  frame   true
public irubyobject initialize irubyobject args  block unusedblock
if args length > 0     args isnil
update args
return this
@jrubymethod name      required   1
public irubyobject initialize_copy irubyobject obj
if this    obj
return this
rubyobject obj  checkfrozen
string name     base obj  algo getalgorithm
try
algo    messagedigest   base obj  algo clone
catch clonenotsupportedexception e
throw getruntime   newtypeerror     name
return this
@jrubymethod name           required   1
public irubyobject update irubyobject obj
bytelist bytes   obj converttostring   getbytelist
algo update bytes bytes  bytes begin  bytes realsize
return this
@jrubymethod name      optional   1
public irubyobject digest irubyobject args
if  args length    1
algo reset
update args
irubyobject digest   getdigeststring
if  args length    1
algo reset
return digest
@jrubymethod name
public irubyobject digest_bang
irubyobject digest   getdigeststringnoclone
reset
return digest
@jrubymethod name        optional   1
public irubyobject hexdigest irubyobject args
if  args length    1
algo reset
update args
irubyobject digest   getdigesthexstring
if  args length    1
algo reset
return digest
@jrubymethod name
public irubyobject to_s
return getdigesthexstring
@jrubymethod name
public irubyobject hexdigest_bang
irubyobject digest   getdigesthexstringnoclone
reset
return digest
@jrubymethod name
public irubyobject inspect
return rubystring newstringnocopy getruntime    bytelist plain     getmetaclass   getrealclass   getname         getdigesthex
@jrubymethod name      required   1
public irubyobject op_equal irubyobject oth
boolean ret   this    oth
if  ret
if  oth instanceof base
base b    base oth
ret   this algo getalgorithm   equals b algo getalgorithm
arrays equals getdigest    b getdigest
else
irubyobject str   oth converttostring
ret   this to_s   equals str
return ret ? getruntime   gettrue     getruntime   getfalse
@jrubymethod name
public irubyobject length
return rubyfixnum newfixnum getruntime    algo getdigestlength
@jrubymethod name
public irubyobject block_length
throw getruntime   newruntimeerror
this getmetaclass
@jrubymethod name
public irubyobject reset
algo reset
return getruntime   getnil
private void setalgorithm irubyobject algo  throws nosuchalgorithmexception
this algo   createmessagedigest getruntime    algo tostring
final static byte digits
private byte getdigest
messagedigest copy
try
copy    messagedigest algo clone
catch  clonenotsupportedexception cnse
copy   algo
return copy digest
private byte getdigestnoclone
return algo digest
private bytelist getdigesthex
return tohex getdigest
private bytelist getdigesthexnoclone
return tohex getdigestnoclone
private irubyobject getdigeststring
return rubystring newstringnocopy getruntime    getdigest
private irubyobject getdigeststringnoclone
return rubystring newstringnocopy getruntime    getdigestnoclone
private irubyobject getdigesthexstring
return rubystring newstringnocopy getruntime    getdigesthex
private irubyobject getdigesthexstringnoclone
return rubystring newstringnocopy getruntime    getdigesthexnoclone
private static bytelist tohex byte val
bytelist bytelist   new bytelist val length   2
for int i 0 j val length i<j i
int b   val   0xff
bytelist append digits
bytelist append digits
return bytelist
rubydigest