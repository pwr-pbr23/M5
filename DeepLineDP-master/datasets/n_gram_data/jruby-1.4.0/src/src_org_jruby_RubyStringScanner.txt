package org jruby
import org joni matcher
import org joni option
import org joni regex
import org joni region
import org jcodings encoding
import org jruby anno jrubyclass
import org jruby anno jrubymethod
import org jruby common irubywarnings id
import org jruby exceptions raiseexception
import org jruby runtime block
import org jruby runtime objectallocator
import org jruby runtime threadcontext
import org jruby runtime visibility
import org jruby runtime builtin irubyobject
import org jruby util bytelist
import org jruby util stringsupport
/**
* @author kscott
*
*/
@jrubyclass name
public class rubystringscanner extends rubyobject
private rubystring str
private int pos   0
private int lastpos    1
private region regs
private int beg    1
private int end    1
// not to be confused with rubyobject's flags
private int scannerflags
private static final int matched_str_scn_f   1 << 11
private static objectallocator stringscanner_allocator   new objectallocator
public irubyobject allocate ruby runtime  rubyclass klass
return new rubystringscanner runtime  klass
public static rubyclass createscannerclass final ruby runtime
rubyclass scannerclass   runtime defineclass    runtime getobject    stringscanner_allocator
scannerclass defineannotatedmethods rubystringscanner class
threadcontext context   runtime getcurrentcontext
scannerclass setconstant    runtime newstring    freeze context
scannerclass setconstant    runtime newstring    freeze context
rubyclass standarderror   runtime getstandarderror
rubyclass error   scannerclass defineclassunder
standarderror  standarderror getallocator
rubyclass objclass   runtime getobject
if   objclass isconstantdefined
objclass defineconstant    error
return scannerclass
private void clearmatched
scannerflags    ~matched_str_scn_f
private void setmatched
scannerflags    matched_str_scn_f
private boolean ismatched
return  scannerflags   matched_str_scn_f     0
private void check
if  str    null  throw getruntime   newargumenterror
protected rubystringscanner ruby runtime  rubyclass type
super runtime  type
// second argument is allowed, but ignored (mri)
@jrubymethod name      required   1  optional   1  frame   true  visibility   visibility private
public irubyobject initialize irubyobject args  block unusedblock
str   args converttostring
return this
@jrubymethod name      frame true  visibility   visibility private
@override
public irubyobject initialize_copy irubyobject other
if  this    other  return this
if    other instanceof rubystringscanner
throw getruntime   newtypeerror
other getmetaclass
rubystringscanner otherscanner    rubystringscanner other
str   otherscanner str
pos   otherscanner pos
lastpos   otherscanner lastpos
scannerflags   otherscanner scannerflags
regs   otherscanner regs    null ? otherscanner regs clone     null
beg   otherscanner beg
end   otherscanner end
return this
@jrubymethod name
public irubyobject reset
check
pos   0
clearmatched
return this
@jrubymethod name
public irubyobject terminate
check
pos   str getbytelist   realsize
clearmatched
return this
@jrubymethod name
public irubyobject clear threadcontext context
check
ruby runtime   context getruntime
if  runtime isverbose
runtime getwarnings   warning id deprecated_method
return terminate
@jrubymethod name
public rubystring string
return str
@jrubymethod name      required   1
public irubyobject set_string threadcontext context  irubyobject str
this str    rubystring  str converttostring   strdup context getruntime    freeze context
pos   0
clearmatched
return str
@jrubymethod name           required   1
public irubyobject concat irubyobject obj
check
str append obj      append will call converttostring
return this
@jrubymethod name
public rubyfixnum pos
check
return rubyfixnum newfixnum getruntime    pos
@jrubymethod name
public irubyobject set_pos irubyobject pos
check
int i   rubynumeric num2int pos
int size   str getbytelist   realsize
if  i < 0  i    size
if  i < 0    i > size  throw getruntime   newrangeerror
this pos   i
return rubyfixnum newfixnum getruntime    i
private irubyobject extractrange ruby runtime  int beg  int end
int size   str getbytelist   realsize
if  beg > size  return getruntime   getnil
if  end > size  end   size
return str makeshared runtime  beg  end   beg
private irubyobject extractbeglen ruby runtime  int beg  int len
assert len >  0
int size   str getbytelist   realsize
if  beg > size  return getruntime   getnil
if  beg   len > size  len   size   beg
return str makeshared runtime  beg  len
private irubyobject scan irubyobject regex  boolean succptr  boolean getstr  boolean headonly
if    regex instanceof rubyregexp   throw getruntime   newtypeerror     regex getmetaclass
check
regex pattern     rubyregexp regex  getpattern
clearmatched
int rest   str getbytelist   realsize   pos
if  rest < 0  return getruntime   getnil
bytelist value   str getbytelist
matcher matcher   pattern matcher value bytes  value begin   pos  value begin   value realsize
final int ret
if  headonly
ret   matcher match value begin   pos  value begin   value realsize  option none
else
ret   matcher search value begin   pos  value begin   value realsize  option none
regs   matcher getregion
if  regs    null
beg   matcher getbegin
end   matcher getend
else
beg   regs beg
end   regs end
if  ret < 0  return getruntime   getnil
setmatched
lastpos   pos
if  succptr  pos    end
return  getstr ? extractbeglen getruntime    lastpos  end    rubyfixnum newfixnum getruntime    end
@jrubymethod name      required   1
public irubyobject scan irubyobject regex
return scan regex  true  true  true
@jrubymethod name      required   1
public irubyobject match_p irubyobject regex
return scan regex  false  false  true
@jrubymethod name      required   1
public irubyobject skip irubyobject regex
return scan regex  true  false  true
@jrubymethod name      required   1
public irubyobject check irubyobject regex
return scan regex  false  true  true
@jrubymethod name      required   3
public irubyobject scan_full irubyobject regex  irubyobject s  irubyobject f
return scan regex  s istrue    f istrue    true
@jrubymethod name      required   1
public irubyobject scan_until irubyobject regex
return scan regex  true  true  false
@jrubymethod name      required   1
public irubyobject exist_p irubyobject regex
return scan regex  false  false  false
@jrubymethod name      required   1
public irubyobject skip_until irubyobject regex
return scan regex  true  false  false
@jrubymethod name      required   1
public irubyobject check_until irubyobject regex
return scan regex  false  true  false
@jrubymethod name      required   3
public irubyobject search_full irubyobject regex  irubyobject s  irubyobject f
return scan regex  s istrue    f istrue    false
private void adjustregisters
beg   0
end   pos   lastpos
regs   null
@jrubymethod name      compat   compatversion ruby1_8
public irubyobject getch threadcontext context
return getchcommon context  false
@jrubymethod name      compat   compatversion ruby1_9
public irubyobject getch19 threadcontext context
return getchcommon context  true
public irubyobject getchcommon threadcontext context  boolean is1_9
check
clearmatched
ruby runtime   context getruntime
bytelist value   str getbytelist
if  pos >  value realsize  return runtime getnil
int len
if  is1_9
encoding enc   str getencoding
len   enc issinglebyte   ? 1   stringsupport length enc  value bytes  value begin   pos  value begin   value realsize
else
encoding enc   runtime getkcode   getencoding
len   enc issinglebyte   ? 1   enc length value bytes  value begin   pos  value begin   value realsize
if  pos   len > value realsize  len   value realsize   pos
lastpos   pos
pos    len
setmatched
adjustregisters
return extractrange runtime  lastpos   beg  lastpos   end
@jrubymethod name
public irubyobject get_byte threadcontext context
check
clearmatched
if  pos >  str getbytelist   realsize  return getruntime   getnil
lastpos   pos
pos
setmatched
adjustregisters
return extractrange context getruntime    lastpos   beg  lastpos   end
@jrubymethod name
public irubyobject getbyte threadcontext context
ruby runtime   context getruntime
if  runtime isverbose
runtime getwarnings   warning id deprecated_method
return get_byte context
@jrubymethod name      required   1
public irubyobject peek threadcontext context  irubyobject length
check
int len   rubynumeric num2int length
if  len < 0
throw context getruntime   newargumenterror
bytelist value   str getbytelist
if  pos >  value realsize  return rubystring newemptystring getruntime    infectby str
if  pos   len > value realsize  len   value realsize   pos
return extractbeglen context getruntime    pos  len
@jrubymethod name      required   1
public irubyobject peep threadcontext context  irubyobject length
ruby runtime   context getruntime
if  runtime isverbose
runtime getwarnings   warning
id deprecated_method
return peek context  length
@jrubymethod name
public irubyobject unscan
check
ruby runtime   getruntime
if   ismatched
rubyclass errorclass   runtime fastgetclass    fastgetclass
throw new raiseexception rubyexception newexception
runtime  errorclass
pos   lastpos
clearmatched
return this
@jrubymethod name      alias
public irubyobject bol_p
check
bytelist value   str getbytelist
if  pos > value realsize  return getruntime   getnil
if  pos    0  return getruntime   gettrue
return value bytes     byte   ? getruntime   gettrue     getruntime   getfalse
@jrubymethod name
public rubyboolean eos_p threadcontext context
check
return pos >  str getbytelist   realsize ? context getruntime   gettrue     context getruntime   getfalse
@jrubymethod name
public rubyboolean empty_p threadcontext context
ruby runtime   context getruntime
if  runtime isverbose
runtime getwarnings   warning id deprecated_method
return eos_p context
@jrubymethod name
public rubyboolean rest_p threadcontext context
check
return pos >  str getbytelist   realsize ? context getruntime   getfalse     context getruntime   gettrue
@jrubymethod name
public rubyboolean matched_p threadcontext context
check
return ismatched   ? context getruntime   gettrue     context getruntime   getfalse
@jrubymethod name
public irubyobject matched threadcontext context
check
if   ismatched    return getruntime   getnil
return extractrange context getruntime    lastpos   beg  lastpos   end
@jrubymethod name
public irubyobject matched_size
check
if   ismatched    return getruntime   getnil
return rubyfixnum newfixnum getruntime    end   beg
@jrubymethod name
public irubyobject matchedsize threadcontext context
ruby runtime   context getruntime
if  runtime isverbose
runtime getwarnings   warning id deprecated_method
return matched_size
@jrubymethod name      required   1
public irubyobject op_aref threadcontext context  irubyobject idx
check
if   ismatched    return context getruntime   getnil
int i   rubynumeric num2int idx
int numregs   regs    null ? 1   regs numregs
if  i < 0  i    numregs
if  i < 0    i >  numregs  return context getruntime   getnil
if  regs    null
assert i    0
if  beg     1  return getruntime   getnil
return extractrange context getruntime    lastpos   beg  lastpos   end
else
if  regs beg     1  return getruntime   getnil
return extractrange context getruntime    lastpos   regs beg  lastpos   regs end
@jrubymethod name
public irubyobject pre_match threadcontext context
check
if   ismatched    return context getruntime   getnil
return extractrange context getruntime    0  lastpos   beg
@jrubymethod name
public irubyobject post_match threadcontext context
check
if   ismatched    return context getruntime   getnil
return extractrange context getruntime    lastpos   end  str getbytelist   realsize
@jrubymethod name
public irubyobject rest threadcontext context
check
bytelist value   str getbytelist
if  pos >  value realsize  return rubystring newemptystring context getruntime    infectby str
return extractrange context getruntime    pos  value realsize
@jrubymethod name
public rubyfixnum rest_size
check
bytelist value   str getbytelist
if  pos >  value realsize  return rubyfixnum zero getruntime
return rubyfixnum newfixnum getruntime    value realsize   pos
@jrubymethod name
public rubyfixnum restsize threadcontext context
ruby runtime   context getruntime
if  runtime isverbose
runtime getwarnings   warning id deprecated_method
return rest_size
@jrubymethod name
@override
public irubyobject inspect
if  str    null  return inspect
if  pos >  str getbytelist   realsize  return inspect
if  pos    0  return inspect pos       str getbytelist   realsize       inspect2
return inspect pos       str getbytelist   realsize       inspect1         inspect2
private irubyobject inspect string msg
rubystring result   getruntime   newstring     getmetaclass         msg
if  str    null  result infectby str
return result
private static final int inspect_length   5
private irubyobject inspect1
if  pos    0  return rubystring newemptystring getruntime
if  pos > inspect_length
return rubystring newstringnocopy getruntime      getbytes
append str substr getruntime    pos   inspect_length  inspect_length   inspect
else
return str substr getruntime    0  pos  inspect
private irubyobject inspect2
if  pos >  str getbytelist   realsize  return rubystring newemptystring getruntime
int len   str getbytelist   realsize   pos
if  len > inspect_length
return   rubystring str substr getruntime    pos  inspect_length   cat   getbytes    inspect
else
return str substr getruntime    pos  len  inspect
@jrubymethod name      meta   true
public static irubyobject mustcversion irubyobject recv
return recv