/*
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache wicket markup html
import java util hashmap
import java util map
import org apache commons logging log
import org apache commons logging logfactory
import org apache wicket application
import org apache wicket iresponsefilter
import org apache wicket requestcycle
import org apache wicket model model
import org apache wicket util string appendingstringbuffer
import org apache wicket util string javascriptutils
/**
* this is a filter that injects javascript code to the top head portion and
* after the body so that the time can me measured what the client parse time
* was for this page. it also reports the total server parse/response time in
* the client and logs the server response time and response size it took for a
* specific response in the server log.
*
* you can specify what the status text should be like this:
* serverandclienttimefilter.statustext=my application, server parsetime:
* ${servertime}, client parsetime: ${clienttime}
*
* @author jcompagner
*/
public class serverandclienttimefilter implements iresponsefilter
private static final log log   logfactory getlog serverandclienttimefilter class
/**
* @see org.apache.wicket.iresponsefilter#filter(appendingstringbuffer)
*/
public appendingstringbuffer filter appendingstringbuffer responsebuffer
int headindex   responsebuffer indexof
int bodyindex   responsebuffer indexof
long timetaken   system currenttimemillis     requestcycle get   getstarttime
if  headindex     1    bodyindex     1
map map   new hashmap 4
map put
map put      double timetaken    1000
appendingstringbuffer defaultvalue   new appendingstringbuffer 128
defaultvalue append
defaultvalue append   double timetaken    1000
defaultvalue
append
string txt   application get   getresourcesettings   getlocalizer   getstring
null  model valueof map
defaultvalue tostring
appendingstringbuffer endscript   new appendingstringbuffer 150
endscript append    append javascriptutils script_open_tag
endscript append
endscript append txt
endscript append    append javascriptutils script_close_tag  append
responsebuffer insert bodyindex   1  endscript
responsebuffer insert headindex   6      javascriptutils script_open_tag
javascriptutils script_close_tag
log info timetaken
requestcycle get   getrequest   geturl
responsebuffer length
return responsebuffer