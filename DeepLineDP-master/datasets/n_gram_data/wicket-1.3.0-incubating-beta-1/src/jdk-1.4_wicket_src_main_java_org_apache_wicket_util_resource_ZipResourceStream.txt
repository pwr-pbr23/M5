/*
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache wicket util resource
import java io bufferedinputstream
import java io bytearrayinputstream
import java io bytearrayoutputstream
import java io fileinputstream
import java io filenotfoundexception
import java io ioexception
import java io inputstream
import java util zip zipentry
import java util zip zipoutputstream
import org apache commons logging log
import org apache commons logging logfactory
import org apache wicket wicketruntimeexception
import org apache wicket util file file
import org apache wicket util time time
/**
* an iresourcestream that zips a directory's contents on the fly
*
* <p>
* <b>note 1.</b> nested directories are not supported yet, and a
* {@link filenotfoundexception} will be thrown in that case.
* </p>
*
* <p>
* <b>note 2.</b> as a future improvement, cache a map of generated zip files
* for every directory and use a watcher to detect modifications in this
* directory. using ehcache would be good for that, but it's not in wicket
* dependencies yet. <b>no caching of the generated zip files is done yet.</b>
* </p>
*
* <p>
* <b>note 3.</b> as a future improvement, implement getlastmodified() and
* request resourcestreamrequesttarget to generate last-modified and expires
* http headers. <b>no http cache headers are provided yet</b>. see wicket-385
* </p>
*
* @author <a href="mailto:jbq@apache.org">jean-baptiste quenot</a>
*/
public class zipresourcestream extends abstractresourcestream
/**
*
*/
private static final long serialversionuid   1l
private static final log log   logfactory getlog zipresourcestream class
bytearrayoutputstream bytearray
/**
* construct.
*
* @param dir
*            the directory where to look for files. the directory itself
*            will not be included in the zip.
*/
public zipresourcestream file dir
bytearray   new bytearrayoutputstream
try
int buffer   2048
bufferedinputstream origin   null
zipoutputstream out   new zipoutputstream bytearray
byte data   new byte
// get a list of files from current directory
string files   dir list
if  files    null
throw new illegalargumentexception     dir
for  int i   0  i < files length  i
log debug     files
fileinputstream fi   new fileinputstream new file dir  files
origin   new bufferedinputstream fi  buffer
zipentry entry   new zipentry files
out putnextentry entry
int count
while   count   origin read data  0  buffer       1
out write data  0  count
origin close
out close
catch  exception e
throw new wicketruntimeexception e
public void close   throws ioexception
/**
* @see org.apache.wicket.util.resource.iresourcestream#getcontenttype()
*/
public string getcontenttype
return null
public inputstream getinputstream   throws resourcestreamnotfoundexception
return new bytearrayinputstream bytearray tobytearray
public long length
return bytearray size
public time lastmodifiedtime
return null