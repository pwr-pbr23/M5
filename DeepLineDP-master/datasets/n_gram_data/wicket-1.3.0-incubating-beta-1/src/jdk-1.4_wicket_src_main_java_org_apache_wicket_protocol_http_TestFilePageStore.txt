/*
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache wicket protocol http
import java io file
import java io fileinputstream
import java io fileoutputstream
import java io ioexception
import java nio bytebuffer
import java util iterator
import java util map
import org apache commons logging log
import org apache commons logging logfactory
import org apache wicket application
import org apache wicket page
import org apache wicket protocol http secondlevelcachesessionstore ipagestore
import org apache wicket util concurrent concurrenthashmap
import org apache wicket util lang objects
/**
* stores pages on disk.
* <p>
* override {@link #getworkdir()} to change the default directory for pages,
* which is configured from the javax.servlet.context.tempdir attribute in the
* servlet context.
*
* @author jcompagner
*/
public class testfilepagestore implements ipagestore
/** log. */
protected static log log   logfactory getlog testfilepagestore class
private map map   new concurrenthashmap
public void destroy
private final file defaultworkdir
private final string appname
volatile long totalsavingtime   0
volatile long totalserializationtime   0
private volatile int saved
private volatile int bytessaved
/**
* construct.
*/
public testfilepagestore
this  file   webapplication application get    getservletcontext   getattribute
/**
* construct.
*
* @param dir
*            the directory to save to.
*/
public testfilepagestore file dir
defaultworkdir   dir
appname   application get   getapplicationkey
private class sessionpagekey
private final string sessionid
private final int id
private final int versionnumber
private final int ajaxversionnumber
private final string pagemap
private final class pageclass
sessionpagekey string sessionid  page page
this sessionid  page getnumericid    page getcurrentversionnumber    page
getajaxversionnumber    page getpagemap   getname    page getclass
sessionpagekey string sessionid  int id  int versionnumber  int ajaxversionnumber
string pagemap  class pageclass
this sessionid   sessionid
this id   id
this versionnumber   versionnumber
this ajaxversionnumber   ajaxversionnumber
this pageclass   pageclass
this pagemap   pagemap
/**
* @see java.lang.object#hashcode()
*/
public int hashcode
return sessionid hashcode     id   versionnumber
/**
* @see java.lang.object#equals(java.lang.object)
*/
public boolean equals object obj
if  obj instanceof sessionpagekey
sessionpagekey key    sessionpagekey obj
return id    key id
versionnumber    key versionnumber
ajaxversionnumber    key ajaxversionnumber
pagemap    null    pagemap equals key pagemap       pagemap    null    key pagemap    null
sessionid equals key sessionid
return false
/**
* @see java.lang.object#tostring()
*/
public string tostring
return     sessionid       id       versionnumber
ajaxversionnumber       pagemap
public page getpage string sessionid  string pagemap  int id  int versionnumber  int ajaxversionnumber
sessionpagekey currentkey   new sessionpagekey sessionid  id  versionnumber  ajaxversionnumber  pagemap  null
file sessiondir   new file getworkdir    sessionid
file pagefile   getpagefile currentkey  sessiondir
if  pagefile exists
long t1   system currenttimemillis
fileinputstream fis   null
try
byte pagedata   null
fis   new fileinputstream pagefile
int length    int pagefile length
bytebuffer bb   bytebuffer allocate length
fis getchannel   read bb
if  bb hasarray
pagedata   bb array
else
pagedata   new byte
bb get pagedata
long t2   system currenttimemillis
page page    page objects bytearraytoobject pagedata
page   page getversion versionnumber
if  page    null    log isdebugenabled
long t3   system currenttimemillis
log debug     page getclass         page getnumericid
page getcurrentversionnumber
pagedata length       sessionid
t2   t1         t3   t2
return page
catch  exception e
log error e
return null
public void pageaccessed string sessionid  page page
public void removepage string sessionid  page page
sessionpagekey key   new sessionpagekey sessionid  page
map remove page
public void storepage string sessionid  page page
sessionpagekey key   new sessionpagekey sessionid  page
byte serialized   objects objecttobytearray page
//map.put(key, serialized);
savepage key  serialized
public void unbind string sessionid
for  iterator i   map keyset   iterator    i hasnext
sessionpagekey key    sessionpagekey i next
if  key sessionid equals sessionid
i remove
private file getpagefile sessionpagekey key  file sessiondir
return new file sessiondir  appname       key pagemap       key id
key versionnumber       key ajaxversionnumber
private file getworkdir
return defaultworkdir
private void savepage sessionpagekey key  byte bytes
file sessiondir   new file getworkdir    key sessionid
sessiondir mkdirs
file pagefile   getpagefile key  sessiondir
fileoutputstream fos   null
long t1   system currenttimemillis
int length   0
try
fos   new fileoutputstream pagefile
bytebuffer bb   bytebuffer wrap bytes
fos getchannel   write bb
length   bytes length
catch  exception e
log error     key pageclass       key id
key versionnumber       key sessionid
finally
try
if  fos    null
fos close
catch  ioexception ex
// ignore
long t3   system currenttimemillis
if  log isdebugenabled
log debug     key pageclass       key id       key versionnumber
length       key sessionid        t3   t1
totalsavingtime     t3   t1
saved
bytessaved    length