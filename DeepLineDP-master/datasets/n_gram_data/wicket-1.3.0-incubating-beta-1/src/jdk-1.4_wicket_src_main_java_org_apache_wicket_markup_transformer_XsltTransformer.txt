/*
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache wicket markup transformer
import java io filenotfoundexception
import java io stringreader
import java io stringwriter
import javax xml transform transformer
import javax xml transform transformerfactory
import javax xml transform stream streamresult
import javax xml transform stream streamsource
import org apache wicket application
import org apache wicket component
import org apache wicket util resource iresourcestream
import org apache wicket util resource locator iresourcestreamlocator
/**
* a processor to xslt transform the output generated by a component.
*
* @see org.apache.wicket.markup.transformer.xsltoutputtransformercontainer
* @see org.apache.wicket.markup.transformer.xslttransfomerbehavior
*
* @author juergen donnerstag
*/
public class xslttransformer implements itransformer
private final static string extension
/** an optional xsl file */
private final string xslfile
/**
* construct.
*/
public xslttransformer
this xslfile   null
/**
* instead of using the default mechanism to determine the associated xsl
* file, it is given by the user.
*
* @param xslfile
*            xsl input file path relative to the component's package. if
*            the path does not end with <tt>.xsl</tt>, then it is
*            considered as a basename and will be passed as-is to
*            {@link iresourcestreamlocator#locate(class, string, string, java.util.locale, string)}.
*            all stylesheets must have the <tt>.xsl</tt> extension.
*/
public xslttransformer final string xslfile
if   xslfile    null     xslfile endswith extension
this xslfile   xslfile substring 0  xslfile length     extension length     1
else
this xslfile   xslfile
/**
* apply a xsl transformation to the markup generated by a component. the
* *.xsl resource must be located in the same path as the nearest parent
* with an associated markup and must have a filename equal to the
* component's id.
*
* @see org.apache.wicket.markup.transformer.itransformer#transform(org.apache.wicket.component,
*      java.lang.string)
*/
public charsequence transform final component component  final string output  throws exception
iresourcestream resourcestream   getresourcestream component
if  resourcestream    null
throw new filenotfoundexception
component tostring
try
// 1. instantiate a transformerfactory.
transformerfactory tfactory   transformerfactory newinstance
// 2. use the transformerfactory to process the stylesheet source
// and
// generate a transformer.
transformer transformer   tfactory newtransformer new streamsource resourcestream
getinputstream
// 3. use the transformer to transform an xml source and send the
// output to a result object.
stringwriter writer   new stringwriter
transformer transform new streamsource new stringreader output    new streamresult
writer
return writer getbuffer
finally
resourcestream close
/**
* get the xsl resource stream
*
* @param component
*
* @return the xslt file resource stream
*/
private iresourcestream getresourcestream final component component
final iresourcestream resourcestream
string filepath   this xslfile
if  filepath    null
filepath   component findparentwithassociatedmarkup   getclass
getpackage   getname   replace
component getid
resourcestream   application get   getresourcesettings   getresourcestreamlocator
locate getclass    filepath  component getstyle    component getlocale
xslttransformer extension
return resourcestream