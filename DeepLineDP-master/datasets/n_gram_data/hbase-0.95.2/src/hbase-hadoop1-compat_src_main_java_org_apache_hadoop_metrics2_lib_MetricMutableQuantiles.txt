/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop metrics2 lib
import org apache hadoop classification interfaceaudience
import org apache hadoop classification interfacestability
import org apache hadoop metrics2 metrichistogram
import org apache hadoop metrics2 metricsexecutor
import org apache hadoop metrics2 metricsrecordbuilder
import org apache hadoop metrics2 util metricquantile
import org apache hadoop metrics2 util metricsamplequantiles
import java io ioexception
import java util map
import java util concurrent timeunit
/**
* watches a stream of long values, maintaining online estimates of specific quantiles with provably
* low error bounds. this is particularly useful for accurate high-percentile (e.g. 95th, 99th)
* latency metrics.
*/
@interfaceaudience public
@interfacestability evolving
public class metricmutablequantiles extends metricmutable implements metrichistogram
static final metricquantile quantiles    new metricquantile 0 50  0 050
new metricquantile 0 75  0 025   new metricquantile 0 90  0 010
new metricquantile 0 95  0 005   new metricquantile 0 99  0 001
static final string quantilessuffix
private final int interval
private metricsamplequantiles estimator
private long previouscount   0
private metricsexecutor executor
protected map<metricquantile  long> previoussnapshot   null
/**
* instantiates a new {@link metricmutablequantiles} for a metric that rolls itself over on the
* specified time interval.
*
* @param name        of the metric
* @param description long-form textual description of the metric
* @param samplename  type of items in the stream (e.g., "ops")
* @param valuename   type of the values
* @param interval    rollover interval (in seconds) of the estimator
*/
public metricmutablequantiles string name  string description  string samplename
string valuename  int interval
super name  description
estimator   new metricsamplequantiles quantiles
executor   new metricsexecutorimpl
this interval   interval
executor getexecutor   scheduleatfixedrate new rolloversample this
interval
interval
timeunit seconds
public metricmutablequantiles string name  string description
this name  description        60
@override
public synchronized void snapshot metricsrecordbuilder builder  boolean all
if  all    changed
builder addcounter name      description  previouscount
for  int i   0  i < quantiles length  i
long newvalue   0
// if snapshot is null, we failed to update since the window was empty
if  previoussnapshot    null
newvalue   previoussnapshot get quantiles
builder addgauge name   quantilessuffix  description  newvalue
if  changed
clearchanged
public synchronized void add long value
estimator insert value
public int getinterval
return interval
/** runnable used to periodically roll over the internal {@link org.apache.hadoop.metrics2.util.metricsamplequantiles} every interval. */
private static class rolloversample implements runnable
metricmutablequantiles parent
public rolloversample metricmutablequantiles parent
this parent   parent
@override
public void run
synchronized  parent
try
parent previouscount   parent estimator getcount
parent previoussnapshot   parent estimator snapshot
catch  ioexception e
// couldn't get a new snapshot because the window was empty
parent previouscount   0
parent previoussnapshot   null
parent estimator clear
parent setchanged