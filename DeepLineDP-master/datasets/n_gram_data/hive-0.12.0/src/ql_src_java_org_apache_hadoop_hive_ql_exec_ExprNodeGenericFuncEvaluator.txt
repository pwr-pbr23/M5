/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hive ql exec
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop hive ql metadata hiveexception
import org apache hadoop hive ql plan exprnodedesc
import org apache hadoop hive ql plan exprnodegenericfuncdesc
import org apache hadoop hive ql udf generic genericudf
import org apache hadoop hive ql udf generic genericudfbasecompare
import org apache hadoop hive ql udf generic genericudfcase
import org apache hadoop hive ql udf generic genericudfwhen
import org apache hadoop hive serde2 objectinspector constantobjectinspector
import org apache hadoop hive serde2 objectinspector objectinspector
import org apache hadoop hive serde2 objectinspector objectinspectorutils
/**
* exprnodegenericfuncevaluator.
*
*/
public class exprnodegenericfuncevaluator extends exprnodeevaluator<exprnodegenericfuncdesc>
private static final log log   logfactory
getlog exprnodegenericfuncevaluator class getname
transient genericudf genericudf
transient object rowobject
transient exprnodeevaluator children
transient genericudf deferredobject deferredchildren
transient boolean iseager
/**
* class to allow deferred evaluation for genericudf.
*/
class deferredexprobject implements genericudf deferredobject
private final boolean eager
private final exprnodeevaluator eval
private transient boolean evaluated
private transient int version
private transient object obj
deferredexprobject exprnodeevaluator eval  boolean eager
this eval   eval
this eager   eager
@override
public void prepare int version  throws hiveexception
this version   version
this evaluated   false
if  eager
get
public object get   throws hiveexception
if   evaluated
obj   eval evaluate rowobject  version
evaluated   true
return obj
public exprnodegenericfuncevaluator exprnodegenericfuncdesc expr  throws hiveexception
super expr
children   new exprnodeevaluator
iseager   false
for  int i   0  i < children length  i
exprnodedesc child   expr getchildexprs   get i
exprnodeevaluator nodeevaluator   exprnodeevaluatorfactory get child
children   nodeevaluator
// if we have eager evaluators anywhere below us, then we are eager too.
if  nodeevaluator instanceof exprnodegenericfuncevaluator
if    exprnodegenericfuncevaluator  nodeevaluator  iseager
iseager   true
// base case:  we are eager if a child is stateful
genericudf childudf
exprnodegenericfuncdesc  child  getgenericudf
if  functionregistry isstateful childudf
iseager   true
genericudf   expr getgenericudf
if  iseager
genericudf instanceof genericudfcase    genericudf instanceof genericudfwhen
throw new hiveexception
@override
public objectinspector initialize objectinspector rowinspector  throws hiveexception
deferredchildren   new genericudf deferredobject
for  int i   0  i < deferredchildren length  i
deferredchildren   new deferredexprobject children  iseager
// initialize all children first
objectinspector childrenois   new objectinspector
for  int i   0  i < children length  i
childrenois   children initialize rowinspector
mapredcontext context   mapredcontext get
if  context    null
context setup genericudf
return outputoi   genericudf initializeandfoldconstants childrenois
@override
public boolean isdeterministic
boolean result   functionregistry isdeterministic genericudf
for  exprnodeevaluator child   children
result   result    child isdeterministic
return result
@override
public exprnodeevaluator getchildren
return children
@override
public boolean isstateful
boolean result   functionregistry isstateful genericudf
for  exprnodeevaluator child   children
if result   result    child isstateful
return result
return result
@override
protected object _evaluate object row  int version  throws hiveexception
rowobject   row
if  objectinspectorutils isconstantobjectinspector outputoi
isdeterministic
// the output of this udf is constant, so don't even bother evaluating.
return   constantobjectinspector outputoi  getwritableconstantvalue
for  int i   0  i < deferredchildren length  i
deferredchildren prepare version
return genericudf evaluate deferredchildren
/**
* if the genericudf is a base comparison, it returns an integer based on the result of comparing
* the two sides of the udf, like the compareto method in comparable.
*
* if the genericudf is not a base comparison, or there is an error executing the comparison, it
* returns null.
* @param row
* @return the compare results
* @throws hiveexception
*/
public integer compare object row  throws hiveexception
if   expr issortedexpr        genericudf instanceof genericudfbasecompare
for  exprnodeevaluator evaluator  children
if  evaluator instanceof exprnodegenericfuncevaluator
integer comparison     exprnodegenericfuncevaluator  evaluator  compare row
if  comparison    null
return comparison
return null
rowobject   row
for  int i   0  i < deferredchildren length  i
deferredchildren prepare  1
return   genericudfbasecompare genericudf  compare deferredchildren