/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hive ql security authorization
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop conf configuration
import org apache hadoop hive conf hiveconf
import org apache hadoop hive metastore metastorepreeventlistener
import org apache hadoop hive metastore metastoreutils
import org apache hadoop hive metastore tabletype
import org apache hadoop hive metastore api database
import org apache hadoop hive metastore api invalidoperationexception
import org apache hadoop hive metastore api metaexception
import org apache hadoop hive metastore api nosuchobjectexception
import org apache hadoop hive metastore events preaddpartitionevent
import org apache hadoop hive metastore events prealterpartitionevent
import org apache hadoop hive metastore events prealtertableevent
import org apache hadoop hive metastore events precreatedatabaseevent
import org apache hadoop hive metastore events precreatetableevent
import org apache hadoop hive metastore events predropdatabaseevent
import org apache hadoop hive metastore events predroppartitionevent
import org apache hadoop hive metastore events predroptableevent
import org apache hadoop hive metastore events preeventcontext
import org apache hadoop hive ql metadata authorizationexception
import org apache hadoop hive ql metadata hiveexception
import org apache hadoop hive ql metadata hiveutils
import org apache hadoop hive ql metadata partition
import org apache hadoop hive ql metadata table
import org apache hadoop hive ql plan hiveoperation
import org apache hadoop hive ql security hivemetastoreauthenticationprovider
/**
* authorizationpreeventlistener : a metastorepreeventlistener that
* performs authorization/authentication checks on the metastore-side.
*
* note that this can only perform authorization checks on defined
* metastore preeventcontexts, such as the adding/dropping and altering
* of databases, tables and partitions.
*/
public class authorizationpreeventlistener extends metastorepreeventlistener
public static final log log   logfactory getlog
authorizationpreeventlistener class
private static hiveconf conf
private static hivemetastoreauthorizationprovider authorizer
private static hivemetastoreauthenticationprovider authenticator
public authorizationpreeventlistener configuration config  throws hiveexception
super config
authenticator    hivemetastoreauthenticationprovider  hiveutils getauthenticator
config  hiveconf confvars hive_metastore_authenticator_manager
authorizer    hivemetastoreauthorizationprovider  hiveutils getauthorizeprovidermanager
config  hiveconf confvars hive_metastore_authorization_manager  authenticator
@override
public void onevent preeventcontext context  throws metaexception  nosuchobjectexception
invalidoperationexception
authenticator setmetastorehandler context gethandler
authorizer setmetastorehandler context gethandler
switch  context geteventtype
case create_table
authorizecreatetable  precreatetableevent context
break
case drop_table
authorizedroptable  predroptableevent context
break
case alter_table
authorizealtertable  prealtertableevent context
break
case add_partition
authorizeaddpartition  preaddpartitionevent context
break
case drop_partition
authorizedroppartition  predroppartitionevent context
break
case alter_partition
authorizealterpartition  prealterpartitionevent context
break
case create_database
authorizecreatedatabase  precreatedatabaseevent context
break
case drop_database
authorizedropdatabase  predropdatabaseevent context
break
case load_partition_done
// noop for now
break
default
break
private void authorizecreatedatabase precreatedatabaseevent context
throws invalidoperationexception  metaexception
try
authorizer authorize new database context getdatabase
hiveoperation createdatabase getinputrequiredprivileges
hiveoperation createdatabase getoutputrequiredprivileges
catch  authorizationexception e
throw invalidoperationexception e
catch  hiveexception e
throw metaexception e
private void authorizedropdatabase predropdatabaseevent context
throws invalidoperationexception  metaexception
try
authorizer authorize new database context getdatabase
hiveoperation dropdatabase getinputrequiredprivileges
hiveoperation dropdatabase getoutputrequiredprivileges
catch  authorizationexception e
throw invalidoperationexception e
catch  hiveexception e
throw metaexception e
private void authorizecreatetable precreatetableevent context
throws invalidoperationexception  metaexception
try
authorizer authorize gettablefromapitable context gettable
hiveoperation createtable getinputrequiredprivileges
hiveoperation createtable getoutputrequiredprivileges
catch  authorizationexception e
throw invalidoperationexception e
catch  hiveexception e
throw metaexception e
private void authorizedroptable predroptableevent context
throws invalidoperationexception  metaexception
try
authorizer authorize gettablefromapitable context gettable
hiveoperation droptable getinputrequiredprivileges
hiveoperation droptable getoutputrequiredprivileges
catch  authorizationexception e
throw invalidoperationexception e
catch  hiveexception e
throw metaexception e
private void authorizealtertable prealtertableevent context
throws invalidoperationexception  metaexception
try
authorizer authorize gettablefromapitable context getoldtable

new privilege privilege alter_metadata
catch  authorizationexception e
throw invalidoperationexception e
catch  hiveexception e
throw metaexception e
private void authorizeaddpartition preaddpartitionevent context
throws invalidoperationexception  metaexception
try
org apache hadoop hive metastore api partition mapipart   context getpartition
authorizer authorize getpartitionfromapipartition mapipart  context
hiveoperation altertable_addparts getinputrequiredprivileges
hiveoperation altertable_addparts getoutputrequiredprivileges
catch  authorizationexception e
throw invalidoperationexception e
catch  nosuchobjectexception e
throw invalidoperationexception e
catch  hiveexception e
throw metaexception e
private void authorizedroppartition predroppartitionevent context
throws invalidoperationexception  metaexception
try
org apache hadoop hive metastore api partition mapipart   context getpartition
authorizer authorize getpartitionfromapipartition mapipart  context
hiveoperation altertable_dropparts getinputrequiredprivileges
hiveoperation altertable_dropparts getoutputrequiredprivileges
catch  authorizationexception e
throw invalidoperationexception e
catch  nosuchobjectexception e
throw invalidoperationexception e
catch  hiveexception e
throw metaexception e
private void authorizealterpartition prealterpartitionevent context
throws invalidoperationexception  metaexception
try
org apache hadoop hive metastore api partition mapipart   context getnewpartition
authorizer authorize getpartitionfromapipartition mapipart  context

new privilege privilege alter_metadata
catch  authorizationexception e
throw invalidoperationexception e
catch  nosuchobjectexception e
throw invalidoperationexception e
catch  hiveexception e
throw metaexception e
private table gettablefromapitable org apache hadoop hive metastore api table apitable
org apache hadoop hive metastore api table ttable   apitable deepcopy
if  ttable gettabletype      null
// tabletype specified was null, we need to figure out what type it was.
if  metastoreutils isexternaltable ttable
ttable settabletype tabletype external_table tostring
else if  metastoreutils isindextable ttable
ttable settabletype tabletype index_table tostring
else if   ttable getsd      null      ttable getsd   getlocation      null
ttable settabletype tabletype virtual_view tostring
else
ttable settabletype tabletype managed_table tostring
table tbl   new table ttable
return tbl
private partition getpartitionfromapipartition
org apache hadoop hive metastore api partition mapipart
preeventcontext context  throws hiveexception  nosuchobjectexception  metaexception
org apache hadoop hive metastore api partition tpart   mapipart deepcopy
org apache hadoop hive metastore api table t   context gethandler   get_table
mapipart getdbname    mapipart gettablename
if  tpart getsd      null
// in the cases of create partition, by the time this event fires, the partition
// object has not yet come into existence, and thus will not yet have a
// location or an sd, but these are needed to create a ql.metadata.partition,
// so we use the table's sd. the only place this is used is by the
// authorization hooks, so we will not affect code flow in the metastore itself.
tpart setsd t getsd
return new partition gettablefromapitable t  tpart
private invalidoperationexception invalidoperationexception exception e
invalidoperationexception ex   new invalidoperationexception e getmessage
ex initcause e getcause
return ex
private metaexception metaexception hiveexception e
metaexception ex    new metaexception e getmessage
ex initcause e
return ex