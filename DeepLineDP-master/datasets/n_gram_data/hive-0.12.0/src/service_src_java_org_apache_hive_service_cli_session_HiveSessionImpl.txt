/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hive service cli session
import java io ioexception
import java util hashmap
import java util hashset
import java util list
import java util map
import java util set
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop hive conf hiveconf
import org apache hadoop hive conf hiveconf confvars
import org apache hadoop hive metastore hivemetastoreclient
import org apache hadoop hive metastore imetastoreclient
import org apache hadoop hive metastore api metaexception
import org apache hadoop hive ql history hivehistory
import org apache hadoop hive ql session sessionstate
import org apache hive common util hiveversioninfo
import org apache hive service cli fetchorientation
import org apache hive service cli getinfotype
import org apache hive service cli getinfovalue
import org apache hive service cli hivesqlexception
import org apache hive service cli operationhandle
import org apache hive service cli rowset
import org apache hive service cli sessionhandle
import org apache hive service cli tableschema
import org apache hive service cli operation executestatementoperation
import org apache hive service cli operation getcatalogsoperation
import org apache hive service cli operation getcolumnsoperation
import org apache hive service cli operation getfunctionsoperation
import org apache hive service cli operation getschemasoperation
import org apache hive service cli operation gettabletypesoperation
import org apache hive service cli operation gettypeinfooperation
import org apache hive service cli operation metadataoperation
import org apache hive service cli operation operationmanager
/**
* hivesession
*
*/
public class hivesessionimpl implements hivesession
private final sessionhandle sessionhandle   new sessionhandle
private string username
private final string password
private final map<string  string> sessionconf   new hashmap<string  string>
private final hiveconf hiveconf   new hiveconf
private final sessionstate sessionstate
private static final string fetch_work_serde_class
private static final log log   logfactory getlog hivesessionimpl class
private sessionmanager sessionmanager
private operationmanager operationmanager
private imetastoreclient metastoreclient   null
private final set<operationhandle> ophandleset   new hashset<operationhandle>
public hivesessionimpl string username  string password  map<string  string> sessionconf
this username   username
this password   password
if  sessionconf    null
for  map entry<string  string> entry   sessionconf entryset
hiveconf set entry getkey    entry getvalue
// set an explicit session name to control the download directory name
hiveconf set confvars hivesessionid varname
sessionhandle gethandleidentifier   tostring
sessionstate   new sessionstate hiveconf
public sessionmanager getsessionmanager
return sessionmanager
public void setsessionmanager sessionmanager sessionmanager
this sessionmanager   sessionmanager
private operationmanager getoperationmanager
return operationmanager
public void setoperationmanager operationmanager operationmanager
this operationmanager   operationmanager
protected synchronized void acquire   throws hivesqlexception
sessionstate start sessionstate
protected synchronized void release
assert sessionstate    null
// no need to release sessionstate...
public sessionhandle getsessionhandle
return sessionhandle
public string getusername
return username
public string getpassword
return password
public hiveconf gethiveconf
hiveconf setvar hiveconf confvars hivefetchoutputserde  fetch_work_serde_class
return hiveconf
public imetastoreclient getmetastoreclient   throws hivesqlexception
if  metastoreclient    null
try
metastoreclient   new hivemetastoreclient gethiveconf
catch  metaexception e
throw new hivesqlexception e
return metastoreclient
public getinfovalue getinfo getinfotype getinfotype
throws hivesqlexception
acquire
try
switch  getinfotype
case cli_server_name
return new getinfovalue
case cli_dbms_name
return new getinfovalue
case cli_dbms_ver
return new getinfovalue hiveversioninfo getversion
case cli_max_column_name_len
return new getinfovalue 128
case cli_max_schema_name_len
return new getinfovalue 128
case cli_max_table_name_len
return new getinfovalue 128
case cli_txn_capable
default
throw new hivesqlexception     getinfotype tostring
finally
release
public operationhandle executestatement string statement  map<string  string> confoverlay
throws hivesqlexception
return executestatementinternal statement  confoverlay  false
public operationhandle executestatementasync string statement  map<string  string> confoverlay
throws hivesqlexception
return executestatementinternal statement  confoverlay  true
private operationhandle executestatementinternal string statement  map<string  string> confoverlay
boolean runasync
throws hivesqlexception
acquire
operationmanager operationmanager   getoperationmanager
executestatementoperation operation   operationmanager
newexecutestatementoperation getsession    statement  confoverlay  runasync
operationhandle ophandle   operation gethandle
try
operation run
ophandleset add ophandle
return ophandle
catch  hivesqlexception e
operationmanager closeoperation ophandle
throw e
finally
release
public operationhandle gettypeinfo
throws hivesqlexception
acquire
operationmanager operationmanager   getoperationmanager
gettypeinfooperation operation   operationmanager newgettypeinfooperation getsession
operationhandle ophandle   operation gethandle
try
operation run
ophandleset add ophandle
return ophandle
catch  hivesqlexception e
operationmanager closeoperation ophandle
throw e
finally
release
public operationhandle getcatalogs
throws hivesqlexception
acquire
operationmanager operationmanager   getoperationmanager
getcatalogsoperation operation   operationmanager newgetcatalogsoperation getsession
operationhandle ophandle   operation gethandle
try
operation run
ophandleset add ophandle
return ophandle
catch  hivesqlexception e
operationmanager closeoperation ophandle
throw e
finally
release
public operationhandle getschemas string catalogname  string schemaname
throws hivesqlexception
acquire
operationmanager operationmanager   getoperationmanager
getschemasoperation operation
operationmanager newgetschemasoperation getsession    catalogname  schemaname
operationhandle ophandle   operation gethandle
try
operation run
ophandleset add ophandle
return ophandle
catch  hivesqlexception e
operationmanager closeoperation ophandle
throw e
finally
release
public operationhandle gettables string catalogname  string schemaname  string tablename
list<string> tabletypes
throws hivesqlexception
acquire
operationmanager operationmanager   getoperationmanager
metadataoperation operation
operationmanager newgettablesoperation getsession    catalogname  schemaname  tablename  tabletypes
operationhandle ophandle   operation gethandle
try
operation run
ophandleset add ophandle
return ophandle
catch  hivesqlexception e
operationmanager closeoperation ophandle
throw e
finally
release
public operationhandle gettabletypes
throws hivesqlexception
acquire
operationmanager operationmanager   getoperationmanager
gettabletypesoperation operation   operationmanager newgettabletypesoperation getsession
operationhandle ophandle   operation gethandle
try
operation run
ophandleset add ophandle
return ophandle
catch  hivesqlexception e
operationmanager closeoperation ophandle
throw e
finally
release
public operationhandle getcolumns string catalogname  string schemaname
string tablename  string columnname   throws hivesqlexception
acquire
operationmanager operationmanager   getoperationmanager
getcolumnsoperation operation   operationmanager newgetcolumnsoperation getsession
catalogname  schemaname  tablename  columnname
operationhandle ophandle   operation gethandle
try
operation run
ophandleset add ophandle
return ophandle
catch  hivesqlexception e
operationmanager closeoperation ophandle
throw e
finally
release
public operationhandle getfunctions string catalogname  string schemaname  string functionname
throws hivesqlexception
acquire
operationmanager operationmanager   getoperationmanager
getfunctionsoperation operation   operationmanager
newgetfunctionsoperation getsession    catalogname  schemaname  functionname
operationhandle ophandle   operation gethandle
try
operation run
ophandleset add ophandle
return ophandle
catch  hivesqlexception e
operationmanager closeoperation ophandle
throw e
finally
release
public void close   throws hivesqlexception
try
acquire
/**
*  for metadata operations like gettables(), getcolumns() etc,
* the session allocates a private metastore handler which should be
* closed at the end of the session
*/
if  metastoreclient    null
metastoreclient close
// iterate through the ophandles and close their operations
for  operationhandle ophandle   ophandleset
operationmanager closeoperation ophandle
ophandleset clear
hivehistory hivehist   sessionstate gethivehistory
if  null    hivehist
hivehist closestream
sessionstate close
release
catch  ioexception ioe
release
throw new hivesqlexception    ioe
public sessionstate getsessionstate
return sessionstate
public string getusername
return username
public void setusername string username
this username   username
@override
public void canceloperation operationhandle ophandle  throws hivesqlexception
acquire
try
sessionmanager getoperationmanager   canceloperation ophandle
finally
release
@override
public void closeoperation operationhandle ophandle  throws hivesqlexception
acquire
try
operationmanager closeoperation ophandle
ophandleset remove ophandle
finally
release
@override
public tableschema getresultsetmetadata operationhandle ophandle  throws hivesqlexception
acquire
try
return sessionmanager getoperationmanager   getoperationresultsetschema ophandle
finally
release
@override
public rowset fetchresults operationhandle ophandle  fetchorientation orientation  long maxrows
throws hivesqlexception
acquire
try
return sessionmanager getoperationmanager
getoperationnextrowset ophandle  orientation  maxrows
finally
release
@override
public rowset fetchresults operationhandle ophandle  throws hivesqlexception
acquire
try
return sessionmanager getoperationmanager   getoperationnextrowset ophandle
finally
release
protected hivesession getsession
return this