/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing,
* software distributed under the license is distributed on an
* "as is" basis, without warranties or conditions of any
* kind, either express or implied.  see the license for the
* specific language governing permissions and limitations
* under the license.
*/
package org apache hive hcatalog cli
import java io bufferedreader
import java io filenotfoundexception
import java io filereader
import java io ioexception
import java io outputstream
import java io printstream
import java io printwriter
import java io unsupportedencodingexception
import java util arraylist
import java util properties
import org apache commons cli commandline
import org apache commons cli gnuparser
import org apache commons cli helpformatter
import org apache commons cli option
import org apache commons cli optionbuilder
import org apache commons cli options
import org apache commons cli parseexception
import org apache commons cli parser
import org apache commons lang stringutils
import org apache hadoop fs permission fspermission
import org apache hadoop hive cli clisessionstate
import org apache hadoop hive common logutils
import org apache hadoop hive common logutils loginitializationexception
import org apache hadoop hive conf hiveconf
import org apache hadoop hive conf hiveconf confvars
import org apache hadoop hive ql commandneedretryexception
import org apache hadoop hive ql processors dfsprocessor
import org apache hadoop hive ql processors setprocessor
import org apache hadoop hive ql session sessionstate
import org apache hive hcatalog cli semanticanalysis hcatsemanticanalyzer
import org apache hive hcatalog common hcatconstants
import org apache hive hcatalog common hcatutil
public class hcatcli
@suppresswarnings
public static void main string args
try
logutils inithivelog4j
catch  loginitializationexception e
clisessionstate ss   new clisessionstate new hiveconf sessionstate class
ss in   system in
try
ss out   new printstream system out  true
ss err   new printstream system err  true
catch  unsupportedencodingexception e
system exit 1
hiveconf conf   ss getconf
hiveconf setvar conf  confvars semantic_analyzer_hook  hcatsemanticanalyzer class getname
sessionstate start ss
options options   new options
// -e 'quoted-query-string'
options addoption optionbuilder
hasarg
withargname
withdescription
create
// -f <query-file>
options addoption optionbuilder
hasarg
withargname
withdescription
create
// -g
options addoption optionbuilder
hasarg
withargname
withdescription
create
// -p
options addoption optionbuilder
hasarg
withargname
withdescription
create
// -d
options addoption optionbuilder
hasargs 2
withargname
withvalueseparator
withdescription
create
// [-h|--help]
options addoption new option       false
parser parser   new gnuparser
commandline cmdline   null
try
cmdline   parser parse options  args
catch  parseexception e
printusage options  ss err
system exit 1
// -e
string execstring    string  cmdline getoptionvalue
// -f
string filename    string  cmdline getoptionvalue
// -h
if  cmdline hasoption
printusage options  ss out
system exit 0
if  execstring    null    filename    null
ss err println
printusage options  ss err
system exit 1
// -p
string perms    string  cmdline getoptionvalue
if  perms    null
validatepermissions ss  conf  perms
// -g
string grp    string  cmdline getoptionvalue
if  grp    null
conf set hcatconstants hcat_group  grp
// -d
setconfproperties conf  cmdline getoptionproperties
if  execstring    null
system exit processline execstring
try
if  filename    null
system exit processfile filename
catch  filenotfoundexception e
ss err println     e getmessage
system exit 1
catch  ioexception e
ss err println     e getmessage
system exit 1
// -h
printusage options  ss err
system exit 1
private static void setconfproperties hiveconf conf  properties props
for  java util map entry<object  object> e   props entryset
conf set  string  e getkey     string  e getvalue
private static int processline string line
int ret   0
string command
for  string onecmd   line split
if  stringutils endswith onecmd
command    stringutils chop onecmd
continue
else
command    onecmd
if  stringutils isblank command
continue
ret   processcmd command
command
return ret
private static int processfile string filename  throws ioexception
filereader filereader   null
bufferedreader reader   null
try
filereader   new filereader filename
reader   new bufferedreader filereader
string line
stringbuilder qsb   new stringbuilder
while   line   reader readline       null
qsb append line
return  processline qsb tostring
finally
if  filereader    null
filereader close
if  reader    null
reader close
private static int processcmd string cmd
sessionstate ss   sessionstate get
long start   system currenttimemillis
cmd   cmd trim
string firsttoken   cmd split    trim
if  firsttoken equalsignorecase
return new setprocessor   run cmd substring firsttoken length    trim    getresponsecode
else if  firsttoken equalsignorecase
return new dfsprocessor ss getconf    run cmd substring firsttoken length    trim    getresponsecode
hcatdriver driver   new hcatdriver
int ret   driver run cmd  getresponsecode
if  ret    0
driver close
system exit ret
arraylist<string> res   new arraylist<string>
try
while  driver getresults res
for  string r   res
ss out println r
res clear
catch  ioexception e
ss err println     e getclass   getname
e getmessage         org apache hadoop util stringutils stringifyexception e
ret   1
catch  commandneedretryexception e
ss err println     e getclass   getname
e getmessage         org apache hadoop util stringutils stringifyexception e
ret   1
int cret   driver close
if  ret    0
ret   cret
long end   system currenttimemillis
if  end > start
double timetaken    end   start    1000 0
ss err println     timetaken
return ret
private static void printusage options options  outputstream os
printwriter pw   new printwriter os
new helpformatter   printhelp pw  2   helpformatter default_width
<query>  <filepath>  <group>  <perms>  <name> <value>
null  options  helpformatter default_left_pad  helpformatter default_desc_pad
null  false
pw flush
private static void validatepermissions clisessionstate ss  hiveconf conf  string perms
perms   perms trim
fspermission fp   null
if  perms matches
fp   fspermission valueof     perms
else if  perms matches
fp   new fspermission short decode     perms
else
ss err println     perms
system exit 1
if   hcatutil validatemorepermissive fp getuseraction    fp getgroupaction
ss err println     perms
system exit 1
if   hcatutil validatemorepermissive fp getgroupaction    fp getotheraction
ss err println     perms
system exit 1
if    hcatutil validateexecutebitpresentifreadorwrite fp getuseraction
hcatutil validateexecutebitpresentifreadorwrite fp getgroupaction
hcatutil validateexecutebitpresentifreadorwrite fp getotheraction
ss err println     perms
system exit 1
conf set hcatconstants hcat_perms      fp tostring