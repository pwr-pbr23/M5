/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hive ql io orc
import org apache hadoop conf configuration
import org apache hadoop fs filesystem
import org apache hadoop fs path
import org apache hadoop hive ql exec filesinkoperator
import org apache hadoop hive ql io hiveoutputformat
import org apache hadoop hive ql io orc orcserde orcserderow
import org apache hadoop hive serde2 objectinspector objectinspector
import org apache hadoop hive serde2 objectinspector objectinspectorfactory
import org apache hadoop io nullwritable
import org apache hadoop io writable
import org apache hadoop mapred fileoutputformat
import org apache hadoop mapred jobconf
import org apache hadoop mapred recordwriter
import org apache hadoop mapred reporter
import org apache hadoop util progressable
import java io ioexception
import java util arraylist
import java util properties
/**
* a hive outputformat for orc files.
*/
public class orcoutputformat extends fileoutputformat<nullwritable  orcserderow>
implements hiveoutputformat<nullwritable  orcserderow>
private static class orcrecordwriter
implements recordwriter<nullwritable  orcserderow>
filesinkoperator recordwriter
private writer writer   null
private final path path
private final orcfile writeroptions options
orcrecordwriter path path  orcfile writeroptions options
this path   path
this options   options
@override
public void write nullwritable nullwritable
orcserderow row  throws ioexception
if  writer    null
options inspector row getinspector
writer   orcfile createwriter path  options
writer addrow row getrow
@override
public void write writable row  throws ioexception
orcserderow serderow    orcserderow  row
if  writer    null
options inspector serderow getinspector
writer   orcfile createwriter path  options
writer addrow serderow getrow
@override
public void close reporter reporter  throws ioexception
close true
@override
public void close boolean b  throws ioexception
// if we haven't written any rows, we need to create a file with a
// generic schema.
if  writer    null
// a row with no columns
objectinspector inspector   objectinspectorfactory
getstandardstructobjectinspector new arraylist<string>
new arraylist<objectinspector>
options inspector inspector
writer   orcfile createwriter path  options
writer close
@override
public recordwriter<nullwritable  orcserderow>
getrecordwriter filesystem filesystem  jobconf conf  string name
progressable reporter  throws ioexception
return new
orcrecordwriter new path name   orcfile writeroptions conf
@override
public filesinkoperator recordwriter
gethiverecordwriter jobconf conf
path path
class<? extends writable> valueclass
boolean iscompressed
properties tableproperties
progressable reporter  throws ioexception
orcfile writeroptions options   orcfile writeroptions conf
if  tableproperties containskey orcfile stripe_size
options stripesize long parselong
tableproperties getproperty orcfile stripe_size
if  tableproperties containskey orcfile compression
options compress compressionkind valueof
tableproperties getproperty orcfile compression
if  tableproperties containskey orcfile compression_block_size
options buffersize integer parseint
tableproperties getproperty
orcfile compression_block_size
if  tableproperties containskey orcfile row_index_stride
options rowindexstride integer parseint
tableproperties getproperty
orcfile row_index_stride
if  tableproperties containskey orcfile enable_indexes
if    equals tableproperties getproperty
orcfile enable_indexes
options rowindexstride 0
if  tableproperties containskey orcfile block_padding
options blockpadding boolean parseboolean
tableproperties getproperty
orcfile block_padding
return new orcrecordwriter path  options