/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hive jdbc
import java sql connection
import java sql databasemetadata
import java sql resultset
import java sql rowidlifetime
import java sql sqlexception
import java util arrays
import java util comparator
import java util jar attributes
import org apache hadoop hive metastore tabletype
import org apache hive service cli getinfotype
import org apache hive service cli thrift tcliservice
import org apache hive service cli thrift tgetcatalogsreq
import org apache hive service cli thrift tgetcatalogsresp
import org apache hive service cli thrift tgetcolumnsreq
import org apache hive service cli thrift tgetcolumnsresp
import org apache hive service cli thrift tgetfunctionsreq
import org apache hive service cli thrift tgetfunctionsresp
import org apache hive service cli thrift tgetinforeq
import org apache hive service cli thrift tgetinforesp
import org apache hive service cli thrift tgetschemasreq
import org apache hive service cli thrift tgetschemasresp
import org apache hive service cli thrift tgettabletypesreq
import org apache hive service cli thrift tgettabletypesresp
import org apache hive service cli thrift tgettablesreq
import org apache hive service cli thrift tgettablesresp
import org apache hive service cli thrift tgettypeinforeq
import org apache hive service cli thrift tgettypeinforesp
import org apache hive service cli thrift tsessionhandle
import org apache thrift texception
/**
* hivedatabasemetadata.
*
*/
public class hivedatabasemetadata implements databasemetadata
private final tcliservice iface client
private final tsessionhandle sesshandle
private static final string catalog_separator
private static final char search_string_escape
//  the maximum column length = mfieldschema.fname in metastore/src/model/package.jdo
private static final int maxcolumnnamelength   128
/**
*
*/
public hivedatabasemetadata tcliservice iface client  tsessionhandle sesshandle
this client   client
this sesshandle   sesshandle
public boolean allproceduresarecallable   throws sqlexception
throw new sqlexception
public boolean alltablesareselectable   throws sqlexception
return true
public boolean autocommitfailureclosesallresultsets   throws sqlexception
throw new sqlexception
public boolean datadefinitioncausestransactioncommit   throws sqlexception
throw new sqlexception
public boolean datadefinitionignoredintransactions   throws sqlexception
throw new sqlexception
public boolean deletesaredetected int type  throws sqlexception
throw new sqlexception
public boolean doesmaxrowsizeincludeblobs   throws sqlexception
throw new sqlexception
public resultset getattributes string catalog  string schemapattern
string typenamepattern  string attributenamepattern  throws sqlexception
throw new sqlexception
public resultset getbestrowidentifier string catalog  string schema
string table  int scope  boolean nullable  throws sqlexception
throw new sqlexception
public string getcatalogseparator   throws sqlexception
return catalog_separator
public string getcatalogterm   throws sqlexception
return
public resultset getcatalogs   throws sqlexception
tgetcatalogsresp catalogresp
try
catalogresp   client getcatalogs new tgetcatalogsreq sesshandle
catch  texception e
throw new sqlexception e getmessage       e
utils verifysuccess catalogresp getstatus
return new hivequeryresultset builder
setclient client
setsessionhandle sesshandle
setstmthandle catalogresp getoperationhandle
build
public resultset getclientinfoproperties   throws sqlexception
throw new sqlexception
public resultset getcolumnprivileges string catalog  string schema
string table  string columnnamepattern  throws sqlexception
throw new sqlexception
public resultset getpseudocolumns string catalog  string schemapattern
string tablenamepattern  string columnnamepattern  throws sqlexception
// jdk 1.7
throw new sqlexception
public boolean generatedkeyalwaysreturned   throws sqlexception
// jdk 1.7
throw new sqlexception
/**
* convert a pattern containing jdbc catalog search wildcards into
* java regex patterns.
*
* @param pattern input which may contain '%' or '_' wildcard characters, or
* these characters escaped using {@link #getsearchstringescape()}.
* @return replace %/_ with regex search characters, also handle escaped
* characters.
*/
private string convertpattern final string pattern
if  pattern  null
return
else
stringbuilder result   new stringbuilder pattern length
boolean escaped   false
for  int i   0  len   pattern length    i < len  i
char c   pattern charat i
if  escaped
if  c    search_string_escape
escaped   false
result append c
else
if  c    search_string_escape
escaped   true
continue
else if  c
result append
else if  c
result append
else
result append character tolowercase c
return result tostring
public resultset getcolumns string catalog  string schemapattern
string tablenamepattern  string columnnamepattern  throws sqlexception
tgetcolumnsresp colresp
tgetcolumnsreq colreq   new tgetcolumnsreq
colreq setsessionhandle sesshandle
colreq setcatalogname catalog
colreq setschemaname schemapattern
colreq settablename tablenamepattern
colreq setcolumnname columnnamepattern
try
colresp   client getcolumns colreq
catch  texception e
throw new sqlexception e getmessage       e
utils verifysuccess colresp getstatus
// build the resultset from response
return new hivequeryresultset builder
setclient client
setsessionhandle sesshandle
setstmthandle colresp getoperationhandle
build
/**
* we sort the output of getcolumns to guarantee jdbc compliance.
* first check by table name then by ordinal position
*/
private class getcolumnscomparator implements comparator<jdbccolumn>
public int compare jdbccolumn o1  jdbccolumn o2
int comparename   o1 gettablename   compareto o2 gettablename
if  comparename  0
if  o1 getordinalpos   > o2 getordinalpos
return 1
else if  o1 getordinalpos   < o2 getordinalpos
return  1
return 0
else
return comparename
public connection getconnection   throws sqlexception
throw new sqlexception
public resultset getcrossreference string primarycatalog
string primaryschema  string primarytable  string foreigncatalog
string foreignschema  string foreigntable  throws sqlexception
throw new sqlexception
public int getdatabasemajorversion   throws sqlexception
throw new sqlexception
public int getdatabaseminorversion   throws sqlexception
throw new sqlexception
public string getdatabaseproductname   throws sqlexception
return
public string getdatabaseproductversion   throws sqlexception
tgetinforeq req   new tgetinforeq sesshandle  getinfotype cli_dbms_ver totgetinfotype
tgetinforesp resp
try
resp   client getinfo req
catch  texception e
throw new sqlexception e getmessage       e
utils verifysuccess resp getstatus
return resp getinfovalue   getstringvalue
public int getdefaulttransactionisolation   throws sqlexception
return connection transaction_none
public int getdrivermajorversion
return hivedriver getmajordriverversion
public int getdriverminorversion
return hivedriver getminordriverversion
public string getdrivername   throws sqlexception
return hivedriver fetchmanifestattribute attributes name implementation_title
public string getdriverversion   throws sqlexception
return hivedriver fetchmanifestattribute attributes name implementation_version
public resultset getexportedkeys string catalog  string schema  string table
throws sqlexception
throw new sqlexception
public string getextranamecharacters   throws sqlexception
// todo: verify that this is correct
return
public resultset getfunctioncolumns string arg0  string arg1  string arg2
string arg3  throws sqlexception
throw new sqlexception
public resultset getfunctions string catalogname  string schemapattern  string functionnamepattern
throws sqlexception
tgetfunctionsresp funcresp
tgetfunctionsreq getfunctionsreq   new tgetfunctionsreq
getfunctionsreq setsessionhandle sesshandle
getfunctionsreq setcatalogname catalogname
getfunctionsreq setschemaname schemapattern
getfunctionsreq setfunctionname functionnamepattern
try
funcresp   client getfunctions getfunctionsreq
catch  texception e
throw new sqlexception e getmessage       e
utils verifysuccess funcresp getstatus
return new hivequeryresultset builder
setclient client
setsessionhandle sesshandle
setstmthandle funcresp getoperationhandle
build
public string getidentifierquotestring   throws sqlexception
throw new sqlexception
public resultset getimportedkeys string catalog  string schema  string table
throws sqlexception
return new hivequeryresultset builder
setclient client
setemptyresultset true
setschema
arrays aslist
arrays aslist
build
public resultset getindexinfo string catalog  string schema  string table
boolean unique  boolean approximate  throws sqlexception
throw new sqlexception
public int getjdbcmajorversion   throws sqlexception
return 3
public int getjdbcminorversion   throws sqlexception
return 0
public int getmaxbinaryliterallength   throws sqlexception
throw new sqlexception
public int getmaxcatalognamelength   throws sqlexception
throw new sqlexception
public int getmaxcharliterallength   throws sqlexception
throw new sqlexception
/**
*  returns the value of maxcolumnnamelength.
*
*/
public int getmaxcolumnnamelength   throws sqlexception
return maxcolumnnamelength
public int getmaxcolumnsingroupby   throws sqlexception
throw new sqlexception
public int getmaxcolumnsinindex   throws sqlexception
throw new sqlexception
public int getmaxcolumnsinorderby   throws sqlexception
throw new sqlexception
public int getmaxcolumnsinselect   throws sqlexception
throw new sqlexception
public int getmaxcolumnsintable   throws sqlexception
throw new sqlexception
public int getmaxconnections   throws sqlexception
throw new sqlexception
public int getmaxcursornamelength   throws sqlexception
throw new sqlexception
public int getmaxindexlength   throws sqlexception
throw new sqlexception
public int getmaxprocedurenamelength   throws sqlexception
throw new sqlexception
public int getmaxrowsize   throws sqlexception
throw new sqlexception
public int getmaxschemanamelength   throws sqlexception
throw new sqlexception
public int getmaxstatementlength   throws sqlexception
throw new sqlexception
public int getmaxstatements   throws sqlexception
throw new sqlexception
public int getmaxtablenamelength   throws sqlexception
throw new sqlexception
public int getmaxtablesinselect   throws sqlexception
throw new sqlexception
public int getmaxusernamelength   throws sqlexception
throw new sqlexception
public string getnumericfunctions   throws sqlexception
return
public resultset getprimarykeys string catalog  string schema  string table
throws sqlexception
// hive doesn't support primary keys
// using local schema with empty resultset
return new hivequeryresultset builder   setclient client  setemptyresultset true
setschema arrays aslist
arrays aslist
build
public resultset getprocedurecolumns string catalog  string schemapattern
string procedurenamepattern  string columnnamepattern
throws sqlexception
// hive doesn't support primary keys
// using local schema with empty resultset
return new hivequeryresultset builder   setclient client  setemptyresultset true
setschema
arrays aslist
arrays aslist
build
public string getprocedureterm   throws sqlexception
return new string
public resultset getprocedures string catalog  string schemapattern
string procedurenamepattern  throws sqlexception
// hive doesn't support primary keys
// using local schema with empty resultset
return new hivequeryresultset builder   setclient client  setemptyresultset true
setschema
arrays aslist
arrays aslist
build
public int getresultsetholdability   throws sqlexception
throw new sqlexception
public rowidlifetime getrowidlifetime   throws sqlexception
throw new sqlexception
public string getsqlkeywords   throws sqlexception
throw new sqlexception
public int getsqlstatetype   throws sqlexception
return databasemetadata sqlstatesql99
public string getschematerm   throws sqlexception
return
public resultset getschemas   throws sqlexception
return getschemas null  null
public resultset getschemas string catalog  string schemapattern
throws sqlexception
tgetschemasresp schemaresp
tgetschemasreq schemareq   new tgetschemasreq
schemareq setsessionhandle sesshandle
if  catalog    null
schemareq setcatalogname catalog
if  schemapattern    null
schemapattern
schemareq setschemaname schemapattern
try
schemaresp   client getschemas schemareq
catch  texception e
throw new sqlexception e getmessage       e
utils verifysuccess schemaresp getstatus
return new hivequeryresultset builder
setclient client
setsessionhandle sesshandle
setstmthandle schemaresp getoperationhandle
build
public string getsearchstringescape   throws sqlexception
return string valueof search_string_escape
public string getstringfunctions   throws sqlexception
return
public resultset getsupertables string catalog  string schemapattern
string tablenamepattern  throws sqlexception
throw new sqlexception
public resultset getsupertypes string catalog  string schemapattern
string typenamepattern  throws sqlexception
throw new sqlexception
public string getsystemfunctions   throws sqlexception
return
public resultset gettableprivileges string catalog  string schemapattern
string tablenamepattern  throws sqlexception
throw new sqlexception
public resultset gettabletypes   throws sqlexception
tgettabletypesresp tabletyperesp
try
tabletyperesp   client gettabletypes new tgettabletypesreq sesshandle
catch  texception e
throw new sqlexception e getmessage       e
utils verifysuccess tabletyperesp getstatus
return new hivequeryresultset builder
setclient client
setsessionhandle sesshandle
setstmthandle tabletyperesp getoperationhandle
build
public resultset gettables string catalog  string schemapattern
string tablenamepattern  string types  throws sqlexception
tgettablesresp gettableresp
if  schemapattern    null
// if schemapattern is null it means that the schemapattern value should not be used to narrow the search
schemapattern
tgettablesreq gettablereq   new tgettablesreq sesshandle
gettablereq settablename tablenamepattern
// todo: need to set catalog parameter
if  types    null
gettablereq settabletypes arrays aslist types
if  schemapattern    null
gettablereq setschemaname schemapattern
try
gettableresp   client gettables gettablereq
catch  texception e
throw new sqlexception e getmessage       e
utils verifysuccess gettableresp getstatus
return new hivequeryresultset builder
setclient client
setsessionhandle sesshandle
setstmthandle gettableresp getoperationhandle
build
/**
* we sort the output of gettables to guarantee jdbc compliance.
* first check by table type then by table name
*/
private class gettablescomparator implements comparator<jdbctable>
public int compare jdbctable o1  jdbctable o2
int comparetype   o1 gettype   compareto o2 gettype
if  comparetype  0
return o1 gettablename   compareto o2 gettablename
else
return comparetype
/**
* translate hive table types into jdbc table types.
* @param hivetabletype
* @return the type of the table
*/
public static string tojdbctabletype string hivetabletype
if  hivetabletype  null
return null
else if  hivetabletype equals tabletype managed_table tostring
return
else if  hivetabletype equals tabletype virtual_view tostring
return
else if  hivetabletype equals tabletype external_table tostring
return
else
return hivetabletype
public string gettimedatefunctions   throws sqlexception
return
public resultset gettypeinfo   throws sqlexception
tgettypeinforesp gettypeinforesp
tgettypeinforeq gettypeinforeq   new tgettypeinforeq
gettypeinforeq setsessionhandle sesshandle
try
gettypeinforesp   client gettypeinfo gettypeinforeq
catch  texception e
throw new sqlexception e getmessage       e
utils verifysuccess gettypeinforesp getstatus
return new hivequeryresultset builder
setclient client
setsessionhandle sesshandle
setstmthandle gettypeinforesp getoperationhandle
build
public resultset getudts string catalog  string schemapattern
string typenamepattern  int types  throws sqlexception
return new hivemetadataresultset
arrays aslist
arrays aslist

public boolean next   throws sqlexception
return false
public <t> t getobject string columnlabel  class<t> type  throws sqlexception
// jdk 1.7
throw new sqlexception
public <t> t getobject int columnindex  class<t> type  throws sqlexception
// jdk 1.7
throw new sqlexception
public string geturl   throws sqlexception
throw new sqlexception
public string getusername   throws sqlexception
throw new sqlexception
public resultset getversioncolumns string catalog  string schema  string table
throws sqlexception
throw new sqlexception
public boolean insertsaredetected int type  throws sqlexception
throw new sqlexception
public boolean iscatalogatstart   throws sqlexception
throw new sqlexception
public boolean isreadonly   throws sqlexception
throw new sqlexception
public boolean locatorsupdatecopy   throws sqlexception
throw new sqlexception
public boolean nullplusnonnullisnull   throws sqlexception
throw new sqlexception
public boolean nullsaresortedatend   throws sqlexception
throw new sqlexception
public boolean nullsaresortedatstart   throws sqlexception
throw new sqlexception
public boolean nullsaresortedhigh   throws sqlexception
throw new sqlexception
public boolean nullsaresortedlow   throws sqlexception
throw new sqlexception
public boolean othersdeletesarevisible int type  throws sqlexception
throw new sqlexception
public boolean othersinsertsarevisible int type  throws sqlexception
throw new sqlexception
public boolean othersupdatesarevisible int type  throws sqlexception
throw new sqlexception
public boolean owndeletesarevisible int type  throws sqlexception
throw new sqlexception
public boolean owninsertsarevisible int type  throws sqlexception
throw new sqlexception
public boolean ownupdatesarevisible int type  throws sqlexception
throw new sqlexception
public boolean storeslowercaseidentifiers   throws sqlexception
throw new sqlexception
public boolean storeslowercasequotedidentifiers   throws sqlexception
throw new sqlexception
public boolean storesmixedcaseidentifiers   throws sqlexception
throw new sqlexception
public boolean storesmixedcasequotedidentifiers   throws sqlexception
throw new sqlexception
public boolean storesuppercaseidentifiers   throws sqlexception
throw new sqlexception
public boolean storesuppercasequotedidentifiers   throws sqlexception
throw new sqlexception
public boolean supportsansi92entrylevelsql   throws sqlexception
throw new sqlexception
public boolean supportsansi92fullsql   throws sqlexception
throw new sqlexception
public boolean supportsansi92intermediatesql   throws sqlexception
throw new sqlexception
public boolean supportsaltertablewithaddcolumn   throws sqlexception
return true
public boolean supportsaltertablewithdropcolumn   throws sqlexception
return false
public boolean supportsbatchupdates   throws sqlexception
return false
public boolean supportscatalogsindatamanipulation   throws sqlexception
return false
public boolean supportscatalogsinindexdefinitions   throws sqlexception
return false
public boolean supportscatalogsinprivilegedefinitions   throws sqlexception
return false
public boolean supportscatalogsinprocedurecalls   throws sqlexception
return false
public boolean supportscatalogsintabledefinitions   throws sqlexception
return false
public boolean supportscolumnaliasing   throws sqlexception
return true
public boolean supportsconvert   throws sqlexception
throw new sqlexception
public boolean supportsconvert int fromtype  int totype  throws sqlexception
throw new sqlexception
public boolean supportscoresqlgrammar   throws sqlexception
throw new sqlexception
public boolean supportscorrelatedsubqueries   throws sqlexception
throw new sqlexception
public boolean supportsdatadefinitionanddatamanipulationtransactions
throws sqlexception
throw new sqlexception
public boolean supportsdatamanipulationtransactionsonly   throws sqlexception
throw new sqlexception
public boolean supportsdifferenttablecorrelationnames   throws sqlexception
throw new sqlexception
public boolean supportsexpressionsinorderby   throws sqlexception
throw new sqlexception
public boolean supportsextendedsqlgrammar   throws sqlexception
throw new sqlexception
public boolean supportsfullouterjoins   throws sqlexception
throw new sqlexception
public boolean supportsgetgeneratedkeys   throws sqlexception
throw new sqlexception
public boolean supportsgroupby   throws sqlexception
return true
public boolean supportsgroupbybeyondselect   throws sqlexception
throw new sqlexception
public boolean supportsgroupbyunrelated   throws sqlexception
throw new sqlexception
public boolean supportsintegrityenhancementfacility   throws sqlexception
throw new sqlexception
public boolean supportslikeescapeclause   throws sqlexception
throw new sqlexception
public boolean supportslimitedouterjoins   throws sqlexception
throw new sqlexception
public boolean supportsminimumsqlgrammar   throws sqlexception
throw new sqlexception
public boolean supportsmixedcaseidentifiers   throws sqlexception
throw new sqlexception
public boolean supportsmixedcasequotedidentifiers   throws sqlexception
throw new sqlexception
public boolean supportsmultipleopenresults   throws sqlexception
throw new sqlexception
public boolean supportsmultipleresultsets   throws sqlexception
return false
public boolean supportsmultipletransactions   throws sqlexception
throw new sqlexception
public boolean supportsnamedparameters   throws sqlexception
throw new sqlexception
public boolean supportsnonnullablecolumns   throws sqlexception
return false
public boolean supportsopencursorsacrosscommit   throws sqlexception
throw new sqlexception
public boolean supportsopencursorsacrossrollback   throws sqlexception
throw new sqlexception
public boolean supportsopenstatementsacrosscommit   throws sqlexception
throw new sqlexception
public boolean supportsopenstatementsacrossrollback   throws sqlexception
throw new sqlexception
public boolean supportsorderbyunrelated   throws sqlexception
throw new sqlexception
public boolean supportsouterjoins   throws sqlexception
return true
public boolean supportspositioneddelete   throws sqlexception
return false
public boolean supportspositionedupdate   throws sqlexception
return false
public boolean supportsresultsetconcurrency int type  int concurrency
throws sqlexception
throw new sqlexception
public boolean supportsresultsetholdability int holdability
throws sqlexception
return false
public boolean supportsresultsettype int type  throws sqlexception
return true
public boolean supportssavepoints   throws sqlexception
return false
public boolean supportsschemasindatamanipulation   throws sqlexception
return false
public boolean supportsschemasinindexdefinitions   throws sqlexception
return false
public boolean supportsschemasinprivilegedefinitions   throws sqlexception
return false
public boolean supportsschemasinprocedurecalls   throws sqlexception
return false
public boolean supportsschemasintabledefinitions   throws sqlexception
return false
public boolean supportsselectforupdate   throws sqlexception
return false
public boolean supportsstatementpooling   throws sqlexception
throw new sqlexception
public boolean supportsstoredfunctionsusingcallsyntax   throws sqlexception
throw new sqlexception
public boolean supportsstoredprocedures   throws sqlexception
return false
public boolean supportssubqueriesincomparisons   throws sqlexception
throw new sqlexception
public boolean supportssubqueriesinexists   throws sqlexception
throw new sqlexception
public boolean supportssubqueriesinins   throws sqlexception
throw new sqlexception
public boolean supportssubqueriesinquantifieds   throws sqlexception
throw new sqlexception
public boolean supportstablecorrelationnames   throws sqlexception
throw new sqlexception
public boolean supportstransactionisolationlevel int level
throws sqlexception
throw new sqlexception
public boolean supportstransactions   throws sqlexception
return false
public boolean supportsunion   throws sqlexception
throw new sqlexception
public boolean supportsunionall   throws sqlexception
throw new sqlexception
public boolean updatesaredetected int type  throws sqlexception
throw new sqlexception
public boolean useslocalfilepertable   throws sqlexception
throw new sqlexception
public boolean useslocalfiles   throws sqlexception
throw new sqlexception
public boolean iswrapperfor class<?> iface  throws sqlexception
throw new sqlexception
public <t> t unwrap class<t> iface  throws sqlexception
throw new sqlexception
public static void main string args  throws sqlexception
hivedatabasemetadata meta   new hivedatabasemetadata null  null
system out println     meta getdrivername
system out println     meta getdriverversion