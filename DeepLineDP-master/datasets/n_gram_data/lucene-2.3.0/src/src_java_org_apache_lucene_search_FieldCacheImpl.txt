package org apache lucene search
/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
import org apache lucene index indexreader
import org apache lucene index term
import org apache lucene index termdocs
import org apache lucene index termenum
import java io ioexception
import java util hashmap
import java util locale
import java util map
import java util weakhashmap
/**
* expert: the default cache implementation, storing all values in memory.
* a weakhashmap is used for storage.
*
* <p>created: may 19, 2004 4:40:36 pm
*
* @author  tim jones (nacimiento software)
* @since   lucene 1.4
* @version $id$
*/
class fieldcacheimpl
implements fieldcache
/** expert: internal cache. */
abstract static class cache
private final map readercache   new weakhashmap
protected abstract object createvalue indexreader reader  object key
throws ioexception
public object get indexreader reader  object key  throws ioexception
map innercache
object value
synchronized  readercache
innercache    map  readercache get reader
if  innercache    null
innercache   new hashmap
readercache put reader  innercache
value   null
else
value   innercache get key
if  value    null
value   new creationplaceholder
innercache put key  value
if  value instanceof creationplaceholder
synchronized  value
creationplaceholder progress    creationplaceholder  value
if  progress value    null
progress value   createvalue reader  key
synchronized  readercache
innercache put key  progress value
return progress value
return value
static final class creationplaceholder
object value
/** expert: every composite-key in the internal cache is of this type. */
static class entry
final string field            which fieldable
final int type                which sortfield type
final object custom           which custom comparator
final locale locale           the locale we're sorting  if string
/** creates one of these objects. */
entry  string field  int type  locale locale
this field   field intern
this type   type
this custom   null
this locale   locale
/** creates one of these objects for a custom comparator. */
entry  string field  object custom
this field   field intern
this type   sortfield custom
this custom   custom
this locale   null
/** two of these are equal iff they reference the same field and type. */
public boolean equals  object o
if  o instanceof entry
entry other    entry  o
if  other field    field    other type    type
if  other locale    null ? locale    null   other locale equals locale
if  other custom    null
if  custom    null  return true
else if  other custom equals  custom
return true
return false
/** composes a hashcode based on the field and type. */
public int hashcode
return field hashcode   ^ type ^  custom  null ? 0   custom hashcode    ^  locale  null ? 0   locale hashcode
private static final byteparser byte_parser   new byteparser
public byte parsebyte string value
return byte parsebyte value
private static final shortparser short_parser   new shortparser
public short parseshort string value
return short parseshort value
private static final intparser int_parser   new intparser
public int parseint string value
return integer parseint value
private static final floatparser float_parser   new floatparser
public float parsefloat string value
return float parsefloat value
// inherit javadocs
public byte getbytes  indexreader reader  string field  throws ioexception
return getbytes reader  field  byte_parser
// inherit javadocs
public byte getbytes indexreader reader  string field  byteparser parser
throws ioexception
return  byte  bytescache get reader  new entry field  parser
cache bytescache   new cache
protected object createvalue indexreader reader  object entrykey
throws ioexception
entry entry    entry  entrykey
string field   entry field
byteparser parser    byteparser  entry custom
final byte retarray   new byte
termdocs termdocs   reader termdocs
termenum termenum   reader terms  new term  field
try
do
term term   termenum term
if  term  null    term field      field  break
byte termval   parser parsebyte term text
termdocs seek  termenum
while  termdocs next
retarray   termval
while  termenum next
finally
termdocs close
termenum close
return retarray
// inherit javadocs
public short getshorts  indexreader reader  string field  throws ioexception
return getshorts reader  field  short_parser
// inherit javadocs
public short getshorts indexreader reader  string field  shortparser parser
throws ioexception
return  short  shortscache get reader  new entry field  parser
cache shortscache   new cache
protected object createvalue indexreader reader  object entrykey
throws ioexception
entry entry    entry  entrykey
string field   entry field
shortparser parser    shortparser  entry custom
final short retarray   new short
termdocs termdocs   reader termdocs
termenum termenum   reader terms  new term  field
try
do
term term   termenum term
if  term  null    term field      field  break
short termval   parser parseshort term text
termdocs seek  termenum
while  termdocs next
retarray   termval
while  termenum next
finally
termdocs close
termenum close
return retarray
// inherit javadocs
public int getints  indexreader reader  string field  throws ioexception
return getints reader  field  int_parser
// inherit javadocs
public int getints indexreader reader  string field  intparser parser
throws ioexception
return  int  intscache get reader  new entry field  parser
cache intscache   new cache
protected object createvalue indexreader reader  object entrykey
throws ioexception
entry entry    entry  entrykey
string field   entry field
intparser parser    intparser  entry custom
final int retarray   new int
termdocs termdocs   reader termdocs
termenum termenum   reader terms  new term  field
try
do
term term   termenum term
if  term  null    term field      field  break
int termval   parser parseint term text
termdocs seek  termenum
while  termdocs next
retarray   termval
while  termenum next
finally
termdocs close
termenum close
return retarray
// inherit javadocs
public float getfloats  indexreader reader  string field
throws ioexception
return getfloats reader  field  float_parser
// inherit javadocs
public float getfloats indexreader reader  string field  floatparser parser
throws ioexception
return  float  floatscache get reader  new entry field  parser
cache floatscache   new cache
protected object createvalue indexreader reader  object entrykey
throws ioexception
entry entry    entry  entrykey
string field   entry field
floatparser parser    floatparser  entry custom
final float retarray   new float
termdocs termdocs   reader termdocs
termenum termenum   reader terms  new term  field
try
do
term term   termenum term
if  term  null    term field      field  break
float termval   parser parsefloat term text
termdocs seek  termenum
while  termdocs next
retarray   termval
while  termenum next
finally
termdocs close
termenum close
return retarray
// inherit javadocs
public string getstrings indexreader reader  string field
throws ioexception
return  string  stringscache get reader  field
cache stringscache   new cache
protected object createvalue indexreader reader  object fieldkey
throws ioexception
string field     string  fieldkey  intern
final string retarray   new string
termdocs termdocs   reader termdocs
termenum termenum   reader terms  new term  field
try
do
term term   termenum term
if  term  null    term field      field  break
string termval   term text
termdocs seek  termenum
while  termdocs next
retarray   termval
while  termenum next
finally
termdocs close
termenum close
return retarray
// inherit javadocs
public stringindex getstringindex indexreader reader  string field
throws ioexception
return  stringindex  stringsindexcache get reader  field
cache stringsindexcache   new cache
protected object createvalue indexreader reader  object fieldkey
throws ioexception
string field     string  fieldkey  intern
final int retarray   new int
string mterms   new string
termdocs termdocs   reader termdocs
termenum termenum   reader terms  new term  field
int t   0      current term number
// an entry for documents that have no terms in this field
// should a document with no terms be at top or bottom?
// this puts them at the top - if it is changed, fielddocsortedhitqueue
// needs to change as well.
mterms   null
try
do
term term   termenum term
if  term  null    term field      field  break
// store term text
// we expect that there is at most one term per document
if  t >  mterms length  throw new runtimeexception
mterms   term text
termdocs seek  termenum
while  termdocs next
retarray   t
t
while  termenum next
finally
termdocs close
termenum close
if  t    0
// if there are no terms, make the term array
// have a single null entry
mterms   new string
else if  t < mterms length
// if there are less terms than documents,
// trim off the dead array space
string terms   new string
system arraycopy  mterms  0  terms  0  t
mterms   terms
stringindex value   new stringindex  retarray  mterms
return value
/** the pattern used to detect integer values in a field */
/** removed for java 1.3 compatibility
protected static final pattern pintegers = pattern.compile ("[0-9\\-]+");
**/
/** the pattern used to detect float values in a field */
/**
* removed for java 1.3 compatibility
* protected static final object pfloats = pattern.compile ("[0-9+\\-\\.eeffdd]+");
*/
// inherit javadocs
public object getauto indexreader reader  string field  throws ioexception
return autocache get reader  field
cache autocache   new cache
protected object createvalue indexreader reader  object fieldkey
throws ioexception
string field     string fieldkey  intern
termenum enumerator   reader terms  new term  field
try
term term   enumerator term
if  term    null
throw new runtimeexception      field
object ret   null
if  term field      field
string termtext   term text   trim
/**
* java 1.4 level code:
if (pintegers.matcher(termtext).matches())
return integersortedhitqueue.comparator (reader, enumerator, field);
else if (pfloats.matcher(termtext).matches())
return floatsortedhitqueue.comparator (reader, enumerator, field);
*/
// java 1.3 level code:
try
integer parseint  termtext
ret   getints  reader  field
catch  numberformatexception nfe1
try
float parsefloat  termtext
ret   getfloats  reader  field
catch  numberformatexception nfe3
ret   getstringindex  reader  field
else
throw new runtimeexception
return ret
finally
enumerator close
// inherit javadocs
public comparable getcustom indexreader reader  string field
sortcomparator comparator  throws ioexception
return  comparable  customcache get reader  new entry field  comparator
cache customcache   new cache
protected object createvalue indexreader reader  object entrykey
throws ioexception
entry entry    entry  entrykey
string field   entry field
sortcomparator comparator    sortcomparator  entry custom
final comparable retarray   new comparable
termdocs termdocs   reader termdocs
termenum termenum   reader terms  new term  field
try
do
term term   termenum term
if  term  null    term field      field  break
comparable termval   comparator getcomparable  term text
termdocs seek  termenum
while  termdocs next
retarray   termval
while  termenum next
finally
termdocs close
termenum close
return retarray