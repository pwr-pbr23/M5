package org apache lucene store je
/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
import java io bytearrayinputstream
import java io datainputstream
import java io ioexception
import java util arraylist
import java util collections
import java util hashset
import java util iterator
import java util list
import java util set
import org apache lucene store directory
import org apache lucene store indexinput
import org apache lucene store indexoutput
import org apache lucene store lock
import com sleepycat je cursor
import com sleepycat je database
import com sleepycat je databaseentry
import com sleepycat je databaseexception
import com sleepycat je operationstatus
import com sleepycat je transaction
/**
* port of andi vajda's dbdirectory to to java edition of berkeley database
*
* a jedirectory is a berkeley db je based implementation of
* {@link org.apache.lucene.store.directory directory}. it uses two
* {@link com.sleepycat.je.database db} database handles, one for storing file
* records and another for storing file data blocks.
*
* @author aaron donovan
*/
public class jedirectory extends directory
protected set openfiles   collections synchronizedset new hashset
protected database files  blocks
protected transaction txn
protected int flags
/**
* instantiate a dbdirectory. the same threading rules that apply to
* berkeley db handles apply to instances of dbdirectory.
*
* @param txn
*            a transaction handle that is going to be used for all db
*            operations done by this instance. this parameter may be
*            <code>null</code>.
* @param files
*            a db handle to store file records.
* @param blocks
*            a db handle to store file data blocks.
* @param flags
*            flags used for db read operations.
*/
public jedirectory transaction txn  database files  database blocks
int flags
super
this txn   txn
this files   files
this blocks   blocks
this flags   flags
public jedirectory transaction txn  database files  database blocks
this txn  files  blocks  0
public void close   throws ioexception
flush
/**
* flush the currently open files. after they have been flushed it is safe
* to commit the transaction without closing this dbdirectory instance
* first.
*
* @see #settransaction
*/
public void flush   throws ioexception
iterator iterator   openfiles iterator
while  iterator hasnext
system out
println   jeindexoutput  iterator next    file getname
// ((indexoutput) iterator.next()).flush();
public indexoutput createoutput string name  throws ioexception
return new jeindexoutput this  name  true
public void deletefile string name  throws ioexception
new file name  delete this
public boolean fileexists string name  throws ioexception
return new file name  exists this
public long filelength string name  throws ioexception
file file   new file name
if  file exists this
return file getlength
throw new ioexception     name
public long filemodified string name  throws ioexception
file file   new file name
if  file exists this
return file gettimemodified
throw new ioexception     name
public string list   throws ioexception
cursor cursor   null
list list   new arraylist
try
try
databaseentry key   new databaseentry new byte
databaseentry data   new databaseentry null
data setpartial true
// todo see if cursor needs configuration
cursor   files opencursor txn  null
// todo see if lockmode should be set
if  cursor getnext key  data  null     operationstatus notfound
bytearrayinputstream buffer   new bytearrayinputstream key
getdata
datainputstream in   new datainputstream buffer
string name   in readutf
in close
list add name
while  cursor getnext key  data  null     operationstatus notfound
buffer   new bytearrayinputstream key getdata
in   new datainputstream buffer
name   in readutf
in close
list add name
finally
if  cursor    null
cursor close
catch  databaseexception e
throw new ioexception e getmessage
return  string  list toarray new string
public indexinput openinput string name  throws ioexception
return new jeindexinput this  name
public lock makelock string name
return new jelock
public void renamefile string from  string to  throws ioexception
new file from  rename this  to
public void touchfile string name  throws ioexception
file file   new file name
long length   0l
if  file exists this
length   file getlength
file modify this  length  system currenttimemillis
/**
* once a transaction handle was committed it is no longer valid. in order
* to continue using this jedirectory instance after a commit, the
* transaction handle has to be replaced.
*
* @param txn
*            the new transaction handle to use
*/
public void settransaction transaction txn
this txn   txn