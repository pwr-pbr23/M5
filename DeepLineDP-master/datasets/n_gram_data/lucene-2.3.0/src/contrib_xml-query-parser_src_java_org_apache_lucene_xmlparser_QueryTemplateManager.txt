package org apache lucene xmlparser
import java io bytearrayoutputstream
import java io ioexception
import java io inputstream
import java util enumeration
import java util hashmap
import java util properties
import javax xml parsers documentbuilder
import javax xml parsers documentbuilderfactory
import javax xml parsers parserconfigurationexception
import javax xml transform result
import javax xml transform source
import javax xml transform templates
import javax xml transform transformer
import javax xml transform transformerconfigurationexception
import javax xml transform transformerexception
import javax xml transform transformerfactory
import javax xml transform dom domresult
import javax xml transform dom domsource
import javax xml transform stream streamresult
import org w3c dom document
import org w3c dom element
import org xml sax saxexception
/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
/**
* provides utilities for turning query form input (such as from a web page or swing gui) into
* lucene xml queries by using xsl templates.  this approach offers a convenient way of externalizing
* and changing how user input is turned into lucene queries.
* database applications often adopt similar practices by externalizing sql in template files that can
* be easily changed/optimized by a dba.
* the static methods can be used on their own or by creating an instance of this class you can store and
* re-use compiled stylesheets for fast use (e.g. in a server environment)
* @author mark harwood
*/
public class querytemplatemanager
static documentbuilderfactory dbf   documentbuilderfactory newinstance
static transformerfactory tfactory   transformerfactory newinstance
hashmap compiledtemplatescache new hashmap
templates defaultcompiledtemplates null
public querytemplatemanager
public querytemplatemanager inputstream xslis  throws transformerconfigurationexception  parserconfigurationexception  saxexception  ioexception
adddefaultquerytemplate xslis
public void adddefaultquerytemplate inputstream xslis  throws transformerconfigurationexception  parserconfigurationexception  saxexception  ioexception
defaultcompiledtemplates gettemplates xslis
public void addquerytemplate string name  inputstream xslis  throws transformerconfigurationexception  parserconfigurationexception  saxexception  ioexception
compiledtemplatescache put name gettemplates xslis
public string getqueryasxmlstring properties formproperties string querytemplatename  throws saxexception  ioexception  parserconfigurationexception  transformerexception
templates ts  templates  compiledtemplatescache get querytemplatename
return getqueryasxmlstring formproperties  ts
public document getqueryasdom properties formproperties string querytemplatename  throws saxexception  ioexception  parserconfigurationexception  transformerexception
templates ts  templates  compiledtemplatescache get querytemplatename
return getqueryasdom formproperties  ts
public string getqueryasxmlstring properties formproperties  throws saxexception  ioexception  parserconfigurationexception  transformerexception
return getqueryasxmlstring formproperties  defaultcompiledtemplates
public document getqueryasdom properties formproperties  throws saxexception  ioexception  parserconfigurationexception  transformerexception
return getqueryasdom formproperties  defaultcompiledtemplates
/**
* fast means of constructing query using a precompiled stylesheet
*/
public static string getqueryasxmlstring properties formproperties  templates template  throws saxexception  ioexception  parserconfigurationexception  transformerexception
bytearrayoutputstream baos new bytearrayoutputstream
streamresult result new streamresult baos
transformcriteria formproperties template result
return baos tostring
/**
* slow means of constructing query parsing a stylesheet from an input stream
*/
public static string getqueryasxmlstring properties formproperties  inputstream xslis  throws saxexception  ioexception  parserconfigurationexception  transformerexception
bytearrayoutputstream baos new bytearrayoutputstream
streamresult result new streamresult baos
transformcriteria formproperties xslis result
return baos tostring
/**
* fast means of constructing query using a cached,precompiled stylesheet
*/
public static document getqueryasdom properties formproperties  templates template  throws saxexception  ioexception  parserconfigurationexception  transformerexception
domresult result new domresult
transformcriteria formproperties template result
return  document result getnode
/**
* slow means of constructing query - parses stylesheet from input stream
*/
public static document getqueryasdom properties formproperties  inputstream xslis  throws saxexception  ioexception  parserconfigurationexception  transformerexception
domresult result new domresult
transformcriteria formproperties xslis result
return  document result getnode
/**
* slower transformation using an uncompiled stylesheet (suitable for development environment)
*/
public static void transformcriteria properties formproperties  inputstream xslis  result result  throws saxexception  ioexception  parserconfigurationexception  transformerexception
dbf setnamespaceaware true
documentbuilder builder   dbf newdocumentbuilder
org w3c dom document xsldoc   builder parse xslis
domsource ds   new domsource xsldoc
transformer transformer  null
synchronized  tfactory
transformer   tfactory newtransformer ds
transformcriteria formproperties transformer result
/**
* fast transformation using a pre-compiled stylesheet (suitable for production environments)
*/
public static void transformcriteria properties formproperties  templates template  result result  throws saxexception  ioexception  parserconfigurationexception  transformerexception
transformcriteria formproperties template newtransformer   result
public static void transformcriteria properties formproperties  transformer transformer  result result  throws saxexception  ioexception  parserconfigurationexception  transformerexception
dbf setnamespaceaware true
//create an xml document representing the search index document.
documentbuilder db   dbf newdocumentbuilder
org w3c dom document doc   db newdocument
element root   doc createelement
doc appendchild  root
enumeration keysenum   formproperties keys
while keysenum hasmoreelements
string propname  string  keysenum nextelement
string value formproperties getproperty propname
if  value  null    value length  >0
domutils insertchild root propname value
//use xslt to to transform into an xml query string using the  querytemplate
domsource xml new domsource doc
transformer transform xml result
/**
* parses a query stylesheet for repeated use
*/
public static templates gettemplates inputstream xslis  throws parserconfigurationexception  saxexception  ioexception  transformerconfigurationexception
dbf setnamespaceaware true
documentbuilder builder   dbf newdocumentbuilder
org w3c dom document xsldoc   builder parse xslis
domsource ds   new domsource xsldoc
return tfactory newtemplates ds