package org apache lucene index
/**
* copyright 2006 the apache software foundation
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
import java io ioexception
import java util date
import org apache lucene search similarity
import org apache lucene store directory
import org apache lucene store fsdirectory
/**
* given a directory and a list of fields, updates the fieldnorms in place for every document.
*
* if similarity class is specified, uses its lengthnorm method to set norms.
* if -n command line argument is used, removed field norms, as if
* {@link org.apache.lucene.document.field.index}.no_norms was used.
*
* <p>
* note: this will overwrite any length normalization or field/document boosts.
* </p>
*
* @author chris hostetter
* @author otis gospodnetic
*/
public class fieldnormmodifier
/**
* command line execution method.
*
* <pre>
* usage: fieldnormmodifier /path/index <package.similarityclassname | -n> field1 field2 ...
* </pre>
*/
public static void main string args  throws ioexception
if  args length < 3
system err println
system exit 1
similarity s   null
if   args equals
try
class simclass   class forname args
s    similarity simclass newinstance
catch  exception e
system err println     args
e printstacktrace system err
system exit 1
directory d   fsdirectory getdirectory args  false
fieldnormmodifier fnm   new fieldnormmodifier d  s
for  int i   2  i < args length  i
system out print     args        new date    tostring
fnm resetnorms args
system out println new date   tostring
d close
private directory dir
private similarity sim
/**
* constructor for code that wishes to use this class programatically
* if similarity is null, kill the field norms.
*
* @param d the directory to modify
* @param s the similiary to use (can be null)
*/
public fieldnormmodifier directory d  similarity s
dir   d
sim   s
/**
* resets the norms for the specified field.
*
* <p>
* opens a new indexreader on the directory given to this instance,
* modifies the norms (either using the similarity given to this instance, or by using fake norms,
* and closes the indexreader.
* </p>
*
* @param field the field whose norms should be reset
*/
public void resetnorms string field  throws ioexception
string fieldname   field intern
int termcounts   new int
byte fakenorms   new byte
indexreader reader   null
termenum termenum   null
termdocs termdocs   null
try
reader   indexreader open dir
termcounts   new int
// if we are killing norms, get fake ones
if  sim    null
fakenorms   segmentreader createfakenorms reader maxdoc
try
termenum   reader terms new term field
try
termdocs   reader termdocs
do
term term   termenum term
if  term    null    term field   equals fieldname
termdocs seek termenum term
while  termdocs next
termcounts    termdocs freq
while  termenum next
finally
if  null    termdocs  termdocs close
finally
if  null    termenum  termenum close
finally
if  null    reader  reader close
try
reader   indexreader open dir
for  int d   0  d < termcounts length  d
if    reader isdeleted d
if  sim    null
reader setnorm d  fieldname  fakenorms
else
reader setnorm d  fieldname  sim encodenorm sim lengthnorm fieldname  termcounts
finally
if  null    reader  reader close