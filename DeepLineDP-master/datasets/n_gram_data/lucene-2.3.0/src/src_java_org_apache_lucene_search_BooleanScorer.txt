package org apache lucene search
/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
import java io ioexception
final class booleanscorer extends scorer
private subscorer scorers   null
private buckettable buckettable   new buckettable
private int maxcoord   1
private float coordfactors   null
private int requiredmask   0
private int prohibitedmask   0
private int nextmask   1
private final int minnrshouldmatch
booleanscorer similarity similarity
this similarity  1
booleanscorer similarity similarity  int minnrshouldmatch
super similarity
this minnrshouldmatch   minnrshouldmatch
static final class subscorer
public scorer scorer
public boolean done
public boolean required   false
public boolean prohibited   false
public hitcollector collector
public subscorer next
public subscorer scorer scorer  boolean required  boolean prohibited
hitcollector collector  subscorer next
throws ioexception
this scorer   scorer
this done    scorer next
this required   required
this prohibited   prohibited
this collector   collector
this next   next
final void add scorer scorer  boolean required  boolean prohibited
throws ioexception
int mask   0
if  required    prohibited
if  nextmask    0
throw new indexoutofboundsexception
mask   nextmask
nextmask   nextmask << 1
else
mask   0
if   prohibited
maxcoord
if  prohibited
prohibitedmask    mask                         update prohibited mask
else if  required
requiredmask    mask                           update required mask
scorers   new subscorer scorer  required  prohibited
buckettable newcollector mask   scorers
private final void computecoordfactors
coordfactors   new float
for  int i   0  i < maxcoord  i
coordfactors   getsimilarity   coord i  maxcoord 1
private int end
private bucket current
public void score hitcollector hc  throws ioexception
next
score hc  integer max_value
protected boolean score hitcollector hc  int max  throws ioexception
if  coordfactors    null
computecoordfactors
boolean more
bucket tmp
do
buckettable first   null
while  current    null               more queued
// check prohibited & required
if   current bits   prohibitedmask     0
current bits   requiredmask     requiredmask
if  current doc >  max
tmp   current
current   current next
tmp next   buckettable first
buckettable first   tmp
continue
if  current coord >  minnrshouldmatch
hc collect current doc  current score   coordfactors
current   current next             pop the queue
if  buckettable first    null
current   buckettable first
buckettable first   current next
return true
// refill the queue
more   false
end    buckettable size
for  subscorer sub   scorers  sub    null  sub   sub next
if   sub done
sub done    sub scorer score sub collector  end
if   sub done
more   true
current   buckettable first
while  current    null    more
return false
public int doc     return current doc
public boolean next   throws ioexception
boolean more
do
while  buckettable first    null               more queued
current   buckettable first
buckettable first   current next             pop the queue
// check prohibited & required, and minnrshouldmatch
if   current bits   prohibitedmask     0
current bits   requiredmask     requiredmask
current coord >  minnrshouldmatch
return true
// refill the queue
more   false
end    buckettable size
for  subscorer sub   scorers  sub    null  sub   sub next
scorer scorer   sub scorer
while   sub done    scorer doc   < end
sub collector collect scorer doc    scorer score
sub done    scorer next
if   sub done
more   true
while  buckettable first    null    more
return false
public float score
if  coordfactors    null
computecoordfactors
return current score   coordfactors
static final class bucket
int doc    1                                     tells if bucket is valid
float       score                                incremental score
int bits                                         used for bool constraints
int coord                                        count of terms in score
bucket      next                                 next valid bucket
/** a simple hash table of document scores within a range. */
static final class buckettable
public static final int size   1 << 11
public static final int mask   size   1
final bucket buckets   new bucket
bucket first   null                              head of valid list
public buckettable
public final int size     return size
public hitcollector newcollector int mask
return new collector mask  this
static final class collector extends hitcollector
private buckettable buckettable
private int mask
public collector int mask  buckettable buckettable
this mask   mask
this buckettable   buckettable
public final void collect final int doc  final float score
final buckettable table   buckettable
final int i   doc   buckettable mask
bucket bucket   table buckets
if  bucket    null
table buckets   bucket   new bucket
if  bucket doc    doc                          invalid bucket
bucket doc   doc                             set doc
bucket score   score                         initialize score
bucket bits   mask                           initialize mask
bucket coord   1                             initialize coord
bucket next   table first                    push onto valid list
table first   bucket
else                                         valid bucket
bucket score    score                        increment score
bucket bits    mask                          add bits in mask
bucket coord                                 increment coord
public boolean skipto int target
throw new unsupportedoperationexception
public explanation explain int doc
throw new unsupportedoperationexception
public string tostring
stringbuffer buffer   new stringbuffer
buffer append
for  subscorer sub   scorers  sub    null  sub   sub next
buffer append sub scorer tostring
buffer append
buffer append
return buffer tostring