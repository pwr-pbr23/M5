package org apache lucene misc
/**
* copyright 2006 the apache software foundation
*
* licensed under the apache license, version 2.0 (the "license");
* you may not use this file except in compliance with the license.
* you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
import org apache lucene index term
import org apache lucene index termenum
import org apache lucene index termdocs
import org apache lucene index indexreader
import org apache lucene search similarity
import org apache lucene store directory
import org apache lucene store fsdirectory
import java io file
import java io ioexception
import java util date
/**
* given a directory, a similarity, and a list of fields, updates the
* fieldnorms in place for every document using the similarity.lengthnorm.
*
* <p>
* note: this only works if you do <b>not</b> use field/document boosts in your
* index.
* </p>
*
* @version $id$
*/
public class lengthnormmodifier
/**
* command line execution method.
*
* <pre>
* usage: lengthnormmodifier /path/index package.similarityclassname field1 field2 ...
* </pre>
*/
public static void main string args  throws ioexception
if  args length < 3
system err println
system exit 1
similarity s   null
try
class simclass   class forname args
s    similarity simclass newinstance
catch  exception e
system err println     args
e printstacktrace system err
file index   new file args
directory d   fsdirectory getdirectory index false
lengthnormmodifier lnm   new lengthnormmodifier d  s
for  int i   2  i < args length  i
system out print     args        new date    tostring
lnm resetnorms args
system out println new date   tostring
d close
private directory dir
private similarity sim
/**
* constructor for code that wishes to use this class progaomatically.
*
* @param d the directory to modify
* @param s the similarity to use in <code>resetnorms</code>
*/
public lengthnormmodifier directory d  similarity s
dir   d
sim   s
/**
* resets the norms for the specified field.
*
* <p>
* opens a new indexreader on the directory given to this instance,
* modifies the norms using the similarity given to this instance,
* and closes the indexreader.
* </p>
*
* @param field the field whose norms should be reset
*/
public void resetnorms string field  throws ioexception
string fieldname   field intern
int termcounts   new int
indexreader reader   null
termenum termenum   null
termdocs termdocs   null
try
reader   indexreader open dir
termcounts   new int
try
termenum   reader terms new term field
try
termdocs   reader termdocs
do
term term   termenum term
if  term    null    term field   equals fieldname
termdocs seek termenum term
while  termdocs next
termcounts    termdocs freq
while  termenum next
finally
if  null    termdocs  termdocs close
finally
if  null    termenum  termenum close
finally
if  null    reader  reader close
try
reader   indexreader open dir
for  int d   0  d < termcounts length  d
if    reader isdeleted d
byte norm   sim encodenorm sim lengthnorm fieldname  termcounts
reader setnorm d  fieldname  norm
finally
if  null    reader  reader close