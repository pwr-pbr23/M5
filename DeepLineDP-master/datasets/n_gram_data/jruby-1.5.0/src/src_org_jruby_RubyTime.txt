/***** begin license block *****
* version: cpl 1.0/gpl 2.0/lgpl 2.1
*
* the contents of this file are subject to the common public
* license version 1.0 (the "license"); you may not use this file
* except in compliance with the license. you may obtain a copy of
* the license at http://www.eclipse.org/legal/cpl-v10.html
*
* software distributed under the license is distributed on an "as
* is" basis, without warranty of any kind, either express or
* implied. see the license for the specific language governing
* rights and limitations under the license.
*
* copyright (c) 2001 chad fowler <chadfowler@chadfowler.com>
* copyright (c) 2001-2004 jan arne petersen <jpetersen@uni-bonn.de>
* copyright (c) 2002 benoit cerrina <b.cerrina@wanadoo.fr>
* copyright (c) 2002-2004 anders bengtsson <ndrsbngtssn@yahoo.se>
* copyright (c) 2004 joey gibson <joey@joeygibson.com>
* copyright (c) 2004 charles o nutter <headius@headius.com>
* copyright (c) 2004 stefan matthias aust <sma@3plus4.de>
* copyright (c) 2006 thomas e enebo <enebo@acm.org>
* copyright (c) 2006 ola bini <ola.bini@ki.se>
* copyright (c) 2006 miguel covarrubias <mlcovarrubias@gmail.com>
* copyright (c) 2009 joseph lafata <joe@quibb.org>
*
* alternatively, the contents of this file may be used under the terms of
* either of the gnu general public license version 2 or later (the "gpl"),
* or the gnu lesser general public license version 2.1 or later (the "lgpl"),
* in which case the provisions of the gpl or the lgpl are applicable instead
* of those above. if you wish to allow use of your version of this file only
* under the terms of either the gpl or the lgpl, and not to allow others to
* use your version of this file under the terms of the cpl, indicate your
* decision by deleting the provisions above and replace them with the notice
* and other provisions required by the gpl or the lgpl. if you do not delete
* the provisions above, a recipient may use your version of this file under
* the terms of any one of the cpl, the gpl or the lgpl.
***** end license block *****/
package org jruby
import java util calendar
import java util date
import java util gregoriancalendar
import java util hashmap
import java util locale
import java util map
import java util timezone
import java util regex matcher
import java util regex pattern
import org joda time datetime
import org joda time datetimezone
import org joda time format datetimeformat
import org joda time format datetimeformatter
import org jruby anno jrubyclass
import org jruby anno jrubymethod
import org jruby runtime block
import org jruby runtime classindex
import org jruby runtime objectallocator
import org jruby runtime threadcontext
import org jruby runtime visibility
import org jruby runtime builtin irubyobject
import org jruby util bytelist
import org jruby util rubydateformat
/** the time class.
*
* @author chadfowler, jpetersen
*/
@jrubyclass name    include
public class rubytime extends rubyobject
public static final string utc
private datetime dt
private long usec
private final static datetimeformatter one_day_ctime_formatter   datetimeformat forpattern    withlocale locale english
private final static datetimeformatter two_day_ctime_formatter   datetimeformat forpattern    withlocale locale english
private final static datetimeformatter to_s_formatter   datetimeformat forpattern    withlocale locale english
private final static datetimeformatter to_s_utc_formatter   datetimeformat forpattern    withlocale locale english
// there are two different popular tz formats: legacy (ast+3:00:00, gmt-3), and
// newer one (us/pacific, america/los_angeles). this pattern is to detect
// the legacy tz format in order to convert it to the newer format
// understood by java api.
private static final pattern tz_pattern
pattern compile
private static final bytelist tz_string   bytelist create
public static datetimezone getlocaltimezone ruby runtime
rubystring tzvar   runtime newstring tz_string
rubyhash h     rubyhash runtime getobject   fastgetconstant
irubyobject tz   h op_aref runtime getcurrentcontext    tzvar
if  tz    null       tz instanceof rubystring
return datetimezone getdefault
else
return gettimezone runtime  tz tostring
public static datetimezone gettimezone ruby runtime  string zone
datetimezone cachedzone   runtime gettimezonecache   get zone
if  cachedzone    null  return cachedzone
string originalzone   zone
// value of "tz" property is of a bit different format,
// which confuses the java's timezone.gettimezone(id) method,
// and so, we need to convert it.
matcher tzmatcher   tz_pattern matcher zone
if  tzmatcher matches
string sign   tzmatcher group 2
string hours   tzmatcher group 3
string minutes   tzmatcher group 4
// gmt+00:00 --> etc/gmt, see "mri behavior"
// comment below.
if     equals hours       equals hours
minutes    null      equals minutes       equals minutes
zone
else
// invert the sign, since tz format and java format
// use opposite signs, sigh... also, java api requires
// the sign to be always present, be it "+" or "-".
sign      equals sign ?
// always use "gmt" since that's required by java api.
zone       sign   hours
if  minutes    null
zone    minutes
// mri behavior: with tz equal to "gmt" or "utc", time.now
// is *not* considered as a proper gmt/utc time:
//   env['tz']="gmt"
//   time.now.gmt? ==> false
//   env['tz']="utc"
//   time.now.utc? ==> false
// hence, we need to adjust for that.
if    equalsignorecase zone       equalsignorecase zone
zone       zone
// for jruby-2759, when met choose cet timezone to work around joda
if    equalsignorecase zone
zone
datetimezone dtz   datetimezone fortimezone timezone gettimezone zone
runtime gettimezonecache   put originalzone  dtz
return dtz
public rubytime ruby runtime  rubyclass rubyclass
super runtime  rubyclass
public rubytime ruby runtime  rubyclass rubyclass  datetime dt
super runtime  rubyclass
this dt   dt
private static objectallocator time_allocator   new objectallocator
public irubyobject allocate ruby runtime  rubyclass klass
datetimezone dtz   getlocaltimezone runtime
datetime dt   new datetime dtz
rubytime rt    new rubytime runtime  klass  dt
rt setusec 0
return rt
public static rubyclass createtimeclass ruby runtime
rubyclass timeclass   runtime defineclass    runtime getobject    time_allocator
timeclass index   classindex time
timeclass setreifiedclass rubytime class
runtime settime timeclass
timeclass includemodule runtime getcomparable
timeclass defineannotatedmethods rubytime class
return timeclass
public void setusec long usec
this usec   usec
public long getusec
return usec
public void updatecal datetime dt
this dt   dt
protected long gettimeinmillis
return dt getmillis        for jdk 1 4 we can use
public static rubytime newtime ruby runtime  long milliseconds
return newtime runtime  new datetime milliseconds
public static rubytime newtime ruby runtime  datetime dt
return new rubytime runtime  runtime gettime    dt
public static rubytime newtime ruby runtime  datetime dt  long usec
rubytime t   new rubytime runtime  runtime gettime    dt
t setusec usec
return t
@override
public class<?> getjavaclass
return date class
@jrubymethod name      required   1
@override
public irubyobject initialize_copy irubyobject original
if    original instanceof rubytime
throw getruntime   newtypeerror
rubytime originaltime    rubytime  original
// we can just use dt, since it is immutable
dt   originaltime dt
usec   originaltime usec
return this
@jrubymethod name
public rubytime succ
return newtime getruntime   dt plusseconds 1
@jrubymethod name
public rubytime gmtime
dt   dt withzone datetimezone utc
return this
@jrubymethod name
public rubytime localtime
dt   dt withzone getlocaltimezone getruntime
return this
@jrubymethod name
public rubyboolean gmt
return getruntime   newboolean dt getzone   getid   equals
@jrubymethod name
public rubytime getgm
return newtime getruntime    dt withzone datetimezone utc   getusec
@jrubymethod name
public rubytime getlocal
return newtime getruntime    dt withzone getlocaltimezone getruntime      getusec
@jrubymethod name      required   1
public rubystring strftime irubyobject format
final rubydateformat rubydateformat   new rubydateformat    locale us  getruntime   is1_9
rubydateformat applypattern format converttostring   getunicodevalue
rubydateformat setdatetime dt
string result   rubydateformat format null
return getruntime   newstring result
@jrubymethod name      required   1  compat  compatversion ruby1_9
public irubyobject op_equal threadcontext context  irubyobject other
if  other isnil
return rubyboolean newboolean getruntime    false
else if  other instanceof rubytime
return getruntime   newboolean cmp  rubytime  other     0
return rubycomparable op_equal context  this  other
@jrubymethod name      required   1
public irubyobject op_ge threadcontext context  irubyobject other
if  other instanceof rubytime
return getruntime   newboolean cmp  rubytime  other  >  0
return rubycomparable op_ge context  this  other
@jrubymethod name      required   1
public irubyobject op_gt threadcontext context  irubyobject other
if  other instanceof rubytime
return getruntime   newboolean cmp  rubytime  other  > 0
return rubycomparable op_gt context  this  other
@jrubymethod name      required   1
public irubyobject op_le threadcontext context  irubyobject other
if  other instanceof rubytime
return getruntime   newboolean cmp  rubytime  other  <  0
return rubycomparable op_le context  this  other
@jrubymethod name      required   1
public irubyobject op_lt threadcontext context  irubyobject other
if  other instanceof rubytime
return getruntime   newboolean cmp  rubytime  other  < 0
return rubycomparable op_lt context  this  other
private int cmp rubytime other
long millis   gettimeinmillis
long millis_other   other gettimeinmillis
long usec_other   other usec
if  millis > millis_other     millis    millis_other    usec > usec_other
return 1
else if  millis < millis_other     millis    millis_other    usec < usec_other
return  1
return 0
@jrubymethod name      required   1
public irubyobject op_plus irubyobject other
long time   gettimeinmillis
if  other instanceof rubytime
throw getruntime   newtypeerror
long adjustment   math round rubynumeric num2dbl other    1000000
long micro   adjustment % 1000
adjustment   adjustment   1000
time    adjustment
if   getusec     micro  >  1000
time
micro    getusec     micro    1000
else
micro   getusec     micro
rubytime newtime   new rubytime getruntime    getmetaclass
newtime dt   new datetime time  withzone dt getzone
newtime setusec micro
return newtime
private irubyobject opminus rubytime other
long time   gettimeinmillis     1000   getusec
time    other gettimeinmillis     1000   other getusec
return rubyfloat newfloat getruntime    time   1000000 0      float number of seconds
@jrubymethod name      required   1
public irubyobject op_minus irubyobject other
if  other instanceof rubytime  return opminus  rubytime  other
long time   gettimeinmillis
long adjustment   math round rubynumeric num2dbl other    1000000
long micro   adjustment % 1000
adjustment   adjustment   1000
time    adjustment
if  getusec   < micro
time
micro   1000    micro   getusec
else
micro   getusec     micro
rubytime newtime   new rubytime getruntime    getmetaclass
newtime dt   new datetime time  withzone dt getzone
newtime setusec micro
return newtime
@jrubymethod name      required   1
@override
public irubyobject op_eqq threadcontext context  irubyobject other
return  rubynumeric fix2int callmethod context     other      0  ? getruntime   gettrue     getruntime   getfalse
@jrubymethod name      required   1
public irubyobject op_cmp threadcontext context  irubyobject other
if  other instanceof rubytime
return context getruntime   newfixnum cmp  rubytime  other
return context getruntime   getnil
@jrubymethod name      required   1
@override
public irubyobject eql_p irubyobject other
if  other instanceof rubytime
rubytime othertime    rubytime other
return  usec    othertime usec    gettimeinmillis      othertime gettimeinmillis    ? getruntime   gettrue     getruntime   getfalse
return getruntime   getfalse
@jrubymethod name
public rubystring asctime
datetimeformatter simpledateformat
if  dt getdayofmonth   < 10
simpledateformat   one_day_ctime_formatter
else
simpledateformat   two_day_ctime_formatter
string result   simpledateformat print dt
return getruntime   newstring result
@jrubymethod name
@override
public irubyobject to_s
datetimeformatter simpledateformat
if  dt getzone      datetimezone utc
simpledateformat   to_s_utc_formatter
else
simpledateformat   to_s_formatter
string result   simpledateformat print dt
return getruntime   newstring result
@jrubymethod name
@override
public rubyarray to_a
return getruntime   newarraynocopy new irubyobject   sec    min    hour    mday    month
year    wday    yday    isdst    zone
@jrubymethod name
public rubyfloat to_f
long time   gettimeinmillis
time   time   1000   usec
return rubyfloat newfloat getruntime    time   1000000 0
@jrubymethod name
public rubyinteger to_i
return getruntime   newfixnum gettimeinmillis     1000
@jrubymethod name      backtrace   true  compat   compatversion ruby1_9
public irubyobject to_r threadcontext context
irubyobject rational   to_f   to_r context
if  rational instanceof rubyrational
irubyobject denominator     rubyrational rational  denominator context
if  rubynumeric num2long denominator     1
return   rubyrational rational  numerator context
return rational
@jrubymethod name
public rubyinteger usec
return getruntime   newfixnum dt getmillisofsecond     1000   getusec
public void setmicroseconds long mic
long millis   gettimeinmillis   % 1000
long withoutmillis   gettimeinmillis     millis
withoutmillis     mic   1000
dt   dt withmillis withoutmillis
usec   mic % 1000
public long microseconds
return gettimeinmillis   % 1000   1000   usec
@jrubymethod name
public rubyinteger sec
return getruntime   newfixnum dt getsecondofminute
@jrubymethod name
public rubyinteger min
return getruntime   newfixnum dt getminuteofhour
@jrubymethod name
public rubyinteger hour
return getruntime   newfixnum dt gethourofday
@jrubymethod name
public rubyinteger mday
return getruntime   newfixnum dt getdayofmonth
@jrubymethod name
public rubyinteger month
return getruntime   newfixnum dt getmonthofyear
@jrubymethod name
public rubyinteger year
return getruntime   newfixnum dt getyear
@jrubymethod name
public rubyinteger wday
return getruntime   newfixnum  dt getdayofweek  %7
@jrubymethod name
public rubyinteger yday
return getruntime   newfixnum dt getdayofyear
@jrubymethod name
public rubyinteger gmt_offset
int offset   dt getzone   getoffsetfromlocal dt getmillis
return getruntime   newfixnum  int  offset 1000
@jrubymethod name
public rubyboolean isdst
return getruntime   newboolean  dt getzone   isstandardoffset dt getmillis
@jrubymethod name
public rubystring zone
string zone   dt getzone   getshortname dt getmillis
if zone equals
zone
return getruntime   newstring zone
public void setdatetime datetime dt
this dt   dt
public datetime getdatetime
return this dt
public date getjavadate
return this dt todate
@jrubymethod name
@override
public rubyfixnum hash
// modified to match how hash is calculated in 1.8.2
return getruntime   newfixnum  int    dt getmillis     1000  ^ microseconds    << 1  >> 1
@jrubymethod name      optional   1  frame   true
public rubystring dump irubyobject args  block unusedblock
rubystring str    rubystring  mdump new irubyobject   this
str syncvariables this getvariablelist
return str
public rubyobject mdump final irubyobject args
rubytime obj    rubytime args
datetime datetime   obj dt
byte dumpvalue   new byte
int pe
0x1                                 << 31
obj gmt   istrue   ? 0x1   0x0    << 30
datetime getyear   1900            << 14
datetime getmonthofyear   1        << 10
datetime getdayofmonth              << 5
datetime gethourofday
int se
datetime getminuteofhour            << 26
datetime getsecondofminute          << 20
datetime getmillisofsecond     1000    int usec      dump usec  not msec
for int i   0  i < 4  i
dumpvalue    byte  pe   0xff
pe >>>  8
for int i   4  i < 8  i
dumpvalue    byte  se   0xff
se >>>  8
return rubystring newstring obj getruntime    new bytelist dumpvalue false
@jrubymethod name      frame   true  visibility   visibility private
public irubyobject initialize block block
return this
/* time class methods */
public static irubyobject s_new irubyobject recv  irubyobject args  block block
ruby runtime   recv getruntime
rubytime time   new rubytime runtime   rubyclass  recv  new datetime getlocaltimezone runtime
time callinit args block
return time
/**
* @deprecated use {@link #newinstance(threadcontext, irubyobject)}
*/
@deprecated
public static irubyobject newinstance threadcontext context  irubyobject recv  irubyobject args  block block
return newinstance context  recv
@jrubymethod name      meta   true  compat   compatversion ruby1_8
public static irubyobject times threadcontext context  irubyobject recv
context getruntime   getwarnings   warn
return rubyprocess times context  recv  block null_block
@jrubymethod name      backtrace   true  meta   true
public static irubyobject newinstance threadcontext context  irubyobject recv
irubyobject obj     rubyclass  recv  allocate
obj getmetaclass   getbasecallsites   call context  recv  obj
return obj
@jrubymethod name       meta   true
public static irubyobject at threadcontext context  irubyobject recv  irubyobject arg
ruby runtime   context getruntime
final rubytime time
if  arg instanceof rubytime
rubytime other    rubytime  arg
time   new rubytime runtime   rubyclass  recv  other dt
time setusec other getusec
else
time   new rubytime runtime   rubyclass  recv
new datetime 0l  getlocaltimezone runtime
long seconds   rubynumeric num2long arg
long millisecs   0
long microsecs   0
// in the case of two arguments, mri will discard the portion of
// the first argument after a decimal point (i.e., "floor").
// however in the case of a single argument, any portion after
// the decimal point is honored.
if  arg instanceof rubyfloat
double dbl     rubyfloat  arg  getdoublevalue
long micro   math round  dbl   seconds    1000000
if dbl < 0
micro    1000000
millisecs   micro   1000
microsecs   micro % 1000
time setusec microsecs
time dt   time dt withmillis seconds   1000   millisecs
time getmetaclass   getbasecallsites   call context  recv  time
return time
@jrubymethod name      meta   true
public static irubyobject at threadcontext context  irubyobject recv  irubyobject arg1  irubyobject arg2
ruby runtime   context getruntime
rubytime time   new rubytime runtime   rubyclass  recv
new datetime 0l  getlocaltimezone runtime
long seconds   rubynumeric num2long arg1
long millisecs   0
long microsecs   0
long tmp   rubynumeric num2long arg2
millisecs   tmp   1000
microsecs   tmp % 1000
time setusec microsecs
time dt   time dt withmillis seconds   1000   millisecs
time getmetaclass   getbasecallsites   call context  recv  time
return time
@jrubymethod name           required   1  optional   9  meta   true
public static rubytime new_local irubyobject recv  irubyobject args
return createtime recv  args  false
@jrubymethod name           required   1  optional   9  meta   true
public static rubytime new_utc irubyobject recv  irubyobject args
return createtime recv  args  true
@jrubymethod name      required   1  frame   true  meta   true
public static rubytime load irubyobject recv  irubyobject from  block block
return s_mload recv   rubytime    rubyclass recv  allocate     from
@override
public object tojava class target
if  target equals date class
return getjavadate
else if  target equals calendar class
calendar cal   gregoriancalendar getinstance
cal settime getjavadate
return cal
else if  target equals datetime class
return this dt
else if  target equals java sql date class
return new java sql date dt getmillis
else if  target equals java sql time class
return new java sql time dt getmillis
else if  target equals java sql timestamp class
return new java sql timestamp dt getmillis
else if  target isassignablefrom date class
return getjavadate
else
return super tojava target
protected static rubytime s_mload irubyobject recv  rubytime time  irubyobject from
ruby runtime   recv getruntime
datetime dt   new datetime getlocaltimezone runtime
byte fromasbytes   null
fromasbytes   from converttostring   getbytes
if fromasbytes length    8
throw runtime newtypeerror
int p 0
int s 0
for  int i   0  i < 4  i
p      int fromasbytes   0xff  <<  8   i
for  int i   4  i < 8  i
s      int fromasbytes   0xff  <<  8    i   4
if   p    1<<31      0
dt   dt withmillis p   1000l
time setusec  s   0xfffff  % 1000
else
p    ~ 1<<31
if  p >>> 30   0x1     0x1  dt   dt withzone datetimezone utc
dt   dt withyear   p >>> 14    0xffff    1900
dt   dt withmonthofyear   p >>> 10    0xf    1
dt   dt withdayofmonth   p >>> 5     0x1f
dt   dt withhourofday  p   0x1f
dt   dt withminuteofhour   s >>> 26    0x3f
dt   dt withsecondofminute   s >>> 20    0x3f
// marsaling dumps usec, not msec
dt   dt withmillisofsecond  s   0xfffff    1000
time setusec  s   0xfffff  % 1000
time setdatetime dt
from getinstancevariables   copyinstancevariablesinto time
return time
private static final string months
private static final map<string  integer> months_map   new hashmap<string  integer>
static
for  int i   0  i < months length  i
months_map put months  i   1
private static final int time_min    1  0  0  0  integer min_value
private static final int time_max    31  23  59  60  integer max_value
private static final int arg_size   7
private static rubytime createtime irubyobject recv  irubyobject args  boolean gmt
ruby runtime   recv getruntime
int len   arg_size
boolean isdst   null
datetimezone dtz
if  gmt
dtz   datetimezone utc
else if  args length    10    args instanceof rubystring
dtz   gettimezone runtime    rubystring  args  tostring
else
dtz   getlocaltimezone runtime
if  args length    10
if args instanceof rubyboolean
isdst     rubyboolean args  istrue
args   new irubyobject   args  args  args  args  args  args  runtime getnil
else
// mri accepts additional wday argument which appears to be ignored.
len   args length
if  len < arg_size
irubyobject newargs   new irubyobject
system arraycopy args  0  newargs  0  args length
for  int i   len  i < arg_size  i
newargs   runtime getnil
args   newargs
len   arg_size
if  args instanceof rubystring
args   rubynumeric str2inum runtime   rubystring  args  10  false
int year    int  rubynumeric num2long args
int month   1
if  len > 1
if   args isnil
irubyobject tmp   args checkstringtype
if   tmp isnil
string monthstring   tmp tostring   tolowercase
integer monthint   months_map get monthstring
if  monthint    null
month   monthint
else
try
month   integer parseint monthstring
catch  numberformatexception nfexcptn
throw runtime newargumenterror
else
month    int  rubynumeric num2long args
if  1 > month    month > 12
throw runtime newargumenterror     month
int int_args     1  0  0  0  0  0
for  int i   0  int_args length >  i   2  i
if   args isnil
if    args instanceof rubynumeric
args   args callmethod
runtime getcurrentcontext
long value   rubynumeric num2long args
if  time_min > value    value > time_max
throw runtime newargumenterror
int_args    int  value
if  0 <  year    year < 39
year    2000
else if  69 <  year    year < 139
year    1900
datetime dt
// set up with min values and then add to allow rolling over
try
dt   new datetime year  1  1  0  0   0  0  datetimezone utc
dt   dt plusmonths month   1
plusdays int_args   1
plushours int_args
plusminutes int_args
plusseconds int_args
dt   dt withzoneretainfields dtz
// we might need to perform a dst correction
if isdst    null
// the instant at which we will ask dtz what the difference between dst and
// standard time is
long offsetcalculationinstant   dt getmillis
// if we might be moving this time from !dst -> dst, the offset is assumed
// to be the same as it was just before we last moved from dst -> !dst
if dtz isstandardoffset dt getmillis
offsetcalculationinstant   dtz previoustransition offsetcalculationinstant
int offset   dtz getstandardoffset offsetcalculationinstant
dtz getoffset offsetcalculationinstant
if   isdst     dtz isstandardoffset dt getmillis
dt   dt minusmillis offset
if  isdst     dtz isstandardoffset dt getmillis
dt   dt plusmillis offset
catch  org joda time illegalfieldvalueexception e
throw runtime newargumenterror
rubytime time   new rubytime runtime   rubyclass  recv  dt
// ignores usec if 8 args (for compatibility with parsedate) or if not supplied.
if  args length    8     args isnil
int usec   int_args % 1000
int msec   int_args   1000
if  int_args < 0
msec    1
usec    1000
time dt   dt withmillis dt getmillis     msec
time setusec usec
time callinit irubyobject null_array  block null_block
return time