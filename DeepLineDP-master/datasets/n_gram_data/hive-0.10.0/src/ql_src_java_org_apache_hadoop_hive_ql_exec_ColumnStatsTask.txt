/**
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hive ql exec
import java io ioexception
import java io serializable
import java util arraylist
import java util list
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop hive conf hiveconf
import org apache hadoop hive metastore api binarycolumnstatsdata
import org apache hadoop hive metastore api booleancolumnstatsdata
import org apache hadoop hive metastore api columnstatistics
import org apache hadoop hive metastore api columnstatisticsdata
import org apache hadoop hive metastore api columnstatisticsdesc
import org apache hadoop hive metastore api columnstatisticsobj
import org apache hadoop hive metastore api doublecolumnstatsdata
import org apache hadoop hive metastore api longcolumnstatsdata
import org apache hadoop hive metastore api stringcolumnstatsdata
import org apache hadoop hive ql commandneedretryexception
import org apache hadoop hive ql context
import org apache hadoop hive ql drivercontext
import org apache hadoop hive ql queryplan
import org apache hadoop hive ql metadata hiveexception
import org apache hadoop hive ql plan columnstatswork
import org apache hadoop hive ql plan fetchwork
import org apache hadoop hive ql plan api stagetype
import org apache hadoop hive serde2 objectinspector inspectableobject
import org apache hadoop hive serde2 objectinspector objectinspector
import org apache hadoop hive serde2 objectinspector primitiveobjectinspector
import org apache hadoop hive serde2 objectinspector structfield
import org apache hadoop hive serde2 objectinspector structobjectinspector
import org apache hadoop hive serde2 objectinspector primitive doubleobjectinspector
import org apache hadoop hive serde2 objectinspector primitive longobjectinspector
import org apache hadoop hive serde2 objectinspector primitive stringobjectinspector
import org apache hadoop mapred jobconf
import org apache hadoop util stringutils
/**
* columnstatstask implementation.
**/
public class columnstatstask extends task<columnstatswork> implements serializable
private static final long serialversionuid   1l
private fetchoperator ftop
private static transient final log log   logfactory getlog columnstatstask class
public columnstatstask
super
@override
public void initialize hiveconf conf  queryplan queryplan  drivercontext ctx
super initialize conf  queryplan  ctx
try
jobconf job   new jobconf conf  execdriver class
ftop   new fetchoperator work getfwork    job
catch  exception e
log error stringutils stringifyexception e
throw new runtimeexception e
private void unpackbooleanstats objectinspector oi  object o  string fname
columnstatisticsobj statsobj
long v     longobjectinspector  oi  get o
if  fname equals
statsobj getstatsdata   getbooleanstats   setnumtrues v
else if  fname equals
statsobj getstatsdata   getbooleanstats   setnumfalses v
else if  fname equals
statsobj getstatsdata   getbooleanstats   setnumnulls v
private void unpackdoublestats objectinspector oi  object o  string fname
columnstatisticsobj statsobj
if  fname equals
long v     longobjectinspector  oi  get o
statsobj getstatsdata   getdoublestats   setnumnulls v
else if  fname equals
long v     longobjectinspector  oi  get o
statsobj getstatsdata   getdoublestats   setnumdvs v
else if  fname equals
double d     doubleobjectinspector  oi  get o
statsobj getstatsdata   getdoublestats   sethighvalue d
else if  fname equals
double d     doubleobjectinspector  oi  get o
statsobj getstatsdata   getdoublestats   setlowvalue d
private void unpacklongstats objectinspector oi  object o  string fname
columnstatisticsobj statsobj
if  fname equals
long v     longobjectinspector  oi  get o
statsobj getstatsdata   getlongstats   setnumnulls v
else if  fname equals
long v     longobjectinspector  oi  get o
statsobj getstatsdata   getlongstats   setnumdvs v
else if  fname equals
long v     longobjectinspector  oi  get o
statsobj getstatsdata   getlongstats   sethighvalue v
else if  fname equals
long  v     longobjectinspector  oi  get o
statsobj getstatsdata   getlongstats   setlowvalue v
private void unpackstringstats objectinspector oi  object o  string fname
columnstatisticsobj statsobj
if  fname equals
long v     longobjectinspector  oi  get o
statsobj getstatsdata   getstringstats   setnumnulls v
else if  fname equals
long v     longobjectinspector  oi  get o
statsobj getstatsdata   getstringstats   setnumdvs v
else if  fname equals
double d     doubleobjectinspector  oi  get o
statsobj getstatsdata   getstringstats   setavgcollen d
else if  fname equals
long v     longobjectinspector  oi  get o
statsobj getstatsdata   getstringstats   setmaxcollen v
private void unpackbinarystats objectinspector oi  object o  string fname
columnstatisticsobj statsobj
if  fname equals
long v     longobjectinspector  oi  get o
statsobj getstatsdata   getbinarystats   setnumnulls v
else if  fname equals
double d     doubleobjectinspector  oi  get o
statsobj getstatsdata   getbinarystats   setavgcollen d
else if  fname equals
long v     longobjectinspector  oi  get o
statsobj getstatsdata   getbinarystats   setmaxcollen v
private void unpackprimitiveobject  objectinspector oi  object o  string fieldname
columnstatisticsobj statsobj
// first infer the type of object
if  fieldname equals
primitiveobjectinspector poi    primitiveobjectinspector  oi
string s     stringobjectinspector  poi  getprimitivejavaobject o
columnstatisticsdata statsdata   new columnstatisticsdata
if  s equalsignorecase
longcolumnstatsdata longstats   new longcolumnstatsdata
statsdata setlongstats longstats
statsobj setstatsdata statsdata
else if  s equalsignorecase
doublecolumnstatsdata doublestats   new doublecolumnstatsdata
statsdata setdoublestats doublestats
statsobj setstatsdata statsdata
else if  s equalsignorecase
stringcolumnstatsdata stringstats   new stringcolumnstatsdata
statsdata setstringstats stringstats
statsobj setstatsdata statsdata
else if  s equalsignorecase
booleancolumnstatsdata booleanstats   new booleancolumnstatsdata
statsdata setbooleanstats booleanstats
statsobj setstatsdata statsdata
else if  s equalsignorecase
binarycolumnstatsdata binarystats   new binarycolumnstatsdata
statsdata setbinarystats binarystats
statsobj setstatsdata statsdata
else
// invoke the right unpack method depending on data type of the column
if  statsobj getstatsdata   issetbooleanstats
unpackbooleanstats oi  o  fieldname  statsobj
else if  statsobj getstatsdata   issetlongstats
unpacklongstats oi  o  fieldname  statsobj
else if  statsobj getstatsdata   issetdoublestats
unpackdoublestats oi o fieldname  statsobj
else if  statsobj getstatsdata   issetstringstats
unpackstringstats oi  o  fieldname  statsobj
else if  statsobj getstatsdata   issetbinarystats
unpackbinarystats oi  o  fieldname  statsobj
private void unpackstructobject objectinspector oi  object o  string fname
columnstatisticsobj cstatsobj
if  oi getcategory      objectinspector category struct
throw new runtimeexception     oi getcategory   tostring
structobjectinspector soi    structobjectinspector  oi
list<? extends structfield> fields   soi getallstructfieldrefs
list<object> list   soi getstructfieldsdataaslist o
for  int i   0  i < fields size    i
// get the field objectinspector, fieldname and the field object.
objectinspector foi   fields get i  getfieldobjectinspector
object f    list    null ? null   list get i
string fieldname   fields get i  getfieldname
if  foi getcategory      objectinspector category primitive
unpackprimitiveobject foi  f  fieldname  cstatsobj
else
unpackstructobject foi  f  fieldname  cstatsobj
private columnstatistics constructcolumnstatsfrompackedrow objectinspector oi
object o  throws hiveexception
if  oi getcategory      objectinspector category struct
throw new hiveexception
string dbname   db getcurrentdatabase
string tablename   work getcolstats   gettablename
string partname   null
list<string> colname   work getcolstats   getcolname
list<string> coltype   work getcolstats   getcoltype
boolean istbllevel   work getcolstats   istbllevel
if   istbllevel
partname   work getcolstats   getpartname
columnstatisticsdesc statsdesc   getcolumnstatsdesc dbname  tablename  partname  istbllevel
list<columnstatisticsobj> statsobjs   new arraylist<columnstatisticsobj>
structobjectinspector soi    structobjectinspector  oi
list<? extends structfield> fields   soi getallstructfieldrefs
list<object> list   soi getstructfieldsdataaslist o
for  int i   0  i < fields size    i
// get the field objectinspector, fieldname and the field object.
objectinspector foi   fields get i  getfieldobjectinspector
object f    list    null ? null   list get i
string fieldname   fields get i  getfieldname
columnstatisticsobj statsobj   new columnstatisticsobj
statsobj setcolname colname get i
statsobj setcoltype coltype get i
unpackstructobject foi  f  fieldname  statsobj
statsobjs add statsobj
columnstatistics colstats   new columnstatistics
colstats setstatsdesc statsdesc
colstats setstatsobj statsobjs
return colstats
private columnstatisticsdesc getcolumnstatsdesc string dbname  string tablename
string partname  boolean istbllevel
columnstatisticsdesc statsdesc   new columnstatisticsdesc
statsdesc setdbname dbname
statsdesc settablename tablename
statsdesc setistbllevel istbllevel
if   istbllevel
statsdesc setpartname partname
else
statsdesc setpartname null
return statsdesc
private int persistpartitionstats   throws hiveexception
inspectableobject io   null
// fetch result of the analyze table .. compute statistics for columns ..
try
io   fetchcolumnstats
catch  ioexception e
e printstacktrace
catch  commandneedretryexception e
e printstacktrace
// construct a column statistics object from the result
columnstatistics colstats   constructcolumnstatsfrompackedrow io oi  io o
// persist the column statistics object to the metastore
try
db updatepartitioncolumnstatistics colstats
catch  exception e
e printstacktrace
return 0
private int persisttablestats   throws hiveexception
inspectableobject io   null
// fetch result of the analyze table .. compute statistics for columns ..
try
io   fetchcolumnstats
catch  ioexception e
e printstacktrace
catch  commandneedretryexception e
e printstacktrace
// construct a column statistics object from the result
columnstatistics colstats   constructcolumnstatsfrompackedrow io oi  io o
// persist the column statistics object to the metastore
try
db updatetablecolumnstatistics colstats
catch  exception e
e printstacktrace
return 0
@override
public int execute drivercontext drivercontext
try
if  work getcolstats   istbllevel
return persisttablestats
else
return persistpartitionstats
catch  exception e
e printstacktrace
return 1
private inspectableobject fetchcolumnstats   throws ioexception  commandneedretryexception
try
inspectableobject io   ftop getnextrow
if  io    null
throw new commandneedretryexception
return io
catch  commandneedretryexception e
throw e
catch  ioexception e
throw e
catch  exception e
throw new ioexception e
@override
public stagetype gettype
return stagetype columnstats
@override
public string getname
return
@override
protected void localizemrtmpfilesimpl context ctx
fetchwork fwork   work getfwork
string s   fwork gettbldir
if   s    null     ctx ismrtmpfileuri s
fwork settbldir ctx localizemrtmpfileuri s
arraylist<string> ls   fwork getpartdir
if  ls    null
ctx localizepaths ls