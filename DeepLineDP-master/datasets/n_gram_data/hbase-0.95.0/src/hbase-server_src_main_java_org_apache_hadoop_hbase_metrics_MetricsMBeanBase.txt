/**
*
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hbase metrics
import java util arraylist
import java util hashmap
import java util list
import java util map
import javax management attributenotfoundexception
import javax management mbeanattributeinfo
import javax management mbeanexception
import javax management mbeaninfo
import javax management reflectionexception
import com yammer metrics stats snapshot
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop classification interfaceaudience
import org apache hadoop hbase metrics histogram metricshistogram
import org apache hadoop metrics util metricsbase
import org apache hadoop metrics util metricsdynamicmbeanbase
import org apache hadoop metrics util metricsregistry
/**
* extends the hadoop metricsdynamicmbeanbase class to provide jmx support for
* custom hbase metricsbase implementations.  metricsdynamicmbeanbase ignores
* registered metricsbase instance that are not instances of one of the
* org.apache.hadoop.metrics.util implementations.
*
*/
@deprecated
@interfaceaudience private
public class metricsmbeanbase extends metricsdynamicmbeanbase
private static final log log   logfactory getlog
protected final metricsregistry registry
protected final string description
protected int registrylength
/** hbase metricsbase implementations that metricsdynamicmbeanbase does
* not understand
*/
protected map<string metricsbase> extendedattributes
new hashmap<string metricsbase>
protected mbeaninfo extendedinfo
protected metricsmbeanbase  metricsregistry mr  string description
super copyminushbasemetrics mr   description
this registry   mr
this description   description
this init
/*
* @param mr metricsregistry.
* @return a copy of the passed metricsregistry minus the hbase metrics
*/
private static metricsregistry copyminushbasemetrics final metricsregistry mr
metricsregistry copy   new metricsregistry
for  metricsbase metric   mr getmetricslist
if  metric instanceof metricsrate    metric instanceof metricsstring
metric instanceof metricshistogram    metric instanceof exactcountermetric
continue
copy add metric getname    metric
return copy
protected void init
list<mbeanattributeinfo> attributes   new arraylist<mbeanattributeinfo>
mbeaninfo parentinfo   super getmbeaninfo
list<string> parentattributes   new arraylist<string>
for  mbeanattributeinfo attr   parentinfo getattributes
attributes add attr
parentattributes add attr getname
this registrylength   this registry getmetricslist   size
for  metricsbase metric   this registry getmetricslist
if  metric getname      null    parentattributes contains metric getname
continue
// add on custom hbase metric types
if  metric instanceof metricsrate
attributes add  new mbeanattributeinfo metric getname
metric getdescription    true  false  false
extendedattributes put metric getname    metric
else if  metric instanceof metricsstring
attributes add  new mbeanattributeinfo metric getname
metric getdescription    true  false  false
extendedattributes put metric getname    metric
log info     metric getname
else if  metric instanceof metricshistogram
string metricname   metric getname     metricshistogram num_ops_metric_name
attributes add new mbeanattributeinfo metricname
metric getdescription    true  false  false
extendedattributes put metricname  metric
metricname   metric getname     metricshistogram min_metric_name
attributes add new mbeanattributeinfo metricname
metric getdescription    true  false  false
extendedattributes put metricname  metric
metricname   metric getname     metricshistogram max_metric_name
attributes add new mbeanattributeinfo metricname
metric getdescription    true  false  false
extendedattributes put metricname  metric
metricname   metric getname     metricshistogram mean_metric_name
attributes add new mbeanattributeinfo metricname
metric getdescription    true  false  false
extendedattributes put metricname  metric
metricname   metric getname     metricshistogram std_dev_metric_name
attributes add new mbeanattributeinfo metricname
metric getdescription    true  false  false
extendedattributes put metricname  metric
metricname   metric getname     metricshistogram median_metric_name
attributes add new mbeanattributeinfo metricname
metric getdescription    true  false  false
extendedattributes put metricname  metric
metricname   metric getname     metricshistogram seventy_fifth_percentile_metric_name
attributes add new mbeanattributeinfo metricname
metric getdescription    true  false  false
extendedattributes put metricname  metric
metricname   metric getname     metricshistogram ninety_fifth_percentile_metric_name
attributes add new mbeanattributeinfo metricname
metric getdescription    true  false  false
extendedattributes put metricname  metric
metricname   metric getname     metricshistogram ninety_nineth_percentile_metric_name
attributes add new mbeanattributeinfo metricname
metric getdescription    true  false  false
extendedattributes put metricname  metric
// else, its probably a hadoop metric already registered. skip it.
log info
this extendedinfo   new mbeaninfo  this getclass   getname
this description  attributes toarray  new mbeanattributeinfo
parentinfo getconstructors    parentinfo getoperations
parentinfo getnotifications
private void checkandupdateattributes
if  this registrylength    this registry getmetricslist   size
this init
@override
public object getattribute  string name
throws attributenotfoundexception  mbeanexception
reflectionexception
if  name    null
throw new illegalargumentexception
/*
* ugly.  since metricsdynamicmbeanbase implementation is private,
* we need to first check the parent class for the attribute.
* in case that the metricsregistry contents have changed, this will
* allow the parent to update it's internal structures (which we rely on
* to update our own.
*/
try
return super getattribute name
catch  attributenotfoundexception ex
checkandupdateattributes
metricsbase metric   this extendedattributes get name
if  metric    null
if  metric instanceof metricsrate
return   metricsrate  metric  getpreviousintervalvalue
else if  metric instanceof metricsstring
return   metricsstring metric  getvalue
else if  metric instanceof metricshistogram
metricshistogram hist    metricshistogram  metric
if  name endswith metricshistogram num_ops_metric_name
return hist getcount
else if  name endswith metricshistogram min_metric_name
return hist getmin
else if  name endswith metricshistogram max_metric_name
return hist getmax
else if  name endswith metricshistogram mean_metric_name
return  float  hist getmean
else if  name endswith metricshistogram std_dev_metric_name
return  float  hist getstddev
else if  name endswith metricshistogram median_metric_name
snapshot s   hist getsnapshot
return  float  s getmedian
else if  name endswith metricshistogram seventy_fifth_percentile_metric_name
snapshot s   hist getsnapshot
return  float  s get75thpercentile
else if  name endswith metricshistogram ninety_fifth_percentile_metric_name
snapshot s   hist getsnapshot
return  float  s get95thpercentile
else if  name endswith metricshistogram ninety_nineth_percentile_metric_name
snapshot s   hist getsnapshot
return  float  s get99thpercentile
else
log warn  string format
metric getclass   getname    name
throw new attributenotfoundexception
@override
public mbeaninfo getmbeaninfo
return this extendedinfo