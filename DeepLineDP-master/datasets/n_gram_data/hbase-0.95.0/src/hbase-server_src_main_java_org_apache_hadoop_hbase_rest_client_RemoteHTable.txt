/*
*
* licensed to the apache software foundation (asf) under one
* or more contributor license agreements.  see the notice file
* distributed with this work for additional information
* regarding copyright ownership.  the asf licenses this file
* to you under the apache license, version 2.0 (the
* "license"); you may not use this file except in compliance
* with the license.  you may obtain a copy of the license at
*
*     http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache hadoop hbase rest client
import java io ioexception
import java util arraylist
import java util collection
import java util iterator
import java util list
import java util map
import java util set
import java util treemap
import com google protobuf service
import com google protobuf serviceexception
import org apache commons logging log
import org apache commons logging logfactory
import org apache hadoop hbase client
import org apache hadoop hbase client coprocessor batch
import org apache hadoop hbase ipc coprocessorrpcchannel
import org apache hadoop util stringutils
import org apache hadoop classification interfaceaudience
import org apache hadoop classification interfacestability
import org apache hadoop conf configuration
import org apache hadoop hbase cell
import org apache hadoop hbase hbaseconfiguration
import org apache hadoop hbase hconstants
import org apache hadoop hbase htabledescriptor
import org apache hadoop hbase keyvalue
import org apache hadoop hbase keyvalueutil
import org apache hadoop hbase client rowmutations
import org apache hadoop hbase client delete
import org apache hadoop hbase client get
import org apache hadoop hbase client htableinterface
import org apache hadoop hbase client increment
import org apache hadoop hbase client put
import org apache hadoop hbase client row
import org apache hadoop hbase client result
import org apache hadoop hbase client resultscanner
import org apache hadoop hbase client scan
import org apache hadoop hbase io timerange
import org apache hadoop hbase rest constants
import org apache hadoop hbase rest model cellmodel
import org apache hadoop hbase rest model cellsetmodel
import org apache hadoop hbase rest model rowmodel
import org apache hadoop hbase rest model scannermodel
import org apache hadoop hbase rest model tableschemamodel
import org apache hadoop hbase util bytes
/**
* htable interface to remote tables accessed via rest gateway
*/
@interfaceaudience public
@interfacestability stable
public class remotehtable implements htableinterface
private static final log log   logfactory getlog remotehtable class
final client client
final configuration conf
final byte name
final int maxretries
final long sleeptime
@suppresswarnings
protected string buildrowspec final byte row  final map familymap
final long starttime  final long endtime  final int maxversions
stringbuffer sb   new stringbuffer
sb append
sb append bytes tostringbinary name
sb append
sb append bytes tostringbinary row
set families   familymap entryset
if  families    null
iterator i   familymap entryset   iterator
if  i hasnext
sb append
while  i hasnext
map entry e    map entry i next
collection quals    collection e getvalue
if  quals    null     quals isempty
iterator ii   quals iterator
while  ii hasnext
sb append bytes tostringbinary  byte e getkey
sb append
object o   ii next
// puts use byte[] but deletes use keyvalue
if  o instanceof byte
sb append bytes tostringbinary  byte o
else if  o instanceof keyvalue
sb append bytes tostringbinary   keyvalue o  getqualifier
else
throw new runtimeexception
if  ii hasnext
sb append
else
sb append bytes tostringbinary  byte e getkey
sb append
if  i hasnext
sb append
if  starttime    0    endtime    long max_value
sb append
sb append starttime
if  starttime    endtime
sb append
sb append endtime
else if  endtime    long max_value
sb append
sb append endtime
if  maxversions > 1
sb append
sb append maxversions
return sb tostring
protected string buildmultirowspec final byte rows  int maxversions
stringbuilder sb   new stringbuilder
sb append
sb append bytes tostringbinary name
sb append
if  rows    null    rows length    0
return sb tostring
sb append
for int i 0  i<rows length  i
byte rk   rows
if  i    0
sb append
sb append
sb append bytes tostringbinary rk
sb append
sb append maxversions
return sb tostring
protected result buildresultfrommodel final cellsetmodel model
list<result> results   new arraylist<result>
for  rowmodel row  model getrows
list<keyvalue> kvs   new arraylist<keyvalue>
for  cellmodel cell  row getcells
byte split   keyvalue parsecolumn cell getcolumn
byte column   split
byte qualifier   split length > 1 ? split   null
kvs add new keyvalue row getkey    column  qualifier
cell gettimestamp    cell getvalue
results add new result kvs
return results toarray new result
protected cellsetmodel buildmodelfromput put put
rowmodel row   new rowmodel put getrow
long ts   put gettimestamp
for  list<? extends cell> cells  put getfamilymap   values
for  cell cell  cells
keyvalue kv   keyvalueutil ensurekeyvalue cell
row addcell new cellmodel kv getfamily    kv getqualifier
ts    hconstants latest_timestamp ? ts   kv gettimestamp
kv getvalue
cellsetmodel model   new cellsetmodel
model addrow row
return model
/**
* constructor
* @param client
* @param name
*/
public remotehtable client client  string name
this client  hbaseconfiguration create    bytes tobytes name
/**
* constructor
* @param client
* @param conf
* @param name
*/
public remotehtable client client  configuration conf  string name
this client  conf  bytes tobytes name
/**
* constructor
* @param client
* @param conf
* @param name
*/
public remotehtable client client  configuration conf  byte name
this client   client
this conf   conf
this name   name
this maxretries   conf getint    10
this sleeptime   conf getlong    1000
public byte gettablename
return name clone
public configuration getconfiguration
return conf
public htabledescriptor gettabledescriptor   throws ioexception
stringbuilder sb   new stringbuilder
sb append
sb append bytes tostringbinary name
sb append
sb append
for  int i   0  i < maxretries  i
response response   client get sb tostring    constants mimetype_protobuf
int code   response getcode
switch  code
case 200
tableschemamodel schema   new tableschemamodel
schema getobjectfrommessage response getbody
return schema gettabledescriptor
case 509
try
thread sleep sleeptime
catch  interruptedexception e
break
default
throw new ioexception     code
throw new ioexception
public void close   throws ioexception
client shutdown
public result get get get  throws ioexception
timerange range   get gettimerange
string spec   buildrowspec get getrow    get getfamilymap
range getmin    range getmax    get getmaxversions
if  get getfilter      null
log warn
result results   getresults spec
if  results length > 0
if  results length > 1
log warn     results length
return results
else
return new result
public result get list<get> gets  throws ioexception
byte rows   new byte
int maxversions   1
int count   0
for get g gets
if   count    0
maxversions   g getmaxversions
else if  g getmaxversions      maxversions
log warn   maxversions
if  g getfilter      null
log warn
rows   g getrow
count
string spec   buildmultirowspec rows  maxversions
return getresults spec
private result getresults string spec  throws ioexception
for  int i   0  i < maxretries  i
response response   client get spec  constants mimetype_protobuf
int code   response getcode
switch  code
case 200
cellsetmodel model   new cellsetmodel
model getobjectfrommessage response getbody
result results   buildresultfrommodel model
if   results length > 0
return results
// fall through
case 404
return new result
case 509
try
thread sleep sleeptime
catch  interruptedexception e
break
default
throw new ioexception     code
throw new ioexception
public boolean exists get get  throws ioexception
log warn
result result   get get
return  result    null      result isempty
/**
* exists(list) is really a list of get() calls. just use get().
* @param gets list of get to test for the existence
*/
public boolean exists list<get> gets  throws ioexception
log warn
boolean results   new boolean
for  int i   0  i < results length  i
results   exists gets get i
return results
public void put put put  throws ioexception
cellsetmodel model   buildmodelfromput put
stringbuilder sb   new stringbuilder
sb append
sb append bytes tostringbinary name
sb append
sb append bytes tostringbinary put getrow
for  int i   0  i < maxretries  i
response response   client put sb tostring    constants mimetype_protobuf
model createprotobufoutput
int code   response getcode
switch  code
case 200
return
case 509
try
thread sleep sleeptime
catch  interruptedexception e
break
default
throw new ioexception     code
throw new ioexception
public void put list<put> puts  throws ioexception
// this is a trick: the gateway accepts multiple rows in a cell set and
// ignores the row specification in the uri
// separate puts by row
treemap<byte list<cell>> map
new treemap<byte list<cell>> bytes bytes_comparator
for  put put  puts
byte row   put getrow
list<cell> cells   map get row
if  cells    null
cells   new arraylist<cell>
map put row  cells
for  list<? extends cell> l  put getfamilymap   values
cells addall l
// build the cell set
cellsetmodel model   new cellsetmodel
for  map entry<byte  list<cell>> e  map entryset
rowmodel row   new rowmodel e getkey
for  cell cell  e getvalue
keyvalue kv   keyvalueutil ensurekeyvalue cell
row addcell new cellmodel kv
model addrow row
// build path for multiput
stringbuilder sb   new stringbuilder
sb append
sb append bytes tostringbinary name
sb append        can be any nonexistent row
for  int i   0  i < maxretries  i
response response   client put sb tostring    constants mimetype_protobuf
model createprotobufoutput
int code   response getcode
switch  code
case 200
return
case 509
try
thread sleep sleeptime
catch  interruptedexception e
break
default
throw new ioexception     code
throw new ioexception
public void delete delete delete  throws ioexception
string spec   buildrowspec delete getrow    delete getfamilymap
delete gettimestamp    delete gettimestamp    1
for  int i   0  i < maxretries  i
response response   client delete spec
int code   response getcode
switch  code
case 200
return
case 509
try
thread sleep sleeptime
catch  interruptedexception e
break
default
throw new ioexception     code
throw new ioexception
public void delete list<delete> deletes  throws ioexception
for  delete delete  deletes
delete delete
public void flushcommits   throws ioexception
// no-op
class scanner implements resultscanner
string uri
public scanner scan scan  throws ioexception
scannermodel model
try
model   scannermodel fromscan scan
catch  exception e
throw new ioexception e
stringbuffer sb   new stringbuffer
sb append
sb append bytes tostringbinary name
sb append
sb append
for  int i   0  i < maxretries  i
response response   client post sb tostring
constants mimetype_protobuf  model createprotobufoutput
int code   response getcode
switch  code
case 201
uri   response getlocation
return
case 509
try
thread sleep sleeptime
catch  interruptedexception e
break
default
throw new ioexception     code
throw new ioexception
@override
public result next int nbrows  throws ioexception
stringbuilder sb   new stringbuilder uri
sb append
sb append nbrows
for  int i   0  i < maxretries  i
response response   client get sb tostring
constants mimetype_protobuf
int code   response getcode
switch  code
case 200
cellsetmodel model   new cellsetmodel
model getobjectfrommessage response getbody
return buildresultfrommodel model
case 204
case 206
return null
case 509
try
thread sleep sleeptime
catch  interruptedexception e
break
default
throw new ioexception     code
throw new ioexception
@override
public result next   throws ioexception
result results   next 1
if  results    null    results length < 1
return null
return results
class iter implements iterator<result>
result cache
public iter
try
cache   scanner this next
catch  ioexception e
log warn stringutils stringifyexception e
@override
public boolean hasnext
return cache    null
@override
public result next
result result   cache
try
cache   scanner this next
catch  ioexception e
log warn stringutils stringifyexception e
cache   null
return result
@override
public void remove
throw new runtimeexception
@override
public iterator<result> iterator
return new iter
@override
public void close
try
client delete uri
catch  ioexception e
log warn stringutils stringifyexception e
public resultscanner getscanner scan scan  throws ioexception
return new scanner scan
public resultscanner getscanner byte family  throws ioexception
scan scan   new scan
scan addfamily family
return new scanner scan
public resultscanner getscanner byte family  byte qualifier
throws ioexception
scan scan   new scan
scan addcolumn family  qualifier
return new scanner scan
public boolean isautoflush
return true
public result getroworbefore byte row  byte family  throws ioexception
throw new ioexception
public boolean checkandput byte row  byte family  byte qualifier
byte value  put put  throws ioexception
// column to check-the-value
put add new keyvalue row  family  qualifier  value
cellsetmodel model   buildmodelfromput put
stringbuilder sb   new stringbuilder
sb append
sb append bytes tostringbinary name
sb append
sb append bytes tostringbinary put getrow
sb append
for  int i   0  i < maxretries  i
response response   client put sb tostring
constants mimetype_protobuf  model createprotobufoutput
int code   response getcode
switch  code
case 200
return true
case 304     not modified
return false
case 509
try
thread sleep sleeptime
catch  final interruptedexception e
break
default
throw new ioexception     code
throw new ioexception
public boolean checkanddelete byte row  byte family  byte qualifier
byte value  delete delete  throws ioexception
put put   new put row
// column to check-the-value
put add new keyvalue row  family  qualifier  value
cellsetmodel model   buildmodelfromput put
stringbuilder sb   new stringbuilder
sb append
sb append bytes tostringbinary name
sb append
sb append bytes tostringbinary row
sb append
for  int i   0  i < maxretries  i
response response   client put sb tostring
constants mimetype_protobuf  model createprotobufoutput
int code   response getcode
switch  code
case 200
return true
case 304     not modified
return false
case 509
try
thread sleep sleeptime
catch  final interruptedexception e
break
default
throw new ioexception     code
throw new ioexception
public result increment increment increment  throws ioexception
throw new ioexception
public result append append append  throws ioexception
throw new ioexception
public long incrementcolumnvalue byte row  byte family  byte qualifier
long amount  throws ioexception
throw new ioexception
public long incrementcolumnvalue byte row  byte family  byte qualifier
long amount  boolean writetowal  throws ioexception
throw new ioexception
@override
public void batch list<? extends row> actions  object results  throws ioexception
throw new ioexception
@override
public object batch list<? extends row> actions  throws ioexception
throw new ioexception
@override
public <r> void batchcallback list<? extends row> actions  object results
batch callback<r> callback  throws ioexception  interruptedexception
throw new ioexception
@override
public <r> object batchcallback list<? extends row> actions  batch callback<r> callback
throws ioexception  interruptedexception
throw new ioexception
@override
public coprocessorrpcchannel coprocessorservice byte row
throw new unsupportedoperationexception
@override
public <t extends service  r> map<byte  r> coprocessorservice class<t> service
byte startkey  byte endkey  batch call<t  r> callable
throws serviceexception  throwable
throw new unsupportedoperationexception
@override
public <t extends service  r> void coprocessorservice class<t> service
byte startkey  byte endkey  batch call<t  r> callable  batch callback<r> callback
throws serviceexception  throwable
throw new unsupportedoperationexception
@override
public void mutaterow rowmutations rm  throws ioexception
throw new ioexception
@override
public void setautoflush boolean autoflush
throw new unsupportedoperationexception
@override
public void setautoflush boolean autoflush  boolean clearbufferonfail
throw new unsupportedoperationexception
@override
public long getwritebuffersize
throw new unsupportedoperationexception
@override
public void setwritebuffersize long writebuffersize  throws ioexception
throw new ioexception