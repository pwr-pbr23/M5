/*
derby - class org.apache.derby.impl.store.raw.xact.xactxaresourcemanager
licensed to the apache software foundation (asf) under one or more
contributor license agreements.  see the notice file distributed with
this work for additional information regarding copyright ownership.
the asf licenses this file to you under the apache license, version 2.0
(the "license"); you may not use this file except in compliance with
the license.  you may obtain a copy of the license at
http://www.apache.org/licenses/license-2.0
unless required by applicable law or agreed to in writing, software
distributed under the license is distributed on an "as is" basis,
without warranties or conditions of any kind, either express or implied.
see the license for the specific language governing permissions and
limitations under the license.
*/
package org apache derby impl store raw xact
import org apache derby iapi reference sqlstate
import org apache derby iapi services context contextmanager
import org apache derby iapi services sanity sanitymanager
import org apache derby iapi error standardexception
import org apache derby iapi store access xa xaresourcemanager
import org apache derby iapi store access xa xaxactid
import org apache derby iapi store access accessfactoryglobals
import org apache derby iapi store raw globaltransactionid
import org apache derby iapi store raw rawstorefactory
import org apache derby iapi store raw transaction
import org apache derby impl store raw xact globalxactid
import org apache derby impl store raw xact transactiontable
import org apache derby impl store raw xact transactiontableentry
import org apache derby impl store raw xact xact
import java util enumeration
import java util hashtable
import javax transaction xa xid
import javax transaction xa xaresource
/**
the xactxaresourcemanager implements the access xaresource interface, which
provides offline control over two phase commit transactions.  it is expected
to be used by tm's (transaction manager's), to recover if systems fail while
transactions are still in-doubt (prepared).
<p>
this interface allows access to commit,prepare,abort global transactions
as part of a two phase commit protocol.  these interfaces have been chosen
to be exact implementations required to implement the xaresource interfaces
as part of the jta standard extension.
<p>
it is expected that the following interfaces are only used during the
recovery portion of 2 phase commit, when the transaction manager is
cleaning up after a runtime crash - it is expected that no current context
managers exist for the xid's being operated on.  the "online" two phase commit
protocol will be implemented by calls directly on a transactioncontroller.
<p>
the xaresource interface is a java mapping of the industry standard xa resource
manager interface.  please refer to: x/open cae specification - distributed
transaction processing: the xa specification, x/open document no. xo/cae/91/300
or isbn 1 872630 24 3.
@see org.apache.derby.iapi.store.access.xa.xaresourcemanager
**/
public class xactxaresourcemanager implements xaresourcemanager
/**************************************************************************
* fields of the class
**************************************************************************
*/
private transactiontable    transaction_table
private rawstorefactory     rsf
/**************************************************************************
* constructors for this class:
**************************************************************************
*/
public xactxaresourcemanager
rawstorefactory     rsf
transactiontable    tt
this rsf                 rsf
this transaction_table   tt
/**************************************************************************
* private/protected methods of this class:
**************************************************************************
*/
/**************************************************************************
* public methods implementing xaresourcemanager interface
**************************************************************************
*/
/**
* this method is called to commit the global transaction specified by xid.
* <p>
* resolve - how do we map to the "right" xaexceptions.
* <p>
*
* @param cm       the contextmanager returned from the find() call.
* @param xid      a global transaction identifier.
* @param onephase if true, the resource manager should use a one-phase
*                 commit protocol to commit the work done on behalf of
*                 xid.
*
* @exception  standardexception  standard exception policy.
**/
public void commit
contextmanager  cm
xid             xid
boolean         onephase
throws standardexception
transaction rawtran
rsf findusertransaction cm  accessfactoryglobals user_trans_name
// this may happen if somehow the transaction was committed between
// the find() call and now.
if  rawtran    null
throw standardexception newexception
sqlstate store_xa_protocol_violation
if  sanitymanager debug
sanitymanager assert rawtran    null
sanitymanager assert
new globalxactid
xid getformatid
xid getglobaltransactionid
xid getbranchqualifier     equals rawtran getglobalid
rawtran xa_commit onephase
/**
* find the given xid in the transaction table.
* <p>
* this routine is used to find a in-doubt transaction from the list
* of xid's returned from the recover() routine.
* <p>
* in the current implementation it is up to the calling routine
* to make the returned contextmanager the "current" contextmanager
* before calls to commit,abort, or forget.  the caller is responsible
* for error handling, ie. calling cleanuponerror() on the correct
* contextmanager.
* <p>
* if the xid is not in the system, "null" is returned.
* resolve - find out from sku if she wants a exception instead?
* <p>
*
* @param xid      a global transaction identifier.
*
**/
public contextmanager find
xid     xid
return
transaction_table findtransactioncontextbyglobalid
new globalxactid
xid getformatid
xid getglobaltransactionid
xid getbranchqualifier
/**
* this method is called to remove the given transaction
* from the transaction table/log.
* <p>
* used to let the store remove all record from log and transaction
* table of the given transaction.  this should only be used to
* clean up heuristically completed transactions, otherwise commit or
* abort should be used to act on other transactions.
* <p>
*
* @param cm       the contextmanager returned from the find() call.
* @param xid      a global transaction identifier.
*
* @exception  standardexception  standard exception policy.
**/
public void forget
contextmanager  cm
xid             xid
throws standardexception
transaction rawtran
rsf findusertransaction cm  accessfactoryglobals user_trans_name
if  sanitymanager debug
sanitymanager assert
new globalxactid
xid getformatid
xid getglobaltransactionid
xid getbranchqualifier    equals rawtran getglobalid
// forget should only be called on heuristically completed xacts, which
// should not exist in our system.
throw standardexception newexception
sqlstate store_xa_protocol_violation
/**
* this method is called to obtain a list of prepared transactions.
* <p>
* this call returns a complete list of global transactions which are
* either prepared or heuristically complete.
* <p>
* the xaresource interface expects a scan type interface, but our
* implementation only returns a complete list of transactions.  so to
* simulate the scan the following state is maintained.  if tmstartscan
* is specified the complete list is returned.  if recover is called with
* tmnoflags is ever called a 0 length array is returned.
*
* @return return a array with 0 or more xid's which are currently in
*         prepared or heuristically completed state.  if an error occurs
*         during the operation, an appropriate error is thrown.
*
* @param flags    combination of the following flags
*                 xaresource.{tmstartrscan,tmendrscan,tmnoflags}.
*                 tmnoflags must be used when no other flags are used.
*
* @exception  standardexception  standard exception policy.
**/
public xid recover int flags
throws standardexception
xaxactid ret_xid_list
if   flags   xaresource tmstartrscan     0
hashtable   trans_hashtable   transaction_table gettableforxa
xaxactid  xid_list          new xaxactid
int         num_prepared      0
// need to hold sync while linear searching the hash table.
synchronized  trans_hashtable
int i   0
for  enumeration e   trans_hashtable elements
e hasmoreelements    i
xact xact
transactiontableentry  e nextelement    getxact
if  xact isprepared
globaltransactionid xa_id   xact getglobalid
xid_list
new xaxactid
xa_id getformat_id
xa_id getglobaltransactionid
xa_id getbranchqualifier
num_prepared
// now need to squish the nulls out of the array to return.
ret_xid_list   new xaxactid
int ret_index   0
for  int i   xid_list length  i   > 0
if  xid_list    null
ret_xid_list   xid_list
if  sanitymanager debug
sanitymanager assert ret_index    num_prepared
else
ret_xid_list   new xaxactid
return ret_xid_list
/**
* rollback the transaction identified by xid.
* <p>
* the given transaction is roll'ed back and it's history is not
* maintained in the transaction table or long term log.
* <p>
*
* @param cm       the contextmanager returned from the find() call.
* @param xid      a global transaction identifier.
*
* @exception  standardexception  standard exception policy.
**/
public void rollback
contextmanager  cm
xid             xid
throws standardexception
transaction rawtran
rsf findusertransaction cm  accessfactoryglobals user_trans_name
// this may happen if somehow the transaction was committed between
// the find() call and now.
if  rawtran    null
throw standardexception newexception
sqlstate store_xa_protocol_violation
if  sanitymanager debug
sanitymanager assert
new globalxactid
xid getformatid
xid getglobaltransactionid
xid getbranchqualifier    equals rawtran getglobalid
rawtran xa_rollback
/**************************************************************************
* public methods of xxxx class:
**************************************************************************
*/