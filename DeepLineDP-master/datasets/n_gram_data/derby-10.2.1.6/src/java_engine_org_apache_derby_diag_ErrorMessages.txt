/*
derby - class org.apache.derby.diag.errormessages
licensed to the apache software foundation (asf) under one or more
contributor license agreements.  see the notice file distributed with
this work for additional information regarding copyright ownership.
the asf licenses this file to you under the apache license, version 2.0
(the "license"); you may not use this file except in compliance with
the license.  you may obtain a copy of the license at
http://www.apache.org/licenses/license-2.0
unless required by applicable law or agreed to in writing, software
distributed under the license is distributed on an "as is" basis,
without warranties or conditions of any kind, either express or implied.
see the license for the specific language governing permissions and
limitations under the license.
*/
package org apache derby diag
import java util hashtable
import java util enumeration
import java sql resultsetmetadata
import java sql sqlexception
import java sql types
import java util properties
import java io ioexception
import java io inputstream
import java util enumeration
import org apache derby vti vticosting
import org apache derby vti vtienvironment
import java lang math
import org apache derby iapi error standardexception
import org apache derby iapi error exceptionseverity
import org apache derby iapi services i18n messageservice
import org apache derby iapi reference limits
import org apache derby iapi util stringutil
import org apache derby vti vtitemplate
import org apache derby vti vticosting
import org apache derby vti vtienvironment
import org apache derby impl jdbc embedresultsetmetadata
import org apache derby iapi sql resultcolumndescriptor
/**
* errormessage shows all the sqlstates, locale-sensitive error
* messages, and exception severities for a database.
*
* <p>to use it, query it as follows:</p>
* <pre> select* from new org.apache.derby.diag.errormessages() as eq; </pre>
* <p>the following columns will be returned:
* <ul><li>sql_state--varchar(5) - nullable.  the sqlstate of the sqlexception.<br>
* (the code returned by getsqlstate() in sqlexception.)</li>
* <li>message--varchar(32672) - nullable.  the error message<br>
* (the code returned by getmessage() in sqlexception.)</li>
* <li>severity--integer - nullable.  the cloudscape code for the severity.<br>
* (the code returned by geterrorcode() in sqlexception.)</li>
* </ul>
*
*/
public final class errormessages extends vtitemplate implements vticosting  java security privilegedaction
/* the name of the file containing all the sqlstate codes.
* the class gets the sqlstate code from the messages
* file (messages_en.properties). then it uses standardexception to get
* the exception severities and locale-sensitive error messages.
*/
/**          */
private properties p
/**          */
private enumeration keys
/**          */
private string k
/**          */
private string sqlstate
/**          */
private string message
/**          */
private int severity
/**          */
public errormessages   throws ioexception
loadproperties
/**          *
* @see java.sql.resultset#next
*/
public boolean next
boolean retcode   true
if   keys hasmoreelements
close
retcode   false
return retcode
k    string keys nextelement
if  notanexception
retcode   next
if  retcode
sqlstate  standardexception getsqlstatefromidentifier k
message   messageservice gettextmessage k
message   stringutil truncate message  limits db2_varchar_maxwidth
return retcode
/**          *
* @see java.sql.resultset#close
*/
public void close
p   null
k   null
keys   null
/**          *
* @see java.sql.resultset#getmetadata
*/
public resultsetmetadata getmetadata
return metadata
/**      *
* @exception sqlexception column at index is not found
* @see java.sql.resultset#getstring
*/
public string getstring int columnindex  throws sqlexception
switch  columnindex
case 1  return sqlstate
case 2  return message
default  return super getstring columnindex      throw an exception
/**      *
* @exception sqlexception column at index is not found
* @see java.sql.resultset#getint
*/
public int getint int columnindex  throws sqlexception
switch  columnindex
case 3  return severity
default  return super getint columnindex      throw an exception
/**          */
private void loadproperties   throws ioexception
p   new properties
for  int i   0  i < 50  i
msgfile   i
inputstream is    inputstream  java security accesscontroller doprivileged this
if  is    null
continue
try
p load is
finally
try
is close
catch  ioexception ioe
keys   p keys
/**          */
private boolean notanexception
if  k length   < 5
return true
int tempseverity   standardexception getseverityfromidentifier k
//if the severity is not one of our customer-visible severity
//levels, it's just a message, not an sqlexception
if  tempseverity <  exceptionseverity no_applicable_severity   1
return true
severity   tempseverity
return false
/*vticosting methods*/
/**          */
public double getestimatedrowcount vtienvironment vtienvironment
return 1000
/**          */
public double getestimatedcostperinstantiation vtienvironment vtienvironment
return 5000
/**          */
public boolean supportsmultipleinstantiations vtienvironment vtienvironment
return true
private int msgfile
public final object run
inputstream msg   getclass   getresourceasstream     msgfile
msgfile   0
return msg
/*
** metadata
*/
private static final resultcolumndescriptor columninfo
embedresultsetmetadata getresultcolumndescriptor     types varchar  true  5
embedresultsetmetadata getresultcolumndescriptor       types varchar  true  limits db2_varchar_maxwidth
embedresultsetmetadata getresultcolumndescriptor      types integer  true
private static final resultsetmetadata metadata   new embedresultsetmetadata columninfo