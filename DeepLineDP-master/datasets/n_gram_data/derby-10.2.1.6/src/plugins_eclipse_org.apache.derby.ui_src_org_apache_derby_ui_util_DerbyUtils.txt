/*
derby - class org.apache.derby.ui.util.derbyutils
licensed to the apache software foundation (asf) under one or more
contributor license agreements.  see the notice file distributed with
this work for additional information regarding copyright ownership.
the asf licenses this file to you under the apache license, version 2.0
(the "license"); you may not use this file except in compliance with
the license.  you may obtain a copy of the license at
http://www.apache.org/licenses/license-2.0
unless required by applicable law or agreed to in writing, software
distributed under the license is distributed on an "as is" basis,
without warranties or conditions of any kind, either express or implied.
see the license for the specific language governing permissions and
limitations under the license.
*/
package org apache derby ui util
import java net url
import java util arraylist
import java util list
import org apache derby ui derbyplugin
import org apache derby ui common commonnames
import org apache derby ui properties derbyproperties
import org eclipse core resources ifile
import org eclipse core resources iproject
import org eclipse core runtime coreexception
import org eclipse core runtime ipath
import org eclipse core runtime istatus
import org eclipse core runtime path
import org eclipse core runtime platform
import org eclipse debug core debugplugin
import org eclipse debug core ilaunch
import org eclipse debug core ilaunchconfiguration
import org eclipse debug core ilaunchconfigurationtype
import org eclipse debug core ilaunchconfigurationworkingcopy
import org eclipse debug core ilaunchmanager
import org eclipse debug core model iprocess
import org eclipse jdt core iclasspathentry
import org eclipse jdt core javacore
import org eclipse jdt launching ijavalaunchconfigurationconstants
import org eclipse jdt launching iruntimeclasspathentry
import org eclipse jdt launching javaruntime
import org eclipse osgi util manifestelement
import org osgi framework bundle
import org osgi framework bundleexception
import org osgi framework constants
public class derbyutils
private static manifestelement getelements string bundlename  throws bundleexception
string requires    string platform getbundle bundlename  getheaders   get constants bundle_classpath
return manifestelement parseheader constants bundle_classpath  requires
public static iclasspathentry addderbyjars iclasspathentry rawcp  throws exception
iclasspathentry newrawcp  null
try
//new osgi way
manifestelement elements_core  elements_ui
elements_core   getelements commonnames core_path
elements_ui getelements commonnames ui_path
bundle bundle platform getbundle commonnames core_path
url pluginurl   bundle getentry
url jarurl null
url localurl null
newrawcp new iclasspathentry
system arraycopy rawcp  0  newrawcp  0  rawcp length
//add the core jars
int oldlength rawcp length
for int i 0 i<elements_core length i
jarurl  new url pluginurl elements_core getvalue
localurl platform aslocalurl jarurl
newrawcp javacore newlibraryentry new path localurl getpath     null  null
// add the ui jars
bundle platform getbundle commonnames ui_path
pluginurl   bundle getentry
oldlength oldlength elements_core length  1
for int i 0 i<elements_ui length i
if   elements_ui getvalue   tolowercase   equals
jarurl  new url pluginurl elements_ui getvalue
localurl platform aslocalurl jarurl
newrawcp javacore newlibraryentry new path localurl getpath     null  null
return newrawcp
catch exception e
throw e
public static iclasspathentry removederbyjars iclasspathentry rawcp  throws exception
arraylist arrl new arraylist
for  int i 0 i<rawcp length i
arrl add rawcp
iclasspathentry newrawcp  null
try
manifestelement elements_core  elements_ui
elements_core   getelements commonnames core_path
elements_ui getelements commonnames ui_path
bundle bundle
url pluginurl jarurl localurl
boolean add
iclasspathentry icp null
for  int j 0 j<arrl size   j
bundle platform getbundle commonnames core_path
pluginurl   bundle getentry
add true
icp  iclasspathentry arrl get j
//remove 'core' jars
for  int i 0 i<elements_core length i
jarurl  new url pluginurl elements_core getvalue
localurl platform aslocalurl jarurl
if   icp  equals javacore newlibraryentry new path localurl getpath     null  null
icp getpath   tostring   tolowercase   endswith
icp getpath   tostring   tolowercase   endswith
icp getpath   tostring   tolowercase   endswith
icp getpath   tostring   tolowercase   endswith
add false
if  add
arrl remove j
j j 1
//remove 'ui' jars
bundle platform getbundle commonnames ui_path
pluginurl   bundle getentry
add true
for  int i 0 i<elements_ui length i
if   elements_ui getvalue   tolowercase   equals
jarurl  new url pluginurl elements_ui getvalue
localurl platform aslocalurl jarurl
if  icp  equals javacore newlibraryentry new path localurl getpath     null  null
add false
if  add
arrl remove j
j j 1
newrawcp new iclasspathentry
for  int i 0 i<arrl size   i
newrawcp  iclasspathentry arrl get i
return newrawcp
catch exception e
e printstacktrace
//return rawcp;
throw e
protected static ilaunch launch iproject proj  string name  string mainclass  string args  string vmargs  string app  throws coreexception
ilaunchmanager manager   debugplugin getdefault   getlaunchmanager
ilaunchconfigurationtype type null
if app equalsignorecase commonnames start_derby_server
//type= manager.getlaunchconfigurationtype("org.apache.derby.ui.startderbyserverlaunchconfigurationtype");
type  manager getlaunchconfigurationtype commonnames start_server_launch_config_type
else if app equalsignorecase commonnames shutdown_derby_server
//type= manager.getlaunchconfigurationtype("org.apache.derby.ui.stopderbyserverlaunchconfigurationtype");
type  manager getlaunchconfigurationtype commonnames stop_server_launch_config_type
else if app equalsignorecase commonnames ij
//type= manager.getlaunchconfigurationtype("org.apache.derby.ui.ijderbylaunchconfigurationtype");
type  manager getlaunchconfigurationtype commonnames ij_launch_config_type
else if app equalsignorecase commonnames sysinfo
//type= manager.getlaunchconfigurationtype("org.apache.derby.ui.sysinfoderbylaunchconfigurationtype");
type  manager getlaunchconfigurationtype commonnames sysinfo_launch_config_type
else
type   manager getlaunchconfigurationtype ijavalaunchconfigurationconstants id_java_application
ilaunchconfiguration config   null
// if the configuration already exists, delete it
ilaunchconfiguration configurations   manager getlaunchconfigurations type
for  int i   0  i < configurations length  i
if  configurations getname   equals name
configurations delete
// else create a new one
if  config    null
ilaunchconfigurationworkingcopy wc   type newinstance null  name
wc setattribute ijavalaunchconfigurationconstants attr_project_name
proj getproject   getname
// current directory should be the project root
wc setattribute ijavalaunchconfigurationconstants attr_working_directory
proj getproject   getlocation   tostring
// use the suplied args
if  vmargs  null     vmargs equals
wc setattribute ijavalaunchconfigurationconstants attr_vm_arguments  vmargs
wc setattribute ijavalaunchconfigurationconstants attr_main_type_name
mainclass
wc setattribute ijavalaunchconfigurationconstants attr_program_arguments
args
// saves the new config
config   wc dosave
ilaunch launch config launch ilaunchmanager run_mode  null
config delete
return launch
public static void runij ifile currentscript  iproject currentproject  throws coreexception
string launchtype
string args
//the above some times throws wrong 'create=true|false' errors
string vmargs
derbyproperties dprop new derbyproperties currentproject
if  dprop getsystemhome    null      dprop getsystemhome   equals
vmargs  commonnames d_system_home dprop getsystemhome
if currentscript  null
launchtype commonnames sql_script
//preferable to use the full string with quotes to take care of spaces
//in file names
args
else
launchtype commonnames ij
args
ilaunch launch launch currentproject launchtype commonnames ij_class args  vmargs  commonnames ij
iprocess ip launch getprocesses
string procname   currentproject getname     commonnames ij   args
ip setattribute iprocess attr_process_label procname
public static void runsysinfo iproject currentproject  throws coreexception
string args
ilaunch launch launch currentproject commonnames sysinfo commonnames sysinfo_class args  null  commonnames sysinfo
iprocess ip launch getprocesses
string procname   currentproject getname     commonnames sysinfo
ip setattribute iprocess attr_process_label procname
//another launch mechanism
public void launch   throws coreexception
derbyplugin plugin   derbyplugin getdefault
// constructs a classpath from the default jre...
ipath systemlibs   new path javaruntime jre_container
iruntimeclasspathentry systemlibsentry   javaruntime newruntimecontainerclasspathentry
systemlibs  iruntimeclasspathentry standard_classes
systemlibsentry setclasspathproperty iruntimeclasspathentry bootstrap_classes
//include org.apache.derby.core plugin
iruntimeclasspathentry derbycpentry   null
list classpath   new arraylist
classpath add systemlibsentry getmemento
try
manifestelement elements_core  elements_ui
elements_core   getelements commonnames core_path
elements_ui getelements commonnames ui_path
bundle bundle
url pluginurl jarurl localurl
bundle platform getbundle commonnames core_path
pluginurl   bundle getentry
for int i 0 i<elements_core length i
if  elements_core getvalue   tolowercase   endswith
jarurl  new url pluginurl elements_core getvalue
localurl platform aslocalurl jarurl
derbycpentry   javaruntime newarchiveruntimeclasspathentry new path localurl getpath
derbycpentry setclasspathproperty iruntimeclasspathentry user_classes
classpath add derbycpentry getmemento
bundle platform getbundle commonnames core_path
pluginurl   bundle getentry
for int i 0 i<elements_ui length i
if  elements_ui getvalue   tolowercase   equals
jarurl  new url pluginurl elements_ui getvalue
localurl platform aslocalurl jarurl
derbycpentry   javaruntime newarchiveruntimeclasspathentry new path localurl getpath
derbycpentry setclasspathproperty iruntimeclasspathentry user_classes
classpath add derbycpentry getmemento
catch exception e
e printstacktrace
logger log   e istatus error