/*
derby - class org.apache.derby.impl.store.raw.xact.endxact
licensed to the apache software foundation (asf) under one or more
contributor license agreements.  see the notice file distributed with
this work for additional information regarding copyright ownership.
the asf licenses this file to you under the apache license, version 2.0
(the "license"); you may not use this file except in compliance with
the license.  you may obtain a copy of the license at
http://www.apache.org/licenses/license-2.0
unless required by applicable law or agreed to in writing, software
distributed under the license is distributed on an "as is" basis,
without warranties or conditions of any kind, either express or implied.
see the license for the specific language governing permissions and
limitations under the license.
*/
package org apache derby impl store raw xact
import org apache derby iapi services io formatidutil
import org apache derby iapi services io storedformatids
import org apache derby iapi services sanity sanitymanager
import org apache derby iapi store raw transaction
import org apache derby iapi store raw loggable
import org apache derby iapi store raw globaltransactionid
import org apache derby iapi store raw log loginstant
import org apache derby iapi store raw xact rawtransaction
import org apache derby iapi services io compressednumber
import org apache derby iapi util bytearray
import java io outputstream
import java io inputstream
import java io objectoutput
import java io objectinput
import java io ioexception
import org apache derby iapi services io limitobjectinput
/**
this operation indicates the end of a transaction.
@see loggable
*/
public class endxact implements loggable
private int transactionstatus
private globaltransactionid xactid
public endxact globaltransactionid xid  int s
super
xactid   xid
transactionstatus   s
/*
* formatable methods
*/
// no-arg constructor, required by formatable
public endxact
super
public void writeexternal objectoutput out  throws ioexception
out writeobject xactid
compressednumber writeint out  transactionstatus
public void readexternal objectinput in  throws ioexception  classnotfoundexception
xactid    globaltransactionid in readobject
transactionstatus   compressednumber readint in
/**
return my format identifier.
*/
public int gettypeformatid
return storedformatids logop_end_xact
/**
loggable methods
@see loggable
*/
/**
apply the change indicated by this operation and optional data.
@param xact			the transaction
@param instant		the log instant of this operation
@param in			optional data
*/
public void dome transaction xact  loginstant instant  limitobjectinput in
if   transactionstatus   xact end_prepared     0
rawtransaction xact  removeupdatetransaction
else
rawtransaction xact  preparetransaction
/**
the default for prepared log is always null for all the operations
that don't have optionaldata.  if an operation has optional data,
the operation need to prepare the optional data for this method.
endxact has no optional data to write out
@see objectoutput
*/
public bytearray getpreparedlog
return  bytearray  null
/**
always redo an endxact.
@param xact		the transaction trying to redo this operation
@return true if operation needs redoing, false if not.
*/
public boolean needsredo transaction xact
return true 			   always redo this
/**
endxact has no resource to release
*/
public void releaseresource transaction xact
/**
endxact is a rawstore log record.
*/
public int group
int group   loggable rawstore
if   transactionstatus   xact end_committed     0
group     loggable commit   loggable last
else if   transactionstatus   xact end_aborted     0
group     loggable abort   loggable last
else if   transactionstatus   xact end_prepared     0
group    loggable prepare
return group
/**
debug: print self.
*/
public string tostring
if  sanitymanager debug
string endstatus
switch transactionstatus
xact end_aborted   xact end_prepared   xact end_committed
case xact end_aborted
endstatus
break
case xact end_prepared
endstatus
break
case xact end_committed
endstatus
break
default
endstatus
return
xactid   endstatus
endstatus
else
return null