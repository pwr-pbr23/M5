/*
derby - class org.apache.derby.impl.sql.compile.dropindexnode
licensed to the apache software foundation (asf) under one or more
contributor license agreements.  see the notice file distributed with
this work for additional information regarding copyright ownership.
the asf licenses this file to you under the apache license, version 2.0
(the "license"); you may not use this file except in compliance with
the license.  you may obtain a copy of the license at
http://www.apache.org/licenses/license-2.0
unless required by applicable law or agreed to in writing, software
distributed under the license is distributed on an "as is" basis,
without warranties or conditions of any kind, either express or implied.
see the license for the specific language governing permissions and
limitations under the license.
*/
package	org apache derby impl sql compile
import org apache derby iapi services context contextmanager
import org apache derby iapi sql compile compilercontext
import org apache derby iapi sql dictionary conglomeratedescriptor
import org apache derby iapi sql dictionary constraintdescriptor
import org apache derby iapi sql dictionary datadictionary
import org apache derby iapi sql dictionary datadictionarycontext
import org apache derby iapi sql dictionary schemadescriptor
import org apache derby iapi sql dictionary tabledescriptor
import org apache derby iapi reference sqlstate
import org apache derby iapi sql execute constantaction
import org apache derby iapi sql dictionary schemadescriptor
import org apache derby iapi error standardexception
/**
* a dropindexnode is the root of a querytree that represents a drop index
* statement.
*
* @author jeff lichtman
*/
public class dropindexnode extends ddlstatementnode
private conglomeratedescriptor	cd
private tabledescriptor			td
public string statementtostring
return
/**
* bind this dropindexnode.  this means looking up the index,
* verifying it exists and getting the conglomerate number.
*
* @return	the bound query tree
*
* @exception standardexception		thrown on error
*/
public querytreenode bind   throws standardexception
compilercontext			cc   getcompilercontext
datadictionary			dd   getdatadictionary
schemadescriptor		sd
sd   getschemadescriptor
if  sd getuuid      null
cd   dd getconglomeratedescriptor getrelativename    sd  false
if  cd    null
throw standardexception newexception sqlstate lang_index_not_found  getfullname
/* get the table descriptor */
td   gettabledescriptor cd gettableid
/* drop index is not allowed on an index backing a constraint -
* user must drop the constraint, which will drop the index.
* drop constraint drops the constraint before the index,
* so it's okay to drop a backing index if we can't find its
* constraintdescriptor.
*/
if  cd isconstraint
constraintdescriptor condesc
string constraintname
condesc   dd getconstraintdescriptor td  cd getuuid
if  condesc    null
constraintname   condesc getconstraintname
throw standardexception newexception sqlstate lang_cant_drop_backing_index
getfullname    constraintname
/* statement is dependent on the tabledescriptor and conglomeratedescriptor */
cc createdependency td
cc createdependency cd
return this
// inherit generate() method from ddlstatementnode
/**
* create the constant information that will drive the guts of execution.
*
* @exception standardexception		thrown on failure
*/
public constantaction	makeconstantaction   throws standardexception
return	getgenericconstantactionfactory   getdropindexconstantaction  getfullname
getrelativename
getrelativename
getschemadescriptor   getschemaname
td getuuid
td getheapconglomerateid