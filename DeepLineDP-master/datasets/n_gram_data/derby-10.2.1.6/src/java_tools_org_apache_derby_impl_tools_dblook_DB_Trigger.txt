/*
derby - class org.apache.derby.impl.tools.dblook.db_trigger
licensed to the apache software foundation (asf) under one or more
contributor license agreements.  see the notice file distributed with
this work for additional information regarding copyright ownership.
the asf licenses this file to you under the apache license, version 2.0
(the "license"); you may not use this file except in compliance with
the license.  you may obtain a copy of the license at
http://www.apache.org/licenses/license-2.0
unless required by applicable law or agreed to in writing, software
distributed under the license is distributed on an "as is" basis,
without warranties or conditions of any kind, either express or implied.
see the license for the specific language governing permissions and
limitations under the license.
*/
package org apache derby impl tools dblook
import java sql connection
import java sql statement
import java sql preparedstatement
import java sql resultset
import java sql sqlexception
import java util hashmap
import java util stringtokenizer
import org apache derby tools dblook
public class db_trigger
/* ************************************************
* generate the ddl for all triggers in a given
* database.
* @param conn connection to the source database.
* @return the ddl for the triggers has been written
*  to output via logs.java.
****/
public static void dotriggers  connection conn
throws sqlexception
statement stmt   conn createstatement
resultset rs   stmt executequery
boolean firsttime   true
while  rs next
string trigname   dblook addquotes
dblook expanddoublequotes rs getstring 1
string trigschema   dblook lookupschemaid rs getstring 2
if  dblook isignorableschema trigschema
continue
trigname   trigschema       trigname
string tablename   dblook lookuptableid rs getstring 6
// we'll write the ddl for this trigger if either 1) it is on
// a table in the user-specified list, or 2) the trigger text
// contains a reference to a table in the user-specified list.
if   dblook stringcontainstargettable rs getstring 8
dblook isexcludedtable tablename
continue
if  firsttime
logs reportstring
logs reportmessage
logs reportstring
string createtrigstring   createtrigger trigname
tablename  rs
logs writetonewddl createtrigstring
logs writestmtendtonewddl
logs writenewlinetonewddl
firsttime   false
rs close
stmt close
/* ************************************************
* generate ddl for a specific trigger.
* @param trigname name of the trigger.
* @param tablename name of the table on which the trigger
*  fires.
* @param atrig information about the trigger.
* @return the ddl for the current trigger is returned
*  as a string.
****/
private static string createtrigger string trigname  string tablename
resultset atrig  throws sqlexception
stringbuffer sb   new stringbuffer
sb append trigname
// firing time.
if  atrig getstring 4  charat 0
sb append
else
sb append
// event.
switch  atrig getstring 3  charat 0
case   	sb append
break
case   	sb append
break
case   	sb append
string updatecols   atrig getstring 7
if   atrig wasnull
sb append
sb append dblook getcolumnlistfromdescription
atrig getstring 6   updatecols
break
default 	   shouldn't happen
logs debug
atrig getstring 3    string null
break
// on table...
sb append
sb append tablename
// referencing...
char trigtype   atrig getstring 5  charat 0
string oldreferencing   atrig getstring 11
string newreferencing   atrig getstring 12
if   oldreferencing    null      newreferencing    null
sb append
if  atrig getboolean 9
sb append
if  trigtype
// statement triggers work on tables.
sb append
else
// don't include "row" keyword (db2 doesn't).
sb append
sb append oldreferencing
if  atrig getboolean 10
sb append
if  trigtype
// statement triggers work on tables.
sb append
else
// don't include "row" keyword (db2 doesn't).
sb append
sb append newreferencing
// trigger type (row/statement).
sb append
if  trigtype
sb append
else
sb append
// db2 requires the following keywords in order to work.
sb append
// finally, the trigger action.
sb append dblook removenewlines atrig getstring 8
return sb tostring