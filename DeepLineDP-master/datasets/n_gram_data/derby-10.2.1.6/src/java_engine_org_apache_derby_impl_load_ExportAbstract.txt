/*
derby - class org.apache.derby.impl.load.exportabstract
licensed to the apache software foundation (asf) under one or more
contributor license agreements.  see the notice file distributed with
this work for additional information regarding copyright ownership.
the asf licenses this file to you under the apache license, version 2.0
(the "license"); you may not use this file except in compliance with
the license.  you may obtain a copy of the license at
http://www.apache.org/licenses/license-2.0
unless required by applicable law or agreed to in writing, software
distributed under the license is distributed on an "as is" basis,
without warranties or conditions of any kind, either express or implied.
see the license for the specific language governing permissions and
limitations under the license.
*/
package org apache derby impl load
import java sql connection
import java sql resultset
import java sql resultsetmetadata
import java sql types
import java util date
/**
*
* <p>
*/
abstract class exportabstract
protected controlinfo controlfilereader
protected exportresultsetforobject exportresultsetforobject
protected exportwritedataabstract exportwritedata
protected connection con
protected string entityname     this can be a plain table name or qualified with schema also
protected string schemaname
protected string selectstatement
//following makes the resultset using select * from entityname
protected resultset resultsetforentity   throws exception
exportresultsetforobject   new exportresultsetforobject con  schemaname
entityname
selectstatement
resultset rs   exportresultsetforobject getresultset
return rs
//convert resultset data to string array
public string getonerowatatime resultset rs  throws exception
int columncount   exportresultsetforobject getcolumncount
resultsetmetadata rsm rs getmetadata
if  rs next
string rowobjects   new string
for  int colnum   0  colnum < columncount  colnum
rowobjects rs getstring colnum   1
return rowobjects
rs close
exportresultsetforobject close
return null
//returns the control file reader corresponding to the control file passed
protected controlinfo getcontrolfilereader
return controlfilereader
protected abstract exportwritedataabstract getexportwritedata   throws exception
protected void doallthework   throws exception
resultset rs   null
try
rs   resultsetforentity
if  rs    null
resultsetmetadata rsmeta   rs getmetadata
int ncols   rsmeta getcolumncount
boolean isnumeric   new boolean
for  int i   0  i < ncols  i
int ctype   rsmeta getcolumntype i 1
if  ctype    types bigint    ctype    types decimal    ctype    types double
ctype    types float   ctype    types integer    ctype    types numeric
ctype    types real   ctype    types smallint    ctype    types tinyint
isnumeric   true
else
isnumeric   false
exportwritedata   getexportwritedata
exportwritedata writecolumndefinitionoptionally
exportresultsetforobject getcolumndefinition
exportresultsetforobject getcolumntypes
exportwritedata setcolumnlengths controlfilereader getcolumnwidths
//get one row at a time and write it to the output file
string onerow   getonerowatatime rs
while  onerow    null
exportwritedata writedata onerow  isnumeric
onerow   getonerowatatime rs
finally
//cleanup work after no more rows
if  exportwritedata    null
exportwritedata nomorerows
if  rs    null
rs close