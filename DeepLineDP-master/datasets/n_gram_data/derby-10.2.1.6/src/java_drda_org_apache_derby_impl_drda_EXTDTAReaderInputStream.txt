/*
derby - class org.apache.derby.impl.drda.extdtareaderinputstream
licensed to the apache software foundation (asf) under one
or more contributor license agreements.  see the notice file
distributed with this work for additional information
regarding copyright ownership.  the asf licenses this file
to you under the apache license, version 2.0 (the
"license"); you may not use this file except in compliance
with the license.  you may obtain a copy of the license at
http://www.apache.org/licenses/license-2.0
unless required by applicable law or agreed to in writing,
software distributed under the license is distributed on an
"as is" basis, without warranties or conditions of any
kind, either express or implied.  see the license for the
specific language governing permissions and limitations
under the license.
*/
package org apache derby impl drda
import java io inputstream
import java io bytearrayinputstream
import java io ioexception
/**
* implementation of inputstream which get extdta from the ddmreader.
* this class can be used to stream lobs from network client to the
* network server.
*/
final class extdtareaderinputstream extends inputstream
/**
* constructor
* @param reader the reader to get data from
* @exception drdaprotocolexception if thrown while initializing current
*                                  buffer.
*/
extdtareaderinputstream final ddmreader reader
throws drdaprotocolexception
super
this reader   reader
this length   reader getddmlength
this remainingbytes   length
this currentbuffer
reader readlobinitstream remainingbytes
/**
* reads the next byte of data from the input stream.
*
* <p> this subclass of inputstream implements this method by reading
* the next byte from the current buffer. if there is more data,
* it will be requested a new buffer from the ddmreader.
*
* @return     the next byte of data, or <code>-1</code> if the end of the
*             stream is reached.
* @exception  ioexception  if an i/o error occurs.
* @see        java.io.inputstream#read()
*/
public final int read
throws ioexception
if  remainingbytes <  0
return  1
int val    currentbuffer    null  ?  1   currentbuffer read
if  val < 0
val   refreshcurrentbuffer
remainingbytes
return val
/**
* reads up to <code>len</code> bytes of data from the input stream into
* an array of bytes.  an attempt is made to read as many as
* <code>len</code> bytes, but a smaller number may be read, possibly
* zero. the number of bytes actually read is returned as an integer.
*
* this subclass implements this method by calling this method on the
* current buffer, which is an instance of bytearrayinputstream. if the
* current buffer does not have any data, it will be requested a new
* buffer from the ddmreader.
*
* @param      b     the buffer into which the data is read.
* @param      off   the start offset in array <code>b</code>
*                   at which the data is written.
* @param      len   the maximum number of bytes to read.
* @return     the total number of bytes read into the buffer, or
*             <code>-1</code> if there is no more data because the end of
*             the stream has been reached.
* @exception  ioexception  if an i/o error occurs.
* @exception  nullpointerexception  if <code>b</code> is <code>null</code>.
* @see        java.io.inputstream#read(byte[], int, int)
*/
public final int read final byte b
final int off
final int len
throws ioexception
if  remainingbytes <  0
return  1
int val   currentbuffer read b  off  len
if  val < 0
currentbuffer
reader readlobcontinuationstream remainingbytes
val   currentbuffer read b  off  len
remainingbytes    val
return val
/**
* returns the number of bytes that can be read (or skipped over) from
* this input stream without blocking by the next caller of a method for
* this input stream.
*
* <p> this subclass implements this method by calling available on
*     the current buffer, which is a byteinputstreamreader.
*
* @return     the number of bytes that can be read from this input stream
*             without blocking.
*/
public final int available
if  remainingbytes <  0
return 0
return currentbuffer available
/**
* return the length if this stream. the length includes data which has
* been read.
* @return length of this stream.
*/
final long getlength
return length
/**
* refresh the current buffer from the ddmreader
* @exception ioexception if there is a ioexception when
*                        refreshing the buffer from ddmreader
* @return the next byte of data, or <code>-1</code> if the end of the
*         stream is reached.
*/
private int refreshcurrentbuffer
throws ioexception
if  remainingbytes > 0
currentbuffer
reader readlobcontinuationstream remainingbytes
return currentbuffer read
else
return  1
/** length of stream */
private final long length
/** ddmreader. used to get more data. */
private final ddmreader reader
/** remaining bytes in stream */
private long remainingbytes
/** current data buffer */
private bytearrayinputstream currentbuffer