/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache activemq broker util
import java io ioexception
import java util set
import org apache activemq broker brokerpluginsupport
import org apache activemq broker connection
import org apache activemq broker connectioncontext
import org apache activemq broker consumerbrokerexchange
import org apache activemq broker producerbrokerexchange
import org apache activemq broker region destination
import org apache activemq broker region messagereference
import org apache activemq broker region subscription
import org apache activemq command activemqdestination
import org apache activemq command brokerinfo
import org apache activemq command connectioninfo
import org apache activemq command consumerinfo
import org apache activemq command destinationinfo
import org apache activemq command message
import org apache activemq command messageack
import org apache activemq command messagedispatch
import org apache activemq command messagedispatchnotification
import org apache activemq command messagepull
import org apache activemq command producerinfo
import org apache activemq command removesubscriptioninfo
import org apache activemq command response
import org apache activemq command sessioninfo
import org apache activemq command transactionid
import org apache activemq usage usage
import org apache commons logging log
import org apache commons logging logfactory
import org springframework beans factory initializingbean
/**
* a simple broker intercepter which allows you to enable/disable logging.
*
* @org.apache.xbean.xbean
*/
public class loggingbrokerplugin extends brokerpluginsupport implements
initializingbean
private static final log log   logfactory getlog loggingbrokerplugin class
private boolean logall   false
private boolean logmessageevents   false
private boolean logconnectionevents   true
private boolean logtransactionevents   false
private boolean logconsumerevents   false
private boolean logproducerevents   false
private boolean loginternalevents   false
public void afterpropertiesset   throws exception
log info     this tostring
public boolean islogall
return logall
/**
* log all events that go through the plugin
*/
public void setlogall boolean logall
this logall   logall
public boolean islogmessageevents
return logmessageevents
/**
* log events that are related to message processing
*/
public void setlogmessageevents boolean logmessageevents
this logmessageevents   logmessageevents
public boolean islogconnectionevents
return logconnectionevents
/**
* log events that are related to connections and sessions
*/
public void setlogconnectionevents boolean logconnectionevents
this logconnectionevents   logconnectionevents
public boolean islogtransactionevents
return logtransactionevents
/**
* log events that are related to transaction processing
*/
public void setlogtransactionevents boolean logtransactionevents
this logtransactionevents   logtransactionevents
public boolean islogconsumerevents
return logconsumerevents
/**
* log events that are related to consumers
*/
public void setlogconsumerevents boolean logconsumerevents
this logconsumerevents   logconsumerevents
public boolean islogproducerevents
return logproducerevents
/**
* log events that are related to producers
*/
public void setlogproducerevents boolean logproducerevents
this logproducerevents   logproducerevents
public boolean isloginternalevents
return loginternalevents
/**
* log events that are normally internal to the broker
*/
public void setloginternalevents boolean loginternalevents
this loginternalevents   loginternalevents
public void acknowledge consumerbrokerexchange consumerexchange
messageack ack  throws exception
if  islogall      islogconsumerevents
log info
consumerexchange getconnectioncontext   getclientid
ack getmessagecount      1 ?     ack getlastmessageid
if  log istraceenabled      ack getmessagecount   > 1
log trace     ack getmessagecount
ack getfirstmessageid
ack getlastmessageid
super acknowledge consumerexchange  ack
public response messagepull connectioncontext context  messagepull pull
throws exception
if  islogall      islogconsumerevents
log info     context getclientid
pull getdestination   getphysicalname
return super messagepull context  pull
public void addconnection connectioncontext context  connectioninfo info
throws exception
if  islogall      islogconnectionevents
log info     context
super addconnection context  info
public subscription addconsumer connectioncontext context  consumerinfo info
throws exception
if  islogall      islogconsumerevents
log info     info
return super addconsumer context  info
public void addproducer connectioncontext context  producerinfo info
throws exception
if  islogall      islogproducerevents
log info     info
super addproducer context  info
public void committransaction connectioncontext context  transactionid xid
boolean onephase  throws exception
if  islogall      islogtransactionevents
log info     xid gettransactionkey
super committransaction context  xid  onephase
public void removesubscription connectioncontext context
removesubscriptioninfo info  throws exception
if  islogall      islogconsumerevents
log info     info
super removesubscription context  info
public transactionid getpreparedtransactions connectioncontext context
throws exception
transactionid result   super getpreparedtransactions context
if   islogall      islogtransactionevents       result    null
stringbuffer tids   new stringbuffer
for  transactionid tid   result
if  tids length   > 0
tids append
tids append tid gettransactionkey
log info     tids
return result
public int preparetransaction connectioncontext context  transactionid xid
throws exception
if  islogall      islogtransactionevents
log info     xid gettransactionkey
return super preparetransaction context  xid
public void removeconnection connectioncontext context
connectioninfo info  throwable error  throws exception
if  islogall      islogconnectionevents
log info     info
super removeconnection context  info  error
public void removeconsumer connectioncontext context  consumerinfo info
throws exception
if  islogall      islogconsumerevents
log info     info
super removeconsumer context  info
public void removeproducer connectioncontext context  producerinfo info
throws exception
if  islogall      islogproducerevents
log info     info
super removeproducer context  info
public void rollbacktransaction connectioncontext context  transactionid xid
throws exception
if  islogall      islogtransactionevents
log info     xid gettransactionkey
super rollbacktransaction context  xid
public void send producerbrokerexchange producerexchange
message messagesend  throws exception
if  islogall      islogproducerevents
log info     messagesend
super send producerexchange  messagesend
public void begintransaction connectioncontext context  transactionid xid
throws exception
if  islogall      islogtransactionevents
log info     xid gettransactionkey
super begintransaction context  xid
public void forgettransaction connectioncontext context
transactionid transactionid  throws exception
if  islogall      islogtransactionevents
log info
transactionid gettransactionkey
super forgettransaction context  transactionid
public connection getclients   throws exception
connection result   super getclients
if  islogall      isloginternalevents
if  result    null
log info
else
stringbuffer cids   new stringbuffer
for  connection c   result
cids append cids length   > 0 ?
cids append c getconnectionid
log info     cids
return super getclients
public org apache activemq broker region destination adddestination
connectioncontext context  activemqdestination destination
throws exception
if  islogall      isloginternalevents
log info
destination getdestinationtypeasstring
destination getphysicalname
return super adddestination context  destination
public void removedestination connectioncontext context
activemqdestination destination  long timeout  throws exception
if  islogall      isloginternalevents
log info
destination getdestinationtypeasstring
destination getphysicalname
super removedestination context  destination  timeout
public activemqdestination getdestinations   throws exception
activemqdestination result   super getdestinations
if  islogall      isloginternalevents
if  result    null
log info
else
stringbuffer destinations   new stringbuffer
for  activemqdestination dest   result
destinations append destinations length   > 0 ?
destinations append dest getphysicalname
log info     destinations
return result
public void start   throws exception
if  islogall      isloginternalevents
log info     getbrokername
super start
public void stop   throws exception
if  islogall      isloginternalevents
log info     getbrokername
super stop
public void addsession connectioncontext context  sessioninfo info
throws exception
if  islogall      islogconnectionevents
log info     info
super addsession context  info
public void removesession connectioncontext context  sessioninfo info
throws exception
if  islogall      islogconnectionevents
log info     info
super removesession context  info
public void addbroker connection connection  brokerinfo info
if  islogall      isloginternalevents
log info     info getbrokername
super addbroker connection  info
public void removebroker connection connection  brokerinfo info
if  islogall      isloginternalevents
log info     info getbrokername
super removebroker connection  info
public brokerinfo getpeerbrokerinfos
brokerinfo result   super getpeerbrokerinfos
if  islogall      isloginternalevents
if  result    null
log info
else
stringbuffer peers   new stringbuffer
for  brokerinfo bi   result
peers append peers length   > 0 ?
peers append bi getbrokername
log info     peers
return result
public void preprocessdispatch messagedispatch messagedispatch
if  islogall      isloginternalevents      islogconsumerevents
log info     messagedispatch
super preprocessdispatch messagedispatch
public void postprocessdispatch messagedispatch messagedispatch
if  islogall      isloginternalevents      islogconsumerevents
log info     messagedispatch
super postprocessdispatch messagedispatch
public void processdispatchnotification
messagedispatchnotification messagedispatchnotification
throws exception
if  islogall      isloginternalevents      islogconsumerevents
log info
messagedispatchnotification
super processdispatchnotification messagedispatchnotification
public set<activemqdestination> getdurabledestinations
set<activemqdestination> result   super getdurabledestinations
if  islogall      isloginternalevents
if  result    null
log info
else
stringbuffer destinations   new stringbuffer
for  activemqdestination dest   result
destinations append destinations length   > 0 ?
destinations append dest getphysicalname
log info     destinations
return result
public void adddestinationinfo connectioncontext context
destinationinfo info  throws exception
if  islogall      isloginternalevents
log info     info
super adddestinationinfo context  info
public void removedestinationinfo connectioncontext context
destinationinfo info  throws exception
if  islogall      isloginternalevents
log info     info
super removedestinationinfo context  info
public void messageexpired connectioncontext context
messagereference message
if  islogall      isloginternalevents
string msg
try
msg   message getmessage   tostring
catch  ioexception ioe
log info     msg
super messageexpired context  message
public void sendtodeadletterqueue connectioncontext context
messagereference messagereference
if  islogall      isloginternalevents
string msg
try
msg   messagereference getmessage   tostring
catch  ioexception ioe
log info     msg
public void fastproducer connectioncontext context
producerinfo producerinfo
if  islogall      islogproducerevents      isloginternalevents
log info     producerinfo
super fastproducer context  producerinfo
public void isfull connectioncontext context  destination destination
usage usage
if  islogall      islogproducerevents      isloginternalevents
log info     destination getname
super isfull context  destination  usage
public void messageconsumed connectioncontext context
messagereference messagereference
if  islogall      islogconsumerevents      isloginternalevents
string msg
try
msg   messagereference getmessage   tostring
catch  ioexception ioe
log info     msg
super messageconsumed context  messagereference
public void messagedelivered connectioncontext context
messagereference messagereference
if  islogall      islogconsumerevents      isloginternalevents
string msg
try
msg   messagereference getmessage   tostring
catch  ioexception ioe
log info     msg
super messagedelivered context  messagereference
public void messagediscarded connectioncontext context
messagereference messagereference
if  islogall      isloginternalevents
string msg
try
msg   messagereference getmessage   tostring
catch  ioexception ioe
log info     msg
super messagediscarded context  messagereference
public void slowconsumer connectioncontext context
destination destination  subscription subs
if  islogall      islogconsumerevents      isloginternalevents
log info     destination getname
stringbuffer buf   new stringbuffer
buf append subs getconsumerinfo   getconsumerid   getconnectionid
buf append
buf append subs getconsumerinfo   getconsumerid   getsessionid
buf append
log info buf
super slowconsumer context  destination  subs
public void nowmasterbroker
if  islogall      isloginternalevents
log info     getbrokername
super nowmasterbroker
public string tostring
stringbuffer buf   new stringbuffer
buf append
buf append
buf append islogall
buf append
buf append islogconnectionevents
buf append
buf append islogconsumerevents
buf append
buf append islogproducerevents
buf append
buf append islogmessageevents
buf append
buf append islogtransactionevents
buf append
buf append isloginternalevents
buf append
return buf tostring