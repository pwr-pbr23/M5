/*
derby - class org.apache.derby.impl.tools.ij.xahelper
licensed to the apache software foundation (asf) under one or more
contributor license agreements.  see the notice file distributed with
this work for additional information regarding copyright ownership.
the asf licenses this file to you under the apache license, version 2.0
(the "license"); you may not use this file except in compliance with
the license.  you may obtain a copy of the license at
http://www.apache.org/licenses/license-2.0
unless required by applicable law or agreed to in writing, software
distributed under the license is distributed on an "as is" basis,
without warranties or conditions of any kind, either express or implied.
see the license for the specific language governing permissions and
limitations under the license.
*/
package org apache derby impl tools ij
import org apache derby iapi tools i18n localizedresource
import java sql connection
import java sql sqlexception
import java util locale
import java util vector
import javax transaction xa xid
import javax transaction xa xaresource
import javax transaction xa xaexception
import javax sql pooledconnection
import javax sql xaconnection
import javax sql xadatasource
import javax sql datasource
import javax sql connectionpooldatasource
import org apache derby iapi services info jvminfo
/*
* the real xa helper class.  load this class only if we know the javax classes
* are in the class path.
*/
class xahelper implements xaabstracthelper
private xadatasource currentxadatasource
private xaconnection currentxaconnection
private string databasename
// non xa stuff
private datasource currentdatasource
private connectionpooldatasource currentcpdatasource
private pooledconnection currentpooledconnection
private boolean isjcc
private boolean isnetclient
private string framework
xahelper
public void setframework string fm
if  fm    null
return
framework   fm touppercase locale english
if  framework endswith
framework equals
isjcc   true
else if  framework equals
isnetclient   true
private xid makexid int xid
return new ijxid xid  databasename getbytes
public void xadatasourcestatement ij parser  token dbname  token shutdown
string create
throws sqlexception
try
currentxadatasource    xadatasource  getxadatasource
databasename   parser stringvalue dbname image
if  isjcc    isnetclient
string hostname   system getproperty
if   hostname    null        hostname equals
xahelper setdatasourceproperty currentxadatasource
hostname
else
xahelper setdatasourceproperty currentxadatasource
xahelper setdatasourceproperty currentxadatasource
1527
string user
string password
user
password
xahelper setdatasourceproperty currentxadatasource
user
xahelper setdatasourceproperty currentxadatasource
password
//xahelper.setdatasourceproperty(currentxadatasource,
//"tracefile", "trace.out." + framework);
if  isjcc
xahelper setdatasourceproperty currentxadatasource
4
xahelper setdatasourceproperty currentxadatasource
true
xahelper setdatasourceproperty currentxadatasource     databasename
if  shutdown    null    shutdown tostring   tolowercase locale english  equals
if  isjcc    isnetclient
xahelper setdatasourceproperty currentxadatasource    databasename
else
xahelper setdatasourceproperty currentxadatasource
// do a getxaconnection to shut it down */
currentxadatasource getxaconnection   getconnection
currentxadatasource   null
currentxaconnection   null
else if  create    null    create tolowercase java util locale english  equals
if  isjcc    isnetclient
xahelper setdatasourceproperty currentxadatasource    databasename
else
xahelper setdatasourceproperty currentxadatasource
/* do a getxaconnection to create it */
xaconnection conn   currentxadatasource getxaconnection
conn close
xahelper setdatasourceproperty currentxadatasource     null
catch  throwable t
handleexception t
public void xaconnectstatement ij parser  token user  token pass  string id
throws sqlexception
try
if  currentxaconnection    null
try
currentxaconnection close
catch  sqlexception sqle
currentxaconnection   null
string username   null
string password
if  pass    null
password   parser stringvalue pass image
if  user    null
username   parser stringvalue user image
currentxaconnection
currentxadatasource getxaconnection username  password
else
currentxaconnection   currentxadatasource getxaconnection
catch  throwable t
handleexception t
public void xadisconnectstatement ij parser  string n  throws sqlexception
if  currentxaconnection    null
throw ijexception nosuchconnection
currentxaconnection close
currentxaconnection   null
public connection xagetconnectionstatement ij parser  string n  throws sqlexception
try
return currentxaconnection getconnection
catch throwable t
handleexception t
return null
public void commitstatement ij parser  token onephase  token twophase
int xid
throws sqlexception
try
currentxaconnection getxaresource   commit makexid xid    onephase    null
catch throwable t
handleexception t
public void endstatement ij parser  int flag  int xid  throws sqlexception
try
currentxaconnection getxaresource   end makexid xid   flag
catch throwable t
handleexception t
public void forgetstatement ij parser  int xid  throws sqlexception
try
currentxaconnection getxaresource   forget makexid xid
catch throwable t
handleexception t
public void preparestatement ij parser  int xid  throws sqlexception
try
currentxaconnection getxaresource   prepare makexid xid
catch throwable t
handleexception t
public ijresult recoverstatement ij parser  int flag  throws sqlexception
object val   null
try
val   currentxaconnection getxaresource   recover flag
catch throwable t
handleexception t
vector v   new vector
v addelement
v addelement localizedresource getmessage    localizedresource getnumber val length
v addelement
for  int i   0  i < val length  i
v addelement localizedresource getmessage    localizedresource getnumber i 1   val tostring
return new ijvectorresult v null
public void rollbackstatement ij parser  int xid  throws sqlexception
try
currentxaconnection getxaresource   rollback makexid xid
catch throwable t
handleexception t
public void startstatement ij parser  int flag  int xid  throws sqlexception
try
currentxaconnection getxaresource   start makexid xid   flag
catch throwable t
handleexception t
private void handleexception throwable t  throws sqlexception
if  t instanceof sqlexception
// let ij handle it
throw  sqlexception t
if  t instanceof xaexception
int errorcode     xaexception t  errorcode
string error   localizedresource getmessage
// xa_rbbase 100
// xa_rbrollback 100
// xa_rbcommfail 101
// xa_rbdeadlock 102
// xa_rbintegrity 103
// xa_rbother 104
// xa_rbproto 105
// xa_rbtimeout 106
// xa_rbtransient 107
// xa_rbend 107
//
// xa_rdonly 3
// xa_retry 4
// xa_heurmix 5
// xa_heurrb 6
// xa_heurcom 7
// xa_heurhaz 8
// xa_nomigrate 9
//
// xaer_async -2
// xaer_rmerr -3
// xaer_nota -4
// xaer_inval -5
// xaer_proto -6
// xaer_rmfail -7
// xaer_dupid -8
// xaer_outside -9
switch errorcode
case xaexception xa_heurcom   error      break
case xaexception xa_heurhaz   error      break
case xaexception xa_heurmix   error      break
case xaexception xa_heurrb   error      break
case xaexception xa_nomigrate   error      break
// case xaexception.xa_rbbase : error = "xa_rbbase "; break;
case xaexception xa_rbcommfail   error      break
case xaexception xa_rbdeadlock   error      break
// case xaexception.xa_rbend : error = "xa_rbend "; break;
case xaexception xa_rbintegrity   error      break
case xaexception xa_rbother   error      break
case xaexception xa_rbproto   error      break
case xaexception xa_rbrollback   error      break
case xaexception xa_rbtimeout   error      break
case xaexception xa_rbtransient   error      break
case xaexception xa_rdonly   error      break
case xaexception xa_retry   error      break
case xaexception xaer_async   error      break
case xaexception xaer_dupid   error      break
case xaexception xaer_inval   error      break
case xaexception xaer_nota   error      break
case xaexception xaer_outside   error      break
case xaexception xaer_proto   error      break
case xaexception xaer_rmerr   error      break
case xaexception xaer_rmfail   error      break
//t.printstacktrace(system.out);
throw new ijexception error
else    standardexception or run time exception  log it first
string info   localizedresource getmessage    t tostring    t getmessage
//		t.printstacktrace(system.out);
throw new ijexception info
// non-xa stuff. datasource and connectionpooldatasource
public connection datasourcestatement ij parser  token dbname  token protocol
token usert  token passt  string id
throws sqlexception
try
currentdatasource    datasource   class forname    newinstance
catch  exception e
throw new sqlexception e tostring
databasename   parser stringvalue dbname image
xahelper setdatasourceproperty currentdatasource     databasename
xahelper setdatasourceproperty currentxadatasource     databasename
// make a connection
connection c   null
string username   null
string password
if  passt    null
password   parser stringvalue passt image
if  usert    null
username   parser stringvalue usert image
c   currentdatasource getconnection username  password
else
c   currentdatasource getconnection
return c
public void cpdatasourcestatement ij parser  token dbname  token protocol
throws sqlexception
try
currentcpdatasource    connectionpooldatasource   class forname    newinstance
catch  exception e
throw new sqlexception e tostring
databasename   parser stringvalue dbname image
xahelper setdatasourceproperty currentcpdatasource     databasename
public void cpconnectstatement ij parser  token usert  token passt  string n
throws sqlexception
string username   null
string password
if  passt    null
password   parser stringvalue passt image
if  usert    null
username   parser stringvalue usert image
currentpooledconnection
currentcpdatasource getpooledconnection username  password
else
currentpooledconnection
currentcpdatasource getpooledconnection
public connection cpgetconnectionstatement ij parser  string n
throws sqlexception
return currentpooledconnection getconnection
public void cpdisconnectstatement ij parser  string n  throws sqlexception
if  currentpooledconnection    null
throw ijexception nosuchconnection localizedresource getmessage
currentpooledconnection close
currentpooledconnection   null
/**
* get a datasource that supports distributed transactions.
*
* @return xadatasource object
*
* @exception exception if xadatasource is not in class path.
*/
private xadatasource getxadatasource   throws exception
// we need to construct this object in this round about fashion because
// if we new it directly, then it will the tools.jar file to bloat.
try
if  isjcc
return  xadatasource
class forname    newinstance
else if  isnetclient
if  jvminfo jdk_id >  jvminfo j2se_16
//running under jdk1.6 or higher
// try instantiating embeddedxadatasource40
try
return  xadatasource  class forname
newinstance
catch  classnotfoundexception e
//probably it was not compiled with jdbc4.0
//support go ahead with embeddedxadatasource
return  xadatasource   class forname
newinstance
else
if  jvminfo jdk_id >  jvminfo j2se_16
//running under jdk1.6 or higher
// try instantiating embeddedxadatasource40
try
return  xadatasource  class forname
newinstance
catch  classnotfoundexception e
//probably it was not compiled with jdbc4.0
//support go ahead with embeddedxadatasource
return  xadatasource  class forname    newinstance
catch classnotfoundexception cnfe
throw new ijexception localizedresource getmessage
catch  instantiationexception e
catch  illegalaccessexception e
throw new ijexception localizedresource getmessage
private static final class string_p       getclass
private static final class int_p     integer type
private static final class boolean_p    boolean type
private static void setdatasourceproperty object ds  string property  int
value  throws sqlexception
string methodname
character touppercase property charat 0     property substring 1
try
java lang reflect method m   ds getclass   getmethod methodname  int_p
m invoke ds  new object  new integer value
catch  exception e
throw new sqlexception property       e getmessage
private static void setdatasourceproperty object ds  string property  string value  throws sqlexception
string methodname
character touppercase property charat 0     property substring 1
try
java lang reflect method m   ds getclass   getmethod methodname  string_p
m invoke ds  new object  value
return
catch    nosuchmethod  exception nsme
throw new sqlexception property
//java.lang.reflect.method m = ds.getclass().getmethod("set" + property, int_p);
//m.invoke(ds, new object[] {integer.valueof(value)});
private static void setdatasourceproperty object ds  string property  boolean value  throws sqlexception
string methodname
character touppercase property charat 0     property substring 1
try
java lang reflect method m   ds getclass   getmethod methodname  boolean_p
m invoke ds  new object  new boolean value
return
catch  exception nsme
throw new sqlexception property
class ijxid implements xid  java io serializable
private static final long serialversionuid   64467452100036l
private final int format_id
private final byte global_id
private final byte branch_id
ijxid int xid  byte id
format_id   xid
global_id   id
branch_id   id
/**
* obtain the format id part of the xid.
* <p>
*
* @return format identifier. o means the osi ccr format.
**/
public int getformatid
return format_id
/**
* obtain the global transaction identifier part of xid as an array of
* bytes.
* <p>
*
* @return a byte array containing the global transaction identifier.
**/
public byte getglobaltransactionid
return global_id
/**
* obtain the transaction branch qualifier part of the xid in a byte array.
* <p>
*
* @return a byte array containing the branch qualifier of the transaction.
**/
public byte getbranchqualifier
return branch_id