/*
derby - class org.apache.derby.impl.sql.execute.norowsresultsetimpl
licensed to the apache software foundation (asf) under one or more
contributor license agreements.  see the notice file distributed with
this work for additional information regarding copyright ownership.
the asf licenses this file to you under the apache license, version 2.0
(the "license"); you may not use this file except in compliance with
the license.  you may obtain a copy of the license at
http://www.apache.org/licenses/license-2.0
unless required by applicable law or agreed to in writing, software
distributed under the license is distributed on an "as is" basis,
without warranties or conditions of any kind, either express or implied.
see the license for the specific language governing permissions and
limitations under the license.
*/
package org apache derby impl sql execute
import java sql timestamp
import org apache derby iapi error standardexception
import org apache derby iapi reference sqlstate
import org apache derby iapi services i18n messageservice
import org apache derby iapi services loader generatedmethod
import org apache derby iapi services monitor monitor
import org apache derby iapi services sanity sanitymanager
import org apache derby iapi services stream headerprintwriter
import org apache derby iapi sql activation
import org apache derby iapi sql resultdescription
import org apache derby iapi sql resultset
import org apache derby iapi sql row
import org apache derby iapi sql conn languageconnectioncontext
import org apache derby iapi sql conn statementcontext
import org apache derby iapi sql dictionary conglomeratedescriptor
import org apache derby iapi sql dictionary datadictionary
import org apache derby iapi sql dictionary tabledescriptor
import org apache derby iapi sql execute execrow
import org apache derby iapi sql execute executioncontext
import org apache derby iapi sql execute noputresultset
import org apache derby iapi sql execute resultsetstatisticsfactory
import org apache derby iapi types datavaluedescriptor
/**
* this implementation of resultset
* is meant to be overridden by subtypes
* in the execution engine. its primary users
* will be ddl, which only need to define a
* constructor to create the ddl object being
* defined. all other resultset operations will
* be handled by this superclass -- i.e., nothing
* is allowed to be done to a ddl result set, since
* it has no rows to provide.
* <p>
* this abstract class does not define the entire resultset
* interface, but leaves the 'get' half of the interface
* for subtypes to implement. it is package-visible only,
* with its methods being public for exposure by its subtypes.
* <p>
*
*/
abstract class norowsresultsetimpl implements resultset
final activation    activation
private boolean dumpedstats
noputresultset	subquerytrackingarray
private final boolean statisticstimingon
/** true if the result set has been opened, and not yet closed. */
private boolean isopen
/* fields used for formating run time statistics output */
protected string indent
protected string subindent
protected int sourcedepth
/* run time statistics variables */
final languageconnectioncontext lcc
protected long begintime
protected long endtime
protected long beginexecutiontime
protected long endexecutiontime
norowsresultsetimpl activation activation
throws standardexception
this activation   activation
if  sanitymanager debug
if  activation    null
sanitymanager throwassert     getclass
lcc   activation getlanguageconnectioncontext
statisticstimingon   lcc getstatisticstiming
/* note - we can't get the current time until after setting up the
* activation, as we end up using the activation to get the
* languageconnectioncontext.
*/
begintime   getcurrenttimemillis
beginexecutiontime   begintime
statementcontext sc   lcc getstatementcontext
sc settopresultset this   noputresultset  null
// pick up any materialized subqueries
if  subquerytrackingarray    null
subquerytrackingarray   sc getsubquerytrackingarray
/**
* set up the result set for use. should always be called from
* <code>open()</code>.
*
* @exception standardexception thrown on error
*/
void setup   throws standardexception
isopen   true
/**
* returns false
*/
public final boolean	returnsrows     return false
/**
* returns zero.
*/
public int	modifiedrowcount     return 0
/**
* returns null.
*/
public resultdescription	getresultdescription
return  resultdescription null
public final activation getactivation
return activation
/**
* returns the row at the absolute position from the query,
* and returns null when there is no such position.
* (negative position means from the end of the result set.)
* moving the cursor to an invalid position leaves the cursor
* positioned either before the first row (negative position)
* or after the last row (positive position).
* note: an exception will be thrown on 0.
*
* @param row	the position.
* @return	the row at the absolute position, or null if no such position.
*
* @exception standardexception		thrown on failure
* @see row
*/
public execrow	getabsoluterow int row  throws standardexception
/*
the jdbc use of this class will never call here.
only the db api used directly can get this exception.
*/
throw standardexception newexception sqlstate lang_does_not_return_rows
/**
* returns the row at the relative position from the current
* cursor position, and returns null when there is no such position.
* (negative position means toward the beginning of the result set.)
* moving the cursor to an invalid position leaves the cursor
* positioned either before the first row (negative position)
* or after the last row (positive position).
* note: 0 is valid.
* note: an exception is thrown if the cursor is not currently
* positioned on a row.
*
* @param row	the position.
* @return	the row at the relative position, or null if no such position.
*
* @exception standardexception		thrown on failure
* @see row
*/
public execrow	getrelativerow int row  throws standardexception
/*
the jdbc use of this class will never call here.
only the db api used directly can get this exception.
*/
throw standardexception newexception sqlstate lang_does_not_return_rows
/**
* sets the current position to before the first row and returns null
* because there is no current row.
*
* @return	null.
*
* @exception standardexception		thrown on failure
* @see row
*/
public execrow	setbeforefirstrow
throws standardexception
/*
the jdbc use of this class will never call here.
only the db api used directly can get this exception.
*/
throw standardexception newexception sqlstate lang_does_not_return_rows
/**
* returns the first row from the query, and returns null when there
* are no rows.
*
* @return	the first row, or null if no rows.
*
* @exception standardexception		thrown on failure
* @see row
*/
public execrow	getfirstrow
throws standardexception
/*
the jdbc use of this class will never call here.
only the db api used directly can get this exception.
*/
throw standardexception newexception sqlstate lang_does_not_return_rows
/**
* no rows to return, so throw an exception.
*
* @exception standardexception		always throws a
*									standardexception to indicate
*									that this method is not intended to
*									be used.
*/
public execrow	getnextrow   throws standardexception
/*
the jdbc use of this class will never call here.
only the db api used directly can get this exception.
*/
throw standardexception newexception sqlstate lang_does_not_return_rows
/**
* returns the previous row from the query, and returns null when there
* are no more previous rows.
*
* @return	the previous row, or null if no more previous rows.
*
* @exception standardexception		thrown on failure
* @see row
*/
public execrow	getpreviousrow
throws standardexception
/*
the jdbc use of this class will never call here.
only the db api used directly can get this exception.
*/
throw standardexception newexception sqlstate lang_does_not_return_rows
/**
* returns the last row from the query, and returns null when there
* are no rows.
*
* @return	the last row, or null if no rows.
*
* @exception standardexception		thrown on failure
* @see row
*/
public execrow	getlastrow
throws standardexception
/*
the jdbc use of this class will never call here.
only the db api used directly can get this exception.
*/
throw standardexception newexception sqlstate lang_does_not_return_rows
/**
* sets the current position to after the last row and returns null
* because there is no current row.
*
* @return	null.
*
* @exception standardexception		thrown on failure
* @see row
*/
public execrow	setafterlastrow
throws standardexception
/*
the jdbc use of this class will never call here.
only the db api used directly can get this exception.
*/
throw standardexception newexception sqlstate lang_does_not_return_rows
/**
* clear the current row. this is done after a commit on holdable
* result sets.
* this is a no-op on result set which do not provide rows.
*/
public final void clearcurrentrow
/**
* determine if the cursor is before the first row in the result
* set.
*
* @return true if before the first row, false otherwise. returns
* false when the result set contains no rows.
*/
public boolean checkrowposition int istype
return false
/**
* returns the row number of the current row.  row
* numbers start from 1 and go to 'n'.  corresponds
* to row numbering used to position current row
* in the result set (as per jdbc).
*
* @return	the row number, or 0 if not on a row
*
*/
public int getrownumber
return 0
/**
* no rows to return, does nothing
*
* @exception standardexception thrown on error
*/
public void	close   throws standardexception
isopen   false
/**
* find out if the <code>resultset</code> is closed.
*
* @return <code>true</code> if closed, <code>false</code> otherwise
*/
public boolean isclosed
return  isopen
/**
*	doesn't need to do anything, as no calls
*	are made that need to be restricted once
*	the result set is 'finished'.
*
* @exception standardexception on error
*/
public void finish   throws standardexception
if    dumpedstats
/*
** if run time statistics tracing is turned on, then now is the
** time to dump out the information.
** note - we make a special exception for commit.  if autocommit
** is on, then the run time statistics from the autocommit is the
** only one that the user would ever see.  so, we don't overwrite
** the run time statistics object for a commit.
*/
if  lcc getruntimestatisticsmode
doescommit
endexecutiontime   getcurrenttimemillis
executioncontext ec   lcc getexecutioncontext
resultsetstatisticsfactory rssf
rssf   ec getresultsetstatisticsfactory
lcc setruntimestatisticsobject
rssf getruntimestatistics activation  this  subquerytrackingarray
headerprintwriter istream   lcc getlogqueryplan   ? monitor getstream     null
if  istream    null
istream printlnwithheader languageconnectioncontext xidstr
lcc gettransactionexecute   gettransactionidstring
languageconnectioncontext lccstr
lcc getinstancenumber
lcc getruntimestatisticsobject   getstatementtext
lcc getruntimestatisticsobject   getstatementexecutionplantext
dumpedstats   true
/* this is the top resultset,
* close all of the open subqueries.
*/
int stalength    subquerytrackingarray    null  ? 0
subquerytrackingarray length
for  int index   0  index < stalength  index
if  subquerytrackingarray    null
continue
if  subquerytrackingarray isclosed
continue
subquerytrackingarray close
/**
* get the execution time in milliseconds.
*
* @return long		the execution time in milliseconds.
*/
public long getexecutetime
return endtime   begintime
/**
* get the timestamp for the beginning of execution.
*
* @return timestamp		the timestamp for the beginning of execution.
*/
public timestamp getbeginexecutiontimestamp
if  beginexecutiontime    0
return null
else
return new timestamp beginexecutiontime
/**
* get the timestamp for the end of execution.
*
* @return timestamp		the timestamp for the end of execution.
*/
public timestamp getendexecutiontimestamp
if  endexecutiontime    0
return null
else
return new timestamp endexecutiontime
/**
* resolve - this method will go away once it is overloaded in all subclasses.
* return the query plan as a string.
*
* @param depth	indentation level.
*
* @return string	the query plan as a string.
*/
public string getqueryplantext int depth
return messageservice gettextmessage
sqlstate lang_gqpt_not_supported
getclass   getname
/**
* return the total amount of time spent in this resultset
*
* @param type	current_resultset_only - time spent only in this resultset
*				entire_resultset_tree  - time spent in this resultset and below.
*
* @return long		the total amount of time spent (in milliseconds).
*/
public long gettimespent int type
/* resolve - this should be overloaded in all subclasses */
return 0
/**
* @see resultset#getsubquerytrackingarray
*/
public final noputresultset getsubquerytrackingarray int numsubqueries
if  subquerytrackingarray    null
subquerytrackingarray   new noputresultset
return subquerytrackingarray
/**
* @see resultset#getautogeneratedkeysresultset
*/
public resultset getautogeneratedkeysresultset
//a non-null resultset would be returned only for an insert statement
return  resultset null
/**
return the cursor name, null in this case.
@see resultset#getcursorname
*/
public string getcursorname
return null
// class implementation
/**
* return the current time in milliseconds, if debug and runtimestats is
* on, else return 0.  (only pay price of system call if need to.)
*
* @return long		current time in milliseconds.
*/
protected final long getcurrenttimemillis
if  statisticstimingon
return system currenttimemillis
else
return 0
/**
*	run a check constraint against the current row. raise an error if
* the check constraint is violated.
*
*	@param	checkgm			generated code to run the check constraint.
* @param	checkname		name of the constraint to check.
*	@param	heapconglom		number of heap conglomerate.
*	@param	activation		class in which checkgm lives.
*
* @exception standardexception thrown on error
*/
public	static	void	evaluateacheckconstraint
generatedmethod checkgm
string checkname
long heapconglom
activation activation
throws standardexception
if  checkgm    null
datavaluedescriptor checkboolean
checkboolean    datavaluedescriptor  checkgm invoke activation
/* throw exception if check constraint is violated.
* (only if check constraint evaluates to false.)
*/
if   checkboolean    null
checkboolean isnull
checkboolean getboolean
/* now we have a lot of painful work to get the
* table name for the error message.  all we have
* is the conglomerate number to work with.
*/
datadictionary dd   activation getlanguageconnectioncontext   getdatadictionary
conglomeratedescriptor cd   dd getconglomeratedescriptor  heapconglom
tabledescriptor td   dd gettabledescriptor cd gettableid
standardexception se   standardexception newexception sqlstate lang_check_constraint_violated
td getqualifiedname    checkname
throw se
/**
*	run check constraints against the current row. raise an error if
* a check constraint is violated.
*
*	@param	checkgm			generated code to run the check constraint.
*	@param	activation		class in which checkgm lives.
*
* @exception standardexception thrown on error
*/
public	static	void	evaluatecheckconstraints
generatedmethod checkgm
activation activation
throws standardexception
if  checkgm    null
// evaluate the expression containing the check constraints.
// this expression will throw an exception if there is a
// violation, so there is no need to check the result.
checkgm invoke activation
/**
* does this resultset cause a commit or rollback.
*
* @return whether or not this resultset cause a commit or rollback.
*/
public boolean doescommit
return false
public java sql sqlwarning getwarnings
return null