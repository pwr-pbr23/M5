/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component cxf interceptors
import java util arraylist
import java util list
import java util resourcebundle
import java util logging level
import java util logging logger
import javax wsdl definition
import javax xml namespace qname
import org w3c dom element
import org apache cxf binding soap soapmessage
import org apache cxf binding soap soapversion
import org apache cxf binding soap model soapbindinginfo
import org apache cxf binding soap model soapheaderinfo
import org apache cxf common i18n bundleutils
import org apache cxf common logging logutils
import org apache cxf endpoint endpoint
import org apache cxf interceptor fault
import org apache cxf message exchange
import org apache cxf phase phase
import org apache cxf service model bindinginfo
import org apache cxf service model bindingmessageinfo
import org apache cxf service model messagepartinfo
import org apache cxf service model operationinfo
import org apache cxf wsdl11 wsdlservicebuilder
public class soapmessageoutinterceptor extends abstractmessageoutinterceptor<soapmessage>
private static final logger log   logutils getl7dlogger soapmessageininterceptor class
public soapmessageoutinterceptor
super phase prepare_send
addafter domoutinterceptor class getname
protected logger getlogger
return log
@suppresswarnings
public void handlemessage soapmessage message  throws fault
// header is not store as the element
element header   message get element class
list<element> payload   message get list class
exchange exchange   message getexchange
bindingmessageinfo bmi   exchange get bindingmessageinfo class
//headers -represent as -element,body -represent as staxstream.
//check if bindingoperationinfo contains header
list<soapheaderinfo> bindinghdr   bmi getextensors soapheaderinfo class
if  bindinghdr    null     bindinghdr isempty
if  log isloggable level info
log info
list<element> headerlist   new arraylist<element>
list<element> newpayload   new arraylist<element> payload
//look for headers in payload.
for  soapheaderinfo shi   bindinghdr
list<element> tmplist   new arraylist<element>
messagepartinfo mpi   shi getpart
qname hdrname   mpi getconcretename
for  element el   payload
qname elname   new qname el getnamespaceuri    el getlocalname
if  elname equals hdrname
newpayload remove el
tmplist add el
if  tmplist size   > 1
throw new fault new org apache cxf common i18n message
log  hdrname
headerlist addall tmplist
if  log isloggable level info
log info
if  headerlist size      0
soapversion version     soapmessage message  getversion
header   createelement version getheader    headerlist
payload   newpayload
//set soap header element.
//child elements could be binding specified parts or user specified headers.
//revisted the soap headers
//message.setheaders(element.class, header);
//todo moving parts from header to payload.
//for e.g payload routing from soap11 <-> soap12
//so write payload and header to outbound message
if  log isloggable level info
log info
soapbindinginfo soapbinding    soapbindinginfo exchange get bindinginfo class
string style   soapbinding getstyle bmi getbindingoperation   getoperationinfo
if    equals style
//add the operation node or operation+"response" node
//remove the operation element.
operationinfo oi   bmi getbindingoperation   getoperationinfo
endpoint ep   exchange get endpoint class
definition def
ep getservice   getserviceinfos   get 0  getproperty wsdlservicebuilder wsdl_definition
definition class
string prefix   def getprefix oi getname   getnamespaceuri
if    equals prefix
prefix
qname opname   null
boolean isclient   isrequestor message
if  isclient
opname   new qname oi getname   getnamespaceuri
oi getname   getlocalpart
prefix
else
opname   new qname oi getname   getnamespaceuri
oi getname   getlocalpart
prefix
element opel   createelement opname  payload
payload   new arraylist<element>
payload add opel
message put list class  payload