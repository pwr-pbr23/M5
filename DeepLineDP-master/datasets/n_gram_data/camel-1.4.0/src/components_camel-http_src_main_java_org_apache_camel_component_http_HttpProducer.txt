/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component http
import java io bufferedinputstream
import java io bytearrayinputstream
import java io inputstream
import java io unsupportedencodingexception
import java util arrays
import java util hashset
import java util set
import org apache camel exchange
import org apache camel message
import org apache camel producer
import org apache camel component http helper loadingbytearrayoutputstream
import org apache camel impl defaultproducer
import org apache commons httpclient header
import org apache commons httpclient httpclient
import org apache commons httpclient httpmethod
import org apache commons httpclient methods entityenclosingmethod
import org apache commons httpclient methods requestentity
import org apache commons httpclient methods stringrequestentity
import org apache commons io ioutils
import static org apache camel component http httpmethods http_method
/**
* @version $revision$
*/
public class httpproducer extends defaultproducer<httpexchange> implements producer<httpexchange>
public static final string http_response_code
public static final string query
// this should be a set of lower-case strings
public static final set<string> headers_to_skip   new hashset<string> arrays aslist
http_response_code
tolowercase
private httpclient httpclient
public httpproducer httpendpoint endpoint
super endpoint
httpclient   endpoint createhttpclient
public void process exchange exchange  throws exception
httpmethod method   createmethod exchange
message in   exchange getin
httpbinding binding     httpendpoint getendpoint    getbinding
// propagate headers as http headers
for  string headername   in getheaders   keyset
string headervalue   in getheader headername  string class
if  binding shouldheaderbepropagated headername  headervalue
method addrequestheader headername  headervalue
// lets store the result in the output message.
message out   exchange getout true
try
int responsecode   httpclient executemethod method
out setheaders in getheaders
out setheader http_response_code  responsecode
loadingbytearrayoutputstream bos   new loadingbytearrayoutputstream
inputstream is   method getresponsebodyasstream
ioutils copy is  bos
bos flush
is close
out setbody bos createinputstream
finally
method releaseconnection
// lets set the headers
header headers   method getresponseheaders
for  header header   headers
string name   header getname
string value   header getvalue
out setheader name  value
public httpclient gethttpclient
return httpclient
public void sethttpclient httpclient httpclient
this httpclient   httpclient
protected httpmethod createmethod exchange exchange
string uri     httpendpoint getendpoint    gethttpuri   tostring
requestentity requestentity   createrequestentity exchange
object m   exchange getin   getheader http_method
httpmethods ms   m instanceof httpmethods
?  httpmethods m   httpmethods valueof m    null
? requestentity    null
?
m tostring
httpmethod method   ms createmethod uri
if  exchange getin   getheader query     null
method setquerystring exchange getin   getheader query  string class
if  ms isentityenclosing
entityenclosingmethod method  setrequestentity requestentity
return method
protected requestentity createrequestentity exchange exchange
message in   exchange getin
if  in getbody      null
return null
requestentity entity   in getbody requestentity class
if  entity    null
string data   in getbody string class
string contenttype   in getheader    string class
try
if  contenttype    null
return new stringrequestentity data  contenttype  null
return new stringrequestentity data  null  null
catch  unsupportedencodingexception e
throw new runtimeexception e
return entity
protected boolean shouldheaderbepropagated string headername  string headervalue
if  headervalue    null
return false
if  http_method equals headername
return false
if  headername startswith
return false
if  headers_to_skip contains headername tolowercase
return false
return true