/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component spring integration adapter
import org apache camel consumer
import org apache camel endpoint
import org apache camel exchange
import org apache camel processor
import org apache camel component spring integration springintegrationbinding
import org apache commons logging log
import org apache commons logging logfactory
import org springframework beans factory initializingbean
import org springframework integration configurationexception
import org springframework integration bus messagebus
import org springframework integration bus messagebusaware
import org springframework integration channel messagechannel
import org springframework integration gateway requestreplytemplate
import org springframework integration message message
/**
* a camelcontext will be injected into camesourceadapter which will
* let spring integration channel talk to the camelcontext certain endpoint
*
* @author willem jiang
*
* @version $revision$
*/
public class camelsourceadapter extends abstractcameladapter implements initializingbean  messagebusaware
protected final object lifecyclemonitor   new object
private final log logger   logfactory getlog this getclass
private consumer consumer
private endpoint camelendpoint
private messagechannel requestchannel
private requestreplytemplate requestreplytemplate   new requestreplytemplate
private volatile boolean initialized
public void setrequestchannel messagechannel channel
requestchannel   channel
requestreplytemplate setrequestchannel requestchannel
public messagechannel getchannel
return requestchannel
public void setreplychannel messagechannel channel
requestreplytemplate setreplychannel channel
public void setrequesttimeout long requesttimeout
this requestreplytemplate setrequesttimeout requesttimeout
public void setreplytimeout long replytimeout
this requestreplytemplate setreplytimeout replytimeout
private void incoming exchange exchange
org springframework integration message message request
springintegrationbinding createspringintegrationmessage exchange
org springframework integration message message response   handle request
if  response    null
// todo how to deal with the fault message
springintegrationbinding storetocamelmessage response  exchange getout
protected class consumerprocessor implements processor
public void process exchange exchange
try
incoming exchange
catch  throwable ex
ex printstacktrace
logger warn     ex
//todo maybe we should set the exception as the fault message
public final void afterpropertiesset   throws exception
synchronized  this lifecyclemonitor
if  this initialized
return
this initialize
this initialized   true
protected void initialize   throws exception
// start the service here
camelendpoint   getcamelcontext   getendpoint getcamelendpointuri
consumer   camelendpoint createconsumer new consumerprocessor
consumer start
public final message<?> handle message<?> message
if   this initialized
try
this afterpropertiesset
catch  exception e
throw new configurationexception     this getclass   getname    e
if   isexpectreply
boolean sent   this requestreplytemplate send message
if   sent    logger iswarnenabled
logger warn
return null
return this requestreplytemplate request message
public void setmessagebus messagebus bus
requestreplytemplate setmessagebus bus