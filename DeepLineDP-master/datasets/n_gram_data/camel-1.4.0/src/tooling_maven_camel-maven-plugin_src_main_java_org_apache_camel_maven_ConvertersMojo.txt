/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel maven
import java io file
import java io fileoutputstream
import java io ioexception
import java io outputstreamwriter
import java io writer
import java lang reflect method
import java util hashmap
import java util list
import java util locale
import java util map
import java util resourcebundle
import java util set
import java util treemap
import java util treeset
import org apache camel impl reportingtypeconverterloader
import org apache camel impl reportingtypeconverterloader typemapping
import org apache camel impl reportingtypeconverterregistry
import org apache camel util objecthelper
import org apache maven artifact artifact
import org apache maven artifact factory artifactfactory
import org apache maven artifact repository artifactrepository
import org apache maven artifact resolver artifactnotfoundexception
import org apache maven artifact resolver artifactresolutionexception
import org apache maven artifact resolver artifactresolver
import org apache maven artifact versioning invalidversionspecificationexception
import org apache maven artifact versioning versionrange
import org apache maven doxia module xhtml decoration render renderingcontext
import org apache maven doxia sink sink
import org apache maven doxia site decoration body
import org apache maven doxia site decoration decorationmodel
import org apache maven doxia site decoration skin
import org apache maven doxia siterenderer renderer
import org apache maven doxia siterenderer rendererexception
import org apache maven doxia siterenderer siterenderingcontext
import org apache maven doxia siterenderer sink siterenderersink
import org apache maven plugin mojoexecutionexception
import org apache maven plugin mojofailureexception
import org apache maven project mavenproject
import org apache maven reporting abstractmavenreport
import org apache maven reporting mavenreportexception
/**
* generate report of available type conversions.
*
* @goal converters-report
* @requiresdependencyresolution runtime
* @phase verify
*/
public class convertersmojo extends abstractmavenreport
private static final string wiki_typeconverer_url
private static final string converter_type_static
private static final string converter_type_instance
private static final string report_method_static
private static final string report_method_instance
private static final string report_method_unknown
/**
* remote repositories which will be searched for source attachments.
*
* @parameter expression="${project.remoteartifactrepositories}"
* @required
* @readonly
*/
protected list remoteartifactrepositories
/**
* local maven repository.
*
* @parameter expression="${localrepository}"
* @required
* @readonly
*/
protected artifactrepository localrepository
/**
* the component that is used to resolve additional artifacts required.
*
* @component
*/
protected artifactresolver artifactresolver
/**
* the component used for creating artifact instances.
*
* @component
*/
protected artifactfactory artifactfactory
/**
* base output directory for reports.
*
* @parameter default-value="${project.build.directory}/site"
* @readonly
* @required
*/
private file outputdirectory
/**
* reference to maven 2 project.
*
* @parameter expression="${project}"
* @required
* @readonly
*/
private mavenproject project
/**
* doxia siterenderer.
*
* @component
*/
private renderer renderer
/**
* gets resource bundle for given locale.
*
* @param locale    locale
* @return resource bundle
*/
protected resourcebundle getbundle final locale locale
return resourcebundle getbundle    locale  this
getclass   getclassloader
/**
* @param locale
*            report locale.
* @return report description.
* @see org.apache.maven.reporting.mavenreport#getdescription(locale)
*/
public string getdescription final locale locale
return getbundle locale  getstring
/**
* @see org.apache.maven.reporting.mavenreport#getname(locale)
*/
public string getname final locale locale
return getbundle locale  getstring
public string getoutputname
return
@override
protected string getoutputdirectory
return outputdirectory getabsolutepath
@override
protected mavenproject getproject
return this project
@override
protected renderer getsiterenderer
return renderer
public void execute   throws mojoexecutionexception
if   cangeneratereport
return
try
decorationmodel model   new decorationmodel
model setbody new body
map<string  object> attributes   new hashmap<string  object>
attributes put
attributes put    project
locale locale   locale getdefault
siterenderingcontext sitecontext   renderer createcontextforskin
getskinartifactfile model   attributes  model
getname locale   locale
renderingcontext context   new renderingcontext
getreportoutputdirectory    getoutputname
siterenderersink sink   new siterenderersink context
generate sink  locale
writer writer   new outputstreamwriter new fileoutputstream
new file getreportoutputdirectory    getoutputname
renderer generatedocument writer  sink  sitecontext
renderer copyresources sitecontext  new file project getbasedir
outputdirectory
catch  ioexception e
throw new mojoexecutionexception    e
catch  rendererexception e
throw new mojoexecutionexception    e
catch  mojofailureexception e
throw new mojoexecutionexception
e
catch  mavenreportexception e
throw new mojoexecutionexception    e
@override
protected void executereport locale locale  throws mavenreportexception
if   createoutputdirectory outputdirectory
throw new mavenreportexception
outputdirectory getabsolutepath
classloader oldclassloader   thread currentthread
getcontextclassloader
try
// todo: this badly needs some refactoring
// mojo.createclassloader creates a urlclassloader with whatever is
// in
// ${project.testclasspathelements}, reason why we don't see all
// converters
// in the report. first we need a list of classpath elements the
// user
// could customize via plugin configuration, and elements of that
// list
// be added to the urlclassloader. this should also be factored out
// into
// a utility class.
// todo: there is some interference with the site plugin that needs
// investigated.
list<?> list   project gettestclasspathelements
embeddedmojo mojo   new embeddedmojo
mojo setclasspathelements list
classloader newclassloader   mojo createclassloader oldclassloader
thread currentthread   setcontextclassloader newclassloader
reportingtypeconverterloader loader   new reportingtypeconverterloader
reportingtypeconverterregistry registry   new reportingtypeconverterregistry
loader load registry
getlog   error
loader gettypeconversions   length
string errors   registry geterrors
for  string error   errors
getlog   error error
generatereport getsink    locale  loader gettypeconversions
catch  exception e
throw new mavenreportexception
e
finally
thread currentthread   setcontextclassloader oldclassloader
private boolean createoutputdirectory final file outputdir
if  outputdir exists
if   outputdir isdirectory
getlog   error
outputdir getabsolutepath
return false
else
if   outputdir mkdirs
getlog   error
outputdir getabsolutepath
return false
return true
private file getskinartifactfile decorationmodel decoration  throws mojofailureexception
skin skin   decoration getskin
if  skin    null
skin   skin getdefaultskin
string version   skin getversion
artifact artifact
try
if  version    null
version   artifact release_version
versionrange versionspec   versionrange
createfromversionspec version
artifact   artifactfactory createdependencyartifact skin
getgroupid    skin getartifactid    versionspec
null  null
artifactresolver resolve artifact  remoteartifactrepositories
localrepository
return artifact getfile
catch  invalidversionspecificationexception e
throw new mojofailureexception     version
e getmessage
catch  artifactresolutionexception e
throw new mojofailureexception
e getmessage
catch  artifactnotfoundexception e
throw new mojofailureexception
e getmessage
private string convertertype string converterclassname
if  converter_type_static equals converterclassname
return report_method_static
else if  converter_type_instance equals converterclassname
return report_method_instance
else
return report_method_unknown
private void generatereport sink sink  locale locale  typemapping mappings
throws mojoexecutionexception
beginreport sink  locale
set<string> classes
map<string  set<string>> packages   new treemap<string  set<string>>
class<?> prevfrom   null
class<?> prevto   null
sink table
tableheader sink  locale
for  typemapping mapping   mappings
boolean ignored   false
class<?> from   mapping getfromtype
class<?> to   mapping gettotype
if  objecthelper equal from  prevfrom
objecthelper equal to  prevto
ignored   true
prevfrom   from
prevto   to
method method   mapping getmethod
class<?> methodclass   method getdeclaringclass
string packagename   methodclass getpackage   getname
if  packages containskey packagename
classes   packages get packagename
else
classes   new treeset<string>
packages put packagename  classes
classes add methodclass getname
if  ignored
sink italic
this tablerow sink  from getsimplename    to getsimplename
method getname    methodclass  mapping
getconvertertype   getname
sink italic_
else
this tablerow sink  from getsimplename    to getsimplename
method getname    methodclass  mapping
getconvertertype   getname
sink table_
generatepackagereport sink  packages
endreport sink
private void generatepackagereport sink sink
map<string  set<string>> packages
for  map entry<string  set<string>> entry   packages entryset
sink section2
sink sectiontitle2
sink text entry getkey
sink sectiontitle2_
sink list
for  string clazz   entry getvalue
sink listitem
sink anchor clazz
sink text clazz
sink anchor_
sink listitem_
sink list_
sink section2_
private void beginreport sink sink  locale locale
string title   getbundle locale  getstring
string header   getbundle locale  getstring
string intro   getbundle locale  getstring
string seealso   getbundle locale  getstring
sink head
sink title
sink text title
sink title_
sink head_
sink body
sink section1
sink sectiontitle1
sink text header
sink sectiontitle1_
sink paragraph
sink text intro
sink paragraph_
sink paragraph
sink text seealso
sink list
sink listitem
sink link wiki_typeconverer_url
sink text wiki_typeconverer_url
sink link_
sink listitem_
sink list_
sink paragraph_
private void tableheader sink sink  locale locale
string caption   getbundle locale  getstring
string head1   getbundle locale  getstring
string head2   getbundle locale  getstring
string head3   getbundle locale  getstring
string head4   getbundle locale  getstring
string head5   getbundle locale  getstring
sink tablecaption
sink text caption
sink tablecaption_
sink tablerow
sink tableheadercell
sink text head1
sink tableheadercell_
sink tableheadercell
sink text head2
sink tableheadercell_
sink tableheadercell
sink text head3
sink tableheadercell_
sink tableheadercell
sink text head4
sink tableheadercell_
sink tableheadercell
sink text head5
sink tableheadercell_
sink tablerow
private void tablerow sink sink  string from  string to  string method
class<?> clazz  string type
sink tablerow
sink tablecell
sink text from
sink tablecell_
sink tablecell
sink text to
sink tablecell_
sink tablecell
sink text method
sink tablecell_
sink tablecell
sink link clazz getname
sink text clazz getsimplename
sink link_
sink tablecell_
sink tablecell
sink text convertertype type
sink tablecell_
sink tablerow
private void endreport sink sink
sink section1_
sink body_
sink flush
sink close