/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel maven
import java io file
import java lang reflect invocationtargetexception
import java lang reflect method
import java net malformedurlexception
import java net url
import java net urlclassloader
import java util arraylist
import java util arrays
import java util list
import org apache maven plugin mojoexecutionexception
import org codehaus mojo exec abstractexecmojo
/**
* runs a camelcontext using any spring xml configuration files found in
* <code>meta-inf/spring/*.xml</code> and <code>camel-*.xml</code>
* and starting up the context; then generating
* the dot file before closing the context down.
*
* @goal embedded
* @requiresdependencyresolution runtime
* @execute phase="test-compile"
*/
public class embeddedmojo extends abstractexecmojo
/**
* the duration to run the application for which by default is in milliseconds.
* a value <= 0 will run forever.
* adding a s indicates seconds - eg "5s" means 5 seconds.
*
* @parameter expression="-1"
* @readonly
*/
protected string duration
/**
* the dot file name used to generate the dot diagram of the route definitions
*
* @parameter expression="${project.build.directory}/site/cameldoc/routes.dot"
* @readonly
*/
protected string outputdirectory
/**
* allows the dot file generation to be disabled
*
* @parameter expression="true"
* @readonly
*/
protected boolean dotenabled
/**
* allows the routes from multiple contexts to be aggregated into one dot file (in addition to the individual files)
*
* @parameter expression="false"
* @readonly
*/
protected boolean dotaggregationenabled
/**
* the classpath based application context uri that spring wants to get.
*
* @parameter expression="${camel.applicationcontexturi}"
*/
protected string applicationcontexturi
/**
* the filesystem based application context uri that spring wants to get.
*
* @parameter expression="${camel.fileapplicationcontexturi}"
*/
protected string fileapplicationcontexturi
/**
* project classpath.
*
* @parameter expression="${project.testclasspathelements}"
* @required
* @readonly
*/
private list classpathelements
/**
* this method will run the mojo
*/
public void execute   throws mojoexecutionexception
try
executewithoutwrapping
catch  exception e
throw new mojoexecutionexception     e  e
public void executewithoutwrapping   throws malformedurlexception  classnotfoundexception
nosuchmethodexception  illegalaccessexception  mojoexecutionexception
classloader oldclassloader   thread currentthread   getcontextclassloader
try
classloader newloader   createclassloader null
thread currentthread   setcontextclassloader newloader
runcamel newloader
finally
thread currentthread   setcontextclassloader oldclassloader
// properties
//-------------------------------------------------------------------------
/**
* getter for property output directory.
*
* @return the value of output directory.
*/
public string getoutputdirectory
return outputdirectory
/**
* setter for the output directory.
*
* @param inoutputdirectory the value of output directory.
*/
public void setoutputdirectory string inoutputdirectory
this outputdirectory   inoutputdirectory
public list getclasspathelements
return classpathelements
public void setclasspathelements list classpathelements
this classpathelements   classpathelements
public boolean isdotenabled
return dotenabled
public void setdotenabled boolean dotenabled
this dotenabled   dotenabled
public string getduration
return duration
public void setduration string duration
this duration   duration
public boolean isdotaggregationenabled
return dotaggregationenabled
public void setdotaggregationenabled boolean dotaggregationenabled
this dotaggregationenabled   dotaggregationenabled
// implementation methods
//-------------------------------------------------------------------------
protected void runcamel classloader newloader  throws classnotfoundexception  nosuchmethodexception
illegalaccessexception  mojoexecutionexception
getlog   debug     newloader
class<?> type   newloader loadclass
method method   type getmethod    string class
string arguments   createarguments
getlog   debug     arrays aslist arguments
try
method invoke null  new object  arguments
catch  invocationtargetexception e
throwable t   e gettargetexception
throw new mojoexecutionexception     t  t
protected string createarguments
arraylist<string> args   new arraylist<string> 5
if  isdotenabled
args add
args add getoutputdirectory
if  isdotaggregationenabled
args add
args add
if  applicationcontexturi    null
args add
args add applicationcontexturi
else if  fileapplicationcontexturi    null
args add
args add fileapplicationcontexturi
args add
args add getduration
return  string  args toarray new string
public classloader createclassloader classloader parent  throws malformedurlexception
getlog   debug     classpathelements
int size   classpathelements size
url urls   new url
for  int i   0  i < size  i
string name    string  classpathelements get i
file file   new file name
urls   file tourl
getlog   debug     urls
urlclassloader loader   new urlclassloader urls  parent
return loader