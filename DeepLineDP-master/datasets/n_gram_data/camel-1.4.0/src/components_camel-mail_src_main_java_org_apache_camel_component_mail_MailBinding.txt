/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component mail
import java util iterator
import java util map
import javax activation datahandler
import javax mail address
import javax mail bodypart
import javax mail message
import javax mail messagingexception
import javax mail part
import javax mail internet internetaddress
import javax mail internet mimebodypart
import javax mail internet mimemessage
import javax mail internet mimemultipart
import org apache camel exchange
import org apache camel runtimecamelexception
import org apache camel converter objectconverter
/**
* a strategy used to convert between a camel {@link exchange} and {@link message} to and
* from a mail {@link mimemessage}
*
* @version $revision$
*/
public class mailbinding
public void populatemailmessage mailendpoint endpoint  mimemessage mimemessage  exchange exchange
throws messagingexception
appendheadersfromcamel mimemessage  exchange  exchange getin
// set the recipients (receivers) of the mail
map<message recipienttype  string> recipients   endpoint getconfiguration   getrecipients
if  recipients containskey message recipienttype to
mimemessage setrecipients message recipienttype to  recipients get message recipienttype to
if  recipients containskey message recipienttype cc
mimemessage setrecipients message recipienttype cc  recipients get message recipienttype cc
if  recipients containskey message recipienttype bcc
mimemessage setrecipients message recipienttype bcc  recipients get message recipienttype bcc
// must have at least one recipients otherwise we do not know where to send the mail
if  mimemessage getallrecipients      null
throw new illegalargumentexception
if  empty mimemessage getfrom
// lets default the address to the endpoint destination
string from   endpoint getconfiguration   getfrom
mimemessage setfrom new internetaddress from
if  exchange getin   hasattachments
appendattachmentsfromcamel mimemessage  exchange  exchange getin
else
mimemessage settext exchange getin   getbody string class
/**
* extracts the body from the mail message
*/
public object extractbodyfrommail mailexchange exchange  message message
try
return message getcontent
catch  exception e
throw new runtimecamelexception     e getmessage
exchange       message  e
/**
* appends the mail headers from the camel {@link mailmessage}
*/
protected void appendheadersfromcamel mimemessage mimemessage  exchange exchange
org apache camel message camelmessage
throws messagingexception
for  map entry<string  object> entry   camelmessage getheaders   entryset
string headername   entry getkey
object headervalue   entry getvalue
if  headervalue    null
if  shouldoutputheader camelmessage  headername  headervalue
// mail messages can repeat the same header...
if  objectconverter iscollection headervalue
iterator iter   objectconverter iterator headervalue
while  iter hasnext
object value   iter next
mimemessage addheader headername  asstring exchange  value
else
mimemessage setheader headername  asstring exchange  headervalue
/**
* appends the mail attachments from the camel {@link mailmessage}
*/
protected void appendattachmentsfromcamel mimemessage mimemessage  exchange exchange
org apache camel message camelmessage
throws messagingexception
// create a multipart
mimemultipart multipart   new mimemultipart
// fill the body with text
multipart setsubtype
mimebodypart textbodypart   new mimebodypart
textbodypart setcontent exchange getin   getbody string class
multipart addbodypart textbodypart
for  map entry<string  datahandler> entry   camelmessage getattachments   entryset
string attachmentfilename   entry getkey
datahandler handler   entry getvalue
if  handler    null
if  shouldoutputattachment camelmessage  attachmentfilename  handler
// create another body part
bodypart messagebodypart   new mimebodypart
// set the data handler to the attachment
messagebodypart setdatahandler handler
// set the filename
messagebodypart setfilename attachmentfilename
// set disposition
messagebodypart setdisposition part attachment
// add part to multipart
multipart addbodypart messagebodypart
// put parts in message
mimemessage setcontent multipart
/**
* strategy to allow filtering of headers which are put on the mail message
*/
protected boolean shouldoutputheader org apache camel message camelmessage  string headername  object headervalue
return true
/**
* strategy to allow filtering of attachments which are put on the mail message
*/
protected boolean shouldoutputattachment org apache camel message camelmessage  string attachmentfilename  datahandler handler
return true
private static boolean empty address addresses
return addresses    null    addresses length    0
private static string asstring exchange exchange  object value
return exchange getcontext   gettypeconverter   convertto string class  value