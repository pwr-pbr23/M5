/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component jetty
import java io ioexception
import java io inputstream
import java util iterator
import java util concurrent countdownlatch
import org apache camel asynccallback
import org apache camel asyncprocessor
import org apache camel exchange
import org apache camel message
import org apache camel producer
import org apache camel component http httpbinding
import org apache camel component http httpendpoint
import org apache camel component http httpexchange
import org apache camel impl defaultproducer
import org mortbay io buffer
import org mortbay jetty httpfields
import org mortbay jetty httpfields field
import org mortbay jetty httpmethods
import org mortbay jetty httpuri
import org mortbay jetty client httpclient
import org mortbay jetty client httpexchange contentexchange
public class jettyhttpproducer extends defaultproducer<httpexchange> implements producer<httpexchange>  asyncprocessor
private final class camelcontentexchange extends contentexchange
private final asynccallback callback
private final exchange exchange
private httpfields responsefields
private camelcontentexchange exchange exchange  asynccallback callback
this exchange   exchange
this callback   callback
responsefields   new httpfields
protected void onresponsecomplete   throws ioexception
super onrequestcomplete
try
message out   exchange getout true
out setbody getresponsecontent
for  iterator i   responsefields getfields    i hasnext
field field    field i next
out setheader field getname    field getvalue
catch  throwable e
exchange setexception e
callback done false
public httpfields getresponsefields
return responsefields
protected void onresponsetheader buffer name  buffer value  throws ioexception
responsefields add name  value
private httpclient httpclient
private string address
public jettyhttpproducer httpendpoint endpoint
super endpoint
httpclient     jettyhttpcomponent endpoint getcomponent    gethttpclient
address   endpoint gethttpuri   tostring
// a workaround where the jetty client does not like to see
// urls like http://google.com but does like http://google.com/
httpuri uri   new httpuri address
if  uri getcompletepath      null
address
public void process exchange exchange  throws exception
final countdownlatch latch   new countdownlatch 1
process exchange  new asynccallback
public void done boolean sync
latch countdown
latch await
public boolean process final exchange exchange  final asynccallback callback
contentexchange jettyexchange   new camelcontentexchange exchange  callback
jettyexchange seturl address
// if a in body can be converted to an inputstream or a buffer
// then do a post otherwise, do a get
message in   exchange getin
inputstream is   in getbody inputstream class
if  is    null
jettyexchange setmethod httpmethods post
jettyexchange setrequestcontentsource is
else
buffer buffer   in getbody buffer class
if  buffer    null
jettyexchange setmethod httpmethods post
jettyexchange setrequestcontent buffer
else
jettyexchange setmethod httpmethods get
httpbinding binding     httpendpoint getendpoint    getbinding
for  string name   in getheaders   keyset
string value   in getheader name  string class
if    equals name
jettyexchange setrequestcontenttype value
else if  binding shouldheaderbepropagated name  value
jettyexchange addrequestheader name  value
try
httpclient send jettyexchange
catch  ioexception e
exchange setexception e
return true
return false