/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component cxf
import java io outputstream
import javax xml transform source
import org apache camel asynccallback
import org apache camel asyncprocessor
import org apache camel exchange
import org apache camel exchangepattern
import org apache camel processor
import org apache camel producer
import org apache camel component cxf util cxfendpointutils
import org apache camel component cxf util dummy
import org apache camel component cxf util nullconduit
import org apache camel component cxf util nullconduitselector
import org apache camel util asyncprocessorhelper
import org apache commons logging log
import org apache commons logging logfactory
import org apache cxf bus
import org apache cxf endpoint clientimpl
import org apache cxf frontend clientfactorybean
import org apache cxf interceptor interceptorchain
import org apache cxf interceptor outgoingchaininterceptor
import org apache cxf io cachedoutputstream
import org apache cxf message exchangeimpl
import org apache cxf message message
/**
* a cxf based soap provider.
* the consumer will delegate to another endpoint for the transport layer
* and will provide soap support on top of it.
*/
public class cxfsoapproducer implements producer  asyncprocessor
private static final log log   logfactory getlog cxfsoapproducer class
private final cxfsoapendpoint endpoint
private final producer producer
private final asyncprocessor processor
private clientimpl client
public cxfsoapproducer cxfsoapendpoint endpoint  throws exception
this endpoint   endpoint
this producer   endpoint getinnerendpoint   createproducer
this processor   new asyncprocessordecorator producer
new processor
public void process exchange exchange  throws exception
processsoapproviderin exchange
new processor
public void process exchange exchange  throws exception
processsoapproviderout exchange
//create the endpoint and setup the interceptors
class sei   cxfendpointutils getseiclass endpoint getserviceclass
clientfactorybean cfb   cxfendpointutils getclientfactorybean sei
if  sei    null
cfb setserviceclass dummy class
else
cfb setserviceclass sei
cfb setwsdlurl endpoint getwsdl   geturl   tostring
if  endpoint getservicename      null
cfb setservicename endpoint getservicename
if  endpoint getendpointname      null
cfb setendpointname endpoint getendpointname
cfb setconduitselector new nullconduitselector
client    clientimpl  cfb create
public org apache camel endpoint getendpoint
return producer getendpoint
public exchange createexchange
return producer createexchange
public exchange createexchange exchangepattern pattern
return producer createexchange pattern
public exchange createexchange exchange exchange
return producer createexchange exchange
public void process exchange exchange  throws exception
asyncprocessorhelper process this  exchange
public boolean process exchange exchange  asynccallback callback
return processor process exchange  callback
public void start   throws exception
producer start
public void stop   throws exception
producer stop
protected void processsoapproviderout exchange exchange  throws exception
log info     exchange
org apache cxf message message inmessage   cxfsoapbinding getcxfinmessage exchange  true
client setininterceptors client getendpoint   getservice   getininterceptors
client onmessage inmessage
exchange getout   setbody inmessage getcontent source class
exchange getout   setheaders inmessage
protected bus getbus
return endpoint getbus
protected void processsoapproviderin exchange exchange  throws exception
log info     exchange
org apache cxf endpoint endpoint cxfendpoint   client getendpoint
org apache cxf message exchange cxfexchange   new exchangeimpl
cxfexchange put org apache cxf endpoint endpoint class  cxfendpoint
cxfexchange put bus class  getbus
cxfexchange setconduit new nullconduit
exchange setproperty cxfconstants cxf_exchange  cxfexchange
org apache cxf message message outmessage   cxfsoapbinding getcxfoutmessage exchange  true
outmessage put message requestor_role  boolean true
outmessage put message inbound_message  boolean false
interceptorchain chain   outgoingchaininterceptor getoutinterceptorchain cxfexchange
outmessage setinterceptorchain chain
chain dointercept outmessage
cachedoutputstream outputstream    cachedoutputstream outmessage getcontent outputstream class
exchange getout   setbody outputstream getinputstream
exchange getin   setbody outputstream getinputstream