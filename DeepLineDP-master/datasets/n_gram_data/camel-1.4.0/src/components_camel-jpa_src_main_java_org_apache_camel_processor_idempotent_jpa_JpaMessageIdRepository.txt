/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel processor idempotent jpa
import java util list
import javax persistence entitymanagerfactory
import javax persistence persistence
import org apache camel processor idempotent messageidrepository
import org springframework orm jpa jpatemplate
import org springframework orm jpa jpatransactionmanager
import org springframework transaction transactiondefinition
import org springframework transaction transactionstatus
import org springframework transaction support transactioncallback
import org springframework transaction support transactiontemplate
/**
* @version $revision$
*/
public class jpamessageidrepository implements messageidrepository
protected static final string query_string       messageprocessed class getname
private jpatemplate jpatemplate
private string processorname
private transactiontemplate transactiontemplate
public jpamessageidrepository jpatemplate template  string processorname
this template  createtransactiontemplate template   processorname
public jpamessageidrepository jpatemplate template  transactiontemplate transactiontemplate  string processorname
this jpatemplate   template
this processorname   processorname
this transactiontemplate   transactiontemplate
public static jpamessageidrepository jpamessageidrepository string persistenceunit  string processorname
entitymanagerfactory entitymanagerfactory   persistence createentitymanagerfactory persistenceunit
return jpamessageidrepository new jpatemplate entitymanagerfactory   processorname
public static jpamessageidrepository jpamessageidrepository jpatemplate jpatemplate  string processorname
return new jpamessageidrepository jpatemplate  processorname
private static transactiontemplate createtransactiontemplate jpatemplate jpatemplate
transactiontemplate transactiontemplate   new transactiontemplate
transactiontemplate settransactionmanager new jpatransactionmanager jpatemplate getentitymanagerfactory
transactiontemplate setpropagationbehavior transactiondefinition propagation_required
return transactiontemplate
public boolean contains final string messageid
// run this in single transaction.
boolean rc    boolean transactiontemplate execute new transactioncallback
public object dointransaction transactionstatus arg0
list list   jpatemplate find query_string  processorname  messageid
if  list isempty
messageprocessed processed   new messageprocessed
processed setprocessorname processorname
processed setmessageid messageid
jpatemplate persist processed
jpatemplate flush
return boolean false
else
return boolean true
return rc booleanvalue