/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component jms requestor
import java math biginteger
import java util random
import java util concurrent scheduledexecutorservice
import javax jms destination
import javax jms exceptionlistener
import javax jms jmsexception
import javax jms message
import javax jms session
import org apache camel component jms jmsconfiguration
import org apache camel component jms requestor deferredrequestreplymap deferredmessagesentcallback
import org springframework core task taskexecutor
import org springframework jms listener abstractmessagelistenercontainer
import org springframework jms listener defaultmessagelistenercontainer
import org springframework jms listener defaultmessagelistenercontainer102
import org springframework jms support destination destinationresolver
import org springframework transaction platformtransactionmanager
public class persistentreplytorequestor extends requestor
private string replytoselectorvalue
public class destinationresolverdelegate implements destinationresolver
private destinationresolver delegate
private destination destination
public destinationresolverdelegate destinationresolver delegate
this delegate   delegate
public destination resolvedestinationname session session  string destinationname
boolean pubsubdomain  throws jmsexception
synchronized  getoutterinstance
try
if  destination    null
destination   delegate resolvedestinationname session  destinationname  pubsubdomain
setreplyto destination
finally
getoutterinstance   notifyall
return destination
public static interface messageselectorcomposer
void addcorrelationid string id
void removecorrelationid string id
public static class cameldefaultmessagelistenercontainer102 extends defaultmessagelistenercontainer102
implements messageselectorcomposer
messageselectorprovider provider   new messageselectorprovider
public void addcorrelationid string id
provider addcorrelationid id
public void removecorrelationid string id
provider removecorrelationid id
@override
public void setmessageselector string messageselector
throw new unsupportedoperationexception
@override
public string getmessageselector
return provider get
public static class cameldefaultmessagelistenercontainer extends defaultmessagelistenercontainer
implements messageselectorcomposer
messageselectorprovider provider   new messageselectorprovider
public void addcorrelationid string id
provider addcorrelationid id
public void removecorrelationid string id
provider removecorrelationid id
@override
public void setmessageselector string messageselector
throw new unsupportedoperationexception
@override
public string getmessageselector
return provider get
public persistentreplytorequestor jmsconfiguration configuration
scheduledexecutorservice executorservice
super configuration  executorservice
@override
protected futurehandler createfuturehandler string correlationid
boolean dynamicselector   getconfiguration   getreplytodestinationselectorname      null
if  dynamicselector
return new persistentreplytofuturehandler this  correlationid
return new futurehandler
@override
protected futurehandler createfuturehandler deferredmessagesentcallback callback
boolean dynamicselector   getconfiguration   getreplytodestinationselectorname      null
if  dynamicselector
return new persistentreplytofuturehandler this  callback
return new futurehandler
@override
public abstractmessagelistenercontainer createlistenercontainer
jmsconfiguration config   getconfiguration
string replytoselectorname   getconfiguration   getreplytodestinationselectorname
abstractmessagelistenercontainer container
config isuseversion102
?  replytoselectorname    null  ? new defaultmessagelistenercontainer102
new cameldefaultmessagelistenercontainer102
replytoselectorname    null  ? new defaultmessagelistenercontainer
new cameldefaultmessagelistenercontainer
container setconnectionfactory config getlistenerconnectionfactory
destinationresolver resolver   config getdestinationresolver
if  resolver    null
resolver   container getdestinationresolver
container setdestinationresolver new destinationresolverdelegate resolver
container setdestinationname getconfiguration   getreplyto
if  replytoselectorname    null
replytoselectorvalue       new biginteger 24   8  new random    tostring 16
container setmessageselector replytoselectorname       replytoselectorvalue
else
messageselectorcomposer container  addcorrelationid     new biginteger 24   8  new random    tostring 16
container setautostartup true
container setmessagelistener this
container setpubsubdomain false
container setsubscriptiondurable false
exceptionlistener exceptionlistener   config getexceptionlistener
if  exceptionlistener    null
container setexceptionlistener exceptionlistener
container setsessiontransacted config istransacted
if  config istransacted
container setsessionacknowledgemode session session_transacted
else
if  config getacknowledgementmode   >  0
container setsessionacknowledgemode config getacknowledgementmode
else if  config getacknowledgementmodename      null
container setsessionacknowledgemodename config getacknowledgementmodename
if  container instanceof defaultmessagelistenercontainer
defaultmessagelistenercontainer defcontainer    defaultmessagelistenercontainer container
defcontainer setconcurrentconsumers 1
defcontainer setcachelevel defaultmessagelistenercontainer cache_session
if  config getreceivetimeout   >  0
defcontainer setreceivetimeout config getreceivetimeout
if  config getrecoveryinterval   >  0
defcontainer setrecoveryinterval config getrecoveryinterval
taskexecutor taskexecutor   config gettaskexecutor
if  taskexecutor    null
defcontainer settaskexecutor taskexecutor
platformtransactionmanager tm   config gettransactionmanager
if  tm    null
defcontainer settransactionmanager tm
else if  config istransacted
throw new illegalargumentexception
if  config gettransactionname      null
defcontainer settransactionname config gettransactionname
if  config gettransactiontimeout   >  0
defcontainer settransactiontimeout config gettransactiontimeout
return container
@override
public void setreplytoselectorheader org apache camel message in  message jmsin  throws jmsexception
string replytoselectorname   getconfiguration   getreplytodestinationselectorname
if  replytoselectorvalue    null
in setheader replytoselectorname  replytoselectorvalue
jmsin setstringproperty replytoselectorname  replytoselectorvalue