/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component cxf
import java io outputstream
import javax xml transform source
import org apache camel consumer
import org apache camel exchange
import org apache camel processor
import org apache camel component cxf util cxfendpointutils
import org apache camel component cxf util nullconduit
import org apache camel component cxf util nulldestinationfactory
import org apache commons logging log
import org apache commons logging logfactory
import org apache cxf bus
import org apache cxf endpoint server
import org apache cxf frontend serverfactorybean
import org apache cxf interceptor interceptorchain
import org apache cxf interceptor outgoingchaininterceptor
import org apache cxf io cachedoutputstream
import org apache cxf transport messageobserver
/**
* a cxf based soap consumer (client).
* the consumer will delegate to another endpoint for the transport layer
* and will provide soap support on top of it.
*/
public class cxfsoapconsumer implements consumer
private static final log log   logfactory getlog cxfsoapconsumer class
private final cxfsoapendpoint endpoint
private final consumer consumer
private messageobserver inmessageobserver
private server server
public cxfsoapconsumer cxfsoapendpoint endpoint  processor processor  throws exception
this endpoint   endpoint
processor soapprocessor   new asyncprocessordecorator processor
new processor
public void process exchange exchange  throws exception
processsoapconsumerin exchange
new processor
public void process exchange exchange  throws exception
processsoapconsumerout exchange
this consumer   endpoint getinnerendpoint   createconsumer soapprocessor
class sei   cxfendpointutils getseiclass endpoint getserviceclass
serverfactorybean sfb   cxfendpointutils getserverfactorybean sei
sfb setwsdlurl endpoint getwsdl   geturl   tostring
if  endpoint getservicename      null
sfb setservicename endpoint getservicename
if  endpoint getendpointname      null
sfb setendpointname endpoint getendpointname
// we do not need use the destination here
sfb setdestinationfactory new nulldestinationfactory
sfb setstart false
server   sfb create
public void start   throws exception
server start
inmessageobserver   server getdestination   getmessageobserver
consumer start
public void stop   throws exception
server stop
consumer stop
protected bus getbus
return endpoint getbus
protected void processsoapconsumerin exchange exchange  throws exception
log info     exchange
org apache cxf message message inmessage   cxfsoapbinding getcxfinmessage exchange  false
org apache cxf message exchange cxfexchange   inmessage getexchange
cxfexchange put org apache cxf endpoint endpoint class  server getendpoint
cxfexchange put bus class  getbus
cxfexchange setconduit new nullconduit
// get the message input stream, deal with the exchange in message
inmessageobserver onmessage inmessage
exchange getin   setbody inmessage getcontent source class
//todo copy the right header information
exchange getin   setheaders inmessage
protected void processsoapconsumerout exchange exchange  throws exception
log info     exchange
// todo check if the message is one-way message
// get the method name from the soap endpoint
org apache cxf message message outmessage   cxfsoapbinding getcxfoutmessage exchange  false
org apache cxf message exchange cxfexchange   outmessage getexchange
interceptorchain chain   outgoingchaininterceptor getoutinterceptorchain cxfexchange
outmessage setinterceptorchain chain
chain dointercept outmessage
cachedoutputstream outputstream    cachedoutputstream outmessage getcontent outputstream class
exchange getout   setbody outputstream getinputstream