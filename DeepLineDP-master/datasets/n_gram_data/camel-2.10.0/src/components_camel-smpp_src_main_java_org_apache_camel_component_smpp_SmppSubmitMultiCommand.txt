/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component smpp
import java nio charset charset
import java util arraylist
import java util arrays
import java util date
import java util hashmap
import java util list
import java util map
import org apache camel exchange
import org apache camel message
import org jsmpp bean address
import org jsmpp bean alphabet
import org jsmpp bean datacoding
import org jsmpp bean esmclass
import org jsmpp bean gsmspecificfeature
import org jsmpp bean generaldatacoding
import org jsmpp bean messageclass
import org jsmpp bean messagemode
import org jsmpp bean messagetype
import org jsmpp bean numberingplanindicator
import org jsmpp bean optionalparameter
import org jsmpp bean registereddelivery
import org jsmpp bean replaceifpresentflag
import org jsmpp bean submitmulti
import org jsmpp bean submitmultiresult
import org jsmpp bean typeofnumber
import org jsmpp bean unsuccessdelivery
import org jsmpp session smppsession
public class smppsubmitmulticommand extends smppsmcommand
public smppsubmitmulticommand smppsession session  smppconfiguration config
super session  config
@override
public void execute exchange exchange  throws smppexception
submitmulti submitmulties   createsubmitmulti exchange
list<submitmultiresult> results   new arraylist<submitmultiresult> submitmulties length
for  submitmulti submitmulti   submitmulties
submitmultiresult result
log debug    exchange getexchangeid
try
result   session submitmultiple
submitmulti getservicetype
typeofnumber valueof submitmulti getsourceaddrton
numberingplanindicator valueof submitmulti getsourceaddrnpi
submitmulti getsourceaddr
address  submitmulti getdestaddresses
new esmclass submitmulti getesmclass
submitmulti getprotocolid
submitmulti getpriorityflag
submitmulti getscheduledeliverytime
submitmulti getvalidityperiod
new registereddelivery submitmulti getregistereddelivery
new replaceifpresentflag submitmulti getreplaceifpresentflag
new generaldatacoding submitmulti getdatacoding
submitmulti getsmdefaultmsgid
submitmulti getshortmessage
new optionalparameter
results add result
catch  exception e
throw new smppexception e
log debug    exchange getexchangeid    results
list<string> messageids   new arraylist<string> results size
// {messageid : [{destaddr : address, error : errorcode}]}
map<string  list<map<string  object>>> errors   new hashmap<string  list<map<string  object>>>
for  submitmultiresult result   results
unsuccessdelivery deliveries   result getunsuccessdeliveries
if  deliveries    null
list<map<string  object>> undelivered   new arraylist<map<string  object>>
for  unsuccessdelivery delivery   deliveries
map<string  object> error   new hashmap<string  object>
error put smppconstants dest_addr  delivery getdestinationaddress   getaddress
error put smppconstants error  delivery geterrorstatuscode
undelivered add error
if   undelivered isempty
errors put result getmessageid    undelivered
messageids add result getmessageid
message message   getresponsemessage exchange
message setheader smppconstants id  messageids
message setheader smppconstants sent_message_count  messageids size
if   errors isempty
message setheader smppconstants error  errors
protected submitmulti createsubmitmulti exchange exchange
string body   exchange getin   getbody string class
byte providedalphabet   getprovidedalphabet exchange
alphabet determinedalphabet   determinealphabet exchange
smppsplitter splitter   createsplitter exchange
charset charset   determinecharset providedalphabet  determinedalphabet value
byte segments   splitter split body getbytes charset
datacoding datacoding   new generaldatacoding false  true  messageclass class1  determinedalphabet
esmclass esmclass
// multipart message
if  segments length > 1
esmclass   new esmclass messagemode default  messagetype default  gsmspecificfeature udhi
else
esmclass   new esmclass
submitmulti template   createsubmitmultitemplate exchange
submitmulti submitmulties   new submitmulti
for  int i   0  i < segments length  i
submitmulti submitmulti   smpputils copysubmitmulti template
submitmulti setesmclass esmclass value
submitmulti setdatacoding datacoding value
submitmulti setshortmessage segments
submitmulties   submitmulti
return submitmulties
@suppresswarnings
protected submitmulti createsubmitmultitemplate exchange exchange
message in   exchange getin
submitmulti submitmulti   new submitmulti
byte destaddrton
if  in getheaders   containskey smppconstants dest_addr_ton
destaddrton   in getheader smppconstants dest_addr_ton  byte class
else
destaddrton   config getdestaddrton
byte destaddrnpi
if  in getheaders   containskey smppconstants dest_addr_npi
destaddrnpi   in getheader smppconstants dest_addr_npi  byte class
else
destaddrnpi   config getdestaddrnpi
list<string> destaddresses
if  in getheaders   containskey smppconstants dest_addr
destaddresses   in getheader smppconstants dest_addr  list class
else
destaddresses   arrays aslist config getdestaddr
address addresses   new address
int addrnum   0
for  string destaddr   destaddresses
address addr   new address destaddrton  destaddrnpi  destaddr
addresses   addr
submitmulti setdestaddresses addresses
if  in getheaders   containskey smppconstants source_addr
submitmulti setsourceaddr in getheader smppconstants source_addr  string class
else
submitmulti setsourceaddr config getsourceaddr
if  in getheaders   containskey smppconstants source_addr_ton
submitmulti setsourceaddrton in getheader smppconstants source_addr_ton  byte class
else
submitmulti setsourceaddrton config getsourceaddrton
if  in getheaders   containskey smppconstants source_addr_npi
submitmulti setsourceaddrnpi in getheader smppconstants source_addr_npi  byte class
else
submitmulti setsourceaddrnpi config getsourceaddrnpi
if  in getheaders   containskey smppconstants service_type
submitmulti setservicetype in getheader smppconstants service_type  string class
else
submitmulti setservicetype config getservicetype
if  in getheaders   containskey smppconstants registered_delivery
submitmulti setregistereddelivery in getheader smppconstants registered_delivery  byte class
else
submitmulti setregistereddelivery config getregistereddelivery
if  in getheaders   containskey smppconstants protocol_id
submitmulti setprotocolid in getheader smppconstants protocol_id  byte class
else
submitmulti setprotocolid config getprotocolid
if  in getheaders   containskey smppconstants priority_flag
submitmulti setpriorityflag in getheader smppconstants priority_flag  byte class
else
submitmulti setpriorityflag config getpriorityflag
if  in getheaders   containskey smppconstants schedule_delivery_time
submitmulti setscheduledeliverytime smpputils formattime in getheader smppconstants schedule_delivery_time  date class
if  in getheaders   containskey smppconstants validity_period
object validityperiod   in getheader smppconstants validity_period
if  validityperiod instanceof string
submitmulti setvalidityperiod  string  validityperiod
else if  validityperiod instanceof date
submitmulti setvalidityperiod smpputils formattime  date  validityperiod
if  in getheaders   containskey smppconstants replace_if_present_flag
submitmulti setreplaceifpresentflag in getheader smppconstants replace_if_present_flag  byte class
else
submitmulti setreplaceifpresentflag config getreplaceifpresentflag
return submitmulti