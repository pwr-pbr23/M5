/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel routepolicy quartz
import java util linkedhashmap
import java util map
import java util concurrent timeunit
import org apache camel route
import org apache camel servicestatus
import org apache camel impl routepolicysupport
import org quartz jobdetail
import org quartz scheduler
import org quartz schedulerexception
import org quartz trigger
import org slf4j logger
import org slf4j loggerfactory
public abstract class scheduledroutepolicy extends routepolicysupport implements scheduledroutepolicyconstants
private static final transient logger log   loggerfactory getlogger scheduledroutepolicy class
protected map<string  scheduledroutedetails> scheduledroutedetailsmap   new linkedhashmap<string  scheduledroutedetails>
private scheduler scheduler
private int routestopgraceperiod
private timeunit timeunit
protected abstract trigger createtrigger action action  route route  throws exception
protected void onjobexecute action action  route route  throws exception
log debug    action  route getid
servicestatus routestatus   route getroutecontext   getcamelcontext   getroutestatus route getid
if  action    action start
if  routestatus    servicestatus stopped
startroute route
else if  routestatus    servicestatus suspended
startconsumer route getconsumer
else if  action    action stop
if   routestatus    servicestatus started      routestatus    servicestatus suspended
stoproute route  getroutestopgraceperiod    gettimeunit
else
log warn    routestatus
else if  action    action suspend
if  routestatus    servicestatus started
stopconsumer route getconsumer
else
log warn    routestatus
else if  action    action resume
if  routestatus    servicestatus started
startconsumer route getconsumer
else
log warn    routestatus
public void scheduleroute action action  route route  throws exception
jobdetail jobdetail   createjobdetail action  route
trigger trigger   createtrigger action  route
updatescheduledroutedetails action  jobdetail  trigger  route
loadcallbackdataintoschedulercontext jobdetail  action  route
getscheduler   schedulejob jobdetail  trigger
if  log isinfoenabled
log info    new object trigger getfullname    action  route getid
public void pauseroutetrigger action action  string routeid  throws schedulerexception
string triggername   retrievetriggername action  routeid
string triggergroup   retrievetriggergroup action  routeid
getscheduler   pausetrigger triggername  triggergroup
log debug    triggergroup  triggername
public void resumeroutetrigger action action  string routeid  throws schedulerexception
string triggername   retrievetriggername action  routeid
string triggergroup   retrievetriggergroup action  routeid
getscheduler   resumetrigger triggername  triggergroup
log debug    triggergroup  triggername
@override
protected void dostop   throws exception
for  scheduledroutedetails scheduledroutedetails   scheduledroutedetailsmap values
if  scheduledroutedetails getstartjobdetail      null
deleteroutejob action start  scheduledroutedetails
if  scheduledroutedetails getstopjobdetail      null
deleteroutejob action stop  scheduledroutedetails
if  scheduledroutedetails getsuspendjobdetail      null
deleteroutejob action suspend  scheduledroutedetails
if  scheduledroutedetails getresumejobdetail      null
deleteroutejob action resume  scheduledroutedetails
public void deleteroutejob action action  scheduledroutedetails scheduledroutedetails  throws schedulerexception
string jobdetailname   retrievejobdetailname action  scheduledroutedetails
string jobdetailgroup   retrievejobdetailgroup action  scheduledroutedetails
if   getscheduler   isshutdown
getscheduler   deletejob jobdetailname  jobdetailgroup
log debug    jobdetailgroup  jobdetailname
protected jobdetail createjobdetail action action  route route  throws exception
jobdetail jobdetail   null
if  action    action start
jobdetail   new jobdetail job_start   route getid    job_group   route getid    scheduledjob class
else if  action    action stop
jobdetail   new jobdetail job_stop   route getid    job_group   route getid    scheduledjob class
else if  action    action suspend
jobdetail   new jobdetail job_suspend   route getid    job_group   route getid    scheduledjob class
else if  action    action resume
jobdetail   new jobdetail job_resume   route getid    job_group   route getid    scheduledjob class
return jobdetail
protected void updatescheduledroutedetails action action  jobdetail jobdetail  trigger trigger  route route  throws exception
scheduledroutedetails scheduledroutedetails   getscheduledroutedetails route getid
if  action    action start
scheduledroutedetails setstartjobdetail jobdetail
scheduledroutedetails setstarttrigger trigger
else if  action    action stop
scheduledroutedetails setstopjobdetail jobdetail
scheduledroutedetails setstoptrigger trigger
else if  action    action suspend
scheduledroutedetails setsuspendjobdetail jobdetail
scheduledroutedetails setsuspendtrigger trigger
else if  action    action resume
scheduledroutedetails setresumejobdetail jobdetail
scheduledroutedetails setresumetrigger trigger
protected void loadcallbackdataintoschedulercontext jobdetail jobdetail  action action  route route  throws schedulerexception
getscheduler   getcontext   put jobdetail getname    new scheduledjobstate action  route
public string retrievetriggername action action  string routeid
scheduledroutedetails scheduledroutedetails   getscheduledroutedetails routeid
string triggername   null
if  action    action start
triggername   scheduledroutedetails getstarttrigger   getname
else if  action    action stop
triggername   scheduledroutedetails getstoptrigger   getname
else if  action    action suspend
triggername   scheduledroutedetails getsuspendtrigger   getname
else if  action    action resume
triggername   scheduledroutedetails getresumetrigger   getname
return triggername
public string retrievetriggergroup action action  string routeid
scheduledroutedetails scheduledroutedetails   getscheduledroutedetails routeid
string triggergroup   null
if  action    action start
triggergroup   scheduledroutedetails getstarttrigger   getgroup
else if  action    action stop
triggergroup   scheduledroutedetails getstoptrigger   getgroup
else if  action    action suspend
triggergroup   scheduledroutedetails getsuspendtrigger   getgroup
else if  action    action resume
triggergroup   scheduledroutedetails getresumetrigger   getgroup
return triggergroup
public string retrievejobdetailname action action  scheduledroutedetails scheduledroutedetails
string jobdetailname   null
if  action    action start
jobdetailname   scheduledroutedetails getstartjobdetail   getname
else if  action    action stop
jobdetailname   scheduledroutedetails getstopjobdetail   getname
else if  action    action suspend
jobdetailname   scheduledroutedetails getsuspendjobdetail   getname
else if  action    action resume
jobdetailname   scheduledroutedetails getresumejobdetail   getname
return jobdetailname
public string retrievejobdetailgroup action action  scheduledroutedetails scheduledroutedetails
string jobdetailgroup   null
if  action    action start
jobdetailgroup   scheduledroutedetails getstartjobdetail   getgroup
else if  action    action stop
jobdetailgroup   scheduledroutedetails getstopjobdetail   getgroup
else if  action    action suspend
jobdetailgroup   scheduledroutedetails getsuspendjobdetail   getgroup
else if  action    action resume
jobdetailgroup   scheduledroutedetails getresumejobdetail   getgroup
return jobdetailgroup
protected void registerroutetoscheduledroutedetails route route
scheduledroutedetails scheduledroutedetails   new scheduledroutedetails
scheduledroutedetailsmap put route getid    scheduledroutedetails
protected scheduledroutedetails getscheduledroutedetails string routeid
return scheduledroutedetailsmap get routeid
public void setscheduler scheduler scheduler
this scheduler   scheduler
public scheduler getscheduler
return scheduler
public void setroutestopgraceperiod int routestopgraceperiod
this routestopgraceperiod   routestopgraceperiod
public int getroutestopgraceperiod
return routestopgraceperiod
public void settimeunit timeunit timeunit
this timeunit   timeunit
public timeunit gettimeunit
return timeunit