/**
* licensed to the apache software foundation (asf) under one or more
* contributor license agreements.  see the notice file distributed with
* this work for additional information regarding copyright ownership.
* the asf licenses this file to you under the apache license, version 2.0
* (the "license"); you may not use this file except in compliance with
* the license.  you may obtain a copy of the license at
*
*      http://www.apache.org/licenses/license-2.0
*
* unless required by applicable law or agreed to in writing, software
* distributed under the license is distributed on an "as is" basis,
* without warranties or conditions of any kind, either express or implied.
* see the license for the specific language governing permissions and
* limitations under the license.
*/
package org apache camel component http helper
import java io ioexception
import java io inputstream
import java io objectinputstream
import java io objectoutputstream
import java io outputstream
import java net uri
import java net urisyntaxexception
import java util arraylist
import java util list
import java util map
import javax servlet servletresponse
import javax servlet http httpservletrequest
import org apache camel exchange
import org apache camel runtimeexchangeexception
import org apache camel component http httpconstants
import org apache camel component http httpconverter
import org apache camel component http httpendpoint
import org apache camel component http httpmethods
import org apache camel converter ioconverter
import org apache camel converter stream cachedoutputstream
import org apache camel util iohelper
import org apache camel util objecthelper
public final class httphelper
private httphelper
// helper class
@suppresswarnings
public static void setcharsetfromcontenttype string contenttype  exchange exchange
if  contenttype    null
// find the charset and set it to the exchange
int index   contenttype indexof
if  index > 0
string charset   contenttype substring index   8
exchange setproperty exchange charset_name  ioconverter normalizecharset charset
/**
* writes the given object as response body to the servlet response
* <p/>
* the content type will be set to {@link httpconstants#content_type_java_serialized_object}
*
* @param response servlet response
* @param target   object to write
* @throws ioexception is thrown if error writing
*/
public static void writeobjecttoservletresponse servletresponse response  object target  throws ioexception
response setcontenttype httpconstants content_type_java_serialized_object
writeobjecttostream response getoutputstream    target
/**
* writes the given object as response body to the output stream
*
* @param stream output stream
* @param target   object to write
* @throws ioexception is thrown if error writing
*/
public static void writeobjecttostream outputstream stream  object target  throws ioexception
objectoutputstream oos   new objectoutputstream stream
oos writeobject target
oos flush
iohelper close oos
/**
* deserializes the input stream to a java object
*
* @param is input stream for the java object
* @return the java object, or <tt>null</tt> if input stream was <tt>null</tt>
* @throws classnotfoundexception is thrown if class not found
* @throws ioexception can be thrown
*/
public static object deserializejavaobjectfromstream inputstream is  throws classnotfoundexception  ioexception
if  is    null
return null
object answer   null
objectinputstream ois   new objectinputstream is
try
answer   ois readobject
finally
iohelper close ois
return answer
/**
* reads the response body from the given http servlet request.
*
* @param request  http servlet request
* @param exchange the exchange
* @return the response body, can be <tt>null</tt> if no body
* @throws ioexception is thrown if error reading response body
*/
public static object readresponsebodyfromservletrequest httpservletrequest request  exchange exchange  throws ioexception
inputstream is   httpconverter toinputstream request  exchange
return readresponsebodyfrominputstream is  exchange
/**
* reads the response body from the given input stream.
*
* @param is       the input stream
* @param exchange the exchange
* @return the response body, can be <tt>null</tt> if no body
* @throws ioexception is thrown if error reading response body
*/
public static object readresponsebodyfrominputstream inputstream is  exchange exchange  throws ioexception
if  is    null
return null
// convert the input stream to streamcache if the stream cache is not disabled
if  exchange getproperty exchange disable_http_stream_cache  boolean false  boolean class
return is
else
cachedoutputstream cos   new cachedoutputstream exchange
iohelper copyandcloseinput is  cos
return cos getstreamcache
/**
* creates the url to invoke.
*
* @param exchange the exchange
* @param endpoint the endpoint
* @return the url to invoke
*/
public static string createurl exchange exchange  httpendpoint endpoint
string uri   null
if    endpoint isbridgeendpoint
uri   exchange getin   getheader exchange http_uri  string class
if  uri    null
uri   endpoint gethttpuri   toasciistring
// resolve placeholders in uri
try
uri   exchange getcontext   resolvepropertyplaceholders uri
catch  exception e
throw new runtimeexchangeexception     uri  exchange  e
// append http_path to http_uri if it is provided in the header
string path   exchange getin   getheader exchange http_path  string class
if  path    null
if  path startswith
uri baseuri
string baseuristring   exchange getin   getheader exchange http_base_uri  string class
try
if  baseuristring    null
if  exchange getfromendpoint      null
baseuristring   exchange getfromendpoint   getendpointuri
else
// will set a default one for it
baseuristring
baseuri   new uri baseuristring
string basepath   baseuri getrawpath
if  path startswith basepath
path   path substring basepath length
if  path startswith
path   path substring 1
else
throw new runtimeexchangeexception    exchange
catch  throwable t
throw new runtimeexchangeexception     t getmessage    exchange  t
if  path length   > 0
// make sure that there is exactly one "/" between http_uri and
// http_path
if   uri endswith
uri   uri
uri   uri concat path
return uri
/**
* creates the httpmethod to use to call the remote server, often either its get or post.
*
* @param exchange  the exchange
* @return the created method
* @throws urisyntaxexception
*/
public static httpmethods createmethod exchange exchange  httpendpoint endpoint  boolean haspayload  throws urisyntaxexception
// is a query string provided in the endpoint uri or in a header (header
// overrules endpoint)
string querystring   exchange getin   getheader exchange http_query  string class
// we need also check the http_uri header query part
string uristring   exchange getin   getheader exchange http_uri  string class
// resolve placeholders in uristring
try
uristring   exchange getcontext   resolvepropertyplaceholders uristring
catch  exception e
throw new runtimeexchangeexception     uristring  exchange  e
if  uristring    null
uri uri   new uri uristring
querystring   uri getquery
if  querystring    null
querystring   endpoint gethttpuri   getquery
// compute what method to use either get or post
httpmethods answer
httpmethods m   exchange getin   getheader exchange http_method  httpmethods class
if  m    null
// always use what end-user provides in a header
answer   m
else if  querystring    null
// if a query string is provided then use get
answer   httpmethods get
else
// fallback to post if we have payload, otherwise get
answer   haspayload ? httpmethods post   httpmethods get
return answer
/**
* appends the key/value to the headers.
* <p/>
* this implementation supports keys with multiple values. in such situations the value
* will be a {@link java.util.list} that contains the multiple values.
*
* @param headers  headers
* @param key      the key
* @param value    the value
*/
@suppresswarnings
public static void appendheader map<string  object> headers  string key  object value
if  headers containskey key
object existing   headers get key
list<object> list
if  existing instanceof list
list    list<object>  existing
else
list   new arraylist<object>
list add existing
list add value
value   list
headers put key  value
/**
* extracts the parameter value.
* <p/>
* this implementation supports http multi value parameters which
* is based on the syntax of <tt>[value1, value2, value3]</tt> by returning
* a {@link list} containing the values.
* <p/>
* if the value is not a http mulit value the value is returned as is.
*
* @param value the parameter value
* @return the extracted parameter value, see more details in javadoc.
*/
public static object extracthttpparametervalue string value
if  value    null    objecthelper isempty value
return value
// trim value before checking for multiple parameters
string trimmed   value trim
if  trimmed startswith       trimmed endswith
// remove the [ ] markers
trimmed   trimmed substring 1  trimmed length     1
list<string> list   new arraylist<string>
string values   trimmed split
for  string s   values
list add s trim
return list
return value